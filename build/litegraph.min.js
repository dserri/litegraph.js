!function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,LiteGraph.debug&&console.log("Node registered: "+t);var i,s=e.name,o=t.lastIndexOf("/");for(i in e.category=t.substring(0,o),e.title||(e.title=s),LGraphNode.prototype)e.prototype[i]||(e.prototype[i]=LGraphNode.prototype[i]);o=this.registered_node_types[t];if(o&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(e.prototype,"shape")&&(Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=t}},get:function(){return this._shape},enumerable:!0,configurable:!0}),e.supported_extensions))for(var n in e.supported_extensions){n=e.supported_extensions[n];n&&n.constructor===String&&(this.node_types_by_file_extension[n.toLowerCase()]=e)}(this.registered_node_types[t]=e).constructor.name&&(this.Nodes[s]=e),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(t,e),o&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(t,e,o),e.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new e(e.title||"tmpnode")},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},registerNodeAndSlotType:function(t,e,i){i=i||!1;var s=(t.constructor===String&&"anonymous"!==this.registered_node_types[t]?this.registered_node_types[t]:t).constructor.type;let o=[];o="string"==typeof e?e.split(","):e==this.EVENT||e==this.ACTION?["_event_"]:["*"];for(let e=0;e<o.length;++e){let t=o[e];""===t&&(t="*");var n=i?"registered_slot_out_types":"registered_slot_in_types";void 0===this[n][t]&&(this[n][t]={nodes:[]}),this[n][t].nodes.includes(s)||this[n][t].nodes.push(s),i?this.slot_types_out.includes(t.toLowerCase())||(this.slot_types_out.push(t.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(t.toLowerCase())||(this.slot_types_in.push(t.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(t,e){var i,s="";if(e.inputs)for(var o=0;o<e.inputs.length;++o)s+="this.addInput('"+e.inputs[o][0]+"',"+(i=(i=e.inputs[o][1])&&i.constructor===String?'"'+i+'"':i)+");\n";if(e.outputs)for(o=0;o<e.outputs.length;++o)s+="this.addOutput('"+e.outputs[o][0]+"',"+(i=(i=e.outputs[o][1])&&i.constructor===String?'"'+i+'"':i)+");\n";if(e.properties)for(var o in e.properties){var n=e.properties[o];s+="this.addProperty('"+o+"',"+(n=n&&n.constructor===String?'"'+n+'"':n)+");\n"}s+="if(this.onCreate)this.onCreate()";var r=Function(s);for(o in e)"inputs"!=o&&"outputs"!=o&&"properties"!=o&&(r.prototype[o]=e[o]);return r.title=e.title||t.split("/").pop(),r.desc=e.desc||"Generated from object",this.registerNodeType(t,r),r},wrapFunctionAsNode:function(t,i,e,s,o){var n=Array(i.length),r="";if(null!==e)for(var a=LiteGraph.getParameterNames(i),u=0;u<a.length;++u){var h=0;e&&(null!=e[u]&&e[u].constructor===String?h="'"+e[u]+"'":null!=e[u]&&(h=e[u])),r+="this.addInput('"+a[u]+"',"+h+");\n"}null!==s&&(r+="this.addOutput('out',"+(null!=s?s.constructor===String?"'"+s+"'":s:0)+");\n"),o&&(r+="this.properties = "+JSON.stringify(o)+";\n");s=Function(r);return s.title=t.split("/").pop(),s.desc="Generated from "+i.name,s.prototype.onExecute=function(){for(var t=0;t<n.length;++t)n[t]=this.getInputData(t);var e=i.apply(this,n);this.setOutputData(0,e)},this.registerNodeType(t,s),s},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var i in LGraphNode.prototype[t]=e,this.registered_node_types){i=this.registered_node_types[i];i.prototype[t]&&(i.prototype["_"+t]=i.prototype[t]),i.prototype[t]=e}},createNode:function(t,e,i){var s=this.registered_node_types[t];if(!s)return LiteGraph.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;s.prototype;e=e||s.title||t;var o=null;if(LiteGraph.catch_exceptions)try{o=new s(e)}catch(t){return console.error(t),null}else o=new s(e);if(o.type=t,!o.title&&e&&(o.title=e),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=LiteGraph.DEFAULT_POSITION.concat()),o.mode||(o.mode=LiteGraph.ALWAYS),i)for(var n in i)o[n]=i[n];return o.onNodeCreated&&o.onNodeCreated(),o},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var i,s=[];for(i in this.registered_node_types){var o=this.registered_node_types[i];o.filter==e&&(""==t?null==o.category&&s.push(o):o.category==t&&s.push(o))}return this.auto_sort_node_types&&s.sort(function(t,e){return t.title.localeCompare(e.title)}),s},getNodeTypesCategories:function(t){var e={"":1};for(s in this.registered_node_types){var i=this.registered_node_types[s];i.category&&!i.skip_list&&i.filter==t&&(e[i.category]=1)}var s,o=[];for(s in e)o.push(s);return this.auto_sort_node_types?o.sort():o},reloadNodes:function(t){for(var e=document.getElementsByTagName("script"),i=[],s=0;s<e.length;s++)i.push(e[s]);var o=document.getElementsByTagName("head")[0];t=document.location.href+t;for(s=0;s<i.length;s++){var n=i[s].src;if(n&&n.substr(0,t.length)==t)try{LiteGraph.debug&&console.log("Reloading: "+n);var r=document.createElement("script");r.type="text/javascript",r.src=n,o.appendChild(r),o.removeChild(i[s])}catch(t){if(LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error while reloading "+n)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var i,s=JSON.parse(JSON.stringify(t));if(!e)return s;for(i in s)e[i]=s[i];return e},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^16*Math.random()>>t/4).toString(16))},isValidConnection:function(t,e){if(""!=e&&"*"!==e||(e=0),!(t=""!=t&&"*"!==t?t:0)||!e||t==e||t==LiteGraph.EVENT&&e==LiteGraph.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var i=t.split(","),s=e.split(","),o=0;o<i.length;++o)for(var n=0;n<s.length;++n)if(this.isValidConnection(i[o],s[n]))return!0;return!1},registerSearchboxExtra:function(t,e,i){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:i}},fetchFile:function(e,i,s,o){if(e){if(i=i||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(t){if(t.ok)return"arraybuffer"==i?t.arrayBuffer():"text"==i||"string"==i?t.text():"json"==i?t.json():"blob"==i?t.blob():void 0;throw new Error("File not found")}).then(function(t){s&&s(t)}).catch(function(t){console.error("error fetching file:",e),o&&o(t)});if(e.constructor===File||e.constructor===Blob){var t=new FileReader;if(t.onload=function(t){t=t.target.result;"json"==i&&(t=JSON.parse(t)),s&&s(t)},"arraybuffer"==i)return t.readAsArrayBuffer(e);if("text"==i||"json"==i)return t.readAsText(e);if("blob"==i)return t.readAsBinaryString(e)}}return null}};function LGraph(t){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function LLink(t,e,i,s,o,n){this.id=t,this.type=e,this.origin_id=i,this.origin_slot=s,this.target_id=o,this.target_slot=n,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(t){this._ctor(t)}function LGraphGroup(t){this._ctor(t)}function DragAndScale(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function LGraphCanvas(t,e,i){this.options=i=i||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=i.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,i.skip_events),this.clear(),i.skip_render||this.startRendering(),this.autoresize=i.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(t){if(t.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),(t.graph=this).list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},LGraph.prototype.detachCanvas=function(t){var e;this.list_of_graphcanvas&&-1!=(e=this.list_of_graphcanvas.indexOf(t))&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))},LGraph.prototype.start=function(t){var e;this.status!=LGraph.STATUS_RUNNING&&(this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=this,0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,function t(){-1==e.execution_timer_id&&(window.requestAnimationFrame(t),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep)&&e.onAfterStep()}()):this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t))},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(t,e,i){t=t||1;var s=LiteGraph.getTime(),o=(this.globaltime=.001*(s-this.starttime),this._nodes_executable||this._nodes);if(o){if(i=i||o.length,e){for(var n=0;n<t;n++){for(var r=0;r<i;++r){var a=o[r];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(n=0;n<t;n++){for(r=0;r<i;++r){a=o[r];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error during execution: "+t),this.stop()}e=LiteGraph.getTime(),s=e-s;this.execution_time=.001*(s=0==s?1:s),this.globaltime+=.001*s,this.iteration+=1,this.elapsed_time=.001*(e-this.last_update_time),this.last_update_time=e,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},LGraph.prototype.computeExecutionOrder=function(t,e){for(var i=[],s=[],o={},n={},r={},a=0,u=this._nodes.length;a<u;++a){var h=this._nodes[a];if(!t||h.onExecute){var p=0;if((o[h.id]=h).inputs)for(var l=0,d=h.inputs.length;l<d;l++)h.inputs[l]&&null!=h.inputs[l].link&&(p+=1);0==p?(s.push(h),e&&(h._level=1)):(e&&(h._level=0),r[h.id]=p)}}for(;;){if(0==s.length)break;h=s.shift();if(i.push(h),delete o[h.id],h.outputs)for(var a=0;a<h.outputs.length;a++){var c=h.outputs[a];if(null!=c&&null!=c.links&&0!=c.links.length)for(l=0;l<c.links.length;l++){var _,g=c.links[l],g=this.links[g];!g||n[g.id]||(null==(_=this.getNodeById(g.target_id))?n[g.id]=!0:(e&&(!_._level||_._level<=h._level)&&(_._level=h._level+1),n[g.id]=!0,--r[_.id],0==r[_.id]&&s.push(_)))}}}for(a in o)i.push(o[a]);i.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(u=i.length,a=0;a<u;++a)i[a].order=a;for(i=i.sort(function(t,e){var i=t.constructor.priority||t.priority||0,s=e.constructor.priority||e.priority||0;return i==s?t.order-e.order:i-s}),a=0;a<u;++a)i[a].order=a;return i},LGraph.prototype.getAncestors=function(t){for(var e=[],i=[t],s={};i.length;){var o=i.shift();if(o.inputs){s[o.id]||o==t||(s[o.id]=!0,e.push(o));for(var n=0;n<o.inputs.length;++n){var r=o.getInputNode(n);r&&-1==e.indexOf(r)&&i.push(r)}}}return e.sort(function(t,e){return t.order-e.order}),e},LGraph.prototype.arrange=function(s,o){s=s||100;var e=this.computeExecutionOrder(!1,!0),i=[];for(let t=0;t<e.length;++t){var n=e[t],r=n._level||1;i[r]||(i[r]=[]),i[r].push(n)}let a=s;for(let t=0;t<i.length;++t){var u=i[t];if(u){let e=100,i=s+LiteGraph.NODE_TITLE_HEIGHT;for(let t=0;t<u.length;++t){var h=u[t],p=(h.pos[0]=o==LiteGraph.VERTICAL_LAYOUT?i:a,h.pos[1]=o==LiteGraph.VERTICAL_LAYOUT?a:i,o==LiteGraph.VERTICAL_LAYOUT?1:0),p=(h.size[p]>e&&(e=h.size[p]),o==LiteGraph.VERTICAL_LAYOUT?0:1);i+=h.size[p]+s+LiteGraph.NODE_TITLE_HEIGHT}a+=e+s}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(t,e,i){i=i||LiteGraph.ALWAYS;var s=this._nodes_in_order||this._nodes;if(s)for(var o=0,n=s.length;o<n;++o){var r=s[o];r.constructor===LiteGraph.Subgraph&&"onExecute"!=t?r.mode==i&&r.sendEventToAllNodes(t,e,i):r[t]&&r.mode==i&&(void 0===e?r[t]():e&&e.constructor===Array?r[t].apply(r,e):r[t](e))}},LGraph.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var s=this.list_of_graphcanvas[i];s[t]&&s[t].apply(s,e)}},LGraph.prototype.add=function(t,e){if(t){if(t.constructor!==LGraphGroup){if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?null!=t.id&&-1!=t.id||(t.id=LiteGraph.uuidv4()):null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),(t.graph=this)._version++,this._nodes.push(t),(this._nodes_by_id[t.id]=t).onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}this._groups.push(t),this.setDirtyCanvas(!0),this.change(),(t.graph=this)._version++}},LGraph.prototype.remove=function(t){if(t.constructor===LiteGraph.LGraphGroup)-1!=(o=this._groups.indexOf(t))&&this._groups.splice(o,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var e=0;e<t.inputs.length;e++)null!=(i=t.inputs[e]).link&&t.disconnectInput(e);if(t.outputs)for(var i,e=0;e<t.outputs.length;e++)null!=(i=t.outputs[e]).links&&i.links.length&&t.disconnectOutput(e);if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(e=0;e<this.list_of_graphcanvas.length;++e){var s=this.list_of_graphcanvas[e];s.selected_nodes[t.id]&&delete s.selected_nodes[t.id],s.node_dragged==t&&(s.node_dragged=null)}var o=this._nodes.indexOf(t);-1!=o&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},LGraph.prototype.findNodesByClass=function(t,e){for(var i=(e=e||[]).length=0,s=this._nodes.length;i<s;++i)this._nodes[i].constructor===t&&e.push(this._nodes[i]);return e},LGraph.prototype.findNodesByType=function(t,e){for(var t=t.toLowerCase(),i=(e=e||[]).length=0,s=this._nodes.length;i<s;++i)this._nodes[i].type.toLowerCase()==t&&e.push(this._nodes[i]);return e},LGraph.prototype.findNodeByTitle=function(t){for(var e=0,i=this._nodes.length;e<i;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},LGraph.prototype.findNodesByTitle=function(t){for(var e=[],i=0,s=this._nodes.length;i<s;++i)this._nodes[i].title==t&&e.push(this._nodes[i]);return e},LGraph.prototype.getNodeOnPos=function(t,e,i,s){for(var o=(i=i||this._nodes).length-1;0<=o;o--){var n=i[o];if(n.isPointInside(t,e,s))return n}return null},LGraph.prototype.getGroupOnPos=function(t,e){for(var i=this._groups.length-1;0<=i;i--){var s=this._groups[i];if(s.isPointInside(t,e,2,!0))return s}return null},LGraph.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var e=this._nodes[t],i=LiteGraph.registered_node_types[e.type];e.constructor!=i&&(console.log("node being replaced by newer version: "+e.type),i=LiteGraph.createNode(e.type),(this._nodes[t]=i).configure(e.serialize()),(i.graph=this)._nodes_by_id[i.id]=i,e.inputs&&(i.inputs=e.inputs.concat()),e.outputs)&&(i.outputs=e.outputs.concat())}this.updateExecutionOrder()},LGraph.prototype.onAction=function(t,e,i){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var s=0;s<this._input_nodes.length;++s){var o=this._input_nodes[s];if(o.properties.name==t){o.actionDo(t,e,i);break}}},LGraph.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},LGraph.prototype.addInput=function(t,e,i){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:i},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(t,e){t=this.inputs[t];t&&(t.value=e)},LGraph.prototype.getInputData=function(t){t=this.inputs[t];return t?t.value:null},LGraph.prototype.renameInput=function(t,e){if(e!=t)return!!this.inputs[t]&&(this.inputs[e]?(console.error("there is already one input with that name"),!1):(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},LGraph.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(t,e,i){this.outputs[t]={name:t,type:e,value:i},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(t,e){t=this.outputs[t];t&&(t.value=e)},LGraph.prototype.getOutputData=function(t){t=this.outputs[t];return t?t.value:null},LGraph.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},LGraph.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(t,e){for(var i=this.findNodesByTitle(t),s=0;s<i.length;++s)i[s].onTrigger(e)},LGraph.prototype.setCallback=function(t,e){for(var i=this.findNodesByTitle(t),s=0;s<i.length;++s)i[s].setTrigger(e)},LGraph.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(this.list_of_graphcanvas)for(var t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var t in this.links){t=this.links[t];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},LGraph.prototype.removeLink=function(t){var e,t=this.links[t];t&&(e=this.getNodeById(t.target_id))&&e.disconnectInput(t.target_slot)},LGraph.prototype.serialize=function(){for(var t=[],e=0,i=this._nodes.length;e<i;++e)t.push(this._nodes[e].serialize());var s=[];for(e in this.links){var o=this.links[e];if(!o.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var n,r=new LLink;for(n in o)r[n]=o[n];o=this.links[e]=r}s.push(o.serialize())}for(var a=[],e=0;e<this._groups.length;++e)a.push(this._groups[e].serialize());var u={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:s,groups:a,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(u),u},LGraph.prototype.configure=function(t,e){if(t){e||this.clear();var i=t.nodes;if(t.links&&t.links.constructor===Array){for(var s=[],o=0;o<t.links.length;++o){var n,r=t.links[o];r?((n=new LLink).configure(r),s[n.id]=n):console.warn("serialized graph link data contains errors, skipping.")}t.links=s}for(o in t)"nodes"!=o&&"groups"!=o&&(this[o]=t[o]);var a=!1;if(this._nodes=[],i){for(var o=0,u=i.length;o<u;++o){var h=i[o];(p=LiteGraph.createNode(h.type,h.title))||(LiteGraph.debug&&console.log("Node not found or has errors: "+h.type),(p=new LGraphNode).last_serialization=h,a=p.has_errors=!0),p.id=h.id,this.add(p,!0)}for(o=0,u=i.length;o<u;++o){var p,h=i[o];(p=this.getNodeById(h.id))&&p.configure(h)}}if(this._groups.length=0,t.groups)for(o=0;o<t.groups.length;++o){var l=new LiteGraph.LGraphGroup;l.configure(t.groups[o]),this.add(l)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),a}},LGraph.prototype.load=function(t,i){var e,s,o=this;t.constructor===File||t.constructor===Blob?((e=new FileReader).addEventListener("load",function(t){t=JSON.parse(t.target.result);o.configure(t),i&&i()}),e.readAsText(t)):((s=new XMLHttpRequest).open("GET",t,!0),s.send(null),s.onload=function(t){var e;200!==s.status?console.error("Error loading graph:",s.status,s.response):(e=JSON.parse(s.response),o.configure(e),i&&i())},s.onerror=function(t){console.error("Error loading graph:",t)})},LGraph.prototype.onNodeTrace=function(t,e,i){},LLink.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink,global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(t){for(var e in this.graph&&this.graph._version++,t)if("properties"==e)for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);else null!=t[e]&&("object"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=LiteGraph.cloneObject(t[e],this[e]):this[e]=t[e]);if(t.title||(this.title=this.constructor.title),this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],n=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,s,!0,n,o),this.onInputAdded&&this.onInputAdded(o)}if(this.outputs)for(s=0;s<this.outputs.length;++s){var r=this.outputs[s];if(r.links){for(e=0;e<r.links.length;++e){n=this.graph?this.graph.links[r.links[e]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,s,!0,n,r)}this.onOutputAdded&&this.onOutputAdded(r)}}if(this.widgets){for(s=0;s<this.widgets.length;++s){var a=this.widgets[s];a&&a.options&&a.options.property&&null!=this.properties[a.options.property]&&(a.value=JSON.parse(JSON.stringify(this.properties[a.options.property])))}if(t.widgets_values)for(s=0;s<t.widgets_values.length;++s)this.widgets[s]&&(this.widgets[s].value=t.widgets_values[s])}this.onConfigure&&this.onConfigure(t)},LGraphNode.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},LGraphNode.prototype.clone=function(){var t=LiteGraph.createNode(this.type);if(!t)return null;var e=LiteGraph.cloneObject(this.serialize());if(e.inputs)for(var i=0;i<e.inputs.length;++i)e.inputs[i].link=null;if(e.outputs)for(i=0;i<e.outputs.length;++i)e.outputs[i].links&&(e.outputs[i].links.length=0);return delete e.id,LiteGraph.use_uuids&&(e.id=LiteGraph.uuidv4()),t.configure(e),t},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var i=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,i)&&(this.properties[t]=i),this.widgets)for(var s=0;s<this.widgets.length;++s){var o=this.widgets[s];if(o&&o.options.property==t){o.value=e;break}}}},LGraphNode.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i._data=e,this.outputs[t].links))for(var s=0;s<this.outputs[t].links.length;s++){var o=this.outputs[t].links[s],o=this.graph.links[o];o&&(o.data=e)}}},LGraphNode.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.type=e,this.outputs[t].links))for(var s=0;s<this.outputs[t].links.length;s++){var o=this.outputs[t].links[s];this.graph.links[o].type=e}}},LGraphNode.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link))return t=this.inputs[t].link,(t=this.graph.links[t])?(e&&(e=this.graph.getNodeById(t.origin_id))&&(e.updateOutputData?e.updateOutputData(t.origin_slot):e.onExecute&&e.onExecute()),t.data):null},LGraphNode.prototype.getInputDataType=function(t){var e;return this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)&&(t=this.inputs[t].link,t=this.graph.links[t])?(e=this.graph.getNodeById(t.origin_id))?(e=e.outputs[t.origin_slot])?e.type:null:t.type:null},LGraphNode.prototype.getInputDataByName=function(t,e){t=this.findInputSlot(t);return-1==t?null:this.getInputData(t,e)},LGraphNode.prototype.isInputConnected=function(t){return!!this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link},LGraphNode.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},LGraphNode.prototype.getInputLink=function(t){return this.inputs&&t<this.inputs.length?(t=this.inputs[t],this.graph.links[t.link]):null},LGraphNode.prototype.getInputNode=function(t){return this.inputs&&!(t>=this.inputs.length)&&(t=this.inputs[t])&&null!==t.link&&(t=this.graph.links[t.link])?this.graph.getNodeById(t.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,i=this.inputs.length;e<i;++e){var s=this.inputs[e];if(t==s.name&&null!=s.link){s=this.graph.links[s.link];if(s)return s.data}}return this.properties[t]},LGraphNode.prototype.getOutputData=function(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data},LGraphNode.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},LGraphNode.prototype.isOutputConnected=function(t){return!!this.outputs&&t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length},LGraphNode.prototype.isAnyOutputConnected=function(){if(this.outputs)for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var i=[],s=0;s<e.links.length;s++){var o=e.links[s],o=this.graph.links[o];o&&(o=this.graph.getNodeById(o.target_id))&&i.push(o)}return i},LGraphNode.prototype.addOnTriggerInput=function(){var t=this.findInputSlot("onTrigger");return-1==t?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):t},LGraphNode.prototype.addOnExecutedOutput=function(){var t=this.findOutputSlot("onExecuted");return-1==t?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):t},LGraphNode.prototype.onAfterExecuteNode=function(t,e){var i=this.findOutputSlot("onExecuted");-1!=i&&this.triggerSlot(i,t,null,e)},LGraphNode.prototype.changeMode=function(t){switch(t){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0},LGraphNode.prototype.executePendingActions=function(){if(this._waiting_actions&&this._waiting_actions.length){for(var t=0;t<this._waiting_actions.length;++t){var e=this._waiting_actions[t];this.onAction(e[0],e[1],e[2],e[3],e[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(t,e){e=e||{},this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e)&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)},LGraphNode.prototype.actionDo=function(t,e,i,s){i=i||{},this.onAction&&(i.action_call||(i.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,i,s),this.graph.nodes_actioning[this.id]=!1,i)&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,i)},LGraphNode.prototype.trigger=function(t,e,i){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var s=0;s<this.outputs.length;++s){var o=this.outputs[s];!o||o.type!==LiteGraph.EVENT||t&&o.name!=t||this.triggerSlot(s,e,null,i)}}},LGraphNode.prototype.triggerSlot=function(t,e,i,s){if(s=s||{},this.outputs)if(null==t)console.error("slot must be a number");else{t.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");t=this.outputs[t];if(t){var o=t.links;if(o&&o.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var n=0;n<o.length;++n){var r,a,u=o[n];null!=i&&i!=u||(u=this.graph.links[o[n]])&&(u._last_time=LiteGraph.getTime(),r=this.graph.getNodeById(u.target_id))&&(a=r.inputs[u.target_slot],r.mode===LiteGraph.ON_TRIGGER?(s.action_call||(s.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),r.onExecute&&r.doExecute(e,s)):r.onAction&&(s.action_call||(s.action_call=this.id+"_act_"+Math.floor(9999*Math.random())),a=r.inputs[u.target_slot],LiteGraph.use_deferred_actions&&r.onExecute?(r._waiting_actions||(r._waiting_actions=[]),r._waiting_actions.push([a.name,e,s,u.target_slot])):r.actionDo(a.name,e,s,u.target_slot)))}}}}},LGraphNode.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){t=this.outputs[t];if(t){var i=t.links;if(i&&i.length)for(var s=0;s<i.length;++s){var o=i[s];null!=e&&e!=o||(o=this.graph.links[i[s]])&&(o._last_time=0)}}}},LGraphNode.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(t,e,i,s){var o={name:t,type:i,default_value:e};if(s)for(var n in s)o[n]=s[n];return this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=e,o},LGraphNode.prototype.addOutput=function(t,e,i){var s={name:t,type:e,links:null};if(i)for(var o in i)s[o]=i[o];return this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),s},LGraphNode.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],s={name:i[0],type:i[1],link:null};if(t[2])for(var o in i[2])s[o]=i[2][o];this.outputs||(this.outputs=[]),this.outputs.push(s),this.onOutputAdded&&this.onOutputAdded(s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var i=this.outputs[e].links,s=0;s<i.length;++s){var o=this.graph.links[i[s]];o&&--o.origin_slot}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(t,e,i){var s={name:t,type:e=e||0,link:null};if(i)for(var o in i)s[o]=i[o];return this.inputs||(this.inputs=[]),this.inputs.push(s),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(s),LiteGraph.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),s},LGraphNode.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],s={name:i[0],type:i[1],link:null};if(t[2])for(var o in i[2])s[o]=i[2][o];this.inputs||(this.inputs=[]),this.inputs.push(s),this.onInputAdded&&this.onInputAdded(s),LiteGraph.registerNodeAndSlotType(this,i[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(t){this.disconnectInput(t);for(var e,i=this.inputs.splice(t,1),s=t;s<this.inputs.length;++s)this.inputs[s]&&(e=this.graph.links[this.inputs[s].link])&&--e.target_slot;this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,i[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(t,e,i,s){t={name:t,type:e,pos:i,direction:s,links:null};return this.connections.push(t),t},LGraphNode.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),i=t||new Float32Array([0,0]),e=Math.max(e,1),s=LiteGraph.NODE_TEXT_SIZE,t=d(this.title),o=0,n=0;if(this.inputs)for(var r=0,a=this.inputs.length;r<a;++r){var u=this.inputs[r];o<(h=d(u.label||u.name||""))&&(o=h)}if(this.outputs)for(r=0,a=this.outputs.length;r<a;++r){var h,p=this.outputs[r];n<(h=d(p.label||p.name||""))&&(n=h)}i[0]=Math.max(o+n+10,t),i[0]=Math.max(i[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(i[0]=Math.max(i[0],1.5*LiteGraph.NODE_WIDTH)),i[1]=(this.constructor.slot_start_y||0)+e*LiteGraph.NODE_SLOT_HEIGHT;var l=0;if(this.widgets&&this.widgets.length){for(r=0,a=this.widgets.length;r<a;++r)this.widgets[r].computeSize?l+=this.widgets[r].computeSize(i[0])[1]+4:l+=LiteGraph.NODE_WIDGET_HEIGHT+4;l+=8}function d(t){return t?s*t.length*.6:0}return this.widgets_up?i[1]=Math.max(i[1],l):null!=this.widgets_start_y?i[1]=Math.max(i[1],l+this.widgets_start_y):i[1]+=l,this.constructor.min_height&&i[1]<this.constructor.min_height&&(i[1]=this.constructor.min_height),i[1]+=6,i},LGraphNode.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),(e=(e=!(e=this.constructor.widgets_info&&this.constructor.widgets_info[t]?this.constructor.widgets_info[t]:e)&&this.onGetPropertyInfo?this.onGetPropertyInfo(t):e)||{}).type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},LGraphNode.prototype.addWidget=function(t,e,i,s,o){this.widgets||(this.widgets=[]),!o&&s&&s.constructor===Object&&(o=s,s=null),o&&o.constructor===String&&(o={property:o}),s&&s.constructor===String&&((o=o||{}).property=s,s=null),s&&s.constructor!==Function&&(console.warn("addWidget: callback must be a function"),s=null);e={type:t.toLowerCase(),name:e,value:i,callback:s,options:o||{}};if(void 0!==e.options.y&&(e.y=e.options.y),s||e.options.callback||e.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"!=t||e.options.values)return this.widgets.push(e),this.setSize(this.computeSize()),e;throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }"},LGraphNode.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},LGraphNode.prototype.getBounding=function(t,e){t=t||new Float32Array(4);var i=this.pos,s=this.flags.collapsed,o=this.size;let n=0,r=1,a=0,u=0;return e&&(n=4,r=6+n,a=4,u=5+a),t[0]=i[0]-n,t[1]=i[1]-LiteGraph.NODE_TITLE_HEIGHT-a,t[2]=s?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+r:o[0]+r,t[3]=s?LiteGraph.NODE_TITLE_HEIGHT+u:o[1]+LiteGraph.NODE_TITLE_HEIGHT+u,this.onBounding&&this.onBounding(t),t},LGraphNode.prototype.isPointInside=function(t,e,i,s){i=i||0;var o=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(s&&(o=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(t,e,this.pos[0]-i,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-i,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*i,LiteGraph.NODE_TITLE_HEIGHT+2*i))return!0}else if(this.pos[0]-4-i<t&&this.pos[0]+this.size[0]+4+i>t&&this.pos[1]-o-i<e&&this.pos[1]+this.size[1]+i>e)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(t,e){var i=new Float32Array(2);if(this.inputs)for(var s=0,o=this.inputs.length;s<o;++s){var n=this.inputs[s];if(this.getConnectionPos(!0,s,i),isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{input:n,slot:s,link_pos:i}}if(this.outputs)for(s=0,o=this.outputs.length;s<o;++s){var r=this.outputs[s];if(this.getConnectionPos(!1,s,i),isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{output:r,slot:s,link_pos:i}}return null},LGraphNode.prototype.findInputSlot=function(t,e){if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i)if(t==this.inputs[i].name)return e?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlot=function(t,e){if(e=e||!1,this.outputs)for(var i=0,s=this.outputs.length;i<s;++i)if(t==this.outputs[i].name)return e?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.inputs[i].type)))return e.returnObj?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.outputs)for(var i=0,s=this.outputs.length;i<s;++i)if(!(this.outputs[i].links&&null!=this.outputs[i].links||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.outputs[i].type)))return e.returnObj?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotByType=function(t,e,i,s){return this.findSlotByType(!0,t,e,i,s)},LGraphNode.prototype.findOutputSlotByType=function(t,e,i,s){return this.findSlotByType(!1,t,e,i,s)},LGraphNode.prototype.findSlotByType=function(t,e,i,s,o){i=i||!1,s=s||!1,o=o||!1;var n=(t=t||!1)?this.inputs:this.outputs;if(n){""!=e&&"*"!=e||(e=0);for(var r=0,a=n.length;r<a;++r){var u=(e+"").toLowerCase().split(",");l=((l="0"==n[r].type||"*"==n[r].type?"0":n[r].type)+"").toLowerCase().split(",");for(var h=0;h<u.length;h++)for(var p=0;p<l.length;p++)if("_event_"==u[h]&&(u[h]=LiteGraph.EVENT),"_event_"==l[h]&&(l[h]=LiteGraph.EVENT),"*"==u[h]&&(u[h]=0),"*"==l[h]&&(l[h]=0),!(u[h]!=l[p]||s&&n[r].links&&null!==n[r].links))return i?n[r]:r}if(s&&!o)for(r=0,a=n.length;r<a;++r){var l,u=(e+"").toLowerCase().split(",");l=((l="0"==n[r].type||"*"==n[r].type?"0":n[r].type)+"").toLowerCase().split(",");for(h=0;h<u.length;h++)for(p=0;p<l.length;p++)if("*"==u[h]&&(u[h]=0),"*"==l[h]&&(l[h]=0),u[h]==l[p])return i?n[r]:r}}return-1},LGraphNode.prototype.connectByType=function(t,e,i,s){var s=s||{},s=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},s),o=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findInputSlotByType(i,!1,!0);return 0<=o&&null!==o?this.connect(t,e,o):s.createEventInCase&&i==LiteGraph.EVENT?this.connect(t,e,-1):s.generalTypeInCase&&0<=(o=e.findInputSlotByType(0,!1,!0,!0))||s.firstFreeIfOutputGeneralInCase&&(0==i||"*"==i||""==i)&&0<=(o=e.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?this.connect(t,e,o):(console.debug("no way to connect type: ",i," to targetNODE ",e),null)},LGraphNode.prototype.connectByTypeOutput=function(t,e,i,s){var s=s||{},s=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},s),o=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findOutputSlotByType(i,!1,!0);return 0<=o&&null!==o||s.generalTypeInCase&&0<=(o=e.findOutputSlotByType(0,!1,!0,!0))?e.connect(o,this,t):s.createEventInCase&&i==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(o=e.addOnExecutedOutput(),e.connect(o,this,t)):s.firstFreeIfInputGeneralInCase&&(0==i||"*"==i||""==i)&&0<=(o=e.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?e.connect(o,this,t):(console.debug("no way to connect byOUT type: ",i," to sourceNODE ",e),null)},LGraphNode.prototype.connect=function(t,e,i){if(i=i||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(!(e=e&&e.constructor===Number?this.graph.getNodeById(e):e))throw"target node is null";if(e==this)return null;if(i.constructor===String){if(-1==(i=e.findInputSlot(i)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+i),null}else if(i===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;e.changeMode(LiteGraph.ON_TRIGGER),i=e.findInputSlot("onTrigger")}else if(!e.inputs||i>=e.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var s,o=!1,n=e.inputs[i],r=this.outputs[t];return this.outputs[t]?!1!==(i=e.onBeforeConnectInput?e.onBeforeConnectInput(i):i)&&null!==i&&LiteGraph.isValidConnection(r.type,n.type)?e.onConnectInput&&!1===e.onConnectInput(i,r.type,r,this,t)||this.onConnectOutput&&!1===this.onConnectOutput(t,n.type,n,e,i)?null:(e.inputs[i]&&null!=e.inputs[i].link&&(this.graph.beforeChange(),e.disconnectInput(i,{doProcessChange:!1}),o=!0),null!==r.links&&r.links.length&&r.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),o=!0),s=new LLink(LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,n.type||r.type,this.id,t,e.id,i),this.graph.links[s.id]=s,null==r.links&&(r.links=[]),r.links.push(s.id),e.inputs[i].link=s.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!0,s,r),e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,i,!0,s,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,i,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,e,i)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,s),s):(this.setDirtyCanvas(!1,!0),o&&this.graph.connectionChange(this,null),null):null},LGraphNode.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.outputs[t];if(!i||!i.links||0==i.links.length)return!1;if(e){if(!(e=e.constructor===Number?this.graph.getNodeById(e):e))throw"Target Node not found";for(var s=0,o=i.links.length;s<o;s++){var n=i.links[s];if((r=this.graph.links[n]).target_id==e.id){i.links.splice(s,1),(a=e.inputs[r.target_slot]).link=null,delete this.graph.links[n],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,r.target_slot,!1,r,a),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,r,i),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot));break}}}else{for(s=0,o=i.links.length;s<o;s++){var r,a,n=i.links[s];(r=this.graph.links[n])&&(e=this.graph.getNodeById(r.target_id),a=null,this.graph&&this.graph._version++,e&&((a=e.inputs[r.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,r.target_slot,!1,r,a),this.graph)&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot),delete this.graph.links[n],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,r,i),this.graph)&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot))}i.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var i=this.inputs[t].link;if(null!=i){this.inputs[t].link=null;var s=this.graph.links[i];if(s){var o=this.graph.getNodeById(s.origin_id);if(!o)return!1;var n=o.outputs[s.origin_slot];if(!n||!n.links||0==n.links.length)return!1;for(var r=0,a=n.links.length;r<a;r++)if(n.links[r]==i){n.links.splice(r,1);break}delete this.graph.links[i],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,s,e),o.onConnectionsChange&&o.onConnectionsChange(LiteGraph.OUTPUT,r,!1,s,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,o,r),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(t,e,i){i=i||new Float32Array(2);var s,o=0,n=(t&&this.inputs&&(o=this.inputs.length),!t&&this.outputs&&(o=this.outputs.length),.5*LiteGraph.NODE_SLOT_HEIGHT),r=!1,r=t?void 0!==this.inputs_horizontal?this.inputs_horizontal:this.horizontal:void 0!==this.outputs_horizontal?this.outputs_horizontal:this.horizontal;return this.flags.collapsed?(s=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,r?(i[0]=this.pos[0]+.5*s,i[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(i[0]=t?this.pos[0]:this.pos[0]+s,i[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT)):t&&-1==e?(i[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,i[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT):t&&e<o&&this.inputs[e].pos?(i[0]=this.pos[0]+this.inputs[e].pos[0],i[1]=this.pos[1]+this.inputs[e].pos[1]):!t&&e<o&&this.outputs[e].pos?(i[0]=this.pos[0]+this.outputs[e].pos[0],i[1]=this.pos[1]+this.outputs[e].pos[1]):r?(i[0]=this.pos[0]+(e+.5)*(this.size[0]/o),i[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(i[0]=t?this.pos[0]+n:this.pos[0]+this.size[0]+1-n,i[1]=this.pos[1]+(e+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),i},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},LGraphNode.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},LGraphNode.prototype.loadImage=function(t){var e=new Image,i=(e.src=LiteGraph.node_images_path+t,e.ready=!1,this);return e.onload=function(){this.ready=!0,i.setDirtyCanvas(!0)},e},LGraphNode.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,i=0;i<e.length;++i){var s=e[i];!t&&s.node_capturing_input!=this||(s.node_capturing_input=t?this:null)}},LGraphNode.prototype.collapse=function(t){this.graph._version++,!1===this.constructor.collapsable&&!t||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},LGraphNode.prototype.localToScreen=function(t,e,i){return[(t+this.pos[0])*i.scale+i.offset[0],(e+this.pos[1])*i.scale+i.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font_size=t.font_size},LGraphGroup.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(t,e,i){if(this._pos[0]+=t,this._pos[1]+=e,!i)for(var s=0;s<this._nodes.length;++s){var o=this._nodes[s];o.pos[0]+=t,o.pos[1]+=e}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),i=0;i<t.length;++i){var s=t[i];s.getBounding(e),overlapBounding(this._bounding,e)&&this._nodes.push(s)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(t){var e,i,s,o;this.element?(o=this.element.width,e=this.element.height,i=-this.offset[0],s=-this.offset[1],t&&(i+=t[0]/this.scale,s+=t[1]/this.scale,o=t[2],e=t[3]),t=i+o/this.scale,o=s+e/this.scale,this.visible_area[0]=i,this.visible_area[1]=s,this.visible_area[2]=t-i,this.visible_area[3]=o-s):this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},DragAndScale.prototype.onMouse=function(t){var e,i,s,o,n,r;if(this.enabled)return s=(e=this.element).getBoundingClientRect(),i=t.clientX-s.left,s=t.clientY-s.top,t.canvasx=i,t.canvasy=s,t.dragging=this.dragging,o=!this.viewport||(this.viewport,i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]),n=!1,this.onmouse&&(n=this.onmouse(t)),t.type==LiteGraph.pointerevents_method+"down"&&o?(this.dragging=!0,LiteGraph.pointerListenerRemove(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback)):t.type==LiteGraph.pointerevents_method+"move"?n||(n=i-this.last_mouse[0],r=s-this.last_mouse[1],this.dragging&&this.mouseDrag(n,r)):t.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback)):!o||"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel",t.wheel="wheel"==t.type?-t.deltaY:null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta)),this.last_mouse[0]=i,this.last_mouse[1]=s,o?(t.preventDefault(),t.stopPropagation(),!1):void 0},DragAndScale.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},DragAndScale.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(t,e){var i;t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element&&(i=this.element.getBoundingClientRect())&&(e=e||[.5*i.width,.5*i.height],i=this.convertCanvasToOffset(e),this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1),e=[(t=this.convertCanvasToOffset(e))[0]-i[0],t[1]-i[1]],this.offset[0]+=e[0],this.offset[1]+=e[1],this.onredraw)&&this.onredraw(this)},DragAndScale.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),!t&&this.graph?this.graph.detachCanvas(this):(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)))},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){var t,e;this._graph_stack&&0!=this._graph_stack.length&&(t=this.graph._subgraph_node,e=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1)},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(t||!this.canvas||e||this.unbindEvents(),this.canvas=t,this.ds.element=t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),e||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){var t,e;this._events_binded?console.warn("LGraphCanvas: events already binded"):(t=this.canvas,e=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(t,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.setAttribute("tabindex",1),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0)},LGraphCanvas.prototype.unbindEvents=function(){var t;this._events_binded?(t=this.getCanvasWindow().document,LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1):console.warn("LGraphCanvas: no events binded")},LGraphCanvas.getFileExtension=function(t){var e=t.indexOf("?"),e=(t=-1!=e?t.substr(0,e):t).lastIndexOf(".");return-1==e?"":t.substr(e+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){var t;return this.canvas?(t=this.canvas.ownerDocument).defaultView||t.parentWindow:window},LGraphCanvas.prototype.startRendering=function(){function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}this.is_rendering||(this.is_rendering=!0,e.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow(),i=(e.document,LGraphCanvas.active_canvas=this),s=t.clientX,o=t.clientY,s=(this.ds.viewport=this.viewport,!this.viewport||(this.viewport,s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&o>=this.viewport[1]&&o<this.viewport[1]+this.viewport[3]));if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(e.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(e.document,"up",this._mouseup_callback,!0)),s){var n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),r=!1,o=LiteGraph.getTime(),s=void 0===t.isPrimary||!t.isPrimary,a=o-this.last_mouseclick<300&&s;if(this.mouse[0]=t.clientX,this.mouse[1]=t.clientY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&s?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(e),!this.onMouse||1!=this.onMouse(t)){if(1!=t.which||this.pointer_is_double)if(2==t.which)if(LiteGraph.middle_click_slot_add_default_node){if(n&&this.allow_interaction&&!r&&!this.read_only&&!this.connecting_node&&!n.flags.collapsed&&!this.live_mode){var u=!1,h=!1,p=!1;if(n.outputs)for(c=0,f=n.outputs.length;c<f;++c){v=n.outputs[c],m=n.getConnectionPos(!1,c);if(isInsideRectangle(t.canvasX,t.canvasY,m[0]-15,m[1]-10,30,20)){u=v,h=c,p=!0;break}}if(n.inputs)for(c=0,f=n.inputs.length;c<f;++c){x=n.inputs[c],m=n.getConnectionPos(!0,c);if(isInsideRectangle(t.canvasX,t.canvasY,m[0]-15,m[1]-10,30,20)){u=x,h=c,p=!1;break}}u&&!1!==h&&(o=.5-(h+1)/(p?n.outputs:n.inputs).length,s=n.getBounding(),s=[p?s[0]+s[2]:s[0],t.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:p?n:null,slotFrom:p?h:null,nodeTo:p?null:n,slotTo:p?null:h,position:s,nodeType:"AUTO",posAdd:[p?30:-30,130*-o],posSizeFix:[p?0:-1,0]}))}}else!r&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else 3!=t.which&&!this.pointer_is_double||!this.allow_interaction||r||this.read_only||(n&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[n.id]||t.shiftKey||t.ctrlKey||t.metaKey)?this.selected_nodes[n.id]||this.selectNodes([n],!0):this.selectNodes([n])),this.processContextMenu(n,t));else{t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,r=!0),LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&n&&this.allow_interaction&&!r&&!this.read_only&&(cloned=n.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),n=cloned,r=!0,l||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=n),this.selected_nodes[n.id])||this.processNodeSelected(n,t));var l,d,s=!1;if(!n||!this.allow_interaction&&!n.flags.allow_interaction||r||this.read_only){if(!r){if(!this.read_only)for(var c=0;c<this.visible_links.length;++c){var _=this.visible_links[c],g=_._pos;if(!(!g||t.canvasX<g[0]-4||t.canvasX>g[0]+4||t.canvasY<g[1]-4||t.canvasY>g[1]+4)){this.showLinkMenu(_,t),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(t.ctrlKey&&(this.dragging_rectangle=null),distance([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),a&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault(),t.stopPropagation()),s=!0}}else{if(this.live_mode||n.flags.pinned||this.bringToFront(n),this.allow_interaction&&!this.connecting_node&&!n.flags.collapsed&&!this.live_mode)if(!r&&!1!==n.resizable&&isInsideRectangle(t.canvasX,t.canvasY,n.pos[0]+n.size[0]-5,n.pos[1]+n.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=n,this.canvas.style.cursor="se-resize",r=!0;else{if(n.outputs)for(var c=0,f=n.outputs.length;c<f;++c){var v=n.outputs[c],m=n.getConnectionPos(!1,c);if(isInsideRectangle(t.canvasX,t.canvasY,m[0]-15,m[1]-10,30,20)){this.connecting_node=n,this.connecting_output=v,this.connecting_output.slot_index=c,this.connecting_pos=n.getConnectionPos(!1,c),this.connecting_slot=c,LiteGraph.shift_click_do_break_link_from&&t.shiftKey&&n.disconnectOutput(c),a?n.onOutputDblClick&&n.onOutputDblClick(c,t):n.onOutputClick&&n.onOutputClick(c,t),r=!0;break}}if(n.inputs)for(var c=0,f=n.inputs.length;c<f;++c){var y,x=n.inputs[c],m=n.getConnectionPos(!0,c);isInsideRectangle(t.canvasX,t.canvasY,m[0]-15,m[1]-10,30,20)&&(a?n.onInputDblClick&&n.onInputDblClick(c,t):n.onInputClick&&n.onInputClick(c,t),null!==x.link&&(y=this.graph.links[x.link],LiteGraph.click_do_break_link_to&&(n.disconnectInput(c),r=this.dirty_bgcanvas=!0),this.allow_reconnect_links||t.shiftKey)&&(LiteGraph.click_do_break_link_to||n.disconnectInput(c),this.connecting_node=this.graph._nodes_by_id[y.origin_id],this.connecting_slot=y.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),r=this.dirty_bgcanvas=!0),r||(this.connecting_node=n,this.connecting_input=x,this.connecting_input.slot_index=c,this.connecting_pos=n.getConnectionPos(!0,c),this.connecting_slot=c,r=this.dirty_bgcanvas=!0))}}r||(l=!1,o=[t.canvasX-n.pos[0],t.canvasY-n.pos[1]],(d=this.processNodeWidgets(n,this.graph_mouse,t))&&(l=!0,this.node_widget=[n,d]),this.allow_interaction&&a&&this.selected_nodes[n.id]&&(n.onDblClick&&n.onDblClick(t,o,this),this.processNodeDblClicked(n),l=!0),n.onMouseDown&&n.onMouseDown(t,o,this)?l=!0:(n.subgraph&&!n.skip_subgraph_button&&!n.flags.collapsed&&o[0]>n.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&o[1]<0&&(i=this,setTimeout(function(){i.openSubgraph(n.subgraph)},10)),this.live_mode&&(l=s=!0)),l?n.is_selected||this.processNodeSelected(n,t):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=n),this.processNodeSelected(n,t)),this.dirty_canvas=!0)}!r&&s&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=t.clientX,this.last_mouse[1]=t.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),e.document.activeElement&&("input"==e.document.activeElement.nodeName.toLowerCase()||"textarea"==e.document.activeElement.nodeName.toLowerCase())||t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},LGraphCanvas.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(LGraphCanvas.active_canvas=this).adjustMouseEvent(t);var e=[t.clientX,t.clientY],i=(this.mouse[0]=e[0],this.mouse[1]=e[1],[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]]);if(this.last_mouse=e,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,!this.block_click){t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0);var s=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]]:(e=i[0]/this.ds.scale,a=i[1]/this.ds.scale,this.selected_group.move(e,a,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||s&&s.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o,n,r,a,u=0,h=this.graph._nodes.length;u<h;++u)this.graph._nodes[u].mouseOver&&s!=this.graph._nodes[u]&&(this.graph._nodes[u].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(s)s.redraw_on_mouse&&(this.dirty_canvas=!0),s.mouseOver||(s.mouseOver=!0,this.node_over=s,this.dirty_canvas=!0,s.onMouseEnter&&s.onMouseEnter(t)),s.onMouseMove&&s.onMouseMove(t,[t.canvasX-s.pos[0],t.canvasY-s.pos[1]],this),this.connecting_node&&(this.connecting_output?(o=this._highlight_input||[0,0],this.isOverNodeBox(s,t.canvasX,t.canvasY)||(-1!=(n=this.isOverNodeInput(s,t.canvasX,t.canvasY,o))&&s.inputs[n]?(r=s.inputs[n].type,LiteGraph.isValidConnection(this.connecting_output.type,r)&&(this._highlight_input=o,this._highlight_input_slot=s.inputs[n])):(this._highlight_input=null,this._highlight_input_slot=null))):this.connecting_input&&(o=this._highlight_output||[0,0],this.isOverNodeBox(s,t.canvasX,t.canvasY)||(-1!=(n=this.isOverNodeOutput(s,t.canvasX,t.canvasY,o))&&s.outputs[n]?(r=s.outputs[n].type,LiteGraph.isValidConnection(this.connecting_input.type,r)&&(this._highlight_output=o)):this._highlight_output=null))),this.canvas&&(isInsideRectangle(t.canvasX,t.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair");else{for(var p=null,u=0;u<this.visible_links.length;++u){var l=this.visible_links[u],d=l._pos;if(!(!d||t.canvasX<d[0]-4||t.canvasX>d[0]+4||t.canvasY<d[1]-4||t.canvasY>d[1]+4)){p=l;break}}p!=this.over_link_center&&(this.over_link_center=p,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=s&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var u in this.selected_nodes){var c=this.selected_nodes[u];c.pos[0]+=i[0]/this.ds.scale,c.pos[1]+=i[1]/this.ds.scale,c.is_selected||this.processNodeSelected(c,t)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(e=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],a=this.resizing_node.computeSize(),e[0]=Math.max(a[0],e[0]),e[1]=Math.max(a[1],e[1]),this.resizing_node.setSize(e),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}}return t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(t){var e=void 0===t.isPrimary||t.isPrimary;if(!e)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var i=this.getCanvasWindow().document,i=((LGraphCanvas.active_canvas=this).options.skip_events||(LiteGraph.pointerListenerRemove(i,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(i,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(t),LiteGraph.getTime());if(t.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==t.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group&&(i=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),r=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(i,r,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null),this.selected_group_resizing=!1;var s,i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var o=this.graph._nodes,n=new Float32Array(4),r=Math.abs(this.dragging_rectangle[2]),a=Math.abs(this.dragging_rectangle[3]),u=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-r:this.dragging_rectangle[0],h=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-a:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=u,this.dragging_rectangle[1]=h,this.dragging_rectangle[2]=r,this.dragging_rectangle[3]=a,!i||10<r&&10<a){for(var p=[],l=0;l<o.length;++l){var d=o[l];d.getBounding(n),overlapBounding(this.dragging_rectangle,n)&&p.push(d)}p.length&&this.selectNodes(p,t.shiftKey)}else this.selectNodes([i],t.shiftKey||t.ctrlKey)}this.dragging_rectangle=null}else this.connecting_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,u=(this.connecting_output||this.connecting_input).type,i?this.connecting_output?-1!=(s=this.isOverNodeInput(i,t.canvasX,t.canvasY))?this.connecting_node.connect(this.connecting_slot,i,s):this.connecting_node.connectByType(this.connecting_slot,i,u):this.connecting_input&&(-1!=(s=this.isOverNodeOutput(i,t.canvasX,t.canvasY))?i.connect(s,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,i,u)):LiteGraph.release_link_on_empty_shows_menu&&(t.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(t,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(t,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:t}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:t})),this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1):this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?((i=this.node_dragged)&&t.click_time<300&&isInsideRectangle(t.canvasX,t.canvasY,i.pos[0],i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&i.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(!(i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]]))}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return e&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,i=(this.adjustMouseEvent(t),t.clientX),s=t.clientY;if(!this.viewport||(this.viewport,i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]))return i=this.ds.scale,0<e?i*=1.1:e<0&&(i*=1/1.1),this.ds.changeScale(i,[t.clientX,t.clientY]),this.graph.change(),t.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeBox=function(t,e,i){var s=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(e,i,t.pos[0]+2,t.pos[1]+2-s,s-4,s-4)},LGraphCanvas.prototype.isOverNodeInput=function(t,e,i,s){if(t.inputs)for(var o=0,n=t.inputs.length;o<n;++o){t.inputs[o];var r=t.getConnectionPos(!0,o);if((void 0!==t.inputs_horizontal?t.inputs_horizontal:t.horizontal)?isInsideRectangle(e,i,r[0]-5,r[1]-10,10,20):isInsideRectangle(e,i,r[0]-10,r[1]-5,40,10))return s&&(s[0]=r[0],s[1]=r[1]),o}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(t,e,i,s){if(t.outputs)for(var o=0,n=t.outputs.length;o<n;++o){t.outputs[o];var r=t.getConnectionPos(!1,o);if((void 0!==t.outputs_horizontal?t.outputs_horizontal:t.horizontal)?isInsideRectangle(e,i,r[0]-5,r[1]-10,10,20):isInsideRectangle(e,i,r[0]-10,r[1]-5,40,10))return s&&(s[0]=r[0],s[1]=r[1]),o}return-1},LGraphCanvas.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(e=this.dragging_canvas=!0),27==t.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),67!==t.keyCode||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),86===t.keyCode&&(t.metaKey||t.ctrlKey)&&this.pasteFromClipboard(t.shiftKey),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,i=[];for(s in this.selected_nodes)!1!==(o=this.selected_nodes[s]).clonable&&(o._relative_id=e,i.push(o),e+=1);for(var s=0;s<i.length;++s){var o=i[s];if(!1!==o.clonable){var n=o.clone();if(n){if(t.nodes.push(n.serialize()),o.inputs&&o.inputs.length)for(var r=0;r<o.inputs.length;++r){var a,u=o.inputs[r];u&&null!=u.link&&(u=this.graph.links[u.link])&&(a=this.graph.getNodeById(u.origin_id))&&t.links.push([a._relative_id,u.origin_slot,o._relative_id,u.target_slot,a.id])}}else console.warn("node type not found: "+o.type)}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},LGraphCanvas.prototype.pasteFromClipboard=function(t=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!t){var e=localStorage.getItem("litegrapheditor_clipboard");if(e){this.graph.beforeChange();for(var i=JSON.parse(e),s=!1,o=!1,n=0;n<i.nodes.length;++n)s?(s[0]>i.nodes[n].pos[0]&&(s[0]=i.nodes[n].pos[0],o[0]=n),s[1]>i.nodes[n].pos[1]&&(s[1]=i.nodes[n].pos[1],o[1]=n)):(s=[i.nodes[n].pos[0],i.nodes[n].pos[1]],o=[n,n]);for(var r=[],n=0;n<i.nodes.length;++n){var a=i.nodes[n],u=LiteGraph.createNode(a.type);u&&(u.configure(a),u.pos[0]+=this.graph_mouse[0]-s[0],u.pos[1]+=this.graph_mouse[1]-s[1],this.graph.add(u,{doProcessChange:!1}),r.push(u))}for(n=0;n<i.links.length;++n){var h,p=i.links[n],l=p[0],l=(null!=l?h=r[l]:LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&t&&(l=p[4])&&(h=this.graph.getNodeById(l)),r[p[2]]);h&&l?h.connect(p[1],l,p[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(r),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=t.clientX,i=t.clientY;if(!this.viewport||(this.viewport,e>=this.viewport[0]&&e<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3])){var e=[t.canvasX,t.canvasY],s=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(s){if(s.onDropFile||s.onDropData){var o=t.dataTransfer.files;if(o&&o.length)for(var n=0;n<o.length;n++){var r,a,u=t.dataTransfer.files[0],h=u.name;LGraphCanvas.getFileExtension(h);s.onDropFile&&s.onDropFile(u),s.onDropData&&((r=new FileReader).onload=function(t){t=t.target.result;s.onDropData(t,h,u)},"text"==(a=u.type.split("/")[0])||""==a?r.readAsText(u):"image"==a?r.readAsDataURL(u):r.readAsArrayBuffer(u))}}return!(!s.onDropItem||!s.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}i=null,(i=this.onDropItem?this.onDropItem(event):i)||this.checkDropItem(t)}},LGraphCanvas.prototype.checkDropItem=function(t){var e,i;t.dataTransfer.files.length&&(e=t.dataTransfer.files[0],i=LGraphCanvas.getFileExtension(e.name).toLowerCase(),i=LiteGraph.node_types_by_file_extension[i])&&(this.graph.beforeChange(),(i=LiteGraph.createNode(i.type)).pos=[t.canvasX,t.canvasY],this.graph.add(i),i.onDropFile&&i.onDropFile(e),this.graph.afterChange())},LGraphCanvas.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)},LGraphCanvas.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},LGraphCanvas.prototype.selectNodes=function(t,e){for(var i in e||this.deselectAllNodes(),t="string"==typeof(t=t||this.graph._nodes)?[t]:t){var s=t[i];if(s.is_selected)this.deselectNode(s);else{if(!s.is_selected&&s.onSelected&&s.onSelected(),s.is_selected=!0,(this.selected_nodes[s.id]=s).inputs)for(var o=0;o<s.inputs.length;++o)this.highlighted_links[s.inputs[o].link]=!0;if(s.outputs)for(o=0;o<s.outputs.length;++o){var n=s.outputs[o];if(n.links)for(var r=0;r<n.links.length;++r)this.highlighted_links[n.links[r]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var i=t.outputs[e];if(i.links)for(var s=0;s<i.links.length;++s)delete this.highlighted_links[i.links[s]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,i=t.length;e<i;++e){var s=t[e];s.is_selected&&(s.onDeselected&&s.onDeselected(),s.is_selected=!1,this.onNodeDeselected)&&this.onNodeDeselected(s)}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e,i,s,o,t=this.selected_nodes[t];t.block_delete||(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length&&(e=t.graph.links[t.inputs[0].link],i=t.graph.links[t.outputs[0].links[0]],s=t.getInputNode(0),o=t.getOutputNodes(0)[0],s)&&o&&s.connect(e.origin_slot,o,i.target_slot),this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(t){var e,i=0,s=0;s=this.canvas?(e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,t.clientY-e.top):(i=t.clientX,t.clientY),this.last_mouse_position[0]=i,this.last_mouse_position[1]=s,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=s/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},LGraphCanvas.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},LGraphCanvas.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},LGraphCanvas.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var temp=new Float32Array(4),temp_vec2=(LGraphCanvas.prototype.computeVisibleNodes=function(t,e){for(var i=e||[],s=i.length=0,o=(t=t||this.graph._nodes).length;s<o;++s){var n=t[s];(!this.live_mode||n.onDrawBackground||n.onDrawForeground)&&overlapBounding(this.visible_area,n.getBounding(temp,!0))&&i.push(n)}return i},LGraphCanvas.prototype.draw=function(t,e){var i;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(i=LiteGraph.getTime(),this.render_time=.001*(i-this.last_draw_time),this.last_draw_time=i,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&i-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1)},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas,i=(t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(i&&(t.save(),t.beginPath(),t.rect(i[0],i[1],i[2],i[3]),t.clip()),this.clear_background&&(i?t.clearRect(i[0],i[1],i[2],i[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,i?i[0]:0,i?i[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var s,o,n,r,a=this.computeVisibleNodes(null,this.visible_nodes),u=0;u<a.length;++u){var h=a[u];t.save(),t.translate(h.pos[0],h.pos[1]),this.drawNode(h,t),t.restore()}this.render_execution_order&&this.drawExecutionOrder(t),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(t),null!=this.connecting_pos&&(t.lineWidth=this.connections_width,s=(e=this.connecting_output||this.connecting_input).type,(r=null)==(o=e.dir)&&(o=this.connecting_output?(void 0!==this.connecting_node.outputs_horizontal?this.connecting_node.outputs_horizontal:this.connecting_node.horizontal)?LiteGraph.DOWN:LiteGraph.RIGHT:(void 0!==this.connecting_node.inputs_horizontal?this.connecting_node.inputs_horizontal:this.connecting_node.horizontal)?LiteGraph.UP:LiteGraph.LEFT),e=e.shape,r=s===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,r,o,LiteGraph.CENTER),t.beginPath(),s===LiteGraph.EVENT||e===LiteGraph.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):e===LiteGraph.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),(n=this._highlight_input_slot.shape)===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()),this._highlight_output)&&(t.beginPath(),n===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),t.fill()),this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),i&&t.restore(),t.finish2D&&t.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(t){var e=this.graph,i=e._subgraph_node;i?(this.drawSubgraphPanelLeft(e,i,t),this.drawSubgraphPanelRight(e,i,t)):console.warn("subgraph without subnode")},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(t,e,i){var s=e.inputs?e.inputs.length:0,o=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(10,10,200,(s+1)*o+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left",i.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var n=50;if(i.font="14px Arial",e.inputs)for(var r=0;r<e.inputs.length;++r){var a,u,h=e.inputs[r];h.not_subgraph_input||(this.drawButton(20,n+2,180,o-2)&&(a=e.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(u=LiteGraph.createNode(a))?(t.add(u),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",h.name),u.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",a)),i.fillStyle="#9C9",i.beginPath(),i.arc(184,n+.5*o,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(h.name,30,n+.75*o),i.fillStyle="#777",i.fillText(h.type,130,n+.75*o),n+=o)}this.drawButton(20,n+2,180,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)}},LGraphCanvas.prototype.drawSubgraphPanelRight=function(t,e,i){var s=e.outputs?e.outputs.length:0,o=this.bgcanvas.width,n=200,r=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT),s=(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(o-n-10,10,n,(s+1)*r+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left","Graph Outputs"),a=i.measureText(s).width;if(i.fillText(s,o-a-20,34),this.drawButton(o-n,20,20,20,"X","#151515"))this.closeSubgraph();else{var u=50;if(i.font="14px Arial",e.outputs)for(var h=0;h<e.outputs.length;++h){var p,l,d=e.outputs[h];d.not_subgraph_input||(this.drawButton(o-n,u+2,180,r-2)&&(p=e.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(l=LiteGraph.createNode(p))?(t.add(l),this.block_click=!1,this.last_click_position=null,this.selectNodes([l]),this.node_dragged=l,this.dragging_canvas=!1,l.setProperty("name",d.name),l.setProperty("type",d.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",p)),i.fillStyle="#9C9",i.beginPath(),i.arc(o-n+16,u+.5*r,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(d.name,o-n+30,u+.75*r),i.fillStyle="#777",i.fillText(d.type,o-n+130,u+.75*r),u+=r)}this.drawButton(o-n,u+2,180,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)}},LGraphCanvas.prototype.drawButton=function(t,e,i,s,o,n,r,a){var u=this.ctx,h=(n=n||LiteGraph.NODE_DEFAULT_COLOR,r=r||"#555",a=a||LiteGraph.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),p=LiteGraph.isInsideRectangle(h[0],h[1],t,e,i,s),l=((h=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(l=this.canvas.getBoundingClientRect(),h[0]-=l.left,h[1]-=l.top),h&&LiteGraph.isInsideRectangle(h[0],h[1],t,e,i,s)),h=(u.fillStyle=p?r:n,l&&(u.fillStyle="#AAA"),u.beginPath(),u.roundRect(t,e,i,s,[4]),u.fill(),null!=o&&o.constructor==String&&(u.fillStyle=a,u.textAlign="center",u.font=(.65*s|0)+"px Arial",u.fillText(o,t+.5*i,e+.75*s),u.textAlign="left"),l&&!this.block_click);return l&&this.blockClick(),h},LGraphCanvas.prototype.isAreaClicked=function(t,e,i,s,o){var n=this.mouse,n=(LiteGraph.isInsideRectangle(n[0],n[1],t,e,i,s),(n=this.last_click_position)&&LiteGraph.isInsideRectangle(n[0],n[1],t,e,i,s)),t=n&&!this.block_click;return n&&o&&this.blockClick(),t},LGraphCanvas.prototype.renderInfo=function(t,e,i){e=e||10,i=i||this.canvas.height-80,t.save(),t.translate(e,i),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var t=this.bgcanvas,e=(t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),i=(e.start&&e.start(),this.viewport||[0,0,e.canvas.width,e.canvas.height]);if(this.clear_background&&e.clearRect(i[0],i[1],i[2],i[3]),this._graph_stack&&this._graph_stack.length){e.save();this._graph_stack[this._graph_stack.length-1];for(var i=this.graph._subgraph_node,s=(e.strokeStyle=i.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=i.bgcolor||"#AAA",""),o=1;o<this._graph_stack.length;++o)s+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";e.fillText(s+i.getTitle(),.5*t.width,40),e.restore()}var n,i=!1;this.onRenderBackground&&(i=this.onRenderBackground(t,e)),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(e.save(),this.ds.toCanvasContext(e),this.ds.scale<1.5&&!i&&this.clear_background_color&&(e.fillStyle=this.clear_background_color,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!i&&(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(n=this)._bg_img.onload=function(){n.draw(!0,!0)}),(i=null)==this._pattern&&0<this._bg_img.width?(i=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=i):i=this._pattern,i&&(e.fillStyle=i,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()),e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},new Float32Array(2)),tmp_area=(LGraphCanvas.prototype.drawNode=function(t,e){var i=(this.current_node=t).color||t.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,s=t.bgcolor||t.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,o=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else{var n=this.editor_alpha;if(e.globalAlpha=n,this.render_shadows&&!o?(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var r,a=t._shape||LiteGraph.BOX_SHAPE,u=temp_vec2,h=(temp_vec2.set(t.size),t.horizontal),p=void 0!==t.inputs_horizontal?t.inputs_horizontal:h,l=void 0!==t.outputs_horizontal?t.outputs_horizontal:h,d=(t.flags.collapsed&&(e.font=this.inner_text_font,null!=(r=t.getTitle?t.getTitle():t.title))&&(t._collapsed_width=Math.min(t.size[0],e.measureText(r).width+2*LiteGraph.NODE_TITLE_HEIGHT),u[0]=t._collapsed_width,u[1]=0),t.clip_area&&(e.save(),e.beginPath(),a==LiteGraph.BOX_SHAPE?e.rect(0,0,u[0],u[1]):a==LiteGraph.ROUND_SHAPE?e.roundRect(0,0,u[0],u[1],[10]):a==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*u[0],.5*u[1],.5*u[0],0,2*Math.PI),e.clip()),this.drawNodeShape(t,e,u,i,s=t.has_errors?"red":s,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=p?"center":"left",e.font=this.inner_text_font,!o),c=this.connecting_output,_=this.connecting_input,g=(e.lineWidth=1,0),f=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var v,m,y=null,x=null;if(t.inputs)for(b=0;b<t.inputs.length;b++){L=t.inputs[b];if(null!=L.link){y=L;break}}if(t.outputs)for(b=0;b<t.outputs.length;b++)(L=t.outputs[b]).links&&L.links.length&&(x=L);y&&(m=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void(v=0)!==t.inputs_horizontal?t.inputs_horizontal:h)&&(v=.5*t._collapsed_width,m=-LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?e.rect(v-7+.5,m-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(v+8,m),e.lineTo(v+-4,m-4),e.lineTo(v+-4,m+4),e.closePath()):e.arc(v,m,4,0,2*Math.PI),e.fill()),x&&(v=t._collapsed_width,m=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void 0!==t.outputs_horizontal?t.outputs_horizontal:h)&&(v=.5*t._collapsed_width,m=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?e.rect(v-7+.5,m-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(v+6,m),e.lineTo(v-6,m-4),e.lineTo(v-6,m+4),e.closePath()):e.arc(v,m,4,0,2*Math.PI),e.fill())}}else{if(t.inputs)for(var b=0;b<t.inputs.length;b++){var T=(L=t.inputs[b]).type,E=L.shape;e.globalAlpha=n,this.connecting_output&&!LiteGraph.isValidConnection(L.type,c.type)&&(e.globalAlpha=.4*n),e.fillStyle=null!=L.link?L.color_on||this.default_connection_color_byType[T]||this.default_connection_color.input_on:L.color_off||this.default_connection_color_byTypeOff[T]||this.default_connection_color_byType[T]||this.default_connection_color.input_off;(O=t.getConnectionPos(!0,b,f))[0]-=t.pos[0],O[1]-=t.pos[1],g<O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.beginPath(),"array"==T&&(E=LiteGraph.GRID_SHAPE);var w=!0;L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?p?e.rect(O[0]-5+.5,O[1]-8+.5,10,14):e.rect(O[0]-6+.5,O[1]-5+.5,14,10):E===LiteGraph.ARROW_SHAPE?(e.moveTo(O[0]+8,O[1]+.5),e.lineTo(O[0]-4,O[1]+6+.5),e.lineTo(O[0]-4,O[1]-6+.5),e.closePath()):E===LiteGraph.GRID_SHAPE?(e.rect(O[0]-4,O[1]-4,2,2),e.rect(O[0]-1,O[1]-4,2,2),e.rect(O[0]+2,O[1]-4,2,2),e.rect(O[0]-4,O[1]-1,2,2),e.rect(O[0]-1,O[1]-1,2,2),e.rect(O[0]+2,O[1]-1,2,2),e.rect(O[0]-4,O[1]+2,2,2),e.rect(O[0]-1,O[1]+2,2,2),e.rect(O[0]+2,O[1]+2,2,2),w=!1):o?e.rect(O[0]-4,O[1]-4,8,8):e.arc(O[0],O[1],4,0,2*Math.PI),e.fill(),d&&(I=null!=L.label?L.label:L.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,p||L.dir==LiteGraph.UP?e.fillText(I,O[0],O[1]-10):e.fillText(I,O[0]+10,O[1]+5))}if(e.textAlign=l?"center":"right",e.strokeStyle="black",t.outputs)for(var b=0;b<t.outputs.length;b++){var L,T=(L=t.outputs[b]).type,E=L.shape;this.connecting_input&&!LiteGraph.isValidConnection(T,_.type)&&(e.globalAlpha=.4*n);(O=t.getConnectionPos(!1,b,f))[0]-=t.pos[0],O[1]-=t.pos[1],g<O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=O[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.fillStyle=L.links&&L.links.length?L.color_on||this.default_connection_color_byType[T]||this.default_connection_color.output_on:L.color_off||this.default_connection_color_byTypeOff[T]||this.default_connection_color_byType[T]||this.default_connection_color.output_off,e.beginPath(),"array"==T&&(E=LiteGraph.GRID_SHAPE);var O,I,w=!0;T===LiteGraph.EVENT||E===LiteGraph.BOX_SHAPE?l?e.rect(O[0]-5+.5,O[1]-8+.5,10,14):e.rect(O[0]-6+.5,O[1]-5+.5,14,10):E===LiteGraph.ARROW_SHAPE?(e.moveTo(O[0]+8,O[1]+.5),e.lineTo(O[0]-4,O[1]+6+.5),e.lineTo(O[0]-4,O[1]-6+.5),e.closePath()):E===LiteGraph.GRID_SHAPE?(e.rect(O[0]-4,O[1]-4,2,2),e.rect(O[0]-1,O[1]-4,2,2),e.rect(O[0]+2,O[1]-4,2,2),e.rect(O[0]-4,O[1]-1,2,2),e.rect(O[0]-1,O[1]-1,2,2),e.rect(O[0]+2,O[1]-1,2,2),e.rect(O[0]-4,O[1]+2,2,2),e.rect(O[0]-1,O[1]+2,2,2),e.rect(O[0]+2,O[1]+2,2,2),w=!1):o?e.rect(O[0]-4,O[1]-4,8,8):e.arc(O[0],O[1],4,0,2*Math.PI),e.fill(),!o&&w&&e.stroke(),d&&(I=null!=L.label?L.label:L.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||L.dir==LiteGraph.DOWN?e.fillText(I,O[0],O[1]-8):e.fillText(I,O[0]-10,O[1]+5))}e.textAlign="left",e.globalAlpha=1,t.widgets&&(r=g,(p||l||t.widgets_up)&&(r=2),null!=t.widgets_start_y&&(r=t.widgets_start_y),this.drawNodeWidgets(t,r,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null))}t.clip_area&&e.restore(),e.globalAlpha=1}}},LGraphCanvas.prototype.drawLinkTooltip=function(t,e){var i,s=e._pos;t.fillStyle="black",t.beginPath(),t.arc(s[0],s[1],3,0,2*Math.PI),t.fill(),null==e.data||this.onDrawLinkTooltip&&1==this.onDrawLinkTooltip(t,e,this)||(i=null)!=(i=(e=e.data).constructor===Number?e.toFixed(2):e.constructor===String?'"'+e+'"':e.constructor===Boolean?String(e):e.toToolTip?e.toToolTip():"["+e.constructor.name+"]")&&(i=i.substr(0,30),t.font="14px Courier New",e=t.measureText(i).width+20,t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(s[0]-.5*e,s[1]-15-24,e,24,[3]),t.moveTo(s[0]-10,s[1]-15),t.lineTo(s[0]+10,s[1]-15),t.lineTo(s[0],s[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(i,s[0],s[1]-15-24*.3))},new Float32Array(4)),margin_area=(LGraphCanvas.prototype.drawNodeShape=function(t,e,i,s,o,n,r){e.strokeStyle=s,e.fillStyle=o;var a,o=LiteGraph.NODE_TITLE_HEIGHT,u=this.ds.scale<.5,h=t._shape||t.constructor.shape||LiteGraph.ROUND_SHAPE,p=t.constructor.title_mode,l=!0,r=(p==LiteGraph.TRANSPARENT_TITLE||p==LiteGraph.NO_TITLE?l=!1:p==LiteGraph.AUTOHIDE_TITLE&&r&&(l=!0),tmp_area),d=(r[0]=0,r[1]=l?-o:0,r[2]=i[0]+1,r[3]=l?i[1]+o:i[1],e.globalAlpha);e.beginPath(),h==LiteGraph.BOX_SHAPE||u?e.fillRect(r[0],r[1],r[2],r[3]):h==LiteGraph.ROUND_SHAPE||h==LiteGraph.CARD_SHAPE?e.roundRect(r[0],r[1],r[2],r[3],h==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):h==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),e.fill(),!t.flags.collapsed&&l&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,r[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),(l||p==LiteGraph.TRANSPARENT_TITLE)&&(t.onDrawTitleBar?t.onDrawTitleBar(e,o,i,this.ds.scale,s):p!=LiteGraph.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)&&(l=t.constructor.title_color||s,t.flags.collapsed&&(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients?((a=LGraphCanvas.gradients[l])||((a=LGraphCanvas.gradients[l]=e.createLinearGradient(0,0,400,0)).addColorStop(0,l),a.addColorStop(1,"#000")),e.fillStyle=a):e.fillStyle=l,e.beginPath(),h==LiteGraph.BOX_SHAPE||u?e.rect(0,-o,i[0]+1,o):h!=LiteGraph.ROUND_SHAPE&&h!=LiteGraph.CARD_SHAPE||e.roundRect(0,-o,i[0]+1,o,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"),a=!1,LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[t.mode]&&(a=LiteGraph.NODE_MODES_COLORS[t.mode]),LiteGraph.node_box_coloured_when_on&&(a=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":a),t.onDrawTitleBox?t.onDrawTitleBox(e,o,i,this.ds.scale):h==LiteGraph.ROUND_SHAPE||h==LiteGraph.CIRCLE_SHAPE||h==LiteGraph.CARD_SHAPE?(u&&(e.fillStyle="black",e.beginPath(),e.arc(.5*o,-.5*o,6,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||a||LiteGraph.NODE_DEFAULT_BOXCOLOR,u?e.fillRect(.5*o-5,-.5*o-5,10,10):(e.beginPath(),e.arc(.5*o,-.5*o,5,0,2*Math.PI),e.fill())):(u&&(e.fillStyle="black",e.fillRect(.5*(o-10)-1,-.5*(o+10)-1,12,12)),e.fillStyle=t.boxcolor||a||LiteGraph.NODE_DEFAULT_BOXCOLOR,e.fillRect(.5*(o-10),-.5*(o+10),10,10)),e.globalAlpha=d,t.onDrawTitleText&&t.onDrawTitleText(e,o,i,this.ds.scale,this.title_text_font,n),!u&&(e.font=this.title_text_font,l=String(t.getTitle()))&&(e.fillStyle=n?LiteGraph.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.measureText(l),e.fillText(l.substr(0,20),o,LiteGraph.NODE_TITLE_TEXT_Y-o),e.textAlign="left"):(e.textAlign="left",e.fillText(l,o,LiteGraph.NODE_TITLE_TEXT_Y-o))),t.flags.collapsed||!t.subgraph||t.skip_subgraph_button||(a=LiteGraph.NODE_TITLE_HEIGHT,d=t.size[0]-a,l=LiteGraph.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],2+d,2-a,a-4,a-4),e.fillStyle=l?"#888":"#555",h==LiteGraph.BOX_SHAPE||u?e.fillRect(2+d,2-a,a-4,a-4):(e.beginPath(),e.roundRect(2+d,2-a,a-4,a-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(d+.2*a,.6*-a),e.lineTo(d+.8*a,.6*-a),e.lineTo(d+.5*a,.3*-a),e.fill()),t.onDrawTitle)&&t.onDrawTitle(e),n&&(t.onBounding&&t.onBounding(r),p==LiteGraph.TRANSPARENT_TITLE&&(r[1]-=o,r[3]+=o),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),h==LiteGraph.BOX_SHAPE?e.rect(-6+r[0],-6+r[1],12+r[2],12+r[3]):h==LiteGraph.ROUND_SHAPE||h==LiteGraph.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+r[0],-6+r[1],12+r[2],12+r[3],[2*this.round_radius]):h==LiteGraph.CARD_SHAPE?e.roundRect(-6+r[0],-6+r[1],12+r[2],12+r[3],[2*this.round_radius,2,2*this.round_radius,2]):h==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),e.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=s,e.globalAlpha=1),0<t.execute_triggered&&t.execute_triggered--,0<t.action_triggered&&t.action_triggered--},new Float32Array(4)),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(t,e){for(var i in t)if(t[i]!=e[i])return!1;return!0}function distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function colorToString(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"}function isInsideRectangle(t,e,i,s,o,n){return i<t&&t<i+o&&s<e&&e<s+n}function growBounding(t,e,i){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),i<t[1]?t[1]=i:i>t[3]&&(t[3]=i)}function isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}function overlapBounding(t,e){var i=t[0]+t[2];return!(e[0]+e[2]<t[0]||t[1]>e[1]+e[3]||i<e[0]||t[1]+t[3]<e[1])}function hex2num(t){t=(t="#"==t.charAt(0)?t.slice(1):t).toUpperCase();for(var e,i,s="0123456789ABCDEF",o=new Array(3),n=0,r=0;r<6;r+=2)e=s.indexOf(t.charAt(r)),i=s.indexOf(t.charAt(r+1)),o[n]=16*e+i,n++;return o}function num2hex(t){for(var e,i,s="0123456789ABCDEF",o="#",n=0;n<3;n++)e=t[n]/16,i=t[n]%16,o+=s.charAt(e)+s.charAt(i);return o}function ContextMenu(t,i){i=i||{},this.options=i;var e=this,s=(i.parentMenu&&(i.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=null):(this.parentMenu=i.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),null),o=("MouseEvent"!==(s=i.event?i.event.constructor.name:s)&&"CustomEvent"!==s&&"PointerEvent"!==s&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+s+")"),i.event=null),document.createElement("div"));function n(t){var e=parseInt(o.style.top);return o.style.top=(e+t.deltaY*i.scroll_speed).toFixed()+"px",t.preventDefault(),!0}o.className="litegraph litecontextmenu litemenubar-panel",i.className&&(o.className+=" "+i.className),o.style.minWidth=100,o.style.minHeight=100,o.style.pointerEvents="none",setTimeout(function(){o.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(o,"up",function(t){return t.preventDefault(),!0},!0),o.addEventListener("contextmenu",function(t){return 2==t.button&&t.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(o,"down",function(t){if(2==t.button)return e.close(),t.preventDefault(),!0},!0),i.scroll_speed||(i.scroll_speed=.1),o.addEventListener("wheel",n,!0),o.addEventListener("mousewheel",n,!0),this.root=o,i.title&&((s=document.createElement("div")).className="litemenu-title",s.innerHTML=i.title,o.appendChild(s));for(var r=0;r<t.length;r++){var a=t.constructor==Array?t[r]:r,u=(null!=a&&a.constructor!==String&&(a=void 0===a.content?String(a):a.content),t[r]);this.addItem(a,u,i),0}LiteGraph.pointerListenerAdd(o,"enter",function(t){o.closing_timer&&clearTimeout(o.closing_timer)});var h,p,s=document,s=(((s=(s=i.event?i.event.target.ownerDocument:s)||document).fullscreenElement||s.body).appendChild(o),i.left||0),l=i.top||0;i.event&&(s=i.event.clientX-10,l=i.event.clientY-10,i.title&&(l-=20),i.parentMenu&&(s=(h=i.parentMenu.root.getBoundingClientRect()).left+h.width),h=document.body.getBoundingClientRect(),p=o.getBoundingClientRect(),0==h.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),h.width&&s>h.width-p.width-10&&(s=h.width-p.width-10),h.height)&&l>h.height-p.height-10&&(l=h.height-p.height-10),o.style.left=s+"px",o.style.top=l+"px",i.scale&&(o.style.transform="scale("+i.scale+")")}function CurveEditor(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}function clamp(t,e,i){return t<e?e:i<t?i:t}LGraphCanvas.prototype.drawConnections=function(t){for(var e=LiteGraph.getTime(),i=this.visible_area,s=(margin_area[0]=i[0]-20,margin_area[1]=i[1]-20,margin_area[2]=i[2]+40,margin_area[3]=i[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha,this.graph._nodes),o=0,n=s.length;o<n;++o){var r=s[o];if(r.inputs&&r.inputs.length)for(var a=0;a<r.inputs.length;++a){var u,h,p,l,d,c,_=r.inputs[a];_&&null!=_.link&&(_=_.link,_=this.graph.links[_])&&null!=(l=this.graph.getNodeById(_.origin_id))&&(u=null,u=-1==(p=_.origin_slot)?[l.pos[0]+10,l.pos[1]+10]:l.getConnectionPos(!1,p,tempA),h=r.getConnectionPos(!0,a,tempB),link_bounding[0]=u[0],link_bounding[1]=u[1],link_bounding[2]=h[0]-u[0],link_bounding[3]=h[1]-u[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area))&&(p=l.outputs[p],d=r.inputs[a],p)&&d&&(p=p.dir||(void 0!==l.outputs_horizontal?l.outputs_horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:l.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),l=d.dir||(void 0!==r.inputs_horizontal?r.inputs_horizontal?LiteGraph.UP:LiteGraph.LEFT:r.horizontal?LiteGraph.UP:LiteGraph.LEFT),this.renderLink(t,u,h,_,!1,0,null,p,l),_)&&_._last_time&&e-_._last_time<1e3&&(d=2-.002*(e-_._last_time),c=t.globalAlpha,t.globalAlpha=c*d,this.renderLink(t,u,h,_,!0,d,"white",p,l),t.globalAlpha=c)}}t.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(t,e,i,s,o,n,r,a,u,h){s&&this.visible_links.push(s),r=(r=!r&&s?s.color||LGraphCanvas.link_type_colors[s.type]:r)||this.default_link_color,null!=s&&this.highlighted_links[s.id]&&(r="#FFF"),a=a||LiteGraph.RIGHT,u=u||LiteGraph.LEFT;var p=distance(e,i),l=!1,d=Math.abs(e[0]-i[0]),c=Math.abs(e[1]-i[1]);this.links_render_mode==LiteGraph.SPLINE_LINK&&(a==LiteGraph.RIGHT&&u==LiteGraph.LEFT||a==LiteGraph.LEFT&&u==LiteGraph.RIGHT?d<50&&20<c&&(l=!0):(a==LiteGraph.DOWN&&u==LiteGraph.UP||a==LiteGraph.UP&&u==LiteGraph.DOWN)&&c<50&&20<d&&(l=!0)),this.render_connections_border&&.6<this.ds.scale&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",1<(h=h||1)&&(t.lineWidth=.5),t.beginPath();for(var _=0;_<h;_+=1){var g=5*(_-.5*(h-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK)if(t.moveTo(e[0],e[1]+g),l){var f=e[0],v=e[1]+g,m=i[0],y=i[1]+g;a==LiteGraph.RIGHT?f+=10:a==LiteGraph.LEFT?f-=10:a==LiteGraph.DOWN?v+=10:a==LiteGraph.UP&&(v-=10),u==LiteGraph.LEFT?m-=10:u==LiteGraph.RIGHT?m+=10:u==LiteGraph.UP?y-=10:u==LiteGraph.DOWN&&(y+=10),t.lineTo(f,v),t.lineTo(.5*(f+m),v),t.lineTo(.5*(f+m),y),t.lineTo(m,y),t.lineTo(i[0],i[1]+g)}else{var x=0,b=0,T=0,E=0;switch(a){case LiteGraph.LEFT:x=-.25*p;break;case LiteGraph.RIGHT:x=.25*p;break;case LiteGraph.UP:b=-.25*p;break;case LiteGraph.DOWN:b=.25*p}switch(u){case LiteGraph.LEFT:T=-.25*p;break;case LiteGraph.RIGHT:T=.25*p;break;case LiteGraph.UP:E=-.25*p;break;case LiteGraph.DOWN:E=.25*p}t.bezierCurveTo(e[0]+x,e[1]+b+g,i[0]+T,i[1]+E+g,i[0],i[1]+g)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){t.moveTo(e[0],e[1]+g);x=0,b=0,T=0,E=0;switch(a){case LiteGraph.LEFT:x=-1;break;case LiteGraph.RIGHT:x=1;break;case LiteGraph.UP:b=-1;break;case LiteGraph.DOWN:b=1}switch(u){case LiteGraph.LEFT:T=-1;break;case LiteGraph.RIGHT:T=1;break;case LiteGraph.UP:E=-1;break;case LiteGraph.DOWN:E=1}t.lineTo(e[0]+15*x,e[1]+15*b+g),t.lineTo(i[0]+15*T,i[1]+15*E+g),t.lineTo(i[0],i[1]+g)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);f=e[0],v=e[1],m=i[0],y=i[1];a==LiteGraph.RIGHT?f+=10:v+=10,u==LiteGraph.LEFT?m-=10:y-=10,t.lineTo(f,v),t.lineTo(.5*(f+m),v),t.lineTo(.5*(f+m),y),t.lineTo(m,y),t.lineTo(i[0],i[1])}}this.render_connections_border&&.6<this.ds.scale&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=r,t.stroke();var w,L,O=this.computeConnectionPoint(e,i,.5,a,u);if(s&&s._pos&&(s._pos[0]=O[0],s._pos[1]=O[1]),.6<=this.ds.scale&&this.highquality_render&&u!=LiteGraph.CENTER&&(this.render_connection_arrows&&(c=this.computeConnectionPoint(e,i,.25,a,u),d=this.computeConnectionPoint(e,i,.26,a,u),o=this.computeConnectionPoint(e,i,.75,a,u),s=this.computeConnectionPoint(e,i,.76,a,u),L=w=0,L=this.render_curved_connections?(w=-Math.atan2(d[0]-c[0],d[1]-c[1]),-Math.atan2(s[0]-o[0],s[1]-o[1])):w=i[1]>e[1]?0:Math.PI,t.save(),t.translate(c[0],c[1]),t.rotate(w),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(o[0],o[1]),t.rotate(L),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()),t.beginPath(),t.arc(O[0],O[1],5,0,2*Math.PI),t.fill()),n){t.fillStyle=r;for(_=0;_<5;++_){var I=(.001*LiteGraph.getTime()+.2*_)%1,O=this.computeConnectionPoint(e,i,I,a,u);t.beginPath(),t.arc(O[0],O[1],5,0,2*Math.PI),t.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(t,e,i,s,o){s=s||LiteGraph.RIGHT,o=o||LiteGraph.LEFT;var n=distance(t,e),r=t,a=[t[0],t[1]],u=[e[0],e[1]],t=e;switch(s){case LiteGraph.LEFT:a[0]+=-.25*n;break;case LiteGraph.RIGHT:a[0]+=.25*n;break;case LiteGraph.UP:a[1]+=-.25*n;break;case LiteGraph.DOWN:a[1]+=.25*n}switch(o){case LiteGraph.LEFT:u[0]+=-.25*n;break;case LiteGraph.RIGHT:u[0]+=.25*n;break;case LiteGraph.UP:u[1]+=-.25*n;break;case LiteGraph.DOWN:u[1]+=.25*n}e=(1-i)*(1-i)*(1-i),s=(1-i)*(1-i)*3*i,o=3*(1-i)*(i*i),i*=i*i;return[e*r[0]+s*a[0]+o*u[0]+i*t[0],e*r[1]+s*a[1]+o*u[1]+i*t[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,i=0;i<e.length;++i){var s=e[i];t.fillStyle="black",t.fillRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==s.order&&t.strokeRect(s.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,s.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(s.order,s.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,s.pos[1]-6)}t.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(t,e,i,s){if(!t.widgets||!t.widgets.length)return 0;for(var o=t.size[0],n=t.widgets,r=(e+=2,LiteGraph.NODE_WIDGET_HEIGHT),a=.5<this.ds.scale,u=(i.save(),i.globalAlpha=this.editor_alpha,LiteGraph.WIDGET_OUTLINE_COLOR),h=LiteGraph.WIDGET_BGCOLOR,p=LiteGraph.WIDGET_TEXT_COLOR,l=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,d=0;d<n.length;++d){var c,_=n[d],g=e,f=(_.y&&(g=_.y),_.last_y=g,i.strokeStyle=u,i.fillStyle="#222",i.textAlign="left",_.disabled&&(i.globalAlpha*=.5),_.width||o);switch(_.type){case"button":_.clicked&&(i.fillStyle="#AAA",_.clicked=!1,this.dirty_canvas=!0),i.fillRect(15,g,f-30,r),a&&!_.disabled&&i.strokeRect(15,g,f-30,r),a&&(i.textAlign="center",i.fillStyle=p,i.fillText(_.label||_.name,.5*f,g+.7*r));break;case"toggle":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),a?i.roundRect(15,g,f-30,r,[.5*r]):i.rect(15,g,f-30,r),i.fill(),a&&!_.disabled&&i.stroke(),i.fillStyle=_.value?"#89A":"#333",i.beginPath(),i.arc(f-30,g+.5*r,.36*r,0,2*Math.PI),i.fill(),a&&(i.fillStyle=l,null!=(v=_.label||_.name)&&i.fillText(v,30,g+.7*r),i.fillStyle=_.value?p:l,i.textAlign="right",i.fillText(_.value?_.options.on||"true":_.options.off||"false",f-40,g+.7*r));break;case"slider":i.fillStyle=h,i.fillRect(15,g,f-30,r);var v=_.options.max-_.options.min,m=(_.value-_.options.min)/v;1<(m=m<0?0:m)&&(m=1),i.fillStyle=_.options.hasOwnProperty("slider_color")?_.options.slider_color:s==_?"#89A":"#678",i.fillRect(15,g,m*(f-30),r),a&&!_.disabled&&i.strokeRect(15,g,f-30,r),_.marker&&(1<(m=(m=(_.marker-_.options.min)/v)<0?0:m)&&(m=1),i.fillStyle=_.options.hasOwnProperty("marker_color")?_.options.marker_color:"#AA9",i.fillRect(15+m*(f-30),g,2,r)),a&&(i.textAlign="center",i.fillStyle=p,i.fillText(_.label||_.name+"  "+Number(_.value).toFixed(null!=_.options.precision?_.options.precision:3),.5*f,g+.7*r));break;case"number":case"combo":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),a?i.roundRect(15,g,f-30,r,[.5*r]):i.rect(15,g,f-30,r),i.fill(),a&&(_.disabled||i.stroke(),i.fillStyle=p,_.disabled||(i.beginPath(),i.moveTo(31,g+5),i.lineTo(21,g+.5*r),i.lineTo(31,g+r-5),i.fill(),i.beginPath(),i.moveTo(f-15-16,g+5),i.lineTo(f-15-6,g+.5*r),i.lineTo(f-15-16,g+r-5),i.fill()),i.fillStyle=l,i.fillText(_.label||_.name,35,g+.7*r),i.fillStyle=p,i.textAlign="right","number"==_.type?i.fillText(Number(_.value).toFixed(void 0!==_.options.precision?_.options.precision:3),f-30-20,g+.7*r):(m=_.value,_.options.values&&(c=(c=_.options.values).constructor===Function?c():c)&&c.constructor!==Array&&(m=c[_.value]),i.fillText(m,f-30-20,g+.7*r)));break;case"string":case"text":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),a?i.roundRect(15,g,f-30,r,[.5*r]):i.rect(15,g,f-30,r),i.fill(),a&&(_.disabled||i.stroke(),i.save(),i.beginPath(),i.rect(15,g,f-30,r),i.clip(),i.fillStyle=l,null!=(c=_.label||_.name)&&i.fillText(c,30,g+.7*r),i.fillStyle=p,i.textAlign="right",i.fillText(String(_.value).substr(0,30),f-30,g+.7*r),i.restore());break;default:_.draw&&_.draw(i,t,f,g,r)}e+=(_.computeSize?_.computeSize(f)[1]:r)+4,i.globalAlpha=this.editor_alpha}i.restore(),i.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction))for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0);break;case"number":case"combo":var old_value=w.value,values,values_list,delta,index,text_values,menu,delta;function inner_clicked(t,e,i){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),!(that.dirty_canvas=!0)}event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type?(deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):event.type==LiteGraph.pointerevents_method+"down"?(values=w.options.values,values&&values.constructor===Function&&(values=w.options.values(w,node)),values_list=null,"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values)),delta=x<40?-1:widget_width-40<x?1:0,"number"==w.type?(w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):delta?(index=-1,this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index):(text_values=values!=values_list?Object.values(values):values,menu=new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window))):event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type&&(delta=x<40?-1:widget_width-40<x?1:0,event.click_time<200)&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}.bind(w),event),old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,function(t){inner_value_change(this,t)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}return null;function inner_value_change(t,e){"number"==t.type&&(e=Number(e)),t.value=e,t.options&&t.options.property&&void 0!==node.properties[t.options.property]&&node.setProperty(t.options.property,e),t.callback&&t.callback(t.value,that,node,pos,event)}},LGraphCanvas.prototype.drawGroups=function(t,e){if(this.graph){var i=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var s=0;s<i.length;++s){var o,n,r=i[s];overlapBounding(this.visible_area,r._bounding)&&(e.fillStyle=r.color||"#335",e.strokeStyle=r.color||"#335",o=r._pos,n=r._size,e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(o[0]+.5,o[1]+.5,n[0],n[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(o[0]+n[0],o[1]+n[1]),e.lineTo(o[0]+n[0]-10,o[1]+n[1]),e.lineTo(o[0]+n[0],o[1]+n[1]-10),e.fill(),n=r.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,e.font=n+"px Arial",e.textAlign="left",e.fillText(r.title,o[0]+4,o[1]+n))}e.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(t,e){var i;t||e||(t=(i=this.canvas.parentNode).offsetWidth,e=i.offsetHeight),this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(t){var e,i,s;t?(i=(e=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),s=setInterval(function(){e.editor_alpha*=i,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,i<1&&e.editor_alpha<.01&&(clearInterval(s),i<1)&&(e.live_mode=!0),1<i&&.99<e.editor_alpha&&(clearInterval(s),e.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.onNodeSelectionChange=function(t){},LGraphCanvas.onGroupAdd=function(t,e,i){var s=LGraphCanvas.active_canvas,o=(s.getCanvasWindow(),new LiteGraph.LGraphGroup);o.pos=s.convertEventToCanvasOffset(i),s.graph.add(o)},LGraphCanvas.getBoundaryNodes=function(t){let e=null,i=null,s=null,o=null;for(var n in t){var n=t[n],[r,a]=n.pos,[u,h]=n.size;(null===e||a<e.pos[1])&&(e=n),(null===i||r+u>i.pos[0]+i.size[0])&&(i=n),(null===s||a+h>s.pos[1]+s.size[1])&&(s=n),(null===o||r<o.pos[0])&&(o=n)}return{top:e,right:i,bottom:s,left:o}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,i,s){if(e){var o,n,r=LGraphCanvas.active_canvas;let t=[];t=void 0===s?LGraphCanvas.getBoundaryNodes(e):{top:s,right:s,bottom:s,left:s};for([o,n]of Object.entries(r.selected_nodes))switch(i){case"right":n.pos[0]=t.right.pos[0]+t.right.size[0]-n.size[0];break;case"left":n.pos[0]=t.left.pos[0];break;case"top":n.pos[1]=t.top.pos[1];break;case"bottom":n.pos[1]=t.bottom.pos[1]+t.bottom.size[1]-n.size[1]}r.dirty_canvas=!0,r.dirty_bgcanvas=!0}},LGraphCanvas.onNodeAlign=function(t,e,i,s,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase(),o)},parentMenu:s})},LGraphCanvas.onGroupAlign=function(t,e,i,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase())},parentMenu:s})},LGraphCanvas.onMenuAdd=function(t,e,i,s,r){var a=LGraphCanvas.active_canvas,u=a.getCanvasWindow(),h=a.graph;if(h)return function o(s,t){var e=LiteGraph.getNodeTypesCategories(a.filter||h.filter).filter(function(t){return t.startsWith(s)}),n=[];e.map(function(t){var e,i;t&&(i=new RegExp("^("+s+")"),t=t.replace(i,"").split("/")[0],e=""===s?t+"/":s+t+"/",-1!=(i=t).indexOf("::")&&(i=i.split("::")[1]),-1===n.findIndex(function(t){return t.value===e}))&&n.push({value:e,content:i,has_submenu:!0,callback:function(t,e,i,s){o(t.value,s)}})}),LiteGraph.getNodeTypesInCategory(s.slice(0,-1),a.filter||h.filter).map(function(t){t.skip_list||n.push({value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,i,s){s=s.getFirstEvent(),a.graph.beforeChange(),(t=LiteGraph.createNode(t.value))&&(t.pos=a.convertEventToCanvasOffset(s),a.graph.add(t)),r&&r(t),a.graph.afterChange()}})}),new LiteGraph.ContextMenu(n,{event:i,parentMenu:t},u)}("",s),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(t,e,i,s,o){if(o){var n,r=this,a=LGraphCanvas.active_canvas.getCanvasWindow(),e=o.optional_inputs,u=[];if(e=o.onGetInputs?o.onGetInputs():e)for(var h=0;h<e.length;h++){var p,l=e[h];l?(p=l[0],p=(l[2]||(l[2]={}),l[2].label&&(p=l[2].label),l[2].removable=!0,{content:p,value:l}),l[1]==LiteGraph.ACTION&&(p.className="event"),u.push(p)):u.push(null)}if((u=o.onMenuNodeInputs&&(n=o.onMenuNodeInputs(u))?n:u).length)return new LiteGraph.ContextMenu(u,{event:i,callback:function(t,e,i){o&&(t.callback&&t.callback.call(r,o,t,e,i),t.value)&&(o.graph.beforeChange(),o.addInput(t.value[0],t.value[1],t.value[2]),o.onNodeInputAdd&&o.onNodeInputAdd(t.value),o.setDirtyCanvas(!0,!0),o.graph.afterChange())},parentMenu:s,node:o},a),!1;console.log("no input entries")}},LGraphCanvas.showMenuNodeOptionalOutputs=function(t,e,i,a,u){if(u){var s,h=this,o=LGraphCanvas.active_canvas.getCanvasWindow(),e=u.optional_outputs,n=[];if(e=u.onGetOutputs?u.onGetOutputs():e)for(var r=0;r<e.length;r++){var p,l=e[r];l?u.flags&&u.flags.skip_repeated_outputs&&-1!=u.findOutputSlot(l[0])||(p=l[0],l[2]||(l[2]={}),l[2].label&&(p=l[2].label),l[2].removable=!0,p={content:p,value:l},l[1]==LiteGraph.EVENT&&(p.className="event"),n.push(p)):n.push(null)}if(this.onMenuNodeOutputs&&(n=this.onMenuNodeOutputs(n)),LiteGraph.do_add_triggers_slots&&-1==u.findOutputSlot("onExecuted")&&n.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),(n=u.onMenuNodeOutputs&&(s=u.onMenuNodeOutputs(n))?s:n).length)return new LiteGraph.ContextMenu(n,{event:i,callback:function t(e,i,s){if(!u)return;e.callback&&e.callback.call(h,u,e,i,s);if(!e.value)return;var o=e.value[1];{if(o&&(o.constructor===Object||o.constructor===Array)){var n,r=[];for(n in o)r.push({content:n,value:o[n]});return new LiteGraph.ContextMenu(r,{event:i,callback:t,parentMenu:a,node:u}),!1}u.graph.beforeChange(),u.addOutput(e.value[0],e.value[1],e.value[2]),u.onNodeOutputAdd&&u.onNodeOutputAdd(e.value),u.setDirtyCanvas(!0,!0),u.graph.afterChange()}},parentMenu:a,node:u},o),!1}},LGraphCanvas.onShowMenuNodeProperties=function(t,e,i,s,n){if(n&&n.properties){var o,r=LGraphCanvas.active_canvas,a=r.getCanvasWindow(),u=[];for(o in n.properties){"object"==typeof(t=void 0!==n.properties[o]?n.properties[o]:" ")&&(t=JSON.stringify(t));var h=n.getPropertyInfo(o);"enum"!=h.type&&"combo"!=h.type||(t=LGraphCanvas.getPropertyPrintableValue(t,h.values)),t=LGraphCanvas.decodeHTML(t),u.push({content:"<span class='property_name'>"+(h.label||o)+"</span><span class='property_value'>"+t+"</span>",value:o})}if(u.length)return new LiteGraph.ContextMenu(u,{event:i,callback:function(t,e,i,s){var o;n&&(o=this.getBoundingClientRect(),r.showEditPropertyValue(n,t.value,{position:[o.left,o.top]}))},parentMenu:s,allow_html:!0,node:n},a),!1}},LGraphCanvas.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},LGraphCanvas.onMenuResizeNode=function(t,e,i,s,o){if(o){var n=function(t){t.size=t.computeSize(),t.onResize&&t.onResize(t.size)},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)n(o);else for(var a in r.selected_nodes)n(r.selected_nodes[a]);o.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(s,t){var o=this,n=o.graph.getNodeById(s.origin_id),r=o.graph.getNodeById(s.target_id),a=!1,u=(n&&n.outputs&&n.outputs[s.origin_slot]&&(a=n.outputs[s.origin_slot].type),!1),h=(r&&r.outputs&&r.outputs[s.target_slot]&&(u=r.inputs[s.target_slot].type),new LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=s.data?s.data.constructor.name:null,callback:function(t,e,i){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,i,h,function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&n.connectByType(s.origin_slot,t,a)&&(t.connectByType(s.target_slot,r,u),t.pos[0]-=.5*t.size[0])});break;case"Delete":o.graph.removeLink(s.id)}}}));return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},e=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),i=e.nodeFrom&&null!==e.slotFrom,t=!i&&e.nodeTo&&null!==e.slotTo;if(i||t)if(e.nodeType){var s=i?e.nodeFrom:e.nodeTo,o=i?e.slotFrom:e.slotTo,n=!1;switch(typeof o){case"string":n=i?s.findOutputSlot(o,!1):s.findInputSlot(o,!1),o=(i?s.outputs:s.inputs)[o];break;case"object":n=i?s.findOutputSlot(o.name):s.findInputSlot(o.name);break;case"number":n=o,o=(i?s.outputs:s.inputs)[o];break;default:return console.warn("Cant get slot information "+o),!1}!1!==o&&!1!==n||console.warn("createDefaultNodeForSlot bad slotX "+o+" "+n);var r=o.type==LiteGraph.EVENT?"_event_":o.type,a=i?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(a&&a[r]){if(o.link,nodeNewType=!1,"object"==typeof a[r]||"array"==typeof a[r]){for(var u in a[r])if(e.nodeType==a[r][u]||"AUTO"==e.nodeType){nodeNewType=a[r][u];break}}else e.nodeType!=a[r]&&"AUTO"!=e.nodeType||(nodeNewType=a[r]);if(nodeNewType){var h=!1,p=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(h=nodeNewType).node),LiteGraph.createNode(nodeNewType));if(p){if(h){if(h.properties)for(var l in h.properties)p.addProperty(l,h.properties[l]);if(h.inputs)for(var l in p.inputs=[],h.inputs)p.addOutput(h.inputs[l][0],h.inputs[l][1]);if(h.outputs)for(var l in p.outputs=[],h.outputs)p.addOutput(h.outputs[l][0],h.outputs[l][1]);h.title&&(p.title=h.title),h.json&&p.configure(h.json)}return this.graph.add(p),p.pos=[e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*p.size[0]:0),e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*p.size[1]:0)],i?e.nodeFrom.connectByType(n,p,r):e.nodeTo.connectByTypeOutput(n,p,r),!0}console.log("failed creating "+nodeNewType)}}}else console.warn("No type to createDefaultNodeForSlot");else console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo);return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},s=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),o=this,n=s.nodeFrom&&s.slotFrom,t=!n&&s.nodeTo&&s.slotTo;if(n||t){var e=n?s.nodeFrom:s.nodeTo,r=n?s.slotFrom:s.slotTo,a=!1;switch(typeof r){case"string":a=n?e.findOutputSlot(r,!1):e.findInputSlot(r,!1),r=(n?e.outputs:e.inputs)[r];break;case"object":a=n?e.findOutputSlot(r.name):e.findInputSlot(r.name);break;case"number":a=r,r=(n?e.outputs:e.inputs)[r];break;default:return console.warn("Cant get slot information "+r),!1}var i=["Add Node",null],u=(o.allow_searchbox&&(i.push("Search"),i.push(null)),r.type==LiteGraph.EVENT?"_event_":r.type),h=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(h&&h[u])if("object"==typeof h[u]||"array"==typeof h[u])for(var p in h[u])i.push(h[u][p]);else i.push(h[u]);var l=new LiteGraph.ContextMenu(i,{event:s.e,title:(r&&""!=r.name?r.name+(u?" | ":""):"")+(r&&u?u:""),callback:function(t,e,i){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,i,l,function(t){n?s.nodeFrom.connectByType(a,t,u):s.nodeTo.connectByTypeOutput(a,t,u)});break;case"Search":n?o.showSearchBox(i,{node_from:s.nodeFrom,slot_from:r,type_filter_in:u}):o.showSearchBox(i,{node_to:s.nodeTo,slot_from:r,type_filter_out:u});break;default:o.createDefaultNodeForSlot(Object.assign(s,{position:[s.e.canvasX,s.e.canvasY],nodeType:t}))}}})}else console.warn("No data passed to showConnectionMenu");return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,i,s,o){var n=e.property||"title",r=o[n],a=document.createElement("div");a.is_modified=!1,a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.close=function(){a.parentNode&&a.parentNode.removeChild(a)};a.querySelector(".name").innerText=n;var u=a.querySelector(".value");u&&(u.value=r,u.addEventListener("blur",function(t){this.focus()}),u.addEventListener("keydown",function(t){if(a.is_modified=!0,27==t.keyCode)a.close();else if(13==t.keyCode)c();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}));var r=LGraphCanvas.active_canvas.canvas,h=r.getBoundingClientRect(),p=-20,l=-20;h&&(p-=h.left,l-=h.top),event?(a.style.left=event.clientX+p+"px",a.style.top=event.clientY+l+"px"):(a.style.left=.5*r.width+p+"px",a.style.top=.5*r.height+l+"px");a.querySelector("button").addEventListener("click",c),r.parentNode.appendChild(a),u&&u.focus();var d=null;function c(){var t;u&&(t=u.value,"Number"==e.type?t=Number(t):"Boolean"==e.type&&(t=Boolean(t)),o[n]=t,a.parentNode&&a.parentNode.removeChild(a),o.setDirtyCanvas(!0,!0))}a.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(d=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),a.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&d&&clearTimeout(d)})},LGraphCanvas.prototype.prompt=function(t,e,i,s,o){var n=this,r=(t=t||"",document.createElement("div"));r.is_modified=!1,r.className="graphdialog rounded",r.innerHTML=o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",r.close=function(){n.prompt_box=null,r.parentNode&&r.parentNode.removeChild(r)};var o=LGraphCanvas.active_canvas.canvas,a=(o.parentNode.appendChild(r),1<this.ds.scale&&(r.style.transform="scale("+this.ds.scale+")"),null),u=!1,h=(LiteGraph.pointerListenerAdd(r,"leave",function(t){u||LiteGraph.dialog_close_on_mouse_leave&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(a=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(r,"enter",function(t){LiteGraph.dialog_close_on_mouse_leave&&a&&clearTimeout(a)}),r.querySelectorAll("select")),h=(h&&h.forEach(function(t){t.addEventListener("click",function(t){u++}),t.addEventListener("blur",function(t){u=0}),t.addEventListener("change",function(t){u=-1})}),n.prompt_box&&n.prompt_box.close(),(n.prompt_box=r).querySelector(".name").innerText=t,r.querySelector(".value")),p=(h.value=e,h);p.addEventListener("keydown",function(t){if(r.is_modified=!0,27!=t.keyCode){if(13!=t.keyCode||"textarea"==t.target.localName)return;i&&i(this.value)}r.close(),t.preventDefault(),t.stopPropagation()});r.querySelector("button").addEventListener("click",function(t){i&&i(p.value),n.setDirty(!0),r.close()});t=o.getBoundingClientRect(),e=-20,h=-20;return t&&(e-=t.left,h-=t.top),s?(r.style.left=s.clientX+e+"px",r.style.top=s.clientY+h+"px"):(r.style.left=.5*o.width+e+"px",r.style.top=.5*o.height+h+"px"),setTimeout(function(){p.focus()},10),r},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(n,d){var t,e,i,s,o={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},c=(d=Object.assign(o,d||{}),this),_=LGraphCanvas.active_canvas,r=_.canvas,a=r.ownerDocument||document,u=document.createElement("div"),g=(u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",d.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),u.innerHTML+="<div class='helper'></div>",a.fullscreenElement?a.fullscreenElement.appendChild(u):(a.body.appendChild(u),a.body.style.overflow="hidden"),d.do_type_filter&&(t=u.querySelector(".slot_in_type_filter"),e=u.querySelector(".slot_out_type_filter")),u.close=function(){c.search_box=null,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(function(){c.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},1<this.ds.scale&&(u.style.transform="scale("+this.ds.scale+")"),d.hide_on_mouse_leave&&(i=!1,s=null,LiteGraph.pointerListenerAdd(u,"enter",function(t){s&&(clearTimeout(s),s=null)}),LiteGraph.pointerListenerAdd(u,"leave",function(t){i||(s=setTimeout(function(){u.close()},500))}),d.do_type_filter)&&(t.addEventListener("click",function(t){i++}),t.addEventListener("blur",function(t){i=0}),t.addEventListener("change",function(t){i=-1}),e.addEventListener("click",function(t){i++}),e.addEventListener("blur",function(t){i=0}),e.addEventListener("change",function(t){i=-1})),c.search_box&&c.search_box.close(),(c.search_box=u).querySelector(".helper")),f=null,v=null,h=null,m=u.querySelector("input");if(m&&(m.addEventListener("blur",function(t){c.search_box&&this.focus()}),m.addEventListener("keydown",function(t){if(38==t.keyCode)w(!1);else if(40==t.keyCode)w(!0);else if(27==t.keyCode)u.close();else{if(13!=t.keyCode)return v&&clearInterval(v),void(v=setTimeout(L,250));L(),h?E(h.innerHTML):f?E(f):u.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0})),d.do_type_filter){if(t){var p=(y=LiteGraph.slot_types_in).length;d.type_filter_in!=LiteGraph.EVENT&&d.type_filter_in!=LiteGraph.ACTION||(d.type_filter_in="_event_");for(var l=0;l<p;l++)(x=document.createElement("option")).value=y[l],x.innerHTML=y[l],t.appendChild(x),!1!==d.type_filter_in&&(d.type_filter_in+"").toLowerCase()==(y[l]+"").toLowerCase()&&(x.selected=!0);t.addEventListener("change",function(){L()})}if(e){var y,p=(y=LiteGraph.slot_types_out).length;d.type_filter_out!=LiteGraph.EVENT&&d.type_filter_out!=LiteGraph.ACTION||(d.type_filter_out="_event_");for(var x,l=0;l<p;l++)(x=document.createElement("option")).value=y[l],x.innerHTML=y[l],e.appendChild(x),!1!==d.type_filter_out&&(d.type_filter_out+"").toLowerCase()==(y[l]+"").toLowerCase()&&(x.selected=!0);e.addEventListener("change",function(){L()})}}var o=r.getBoundingClientRect(),b=(n?n.clientX:o.left+.5*o.width)-80,T=(n?n.clientY:o.top+.5*o.height)-20;function E(t){if(t)if(c.onSearchBoxSelection)c.onSearchBoxSelection(t,n,_);else{var e=LiteGraph.searchbox_extras[t.toLowerCase()],i=(e&&(t=e.type),_.graph.beforeChange(),LiteGraph.createNode(t));if(i&&(i.pos=_.convertEventToCanvasOffset(n),_.graph.add(i,!1)),e&&e.data){if(e.data.properties)for(var s in e.data.properties)i.addProperty(s,e.data.properties[s]);if(e.data.inputs)for(var s in i.inputs=[],e.data.inputs)i.addOutput(e.data.inputs[s][0],e.data.inputs[s][1]);if(e.data.outputs)for(var s in i.outputs=[],e.data.outputs)i.addOutput(e.data.outputs[s][0],e.data.outputs[s][1]);e.data.title&&(i.title=e.data.title),e.data.json&&i.configure(e.data.json)}if(d.node_from){var o=!1;switch(typeof d.slot_from){case"string":o=d.node_from.findOutputSlot(d.slot_from);break;case"object":-1==(o=d.slot_from.name?d.node_from.findOutputSlot(d.slot_from.name):-1)&&void 0!==d.slot_from.slot_index&&(o=d.slot_from.slot_index);break;case"number":o=d.slot_from;break;default:o=0}void 0!==d.node_from.outputs[o]&&!1!==o&&-1<o&&d.node_from.connectByType(o,i,d.node_from.outputs[o].type)}if(d.node_to){o=!1;switch(typeof d.slot_from){case"string":o=d.node_to.findInputSlot(d.slot_from);break;case"object":-1==(o=d.slot_from.name?d.node_to.findInputSlot(d.slot_from.name):-1)&&void 0!==d.slot_from.slot_index&&(o=d.slot_from.slot_index);break;case"number":o=d.slot_from;break;default:o=0}void 0!==d.node_to.inputs[o]&&!1!==o&&-1<o&&d.node_to.connectByTypeOutput(o,i,d.node_to.inputs[o].type)}_.graph.afterChange()}u.close()}function w(t){var e=h;h&&h.classList.remove("selected"),(h=h?(h=t?h.nextSibling:h.previousSibling)||e:t?g.childNodes[0]:g.childNodes[g.childNodes.length])&&(h.classList.add("selected"),h.scrollIntoView({block:"end",behavior:"smooth"}))}function L(){v=null;var o=m.value;if(f=null,g.innerHTML="",o||d.show_all_if_empty)if(c.onSearchBox){var t=c.onSearchBox(g,o,_);if(t)for(var e=0;e<t.length;++e)l(t[e])}else{var n,r,i=0,o=o.toLowerCase(),a=_.filter||_.graph.filter;for(e in r=d.do_type_filter&&c.search_box?(n=c.search_box.querySelector(".slot_in_type_filter"),c.search_box.querySelector(".slot_out_type_filter")):n=!1,LiteGraph.searchbox_extras){var s=LiteGraph.searchbox_extras[e];if(d.show_all_if_empty&&!o||-1!==s.desc.toLowerCase().indexOf(o)){var u=LiteGraph.registered_node_types[s.type];if((!u||u.filter==a)&&p(s.type)&&(l(s.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit)&&i++>LGraphCanvas.search_limit)break}}var h=null;if(Array.prototype.filter)h=Object.keys(LiteGraph.registered_node_types).filter(p);else for(var e in h=[],LiteGraph.registered_node_types)p(e)&&h.push(e);for(e=0;e<h.length&&(l(h[e]),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);if(d.show_general_after_typefiltered&&(n.value||r.value)){for(var e in filtered_extra=[],LiteGraph.registered_node_types)p(e,{inTypeOverride:!(!n||!n.value)&&"*",outTypeOverride:!(!r||!r.value)&&"*"})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(l(filtered_extra[e],"generic_type"),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);}if((n.value||r.value)&&0==g.childNodes.length&&d.show_general_if_none_on_typefilter){for(var e in filtered_extra=[],LiteGraph.registered_node_types)p(e,{skipFilter:!0})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(l(filtered_extra[e],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);}function p(t,e){var e=e||{},e=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},e),i=LiteGraph.registered_node_types[t];if(a&&i.filter!=a)return!1;if((!d.show_all_if_empty||o)&&-1===t.toLowerCase().indexOf(o))return!1;if(d.do_type_filter&&!e.skipFilter){i=t,t=n.value;if(!1!==e.inTypeOverride&&(t=e.inTypeOverride),n&&t&&LiteGraph.registered_slot_in_types[t]&&LiteGraph.registered_slot_in_types[t].nodes){var s=LiteGraph.registered_slot_in_types[t].nodes.includes(i);if(!1===s)return!1}t=r.value;if(!1!==e.outTypeOverride&&(t=e.outTypeOverride),r&&t&&LiteGraph.registered_slot_out_types[t]&&LiteGraph.registered_slot_out_types[t].nodes){s=LiteGraph.registered_slot_out_types[t].nodes.includes(i);if(!1===s)return!1}}return!0}}function l(t,e){var i=document.createElement("div");f=f||t,i.innerText=t,i.dataset.type=escape(t),i.className="litegraph lite-search-item",e&&(i.className+=" "+e),i.addEventListener("click",function(t){E(unescape(this.dataset.type))}),g.appendChild(i)}}return u.style.left=b+"px",u.style.top=T+"px",n.layerY>o.height-200&&(g.style.maxHeight=o.height-n.layerY-20+"px"),m.focus(),d.show_all_on_open&&L(),u},LGraphCanvas.prototype.showEditPropertyValue=function(e,i,s){if(e&&void 0!==e.properties[i]){s=s||{};var o=e.getPropertyInfo(i),n=o.type,t="";if("string"==n||"number"==n||"array"==n||"object"==n)t="<input autofocus type='text' class='value'/>";else if("enum"!=n&&"combo"!=n||!o.values){if("boolean"!=n&&"toggle"!=n)return void console.warn("unknown type: "+n);t="<input autofocus type='checkbox' class='value' "+(e.properties[i]?"checked":"")+"/>"}else{for(var r in t="<select autofocus type='text' class='value'>",o.values){var a=r;t+="<option value='"+(a=o.values.constructor===Array?o.values[r]:a)+"' "+(a==e.properties[i]?"selected":"")+">"+o.values[r]+"</option>"}t+="</select>"}var u=this.createDialog("<span class='name'>"+(o.label||i)+"</span>"+t+"<button>OK</button>",s),h=!1;return"enum"!=n&&"combo"!=n||!o.values?"boolean"==n||"toggle"==n?(h=u.querySelector("input"))&&h.addEventListener("click",function(t){u.modified(),l(!!h.checked)}):(h=u.querySelector("input"))&&(h.addEventListener("blur",function(t){this.focus()}),a=void 0!==e.properties[i]?e.properties[i]:"","string"!==n&&(a=JSON.stringify(a)),h.value=a,h.addEventListener("keydown",function(t){if(27==t.keyCode)u.close();else if(13==t.keyCode)p();else if(13!=t.keyCode)return void u.modified();t.preventDefault(),t.stopPropagation()})):(h=u.querySelector("select")).addEventListener("change",function(t){u.modified(),l(t.target.value)}),h&&h.focus(),u.querySelector("button").addEventListener("click",p),u}function p(){l(h.value)}function l(t){o&&o.values&&o.values.constructor===Object&&null!=o.values[t]&&(t=o.values[t]),"number"==typeof e.properties[i]&&(t=Number(t)),"array"!=n&&"object"!=n||(t=JSON.parse(t)),e.properties[i]=t,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(i,t),s.onclose&&s.onclose(),u.close(),e.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(t,e){e=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},e||{});var i=document.createElement("div"),t=(i.className="graphdialog",i.innerHTML=t,i.is_modified=!1,this.canvas.getBoundingClientRect()),s=-20,o=-20,n=(t&&(s-=t.left,o-=t.top),e.position?(s+=e.position[0],o+=e.position[1]):e.event?(s+=e.event.clientX,o+=e.event.clientY):(s+=.5*this.canvas.width,o+=.5*this.canvas.height),i.style.left=s+"px",i.style.top=o+"px",this.canvas.parentNode.appendChild(i),e.checkForInput&&(t=[],t=i.querySelectorAll("input"))&&t.forEach(function(t){t.addEventListener("keydown",function(t){if(i.modified(),27==t.keyCode)i.close();else if(13!=t.keyCode)return;t.preventDefault(),t.stopPropagation()}),t.focus()}),i.modified=function(){i.is_modified=!0},i.close=function(){i.parentNode&&i.parentNode.removeChild(i)},null),r=!1,s=(i.addEventListener("mouseleave",function(t){r||(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!i.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(n=setTimeout(i.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),i.addEventListener("mouseenter",function(t){(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&n&&clearTimeout(n)}),i.querySelectorAll("select"));return s&&s.forEach(function(t){t.addEventListener("click",function(t){r++}),t.addEventListener("blur",function(t){r=0}),t.addEventListener("change",function(t){r=-1})}),i},LGraphCanvas.prototype.createPanel=function(t,e){var h=(e=e||{}).window||window,p=document.createElement("div");return p.className="litegraph dialog",p.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",p.header=p.querySelector(".dialog-header"),e.width&&(p.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(p.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable&&((e=document.createElement("span")).innerHTML="&#10005;",e.classList.add("close"),e.addEventListener("click",function(){p.close()}),p.header.appendChild(e)),p.title_element=p.querySelector(".dialog-title"),p.title_element.innerText=t,p.content=p.querySelector(".dialog-content"),p.alt_content=p.querySelector(".dialog-alt-content"),p.footer=p.querySelector(".dialog-footer"),p.close=function(){p.onClose&&"function"==typeof p.onClose&&p.onClose(),p.parentNode&&p.parentNode.removeChild(p),this.parentNode&&this.parentNode.removeChild(this)},p.toggleAltContent=function(t){var e;t=void 0!==t?(e=t?"block":"none",t?"none":"block"):(e="block"!=p.alt_content.style.display?"block":"none","block"!=p.alt_content.style.display?"none":"block"),p.alt_content.style.display=e,p.content.style.display=t},p.toggleFooterVisibility=function(t){t=void 0!==t?t?"block":"none":"block"!=p.footer.style.display?"block":"none",p.footer.style.display=t},p.clear=function(){this.content.innerHTML=""},p.addHTML=function(t,e,i){var s=document.createElement("div");return e&&(s.className=e),s.innerHTML=t,(i?p.footer:p.content).appendChild(s),s},p.addButton=function(t,e,i){var s=document.createElement("button");return s.innerText=t,s.options=i,s.classList.add("btn"),s.addEventListener("click",e),p.footer.appendChild(s),s},p.addSeparator=function(){var t=document.createElement("div");t.className="separator",p.content.appendChild(t)},p.addWidget=function(e,t,i,n,s){n=n||{};var o=String(i),r=("number"==(e=e.toLowerCase())&&(o=i.toFixed(3)),document.createElement("div")),a=(r.className="property",r.innerHTML="<span class='property_name'></span><span class='property_value'></span>",r.querySelector(".property_name").innerText=n.label||t,r.querySelector(".property_value"));function u(t,e){n.callback&&n.callback(t,e,n),s&&s(t,e,n)}return a.innerText=o,r.dataset.property=t,r.dataset.type=n.type||e,r.options=n,r.value=i,"code"==e?r.addEventListener("click",function(t){p.inner_showCodePad(this.dataset.property)}):"boolean"==e?(r.classList.add("boolean"),i&&r.classList.add("bool-on"),r.addEventListener("click",function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",u(t,this.value)})):"string"==e||"number"==e?(a.setAttribute("contenteditable",!0),a.addEventListener("keydown",function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())}),a.addEventListener("blur",function(){var t=this.innerText;u(this.parentNode.dataset.property,t="number"==this.parentNode.dataset.type?Number(t):t)})):"enum"!=e&&"combo"!=e||(o=LGraphCanvas.getPropertyPrintableValue(i,n.values),a.innerText=o,a.addEventListener("click",function(t){var e=n.values||[],s=this.parentNode.dataset.property,o=this;new LiteGraph.ContextMenu(e,{event:t,className:"dark",callback:function(t,e,i){return o.innerText=t,u(s,t),!1}},h)})),p.content.appendChild(r),r},p.onOpen&&"function"==typeof p.onOpen&&p.onOpen(),p},LGraphCanvas.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var i,s="";for(i in e)if(e[i]==t){s=i;break}return String(t)+" ("+s+")"}},LGraphCanvas.prototype.closePanels=function(){var t=document.querySelector("#node-panel");t&&t.close(),(t=document.querySelector("#option-panel"))&&t.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(t,e,i,s){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!(e&&e.event&&e.event.target&&e.event.target.lgraphcanvas))return void console.warn("Canvas not found");var o=e.event.target.lgraphcanvas}else o=this;o.closePanels();e=o.getCanvasWindow();function n(t,e,i){i&&i.key&&(t=i.key),i.values&&(e=Object.values(i.values).indexOf(e)),o[t]=e}panel=o.createPanel("Options",{closable:!0,window:e,onOpen:function(){o.OPTIONPANEL_IS_OPEN=!0},onClose:function(){o.OPTIONPANEL_IS_OPEN=!1,o.options_panel=null}}),(o.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var r,a=LiteGraph.availableCanvasOptions;for(r in a.sort(),a){var u=a[r];panel.addWidget("boolean",u,o[u],{key:u,on:"True",off:"False"},n)}o.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[o.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},n),panel.addSeparator(),panel.footer.innerHTML="",o.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(n){this.SELECTED_NODE=n,this.closePanels();var t=this.getCanvasWindow(),r=this,a=this.createPanel(n.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});function o(){a.content.innerHTML="",a.addHTML("<span class='node_type'>"+n.type+"</span><span class='node_desc'>"+(n.constructor.desc||"")+"</span><span class='separator'></span>"),a.addHTML("<h3>Properties</h3>");function t(t,e){switch(r.graph.beforeChange(n),t){case"Title":n.title=e;break;case"Mode":var i=Object.values(LiteGraph.NODE_MODES).indexOf(e);0<=i&&LiteGraph.NODE_MODES[i]?n.changeMode(i):console.warn("unexpected mode: "+e);break;case"Color":LGraphCanvas.node_colors[e]?(n.color=LGraphCanvas.node_colors[e].color,n.bgcolor=LGraphCanvas.node_colors[e].bgcolor):console.warn("unexpected color: "+e);break;default:n.setProperty(t,e)}r.graph.afterChange(),r.dirty_canvas=!0}a.addWidget("string","Title",n.title,{},t),a.addWidget("combo","Mode",LiteGraph.NODE_MODES[n.mode],{values:LiteGraph.NODE_MODES},t);var e,i="";for(e in void 0!==n.color&&(i=Object.keys(LGraphCanvas.node_colors).filter(function(t){return LGraphCanvas.node_colors[t].color==n.color})),a.addWidget("combo","Color",i,{values:Object.keys(LGraphCanvas.node_colors)},t),n.properties){var s=n.properties[e],o=n.getPropertyInfo(e);o.type;n.onAddPropertyToPanel&&n.onAddPropertyToPanel(e,a)||a.addWidget(o.widget||o.type,e,s,o,t)}a.addSeparator(),n.onShowCustomPanelInfo&&n.onShowCustomPanelInfo(a),a.footer.innerHTML="",a.addButton("Delete",function(){n.block_delete||(n.graph.remove(n),a.close())}).classList.add("delete")}(r.node_panel=a).id="node-panel",a.node=n,a.classList.add("settings"),a.inner_showCodePad=function(e){a.classList.remove("settings"),a.classList.add("centered"),a.alt_content.innerHTML="<textarea class='code'></textarea>";function i(){a.toggleAltContent(!1),a.toggleFooterVisibility(!0),s.parentNode.removeChild(s),a.classList.add("settings"),a.classList.remove("centered"),o()}var s=a.alt_content.querySelector("textarea"),t=(s.value=n.properties[e],s.addEventListener("keydown",function(t){"Enter"==t.code&&t.ctrlKey&&(n.setProperty(e,s.value),i())}),a.toggleAltContent(!0),a.toggleFooterVisibility(!1),s.style.height="calc(100% - 40px)",a.addButton("Assign",function(){n.setProperty(e,s.value),i()})),t=(a.alt_content.appendChild(t),a.addButton("Close",i));t.style.float="right",a.alt_content.appendChild(t)},o(),this.canvas.parentNode.appendChild(a)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(o){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),s=(t&&t.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function n(){if(s.clear(),o.inputs)for(var t=0;t<o.inputs.length;++t){var e,i=o.inputs[t];i.not_subgraph_input||((e=s.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=i.name,e.dataset.slot=t,e.querySelector(".name").innerText=i.name,e.querySelector(".type").innerText=i.type,e.querySelector("button").addEventListener("click",function(t){o.removeInput(Number(this.parentNode.dataset.slot)),n()}))}}s.node=o,s.classList.add("subgraph_dialog");return s.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(t){var e=this.parentNode,i=e.querySelector(".name").value,s=e.querySelector(".type").value;i&&-1==o.findInputSlot(i)&&(o.addInput(i,s),e.querySelector(".name").value="",e.querySelector(".type").value="",n())}),n(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(s){var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),o=(t&&t.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function n(){if(o.clear(),s.outputs)for(var t=0;t<s.outputs.length;++t){var e,i=s.outputs[t];i.not_subgraph_output||((e=o.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=i.name,e.dataset.slot=t,e.querySelector(".name").innerText=i.name,e.querySelector(".type").innerText=i.type,e.querySelector("button").addEventListener("click",function(t){s.removeOutput(Number(this.parentNode.dataset.slot)),n()}))}}o.node=s,o.classList.add("subgraph_dialog");t=o.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function e(){var t=this.parentNode,e=t.querySelector(".name").value,i=t.querySelector(".type").value;e&&-1==s.findOutputSlot(e)&&(s.addOutput(e,i),t.querySelector(".name").value="",t.querySelector(".type").value="",n())}return t.querySelector(".name").addEventListener("keydown",function(t){13==t.keyCode&&e.apply(this)}),t.querySelector("button").addEventListener("click",function(t){e.apply(this)}),n(),this.canvas.parentNode.appendChild(o),o},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var i=t[e];!i.node||i.node.graph&&i.graph==this.graph||i.close()}},LGraphCanvas.onMenuNodeCollapse=function(t,e,i,s,o){o.graph.beforeChange();function n(t){t.collapse()}var r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)n(o);else for(var a in r.selected_nodes)n(r.selected_nodes[a]);o.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(t,e,i,s,o){o.pin()},LGraphCanvas.onMenuNodeMode=function(t,e,i,s,n){return new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:i,callback:function(e){if(n){var i=Object.values(LiteGraph.NODE_MODES).indexOf(e),t=function(t){0<=i&&LiteGraph.NODE_MODES[i]?t.changeMode(i):(console.warn("unexpected mode: "+e),t.changeMode(LiteGraph.ALWAYS))},s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)t(n);else for(var o in s.selected_nodes)t(s.selected_nodes[o])}},parentMenu:s,node:n}),!1},LGraphCanvas.onMenuNodeColors=function(t,e,i,s,n){if(!n)throw"no node for color";var o,r=[];for(o in r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var a=LGraphCanvas.node_colors[o],t={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+a.color+"; background-color:"+a.bgcolor+"'>"+o+"</span>"};r.push(t)}return new LiteGraph.ContextMenu(r,{event:i,callback:function(t){if(n){var e=t.value?LGraphCanvas.node_colors[t.value]:null,i=function(t){e?t.constructor===LiteGraph.LGraphGroup?t.color=e.groupcolor:(t.color=e.color,t.bgcolor=e.bgcolor):(delete t.color,delete t.bgcolor)},s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)i(n);else for(var o in s.selected_nodes)i(s.selected_nodes[o]);n.setDirtyCanvas(!0,!0)}},parentMenu:s,node:n}),!1},LGraphCanvas.onMenuNodeShapes=function(t,e,i,s,o){if(o)return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:i,callback:function(e){if(o){o.graph.beforeChange();var t=function(t){t.shape=e},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)t(o);else for(var s in i.selected_nodes)t(i.selected_nodes[s]);o.graph.afterChange(),o.setDirtyCanvas(!0)}},parentMenu:s,node:o}),!1;throw"no node passed"},LGraphCanvas.onMenuNodeRemove=function(t,e,i,s,o){if(!o)throw"no node passed";function n(t){!1!==t.removable&&r.remove(t)}var r=o.graph,a=(r.beforeChange(),LGraphCanvas.active_canvas);if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)n(o);else for(var u in a.selected_nodes)n(a.selected_nodes[u]);r.afterChange(),o.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(t,e,i,s,o){var n,r,a=o.graph,u=LGraphCanvas.active_canvas;u&&((n=Object.values(u.selected_nodes||{})).length||(n=[o]),(r=LiteGraph.createNode("graph/subgraph")).pos=o.pos.concat(),a.add(r),r.buildFromNodes(n),u.deselectAllNodes(),o.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(t,e,i,s,o){o.graph.beforeChange();function n(t){var e;!1!==t.clonable&&(e=t.clone())&&(e.pos=[t.pos[0]+5,t.pos[1]+5],t.graph.add(e),r[e.id]=e)}var r={},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)n(o);else for(var u in a.selected_nodes)n(a.selected_nodes[u]);Object.keys(r).length&&a.selectNodes(r),o.graph.afterChange(),o.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var t,e=null;return this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],1<Object.keys(this.selected_nodes).length&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),e=this.getExtraMenuOptions&&(t=this.getExtraMenuOptions(this,e))?e.concat(t):e},LGraphCanvas.prototype.getNodeMenuOptions=function(t){var e,i=null;return t.getMenuOptions?i=t.getMenuOptions(this):(!(i=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}])!==t.resizable&&i.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),i.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),t.onGetInputs&&(e=t.onGetInputs())&&e.length&&(i[0].disabled=!1),t.onGetOutputs&&(e=t.onGetOutputs())&&e.length&&(i[1].disabled=!1),t.getExtraMenuOptions&&(e=t.getExtraMenuOptions(this,i))&&(e.push(null),i=e.concat(i)),!1!==t.clonable&&i.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&i.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),i.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(i,t),i},LGraphCanvas.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(u,t){var e,h=this,i=LGraphCanvas.active_canvas.getCanvasWindow(),s=null,o={event:t,callback:function(t,e,i){var s,o,n,r,a;t&&("Remove Slot"==t.content?(s=t.slot,u.graph.beforeChange(),s.input?u.removeInput(s.slot):s.output&&u.removeOutput(s.slot),u.graph.afterChange()):"Disconnect Links"==t.content?(s=t.slot,u.graph.beforeChange(),s.output?u.disconnectOutput(s.slot):s.input&&u.disconnectInput(s.slot),u.graph.afterChange()):"Rename Slot"==t.content&&(o=(s=t.slot).input?u.getInputInfo(s.slot):u.getOutputInfo(s.slot),n=h.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",e),(r=n.querySelector("input"))&&o&&(r.value=o.label||""),a=function(){u.graph.beforeChange(),r.value&&(o&&(o.label=r.value),h.setDirty(!0)),n.close(),u.graph.afterChange()},n.querySelector("button").addEventListener("click",a),r.addEventListener("keydown",function(t){if(n.is_modified=!0,27==t.keyCode)n.close();else if(13==t.keyCode)a();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}),r.focus()))},extra:u},n=(u&&(o.title=u.type),null);u&&(n=u.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=u),n?(s=[],u.getSlotMenuOptions?s=u.getSlotMenuOptions(n):(n&&n.output&&n.output.links&&n.output.links.length&&s.push({content:"Disconnect Links",slot:n}),(e=n.input||n.output).removable&&s.push(e.locked?"Cannot remove":{content:"Remove Slot",slot:n}),e.nameLocked||s.push({content:"Rename Slot",slot:n})),o.title=(n.input||n.output).type||"*",n.input&&n.input.type==LiteGraph.ACTION&&(o.title="Action"),n.output&&n.output.type==LiteGraph.EVENT&&(o.title="Event")):u?s=this.getNodeMenuOptions(u):(s=this.getCanvasMenuOptions(),(e=this.graph.getGroupOnPos(t.canvasX,t.canvasY))&&s.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:e,options:this.getGroupMenuOptions(e)}})),s&&new LiteGraph.ContextMenu(s,o,i)},LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(t,e,s){var o=this,i=(s=s||{},document.createElement("div")),n=!(i.className="litemenu-entry submenu");function r(t){var e=this.value,i=!0;if((o.current_submenu&&o.current_submenu.close(t),s.callback&&!0===s.callback.call(this,e,s,t,o,s.node)&&(i=!1),e)&&(e.callback&&!s.ignore_item_callbacks&&!0!==e.disabled&&!0===e.callback.call(this,e,s,t,o,s.extra)&&(i=!1),e.submenu)){if(!e.submenu.options)throw"ContextMenu submenu needs options";new o.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:o,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:s.autoopen});i=!1}i&&!o.lock&&o.close()}return null===e?i.classList.add("separator"):(i.innerHTML=e&&e.title?e.title:t,(i.value=e)&&(e.disabled&&(n=!0,i.classList.add("disabled")),e.submenu||e.has_submenu)&&i.classList.add("has_submenu"),"function"==typeof e?(i.dataset.value=t,i.onclick_callback=e):i.dataset.value=e,e.className&&(i.className+=" "+e.className)),this.root.appendChild(i),n||i.addEventListener("click",r),!n&&s.autoopen&&LiteGraph.pointerListenerAdd(i,"enter",function(t){var e=this.value;e&&e.has_submenu&&r.call(this,t)}),i},ContextMenu.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(t,e,i,s){var o=document.createEvent("CustomEvent");return o.initCustomEvent(e,!0,!0,i),o.srcElement=s,t.dispatchEvent?t.dispatchEvent(o):t.__events&&t.__events.dispatchEvent(o),o},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(t,e){var i=t.clientX,t=t.clientY,e=e.getBoundingClientRect();return!!e&&t>e.top&&t<e.top+e.height&&i>e.left&&i<e.left+e.width},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var i=[],s=0;s<e.length;s++)i.push(e[s]);for(s=0;s<i.length;s++)i[s].close?i[s].close():i[s].parentNode&&i[s].parentNode.removeChild(i[s])}},LiteGraph.extendClass=function(t,e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i]);if(e.prototype)for(var i in e.prototype)!e.prototype.hasOwnProperty(i)||t.prototype.hasOwnProperty(i)||(e.prototype.__lookupGetter__(i)?t.prototype.__defineGetter__(i,e.prototype.__lookupGetter__(i)):t.prototype[i]=e.prototype[i],e.prototype.__lookupSetter__(i)&&t.prototype.__defineSetter__(i,e.prototype.__lookupSetter__(i)))},CurveEditor.sampleCurve=function(t,e){if(e){for(var i=0;i<e.length-1;++i){var s,o=e[i],n=e[i+1];if(!(n[0]<t))return s=n[0]-o[0],Math.abs(s)<1e-5?o[1]:(s=(t-o[0])/s,o[1]*(1-s)+n[1]*s)}return 0}},CurveEditor.prototype.draw=function(t,e,i,s,o,n){var r=this.points;if(r){var a=(this.size=e)[0]-2*this.margin,u=e[1]-2*this.margin;o=o||"#666",t.save(),t.translate(this.margin,this.margin),s&&(t.fillStyle="#111",t.fillRect(0,0,a,u),t.fillStyle="#222",t.fillRect(.5*a,0,1,u),t.strokeStyle="#333",t.strokeRect(0,0,a,u)),t.strokeStyle=o,n&&(t.globalAlpha=.5),t.beginPath();for(var h=0;h<r.length;++h){var p=r[h];t.lineTo(p[0]*a,(1-p[1])*u)}if(t.stroke(),t.globalAlpha=1,!n)for(h=0;h<r.length;++h){p=r[h];t.fillStyle=this.selected==h?"#FFF":this.nearest==h?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*a,(1-p[1])*u,2,0,2*Math.PI),t.fill()}t.restore()}},CurveEditor.prototype.onMouseDown=function(t,e){var i,s,o,n=this.points;if(n&&!(t[1]<0))return i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=t[0]-this.margin,t=t[1]-this.margin,e=30/e.ds.scale,this.selected=this.getCloserPoint([o,t],e),-1==this.selected&&(n.push(e=[o/i,1-t/s]),n.sort(function(t,e){return t[0]-e[0]}),this.selected=n.indexOf(e),this.must_update=!0),-1!=this.selected||void 0},CurveEditor.prototype.onMouseMove=function(t,e){var i,s,o,n,r=this.points;!r||(i=this.selected)<0||(s=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),n=[t[0]-this.margin,t[1]-this.margin],e=30/e.ds.scale,this._nearest=this.getCloserPoint(n,e),(n=r[i])&&(!(e=0==i||i==r.length-1)&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)?(r.splice(i,1),this.selected=-1):(n[0]=e?0==i?0:1:clamp(s,0,1),n[1]=1-clamp(o,0,1),r.sort(function(t,e){return t[0]-e[0]}),this.selected=r.indexOf(n),this.must_update=!0)))},CurveEditor.prototype.onMouseUp=function(t,e){return!(this.selected=-1)},CurveEditor.prototype.getCloserPoint=function(t,e){var i=this.points;if(!i)return-1;e=e||30;for(var s=this.size[0]-2*this.margin,o=this.size[1]-2*this.margin,n=i.length,r=[0,0],a=1e6,u=-1,h=0;h<n;++h){var p=i[h],p=(r[0]=p[0]*s,r[1]=(1-p[1])*o,r[0]<t[0]&&0,vec2.distance(t,r));a<p||e<p||(u=h,a=p)}return u},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(t,e,i,s=!1){if(t&&t.addEventListener&&e&&"function"==typeof i){var o=LiteGraph.pointerevents_method,n=e;if("pointer"==o&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+n+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),n){case"down":o="touch",n="start";break;case"move":o="touch";break;case"up":o="touch",n="end";break;case"cancel":o="touch";break;case"enter":console.log("debug: Should I send a move event?");break;default:console.warn("PointerEvent not available in this browser ? The event "+n+" would not be called")}switch(n){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+n,i,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=o)return t.addEventListener(o+n,i,s);default:return t.addEventListener(n,i,s)}}},LiteGraph.pointerListenerRemove=function(t,e,i,s=!1){if(t&&t.removeEventListener&&e&&"function"==typeof i)switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":"pointer"!=LiteGraph.pointerevents_method&&"mouse"!=LiteGraph.pointerevents_method||t.removeEventListener(LiteGraph.pointerevents_method+e,i,s);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return t.removeEventListener(LiteGraph.pointerevents_method+e,i,s);default:return t.removeEventListener(e,i,s)}},global.clamp=clamp,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),"undefined"!=typeof exports&&(exports.LiteGraph=this.LiteGraph,exports.LGraph=this.LGraph,exports.LLink=this.LLink,exports.LGraphNode=this.LGraphNode,exports.LGraphGroup=this.LGraphGroup,exports.DragAndScale=this.DragAndScale,exports.LGraphCanvas=this.LGraphCanvas,exports.ContextMenu=this.ContextMenu),(t=>{var d=t.LiteGraph;function e(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}function i(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new d.LGraph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}function s(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var e=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(t){t&&e.setProperty("name",t)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(t){e.setProperty("type",t)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(t){e.setProperty("value",t)}),this.widgets_up=!0,this.size=[180,90]}function o(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""};this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}function n(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}function r(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}function a(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}function u(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}function h(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}function p(){this.addInput("parse",d.ACTION),this.addInput("json","string"),this.addOutput("done",d.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}function l(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}function c(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}function _(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}function g(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}function f(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}function v(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}function m(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}function y(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}function x(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var t=this;this.addWidget("button","clear","",function(){t._result={}}),this.size=this.computeSize()}function b(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:b.LITEGRAPH},this.value=null}function T(){this.size=[60,30],this.addInput("data",0),this.addInput("download",d.ACTION),this.properties={filename:"data.json"},this.value=null;var e=this;this.addWidget("button","Download","",function(t){e.value&&e.downloadAsFile()})}function E(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}function w(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}function L(){this.mode=d.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",d.EVENT),this.addInput("msg",0)}function O(){this.mode=d.ON_EVENT,this.addProperty("msg",""),this.addInput("",d.EVENT);this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}function I(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}function C(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:C.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:C.values}),this.size=[80,60]}e.title="Time",e.desc="Time",e.prototype.onExecute=function(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)},d.registerNodeType("basic/time",e),i.title="Subgraph",i.desc="Graph inside a node",i.title_color="#334",i.prototype.onGetInputs=function(){return[["enabled","boolean"]]},i.prototype.onDblClick=function(t,e,i){var s=this;setTimeout(function(){i.openSubgraph(s.subgraph)},10)},i.prototype.onAction=function(t,e){this.subgraph.onAction(t,e)},i.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);this.subgraph.setInputData(e.name,i)}if(this.subgraph.runStep(),this.outputs)for(t=0;t<this.outputs.length;t++){var s=this.outputs[t],i=this.subgraph.getOutputData(s.name);this.setOutputData(t,i)}}},i.prototype.sendEventToAllNodes=function(t,e,i){this.enabled&&this.subgraph.sendEventToAllNodes(t,e,i)},i.prototype.onDrawBackground=function(t,e,i,s){var o,n;this.flags.collapsed||(o=this.size[1]-d.NODE_TITLE_HEIGHT+.5,n=d.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+o,this.size[0],d.NODE_TITLE_HEIGHT),s=d.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+o,this.size[0]/2,d.NODE_TITLE_HEIGHT),t.fillStyle=n?"#555":"#222",t.beginPath(),this._shape==d.BOX_SHAPE?s?t.rect(0,o,this.size[0]/2+1,d.NODE_TITLE_HEIGHT):t.rect(this.size[0]/2,o,this.size[0]/2+1,d.NODE_TITLE_HEIGHT):s?t.roundRect(0,o,this.size[0]/2+1,d.NODE_TITLE_HEIGHT,[0,0,8,8]):t.roundRect(this.size[0]/2,o,this.size[0]/2+1,d.NODE_TITLE_HEIGHT,[0,0,8,8]),n?t.fill():t.fillRect(0,o,this.size[0]+1,d.NODE_TITLE_HEIGHT),t.textAlign="center",t.font="24px Arial",t.fillStyle=n?"#DDD":"#999",t.fillText("+",.25*this.size[0],24+o),t.fillText("+",.75*this.size[0],24+o))},i.prototype.onMouseDown=function(t,e,i){var s=this.size[1]-d.NODE_TITLE_HEIGHT+.5;console.log(0),e[1]>s&&(e[0]<this.size[0]/2?(console.log(1),i.showSubgraphPropertiesDialog(this)):(console.log(2),i.showSubgraphPropertiesDialogRight(this)))},i.prototype.computeSize=function(){var t=this.inputs?this.inputs.length:0,e=this.outputs?this.outputs.length:0;return[200,Math.max(t,e)*d.NODE_SLOT_HEIGHT+d.NODE_TITLE_HEIGHT]},i.prototype.onSubgraphTrigger=function(t,e){t=this.findOutputSlot(t);-1!=t&&this.triggerSlot(t)},i.prototype.onSubgraphNewInput=function(t,e){-1==this.findInputSlot(t)&&this.addInput(t,e)},i.prototype.onSubgraphRenamedInput=function(t,e){t=this.findInputSlot(t);-1!=t&&(this.getInputInfo(t).name=e)},i.prototype.onSubgraphTypeChangeInput=function(t,e){t=this.findInputSlot(t);-1!=t&&(this.getInputInfo(t).type=e)},i.prototype.onSubgraphRemovedInput=function(t){t=this.findInputSlot(t);-1!=t&&this.removeInput(t)},i.prototype.onSubgraphNewOutput=function(t,e){-1==this.findOutputSlot(t)&&this.addOutput(t,e)},i.prototype.onSubgraphRenamedOutput=function(t,e){t=this.findOutputSlot(t);-1!=t&&(this.getOutputInfo(t).name=e)},i.prototype.onSubgraphTypeChangeOutput=function(t,e){t=this.findOutputSlot(t);-1!=t&&(this.getOutputInfo(t).type=e)},i.prototype.onSubgraphRemovedOutput=function(t){t=this.findOutputSlot(t);-1!=t&&this.removeOutput(t)},i.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Open",callback:function(){t.openSubgraph(e.subgraph)}}]},i.prototype.onResize=function(t){t[1]+=20},i.prototype.serialize=function(){var t=d.LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t},i.prototype.reassignSubgraphUUIDs=function(t){let e={nodeIDs:{},linkIDs:{}};for(var i of t.nodes){var s=i.id,o=d.uuidv4();if(i.id=o,e.nodeIDs[s]||e.nodeIDs[o])throw new Error(`New/old node UUID wasn't unique in changed map! ${s} `+o);e.nodeIDs[s]=o,e.nodeIDs[o]=s}for(var n of t.links){var r=n[0],a=d.uuidv4();if(n[0]=a,e.linkIDs[r]||e.linkIDs[a])throw new Error(`New/old link UUID wasn't unique in changed map! ${r} `+a);e.linkIDs[r]=a,e.linkIDs[a]=r;a=n[1],r=n[3];if(!e.nodeIDs[a])throw new Error("Old node UUID not found in mapping! "+a);if(n[1]=e.nodeIDs[a],!e.nodeIDs[r])throw new Error("Old node UUID not found in mapping! "+r);n[3]=e.nodeIDs[r]}for(var u of t.nodes){if(u.inputs)for(var h of u.inputs)h.link&&(h.link=e.linkIDs[h.link]);if(u.outputs)for(var p of u.outputs)p.links&&(p.links=p.links.map(t=>e.linkIDs[t]))}for(var l of t.nodes)"graph/subgraph"===l.type&&(l=reassignGraphUUIDs(l.subgraph),e.nodeIDs.assign(l.nodeIDs),e.linkIDs.assign(l.linkIDs))},i.prototype.clone=function(){var t,e=d.createNode(this.type),i=this.serialize();return d.use_uuids&&(t=d.cloneObject(i.subgraph),this.reassignSubgraphUUIDs(t),i.subgraph=t),delete i.id,delete i.inputs,delete i.outputs,e.configure(i),e},i.prototype.buildFromNodes=function(t){for(var e={},i=0,s=0;s<t.length;++s)e[(o=t[s]).id]=o,i=Math.min(o.pos[0],i),Math.max(o.pos[0],i);for(var o,s=0;s<t.length;++s){if((o=t[s]).inputs)for(var n=0;n<o.inputs.length;++n){var r=o.inputs[n];r&&r.link&&((h=o.graph.links[r.link])&&!e[h.origin_id]&&this.subgraph.addInput(r.name,h.type))}if(o.outputs)for(n=0;n<o.outputs.length;++n){var a=o.outputs[n];if(a&&a.links&&a.links.length)for(var u=0;u<a.links.length;++u){var h=o.graph.links[a.links[u]];if(h&&!e[h.target_id]){0;break}}}}},d.Subgraph=i,d.registerNodeType("graph/subgraph",i),s.title="Input",s.desc="Input of the graph",s.prototype.onConfigure=function(){this.updateType()},s.prototype.updateType=function(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(d.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),"number"==t?(this.value_widget.type="number",this.value_widget.value=0):"boolean"==t?(this.value_widget.type="toggle",this.value_widget.value=!0):"string"==t?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)},s.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,e):this.graph.addInput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},s.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},s.prototype.onAction=function(t,e){this.properties.type==d.EVENT&&this.triggerSlot(0,e)},s.prototype.onExecute=function(){var t=this.properties.name,t=this.graph.inputs[t];t?this.setOutputData(0,(void 0!==t.value?t:this.properties).value):this.setOutputData(0,this.properties.value)},s.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},d.GraphInput=s,d.registerNodeType("graph/input",s),o.title="Output",o.desc="Output of the graph",o.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,e):this.graph.addOutput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},o.prototype.updateType=function(){var t=this.properties.type;this.type_widget&&(this.type_widget.value=t),this.inputs[0].type!=t&&("action"!=t&&"event"!=t||(t=d.EVENT),d.isValidConnection(this.inputs[0].type,t)||this.disconnectInput(0),this.inputs[0].type=t),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,t)},o.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},o.prototype.onAction=function(t,e){this.properties.type==d.ACTION&&this.graph.trigger(this.properties.name,e)},o.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},d.GraphOutput=o,d.registerNodeType("graph/output",o),n.title="Const Number",n.desc="Constant number",n.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},n.prototype.setValue=function(t){this.setProperty("value",t)},n.prototype.onDrawBackground=function(t){this.outputs[0].label=this.properties.value.toFixed(3)},d.registerNodeType("basic/const",n),r.title="Const Boolean",r.desc="Constant boolean",r.prototype.getTitle=n.prototype.getTitle,r.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},r.prototype.setValue=n.prototype.setValue,r.prototype.onGetInputs=function(){return[["toggle",d.ACTION]]},r.prototype.onAction=function(t){this.setValue(!this.properties.value)},d.registerNodeType("basic/boolean",r),a.title="Const String",a.desc="Constant string",a.prototype.getTitle=n.prototype.getTitle,a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},a.prototype.setValue=n.prototype.setValue,a.prototype.onDropFile=function(t){var e=this,i=new FileReader;i.onload=function(t){e.setProperty("value",t.target.result)},i.readAsText(t)},d.registerNodeType("basic/string",a),u.title="Const Object",u.desc="Constant Object",u.prototype.onExecute=function(){this.setOutputData(0,this._object)},d.registerNodeType("basic/object",u),h.title="Const File",h.desc="Fetches a file from an url",h["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},h.prototype.onPropertyChanged=function(t,e){"url"==t&&(null==e||""==e?this._data=null:this.fetchFile(e))},h.prototype.onExecute=function(){var t=this.getInputData(0)||this.properties.url;!t||t==this._url&&this._type==this.properties.type||this.fetchFile(t),this.setOutputData(0,this._data)},h.prototype.setValue=n.prototype.setValue,h.prototype.fetchFile=function(e){var i=this;e&&e.constructor===String?(this._url=e,this._type=this.properties.type,"http"==e.substr(0,4)&&d.proxy&&(e=d.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(t){if(t.ok)return"arraybuffer"==i.properties.type?t.arrayBuffer():"text"==i.properties.type?t.text():"json"==i.properties.type?t.json():"blob"==i.properties.type?t.blob():void 0;throw new Error("File not found")}).then(function(t){i._data=t,i.boxcolor="#AEA"}).catch(function(t){i._data=null,i.boxcolor="red",console.error("error fetching file:",e)})):(i._data=null,i.boxcolor=null)},h.prototype.onDropFile=function(t){var e=this,i=(this._url=t.name,this._type=this.properties.type,this.properties.url=t.name,new FileReader);if(i.onload=function(t){e.boxcolor="#AEA";t=t.target.result;"json"==e.properties.type&&(t=JSON.parse(t)),e._data=t},"arraybuffer"==e.properties.type)i.readAsArrayBuffer(t);else if("text"==e.properties.type||"json"==e.properties.type)i.readAsText(t);else if("blob"==e.properties.type)return i.readAsBinaryString(t)},d.registerNodeType("basic/file",h),p.title="JSON Parse",p.desc="Parses JSON String into object",p.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch(t){this.boxcolor="red"}},p.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},p.prototype.onAction=function(t){"parse"==t&&this.parse()},d.registerNodeType("basic/jsonparse",p),l.title="Const Data",l.desc="Constant Data",l.prototype.onPropertyChanged=function(t,e){if(null!=(this.widget.value=e)&&""!=e)try{this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},l.prototype.onExecute=function(){this.setOutputData(0,this._value)},l.prototype.setValue=n.prototype.setValue,d.registerNodeType("basic/data",l),c.title="Const Array",c.desc="Constant Array",c.prototype.onPropertyChanged=function(t,e){if(null!=(this.widget.value=e)&&""!=e)try{"["!=e[0]?this._value=JSON.parse("["+e+"]"):this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},c.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=new Array),this._value.length=t.length;for(var e=0;e<t.length;++e)this._value[e]=t[e]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},c.prototype.setValue=n.prototype.setValue,d.registerNodeType("basic/array",c),_.title="Set Array",_.desc="Sets index of array",_.prototype.onExecute=function(){var t,e=this.getInputData(0);e&&void 0!==(t=this.getInputData(1))&&(this.properties.index&&(e[Math.floor(this.properties.index)]=t),this.setOutputData(0,e))},d.registerNodeType("basic/set_array",_),g.title="Array[i]",g.desc="Returns an element from an array",g.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);null==e&&(e=this.properties.index),null!=t&&null!=e&&this.setOutputData(0,t[Math.floor(Number(e))])},d.registerNodeType("basic/array[]",g),f.title="Table[row][col]",f.desc="Returns an element from a table",f.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);null==e&&(e=this.properties.row),null==i&&(i=this.properties.column),null!=t&&null!=e&&null!=i&&((e=t[Math.floor(Number(e))])?this.setOutputData(0,e[Math.floor(Number(i))]):this.setOutputData(0,null))},d.registerNodeType("basic/table[][]",f),v.title="Object property",v.desc="Outputs the property of an object",v.prototype.setValue=function(t){this.properties.value=t,this.widget.value=t},v.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},v.prototype.onPropertyChanged=function(t,e){this.widget.value=e},v.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t[this.properties.value])},d.registerNodeType("basic/object_property",v),m.title="Object keys",m.desc="Outputs an array with the keys of an object",m.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Object.keys(t))},d.registerNodeType("basic/object_keys",m),y.title="Set Object",y.desc="Adds propertiesrty to object",y.prototype.onExecute=function(){var t,e=this.getInputData(0);e&&void 0!==(t=this.getInputData(1))&&(this.properties.property&&(e[this.properties.property]=t),this.setOutputData(0,e))},d.registerNodeType("basic/set_object",y),x.title="Merge Objects",x.desc="Creates an object copying properties from others",x.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this._result;if(t)for(var s in t)i[s]=t[s];if(e)for(var s in e)i[s]=e[s];this.setOutputData(0,i)},d.registerNodeType("basic/merge_objects",x),b.title="Variable",b.desc="store/read variable value",b["@container"]={type:"enum",values:{litegraph:b.LITEGRAPH=0,graph:b.GRAPH=1,global:b.GLOBALSCOPE=2}},b.prototype.onExecute=function(){var t=this.getContainer();this.isInputConnected(0)?(this.value=this.getInputData(0),t[this.properties.varname]=this.value,this.setOutputData(0,this.value)):this.setOutputData(0,t[this.properties.varname])},b.prototype.getContainer=function(){switch(this.properties.container){case b.GRAPH:return this.graph?this.graph.vars:{};case b.GLOBALSCOPE:return t;default:return d.Globals}},b.prototype.getTitle=function(){return this.properties.varname},d.registerNodeType("basic/variable",b),d.wrapFunctionAsNode("basic/length",function(t){return t&&null!=t.length?Number(t.length):0},[""],"number"),d.wrapFunctionAsNode("basic/not",function(t){return!t},[""],"boolean"),T.title="Download",T.desc="Download some data",T.prototype.downloadAsFile=function(){var t,e;null!=this.value&&(e=null,e=this.value.constructor===String?this.value:JSON.stringify(this.value),e=new Blob([e]),t=URL.createObjectURL(e),(e=document.createElement("a")).setAttribute("href",t),e.setAttribute("download",this.properties.filename),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),setTimeout(function(){URL.revokeObjectURL(t)},6e4))},T.prototype.onAction=function(t,e){var i=this;setTimeout(function(){i.downloadAsFile()},100)},T.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},T.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},d.registerNodeType("basic/download",T),E.title="Watch",E.desc="Show value of input",E.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},E.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},E.toString=function(t){if(null==t)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor!==Array)return String(t);for(var e="[",i=0;i<t.length;++i)e+=E.toString(t[i])+(i+1!=t.length?",":"");return e+="]"},E.prototype.onDrawBackground=function(t){this.inputs[0].label=E.toString(this.value)},d.registerNodeType("basic/watch",E),w.title="Cast",w.desc="Allows to connect different types",w.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},d.registerNodeType("basic/cast",w),L.title="Console",L.desc="Show value inside the console",L.prototype.onAction=function(t,e){var i=this.getInputData(1);i=(i=i||this.properties.msg)||"Event: "+e,"log"==t?console.log(i):"warn"==t?console.warn(i):"error"==t&&console.error(i)},L.prototype.onExecute=function(){var t=this.getInputData(1);null!=(t=t||this.properties.msg)&&void 0!==t&&(this.properties.msg=t,console.log(t))},L.prototype.onGetInputs=function(){return[["log",d.ACTION],["warn",d.ACTION],["error",d.ACTION]]},d.registerNodeType("basic/console",L),O.title="Alert",O.desc="Show an alert window",O.color="#510",O.prototype.onConfigure=function(t){this.widget.value=t.properties.msg},O.prototype.onAction=function(t,e){var i=this.properties.msg;setTimeout(function(){alert(i)},10)},d.registerNodeType("basic/alert",O),I.prototype.onConfigure=function(t){t.properties.onExecute&&d.allow_scripts?this.compileCode(t.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},I.title="Script",I.desc="executes a code (max 256 characters)",I.widgets_info={onExecute:{type:"code"}},I.prototype.onPropertyChanged=function(t,e){"onExecute"==t&&d.allow_scripts?this.compileCode(e):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},I.prototype.compileCode=function(t){if(this._func=null,256<t.length)console.warn("Script too long, max 256 chars");else{for(var e=t.toLowerCase(),i=["script","body","document","eval","nodescript","function"],s=0;s<i.length;++s)if(-1!=e.indexOf(i[s]))return void console.warn("invalid script");try{this._func=new Function("A","B","C","DATA","node",t)}catch(t){console.error("Error parsing script"),console.error(t)}}},I.prototype.onExecute=function(){if(this._func)try{var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);this.setOutputData(0,this._func(t,e,i,this.data,this))}catch(t){console.error("Error in script"),console.error(t)}},I.prototype.onGetOutputs=function(){return[["C",""]]},d.registerNodeType("basic/script",I),C["@OP"]={type:"enum",title:"operation",values:C.values=["==","!="]},C.title="Compare *",C.desc="evaluates condition between A and B",C.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},C.prototype.onExecute=function(){var t=this.getInputData(0),e=(void 0===t?t=this.properties.A:this.properties.A=t,this.getInputData(1)),i=(void 0===e?e=this.properties.B:this.properties.B=e,!1);if(typeof t==typeof e)switch(this.properties.OP){case"==":case"!=":if(i=!0,"object"==typeof t){var s=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(e);if(s.length!=o.length)i=!1;else for(var n=0;n<s.length;n++){var r=s[n];if(t[r]!==e[r]){i=!1;break}}}else i=t==e;"!="==this.properties.OP&&(i=!i)}this.setOutputData(0,i),this.setOutputData(1,!i)},d.registerNodeType("basic/CompareValues",C)})(this),(t=>{var s=t.LiteGraph;function e(){this.size=[60,30],this.addInput("event",s.ACTION)}function i(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",s.EVENT),this.addOutput("change",s.EVENT),this.addOutput("false",s.EVENT),this.properties={only_on_change:!0},this.prev=0}function o(){var t=this;this.addInput("",s.ACTION),this.addInput("",s.ACTION),this.addInput("",s.ACTION),this.addOutput("",s.EVENT),this.addOutput("",s.EVENT),this.addOutput("",s.EVENT),this.addWidget("button","+",null,function(){t.addInput("",s.ACTION),t.addOutput("",s.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}function n(){var t=this;this.addInput("",s.ACTION),this.addInput("",s.ACTION),this.addOutput("",s.EVENT),this.addWidget("button","+",null,function(){t.addInput("",s.ACTION),t.size[0]=90}),this.size=[90,70],this.ready=[]}function r(){var t=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",s.ACTION),this.addInput("reset",s.ACTION),this.addOutput("index","number"),this.addOutput("",s.EVENT),this.addOutput("",s.EVENT),this.addOutput("",s.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){t.addOutput("",s.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}function a(){this.size=[60,30],this.addInput("event",s.ACTION),this.addOutput("event",s.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}function u(){this.addInput("in",s.ACTION),this.addInput("cond","boolean"),this.addOutput("true",s.EVENT),this.addOutput("false",s.EVENT),this.size=[120,60],this._value=!1}function h(){this.addInput("inc",s.ACTION),this.addInput("dec",s.ACTION),this.addInput("reset",s.ACTION),this.addOutput("change",s.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}function p(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",s.ACTION),this.addOutput("on_time",s.EVENT),this._pending=[]}function l(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",s.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}function d(){this.addInput("go",s.ACTION),this.addInput("green",s.ACTION),this.addInput("red",s.ACTION),this.addOutput("continue",s.EVENT),this.addOutput("blocked",s.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._ready=!1})}function c(){this.addInput("in",s.ACTION),this.addInput("reset",s.ACTION),this.addOutput("out",s.EVENT),this._once=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._once=!1})}function _(){this.addInput("data",0),this.addInput("assign",s.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var t=this;this.addWidget("button","store","",function(){t.properties.data=t._last_value})}e.title="Log Event",e.desc="Log event in console",e.prototype.onAction=function(t,e,i){console.log(t,e)},s.registerNodeType("events/log",e),i.title="TriggerEvent",i.desc="Triggers event if input evaluates to true",i.prototype.onExecute=function(t,e){var i=this.getInputData(0),s=i!=this.prev,o=(s=0===this.prev?!1:s)&&this.properties.only_on_change||!s&&!this.properties.only_on_change;i&&o&&this.triggerSlot(0,t,null,e),!i&&o&&this.triggerSlot(2,t,null,e),s&&this.triggerSlot(1,t,null,e),this.prev=i},s.registerNodeType("events/trigger",i),o.title="Sequence",o.desc="Triggers a sequence of events when an event arrives",o.prototype.getTitle=function(){return""},o.prototype.onAction=function(t,e,i){if(this.outputs){i=i||{};for(var s=0;s<this.outputs.length;++s){this.outputs[s];i.action_call?i.action_call=i.action_call+"_seq_"+s:i.action_call=this.id+"_"+(t||"action")+"_seq_"+s+"_"+Math.floor(9999*Math.random()),this.triggerSlot(s,e,null,i)}}},s.registerNodeType("events/sequence",o),n.title="WaitAll",n.desc="Wait until all input events arrive then triggers output",n.prototype.getTitle=function(){return""},n.prototype.onDrawBackground=function(t){if(!this.flags.collapsed)for(var e=0;e<this.inputs.length;++e){var i=e*s.NODE_SLOT_HEIGHT+10;t.fillStyle=this.ready[e]?"#AFB":"#000",t.fillRect(20,i,10,10)}},n.prototype.onAction=function(t,e,i,s){if(null!=s){this.ready.length=this.outputs.length,this.ready[s]=!0;for(var o=0;o<this.ready.length;++o)if(!this.ready[o])return;this.reset(),this.triggerSlot(0)}},n.prototype.reset=function(){this.ready.length=0},s.registerNodeType("events/waitAll",n),r.title="Stepper",r.desc="Trigger events sequentially when an tick arrives",r.prototype.onDrawBackground=function(t){var e,i;this.flags.collapsed||(i=this.properties.index||0,t.fillStyle="#AFB",e=this.size[0],i=(i+1)*s.NODE_SLOT_HEIGHT+4,t.beginPath(),t.moveTo(e-30,i),t.lineTo(e-30,i+s.NODE_SLOT_HEIGHT),t.lineTo(e-15,i+.5*s.NODE_SLOT_HEIGHT),t.fill())},r.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.floor(t),(t=clamp(t,0,this.outputs?this.outputs.length-2:0))!=this.properties.index)&&(this.properties.index=t,this.triggerSlot(t+1)),this.setOutputData(0,this.properties.index)},r.prototype.onAction=function(t,e){"reset"==t?this.properties.index=0:"step"==t&&(this.triggerSlot(this.properties.index+1,e),t=this.outputs?this.outputs.length-1:0,this.properties.index=(this.properties.index+1)%t)},s.registerNodeType("events/stepper",r),a.title="Filter Event",a.desc="Blocks events that do not match the filter",a.prototype.onAction=function(t,e,i){if(null!=e&&(!this.properties.equal_to||this.properties.equal_to==e)){if(this.properties.has_property){var s=e[this.properties.has_property];if(null==s)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=s)return}this.triggerSlot(0,e,null,i)}},s.registerNodeType("events/filter",a),u.title="Branch",u.desc="If condition is true, outputs triggers true, otherwise false",u.prototype.onExecute=function(){this._value=this.getInputData(1)},u.prototype.onAction=function(t,e,i){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,e,null,i)},s.registerNodeType("events/branch",u),h.title="Counter",h.desc="Counts events",h.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},h.prototype.onAction=function(t,e,i){var s=this.num;"inc"==t?this.num+=1:"dec"==t?--this.num:"reset"==t&&(this.num=0),this.num!=s&&this.trigger("change",this.num)},h.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.fillStyle="#AAA",t.font="20px Arial",t.textAlign="center",t.fillText(this.num,.5*this.size[0],.5*this.size[1]))},h.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},s.registerNodeType("events/counter",h),p.title="Delay",p.desc="Delays one event",p.prototype.onAction=function(t,e,i){var s=this.properties.time_in_ms;s<=0?this.trigger(null,e,i):this._pending.push([s,e])},p.prototype.onExecute=function(t,e){var i=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var s=0;s<this._pending.length;++s){var o=this._pending[s];o[0]-=i,0<o[0]||(this._pending.splice(s,1),--s,this.trigger(null,o[1],e))}},p.prototype.onGetInputs=function(){return[["event",s.ACTION],["time_in_ms","number"]]},s.registerNodeType("events/delay",p),l.title="Timer",l.desc="Sends an event every N milliseconds",l.prototype.onStart=function(){this.time=0},l.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},l.on_color="#AAA",l.off_color="#222",l.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?l.on_color:l.off_color,this.triggered=!1},l.prototype.onExecute=function(){var t=1e3*this.graph.elapsed_time,e=0==this.time;this.time+=t,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),!e&&(this.time<this.last_interval||isNaN(this.last_interval))?this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!1):(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!0))},l.prototype.onGetInputs=function(){return[["interval","number"]]},l.prototype.onGetOutputs=function(){return[["tick","boolean"]]},s.registerNodeType("events/timer",l),d.title="Semaphore Event",d.desc="Until both events are not triggered, it doesnt continue.",d.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},d.prototype.onAction=function(t,e){"go"==t?this.triggerSlot(this._ready?0:1):"green"==t?this._ready=!0:"red"==t&&(this._ready=!1)},s.registerNodeType("events/semaphore",d),c.title="Once",c.desc="Only passes an event once, then gets locked",c.prototype.onAction=function(t,e){"in"!=t||this._once?"reset"==t&&(this._once=!1):(this._once=!0,this.triggerSlot(0,e))},s.registerNodeType("events/once",c),_.title="Data Store",_.desc="Stores data and only changes when event is received",_.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},_.prototype.onAction=function(t,e,i){this.properties.data=this._last_value},_.prototype.onSerialize=function(t){null!=t.data&&(0==this.properties.serialize||t.data.constructor!==String&&t.data.constructor!==Number&&t.data.constructor!==Boolean&&t.data.constructor!==Array&&t.data.constructor!==Object)&&(t.data=null)},s.registerNodeType("basic/data_store",_)})(this),(t=>{var i=t.LiteGraph;function s(){this.addOutput("",i.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}function e(){this.addInput("","boolean"),this.addInput("e",i.ACTION),this.addOutput("v","boolean"),this.addOutput("e",i.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}function o(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}function n(){this.addOutput("","string"),this.addOutput("change",i.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var e=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(t){e.properties.value=t,e.triggerSlot(1,t)},{property:"value",values:this._values})}function r(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}function a(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var e=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(t){e.properties.value=t},this.properties),this.widgets_up=!0}function u(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}function h(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}function p(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}function l(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}s.title="Button",s.desc="Triggers an event",s.font="Arial",s.prototype.onDrawForeground=function(t){var e;!this.flags.collapsed&&(t.fillStyle="black",t.fillRect(11,11,this.size[0]-20,this.size[1]-20),t.fillStyle="#AAF",t.fillRect(9,9,this.size[0]-20,this.size[1]-20),t.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",t.fillRect(10,10,this.size[0]-20,this.size[1]-20),this.properties.text||0===this.properties.text)&&(e=this.properties.font_size||30,t.textAlign="center",t.fillStyle=this.clicked?"black":"white",t.font=e+"px "+s.font,t.fillText(this.properties.text,.5*this.size[0],.5*this.size[1]+.3*e),t.textAlign="left")},s.prototype.onMouseDown=function(t,e){if(1<e[0]&&1<e[1]&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},s.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},s.prototype.onMouseUp=function(t){this.clicked=!1},i.registerNodeType("widget/button",s),e.title="Toggle",e.desc="Toggles between true or false",e.prototype.onDrawForeground=function(t){var e,i,s;this.flags.collapsed||(e=.5*this.size[1],i=.8*this.size[1],t.font=this.properties.font||(.8*e).toFixed(0)+"px Arial",s=t.measureText(this.title).width,s=.5*(this.size[0]-(s+e)),t.fillStyle="#AAA",t.fillRect(s,i-e,e,e),t.fillStyle=this.properties.value?"#AEF":"#000",t.fillRect(s+.25*e,i-e+.25*e,.5*e,.5*e),t.textAlign="left",t.fillStyle="#AAA",t.fillText(this.title,1.2*e+s,.85*i),t.textAlign="left")},e.prototype.onAction=function(t){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},e.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t),this.setOutputData(0,this.properties.value)},e.prototype.onMouseDown=function(t,e){if(1<e[0]&&1<e[1]&&e[0]<this.size[0]-2&&e[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},i.registerNodeType("widget/toggle",e),o.title="Number",o.desc="Widget to select number value",o.pixels_threshold=10,o.markers_color="#666",o.prototype.onDrawForeground=function(t){var e=.5*this.size[0],i=this.size[1];30<i?(t.fillStyle=o.markers_color,t.beginPath(),t.moveTo(e,.1*i),t.lineTo(e+.1*i,.2*i),t.lineTo(e+-.1*i,.2*i),t.fill(),t.beginPath(),t.moveTo(e,.9*i),t.lineTo(e+.1*i,.8*i),t.lineTo(e+-.1*i,.8*i),t.fill(),t.font=(.7*i).toFixed(1)+"px Arial"):t.font=(.8*i).toFixed(1)+"px Arial",t.textAlign="center",t.font=(.7*i).toFixed(1)+"px Arial",t.fillStyle="#EEE",t.fillText(this.properties.value.toFixed(this._precision),e,.75*i)},o.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},o.prototype.onPropertyChanged=function(t,e){var i=(this.properties.step+"").split(".");this._precision=1<i.length?i[1].length:0},o.prototype.onMouseDown=function(t,e){if(!(e[1]<0))return this.old_y=t.canvasY,this.captureInput(!0),this.mouse_captured=!0},o.prototype.onMouseMove=function(t){var e;this.mouse_captured&&(e=this.old_y-t.canvasY,t.shiftKey&&(e*=10),(t.metaKey||t.altKey)&&(e*=.1),this.old_y=t.canvasY,t=this._remainder+e/o.pixels_threshold,this._remainder=t%1,t|=0,e=clamp(this.properties.value+t*this.properties.step,this.properties.min,this.properties.max),this.properties.value=e,this.graph._version++,this.setDirtyCanvas(!0))},o.prototype.onMouseUp=function(t,e){t.click_time<200&&(t=e[1]>.5*this.size[1]?-1:1,this.properties.value=clamp(this.properties.value+t*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)),this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},i.registerNodeType("widget/number",o),n.title="Combo",n.desc="Widget to select from a list",n.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},n.prototype.onPropertyChanged=function(t,e){"values"==t?(this._values=e.split(";"),this.widget.options.values=this._values):"value"==t&&(this.widget.value=e)},i.registerNodeType("widget/combo",n),r.title="Knob",r.desc="Circular controller",r.size=[80,100],r.prototype.onDrawForeground=function(t){var e,i,s,o;this.flags.collapsed||(-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),e=.5*this.size[0],i=.5*this.size[1],s=.5*Math.min(this.size[0],this.size[1])-5,Math.floor(.05*s),t.globalAlpha=1,t.save(),t.translate(e,i),t.rotate(.75*Math.PI),t.fillStyle="rgba(0,0,0,0.5)",t.beginPath(),t.moveTo(0,0),t.arc(0,0,s,0,1.5*Math.PI),t.fill(),t.strokeStyle="black",t.fillStyle=this.properties.color,t.lineWidth=2,t.beginPath(),t.moveTo(0,0),t.arc(0,0,s-4,0,1.5*Math.PI*Math.max(.01,this.value)),t.closePath(),t.fill(),t.lineWidth=1,t.globalAlpha=1,t.restore(),t.fillStyle="black",t.beginPath(),t.arc(e,i,.75*s,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":this.properties.color,t.beginPath(),o=this.value*Math.PI*1.5+.75*Math.PI,t.arc(e+Math.cos(o)*s*.65,i+Math.sin(o)*s*.65,.05*s,0,2*Math.PI,!0),t.fill(),t.fillStyle=this.mouseOver?"white":"#AAA",t.font=Math.floor(.5*s)+"px Arial",t.textAlign="center",t.fillText(this.properties.value.toFixed(this.properties.precision),e,i+.15*s))},r.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=i.colorToString([this.value,this.value,this.value])},r.prototype.onMouseDown=function(t){return this.center=[.5*this.size[0],.5*this.size[1]+20],this.radius=.5*this.size[0],!(t.canvasY-this.pos[1]<20||i.distance([t.canvasX,t.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius||(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),0))},r.prototype.onMouseMove=function(t){var e;this.oldmouse&&(t=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],e=this.value,1<(e-=.01*(t[1]-this.oldmouse[1]))?e=1:e<0&&(e=0),this.value=e,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=t,this.setDirtyCanvas(!0))},r.prototype.onMouseUp=function(t){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},r.prototype.onPropertyChanged=function(t,e){if("min"==t||"max"==t||"value"==t)return this.properties[t]=parseFloat(e),!0},i.registerNodeType("widget/knob",r),a.title="Inner Slider",a.prototype.onPropertyChanged=function(t,e){"value"==t&&(this.slider.value=e)},a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},i.registerNodeType("widget/internal_slider",a),u.title="H.Slider",u.desc="Linear slider controller",u.prototype.onDrawForeground=function(t){-1==this.value&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),t.globalAlpha=1,t.lineWidth=1,t.fillStyle="#000",t.fillRect(2,2,this.size[0]-4,this.size[1]-4),t.fillStyle=this.properties.color,t.beginPath(),t.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),t.fill()},u.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=i.colorToString([this.value,this.value,this.value])},u.prototype.onMouseDown=function(t){return!(t.canvasY-this.pos[1]<0||(this.oldmouse=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],this.captureInput(!0),0))},u.prototype.onMouseMove=function(t){var e;this.oldmouse&&(t=[t.canvasX-this.pos[0],t.canvasY-this.pos[1]],e=this.value,1<(e+=(t[0]-this.oldmouse[0])/this.size[0])?e=1:e<0&&(e=0),this.value=e,this.oldmouse=t,this.setDirtyCanvas(!0))},u.prototype.onMouseUp=function(t){this.oldmouse=null,this.captureInput(!1)},u.prototype.onMouseLeave=function(t){},i.registerNodeType("widget/hslider",u),h.title="Progress",h.desc="Shows data in linear progress",h.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t)},h.prototype.onDrawForeground=function(t){t.lineWidth=1,t.fillStyle=this.properties.color;var e=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min),e=Math.min(1,e);e=Math.max(0,e),t.fillRect(2,2,(this.size[0]-4)*e,this.size[1]-4)},i.registerNodeType("widget/progress",h),p.title="Text",p.desc="Shows the input value",p.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],p.prototype.onDrawForeground=function(t){t.fillStyle=this.properties.color;var e=this.properties.value,i=(this.properties.glowSize?(t.shadowColor=this.properties.color,t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.glowSize):t.shadowColor="transparent",this.properties.fontsize);if(t.textAlign=this.properties.align,t.font=i.toString()+"px "+this.properties.font,this.str="number"==typeof e?e.toFixed(this.properties.decimals):e,"string"==typeof this.str)for(var s=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),o=0;o<s.length;o++)t.fillText(s[o],"left"==this.properties.align?15:this.size[0]-15,-.15*i+i*(parseInt(o)+1));t.shadowColor="transparent",(this.last_ctx=t).textAlign="left"},p.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.properties.value=t)},p.prototype.resize=function(){if(this.last_ctx){for(var t=this.str.split("\\n"),e=(this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font,0),i=0;i<t.length;i++){var s=this.last_ctx.measureText(t[i]).width;e<s&&(e=s)}this.size[0]=e+20,this.size[1]=4+t.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},p.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,this.str="number"==typeof e?e.toFixed(3):e,!0},i.registerNodeType("widget/text",p),l.title="Panel",l.desc="Non interactive panel",l.widgets=[{name:"update",text:"Update",type:"button"}],l.prototype.createGradient=function(t){""==this.properties.bgcolorTop||""==this.properties.bgcolorBottom?this.lineargradient=0:(this.lineargradient=t.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom))},l.prototype.onDrawForeground=function(t){this.flags.collapsed||(null==this.lineargradient&&this.createGradient(t),this.lineargradient&&(t.lineWidth=1,t.strokeStyle=this.properties.borderColor,t.fillStyle=this.lineargradient,this.properties.shadowSize?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=this.properties.shadowSize):t.shadowColor="transparent",t.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),t.fill(),t.shadowColor="transparent",t.stroke()))},i.registerNodeType("widget/panel",l)})(this),(t=>{var e=t.LiteGraph;function r(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",e.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}r.title="Gamepad",r.desc="gets the input of the gamepad",r.CENTER=0,r.LEFT=1,r.RIGHT=2,r.UP=4,r.DOWN=8,r.zero=new Float32Array(2),r.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],r.prototype.onExecute=function(){var t=this.getGamepad(),e=this.properties.threshold||0;if(t&&(this._left_axis[0]=Math.abs(t.xbox.axes.lx)>e?t.xbox.axes.lx:0,this._left_axis[1]=Math.abs(t.xbox.axes.ly)>e?t.xbox.axes.ly:0,this._right_axis[0]=Math.abs(t.xbox.axes.rx)>e?t.xbox.axes.rx:0,this._right_axis[1]=Math.abs(t.xbox.axes.ry)>e?t.xbox.axes.ry:0,this._triggers[0]=Math.abs(t.xbox.axes.ltrigger)>e?t.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(t.xbox.axes.rtrigger)>e?t.xbox.axes.rtrigger:0),this.outputs)for(var i=0;i<this.outputs.length;i++){var s=this.outputs[i];if(s.links&&s.links.length){var o=null;if(t)switch(s.name){case"left_axis":o=this._left_axis;break;case"right_axis":o=this._right_axis;break;case"left_x_axis":o=this._left_axis[0];break;case"left_y_axis":o=this._left_axis[1];break;case"right_x_axis":o=this._right_axis[0];break;case"right_y_axis":o=this._right_axis[1];break;case"trigger_left":o=this._triggers[0];break;case"trigger_right":o=this._triggers[1];break;case"a_button":o=t.xbox.buttons.a?1:0;break;case"b_button":o=t.xbox.buttons.b?1:0;break;case"x_button":o=t.xbox.buttons.x?1:0;break;case"y_button":o=t.xbox.buttons.y?1:0;break;case"lb_button":o=t.xbox.buttons.lb?1:0;break;case"rb_button":o=t.xbox.buttons.rb?1:0;break;case"ls_button":o=t.xbox.buttons.ls?1:0;break;case"rs_button":o=t.xbox.buttons.rs?1:0;break;case"hat_left":o=t.xbox.hatmap&r.LEFT;break;case"hat_right":o=t.xbox.hatmap&r.RIGHT;break;case"hat_up":o=t.xbox.hatmap&r.UP;break;case"hat_down":o=t.xbox.hatmap&r.DOWN;break;case"hat":o=t.xbox.hatmap;break;case"start_button":o=t.xbox.buttons.start?1:0;break;case"back_button":o=t.xbox.buttons.back?1:0;break;case"button_pressed":for(var n=0;n<this._current_buttons.length;++n)this._current_buttons[n]&&!this._previous_buttons[n]&&this.triggerSlot(i,r.buttons[n])}else switch(s.name){case"button_pressed":break;case"left_axis":case"right_axis":o=r.zero;break;default:o=0}this.setOutputData(i,o)}}},r.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},r.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],r.prototype.getGamepad=function(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!t)return null;var e=t.call(navigator),i=null;this._previous_buttons.set(this._current_buttons);for(var s=this.properties.gamepad_index;s<4;s++)if(e[s]){var i=e[s],o=this.xbox_mapping;(o=o||(this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:r.CENTER})).axes.lx=i.axes[0],o.axes.ly=i.axes[1],o.axes.rx=i.axes[2],o.axes.ry=i.axes[3],o.axes.ltrigger=i.buttons[6].value,o.axes.rtrigger=i.buttons[7].value,o.hat="",o.hatmap=r.CENTER;for(var n=0;n<i.buttons.length;n++)if(this._current_buttons[n]=i.buttons[n].pressed,n<12)o.buttons[r.mapping_array[n]]=i.buttons[n].pressed,i.buttons[n].was_pressed&&this.trigger(r.mapping_array[n]+"_button_event");else switch(n){case 12:i.buttons[n].pressed&&(o.hat+="up",o.hatmap|=r.UP);break;case 13:i.buttons[n].pressed&&(o.hat+="down",o.hatmap|=r.DOWN);break;case 14:i.buttons[n].pressed&&(o.hat+="left",o.hatmap|=r.LEFT);break;case 15:i.buttons[n].pressed&&(o.hat+="right",o.hatmap|=r.RIGHT);break;case 16:o.buttons.home=i.buttons[n].pressed}return i.xbox=o,i}},r.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this._left_axis,i=this._right_axis,s=(t.strokeStyle="#88A",t.strokeRect(.5*(e[0]+1)*this.size[0]-4,.5*(e[1]+1)*this.size[1]-4,8,8),t.strokeStyle="#8A8",t.strokeRect(.5*(i[0]+1)*this.size[0]-4,.5*(i[1]+1)*this.size[1]-4,8,8),this.size[1]/this._current_buttons.length);t.fillStyle="#AEB";for(var o=0;o<this._current_buttons.length;++o)this._current_buttons[o]&&t.fillRect(0,s*o,6,s)}},r.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",e.EVENT],["b_button_event",e.EVENT],["x_button_event",e.EVENT],["y_button_event",e.EVENT],["lb_button_event",e.EVENT],["rb_button_event",e.EVENT],["ls_button_event",e.EVENT],["rs_button_event",e.EVENT],["start_button_event",e.EVENT],["back_button_event",e.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",e.EVENT]]},e.registerNodeType("input/gamepad",r)})(this),(t=>{var s=t.LiteGraph;function e(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}function i(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}function o(){this.addInput("in"),this.addOutput("out")}function n(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}function r(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}function h(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}function a(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}function u(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}function p(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}function l(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function d(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function _(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}function g(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}function f(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}function v(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}function m(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}function y(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:y.values}),this._func=y.funcs[this.properties.OP],this._result=[]}function x(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}function b(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:b.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:b.values}),this.size=[80,60]}function T(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}function E(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}function w(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}function L(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(t,e,i){i.properties.formula=t}),this.addWidget("toggle","allow",s.allow_scripts,function(t){s.allow_scripts=t}),this._func=null}function O(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}function I(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}function C(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}function D(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}function N(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}function G(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}e.title="Converter",e.desc="type A to type B",e.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t&&this.outputs)for(var e=0;e<this.outputs.length;e++){var i=this.outputs[e];if(i.links&&i.links.length){var s=null;switch(i.name){case"number":s=t.length?t[0]:parseFloat(t);break;case"vec2":case"vec3":case"vec4":var s=null,o=1;switch(i.name){case"vec2":o=2;break;case"vec3":o=3;break;case"vec4":o=4}s=new Float32Array(o);if(t.length)for(var n=0;n<t.length&&n<s.length;n++)s[n]=t[n];else s[0]=parseFloat(t)}this.setOutputData(e,s)}}},e.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},s.registerNodeType("math/converter",e),i.title="Bypass",i.desc="removes the type",i.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,t)},s.registerNodeType("math/bypass",i),o.title="to Number",o.desc="Cast to number",o.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,Number(t))},s.registerNodeType("math/to_number",o),n.title="Range",n.desc="Convert a number from one range to another",n.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},n.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t];void 0!==(i=this.getInputData(t))&&(this.properties[e.name]=i)}null!=(i=this.properties.in)&&i.constructor===Number||(i=0);var i,s=this.properties.in_min,o=this.properties.in_max,n=this.properties.out_min,r=this.properties.out_max;this._last_v=(i-s)/(o-s)*(r-n)+n,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,n,r))},n.prototype.onDrawBackground=function(t){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},n.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},s.registerNodeType("math/range",n),r.title="Rand",r.desc="Random number",r.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);void 0!==i&&(this.properties[e.name]=i)}var s=this.properties.min,o=this.properties.max;this._last_v=Math.random()*(o-s)+s,this.setOutputData(0,this._last_v)},r.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},r.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},s.registerNodeType("math/rand",r),h.title="Noise",h.desc="Random number with temporal continuity",h.data=null,h.getValue=function(t,e){if(!h.data){h.data=new Float32Array(1024);for(var i=0;i<h.data.length;++i)h.data[i]=Math.random()}(t%=1024)<0&&(t+=1024);var s=Math.floor(t),t=t-s;return h.data[s]*(1-(t=e?t*t*t*(t*(6*t-15)+10):t))+h.data[1023==s?0:s+1]*t},h.prototype.onExecute=function(){for(var t=this.getInputData(0)||0,e=this.properties.octaves||1,i=0,s=1,o=(t+=this.properties.seed||0,this.properties.speed||1),n=0,r=0;r<e&&(i+=h.getValue(t*(1+r)*o,this.properties.smooth)*s,n+=s,!((s*=this.properties.persistence)<.001));++r);var a=this.properties.min,u=this.properties.max;this._last_v=(i/=n)*(u-a)+a,this.setOutputData(0,this._last_v)},h.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},s.registerNodeType("math/noise",h),a.title="Spikes",a.desc="spike every random time",a.prototype.onExecute=function(){var t,e=this.graph.elapsed_time,e=(this._remaining_time-=e,this._blink_time-=e,0);0<this._blink_time&&(t=this._blink_time/this.properties.duration,e=1/(Math.pow(8*t-4,4)+1)),this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,e)},s.registerNodeType("math/spikes",a),u.title="Clamp",u.desc="Clamp number between min and max",u.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.max(this.properties.min,t),t=Math.min(this.properties.max,t),this.setOutputData(0,t))},u.prototype.getCode=function(t){var e="";return this.isInputConnected(0)&&(e+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),e},s.registerNodeType("math/clamp",u),p.title="Lerp",p.desc="Linear Interpolation",p.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.getInputData(1)),i=(null==e&&(e=0),this.properties.f),s=this.getInputData(2);this.setOutputData(0,t*(1-(i=void 0!==s?s:i))+e*i)},p.prototype.onGetInputs=function(){return[["f","number"]]},s.registerNodeType("math/lerp",p),l.title="Abs",l.desc="Absolute",l.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.abs(t))},s.registerNodeType("math/abs",l),d.title="Floor",d.desc="Floor number to remove fractional part",d.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.floor(t))},s.registerNodeType("math/floor",d),c.title="Frac",c.desc="Returns fractional part",c.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t%1)},s.registerNodeType("math/frac",c),_.title="Smoothstep",_.desc="Smoothstep",_.prototype.onExecute=function(){var t,e,i=this.getInputData(0);void 0!==i&&(t=this.properties.A,e=this.properties.B,i=clamp((i-t)/(e-t),0,1),this.setOutputData(0,i=i*i*(3-2*i)))},s.registerNodeType("math/smoothstep",_),g.title="Scale",g.desc="v * factor",g.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t*this.properties.factor)},s.registerNodeType("math/scale",g),f.title="Gate",f.desc="if v is true, then outputs A, otherwise B",f.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,this.getInputData(t?1:2))},s.registerNodeType("math/gate",f),v.title="Average",v.desc="Average Filter",v.prototype.onExecute=function(){for(var t=this.getInputData(0),e=this._values.length,i=(this._values[this._current%e]=t=null==t?0:t,this._current+=1,this._current>e&&(this._current=0),0),s=0;s<e;++s)i+=this._values[s];this.setOutputData(0,i/e)},v.prototype.onPropertyChanged=function(t,e){e<1&&(e=1),this.properties.samples=Math.round(e);e=this._values;this._values=new Float32Array(this.properties.samples),e.length<=this._values.length?this._values.set(e):this._values.set(e.subarray(0,this._values.length))},s.registerNodeType("math/average",v),m.title="TendTo",m.desc="moves the output value always closer to the input",m.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.properties.factor);null==this._value?this._value=t:this._value=this._value*(1-e)+t*e,this.setOutputData(0,this._value)},s.registerNodeType("math/tendTo",m),y.values=["+","-","*","/","%","^","max","min"],y.funcs={"+":function(t,e){return t+e},"-":function(t,e){return t-e},x:function(t,e){return t*e},X:function(t,e){return t*e},"*":function(t,e){return t*e},"/":function(t,e){return t/e},"%":function(t,e){return t%e},"^":function(t,e){return Math.pow(t,e)},max:function(t,e){return Math.max(t,e)},min:function(t,e){return Math.min(t,e)}},y.title="Operation",y.desc="Easy math operators",y["@OP"]={type:"enum",title:"operation",values:y.values},y.size=[100,60],y.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},y.prototype.setValue=function(t){"string"==typeof t&&(t=parseFloat(t)),this.properties.value=t},y.prototype.onPropertyChanged=function(t,e){"OP"!=t||(this._func=y.funcs[this.properties.OP],this._func)||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(t){return t})},y.prototype.onExecute=function(){var t,e=this.getInputData(0),i=this.getInputData(1),s=(null!=e?e.constructor===Number&&(this.properties.A=e):e=this.properties.A,null!=i?this.properties.B=i:i=this.properties.B,y.funcs[this.properties.OP]);if(e.constructor===Number)t=0,t=s(e,i);else if(e.constructor===Array){(t=this._result).length=e.length;for(var o=0;o<e.length;++o)t[o]=s(e[o],i)}else for(var o in t={},e)t[o]=s(e[o],i);this.setOutputData(0,t)},y.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+s.NODE_TITLE_HEIGHT)),t.textAlign="left")},s.registerNodeType("math/operation",y),s.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),s.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"}),x.title="Compare",x.desc="compares between two values",x.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);void 0!==t?this.properties.A=t:t=this.properties.A,void 0!==e?this.properties.B=e:e=this.properties.B;for(var i=0,s=this.outputs.length;i<s;++i){var o,n=this.outputs[i];if(n.links&&n.links.length){switch(n.name){case"A==B":o=t==e;break;case"A!=B":o=t!=e;break;case"A>B":o=e<t;break;case"A<B":o=t<e;break;case"A<=B":o=t<=e;break;case"A>=B":o=e<=t}this.setOutputData(i,o)}}},x.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},s.registerNodeType("math/compare",x),s.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),s.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),s.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),s.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),s.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),s.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"}),b["@OP"]={type:"enum",title:"operation",values:b.values=[">","<","==","!=","<=",">=","||","&&"]},b.title="Condition",b.desc="evaluates condition between A and B",b.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},b.prototype.onExecute=function(){var t=this.getInputData(0),e=(void 0===t?t=this.properties.A:this.properties.A=t,this.getInputData(1)),i=(void 0===e?e=this.properties.B:this.properties.B=e,!0);switch(this.properties.OP){case">":i=e<t;break;case"<":i=t<e;break;case"==":i=t==e;break;case"!=":i=t!=e;break;case"<=":i=t<=e;break;case">=":i=e<=t;break;case"||":i=t||e;break;case"&&":i=t&&e}this.setOutputData(0,i),this.setOutputData(1,!i)},s.registerNodeType("math/condition",b),T.title="Branch",T.desc="If condition is true, outputs IN in true, otherwise in false",T.prototype.onExecute=function(){var t=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,t),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,t))},s.registerNodeType("math/branch",T),E.title="Accumulate",E.desc="Increments a value every time",E.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var t=this.getInputData(0);this.properties.value+=null!==t?t:this.properties.increment,this.setOutputData(0,this.properties.value)},s.registerNodeType("math/accumulate",E),w.title="Trigonometry",w.desc="Sin Cos Tan",w.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.properties.amplitude),i=this.findInputSlot("amplitude"),s=(-1!=i&&(e=this.getInputData(i)),this.properties.offset);-1!=(i=this.findInputSlot("offset"))&&(s=this.getInputData(i));for(var o,n=0,r=this.outputs.length;n<r;++n){switch(this.outputs[n].name){case"sin":o=Math.sin(t);break;case"cos":o=Math.cos(t);break;case"tan":o=Math.tan(t);break;case"asin":o=Math.asin(t);break;case"acos":o=Math.acos(t);break;case"atan":o=Math.atan(t)}this.setOutputData(n,e*o+s)}},w.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},w.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},s.registerNodeType("math/trigonometry",w),s.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),s.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),s.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"}),L.title="Formula",L.desc="Compute formula",L.size=[160,100],v.prototype.onPropertyChanged=function(t,e){"formula"==t&&(this.code_widget.value=e)},L.prototype.onExecute=function(){if(s.allow_scripts){var t,e=this.getInputData(0),i=this.getInputData(1);null!=e?this.properties.x=e:e=this.properties.x,null!=i?this.properties.y=i:i=this.properties.y,this.properties.formula;try{this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),t=this._func(e,i,this.graph.globaltime),this.boxcolor=null}catch(t){this.boxcolor="red"}this.setOutputData(0,t)}},L.prototype.getTitle=function(){return this._func_code||"Formula"},L.prototype.onDrawBackground=function(){var t=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=t)},s.registerNodeType("math/formula",L),O.title="Vec2->XY",O.desc="vector 2 to components",O.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]))},s.registerNodeType("math3d/vec2-to-xy",O),I.title="XY->Vec2",I.desc="components to vector2",I.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this._data);i[0]=t,i[1]=e,this.setOutputData(0,i)},s.registerNodeType("math3d/xy-to-vec2",I),C.title="Vec3->XYZ",C.desc="vector 3 to components",C.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]))},s.registerNodeType("math3d/vec3-to-xyz",C),D.title="XYZ->Vec3",D.desc="components to vector3",D.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this.getInputData(2)),s=(null==i&&(i=this.properties.z),this._data);s[0]=t,s[1]=e,s[2]=i,this.setOutputData(0,s)},s.registerNodeType("math3d/xyz-to-vec3",D),N.title="Vec4->XYZW",N.desc="vector 4 to components",N.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]),this.setOutputData(3,t[3]))},s.registerNodeType("math3d/vec4-to-xyzw",N),G.title="XYZW->Vec4",G.desc="components to vector4",G.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this.getInputData(2)),s=(null==i&&(i=this.properties.z),this.getInputData(3)),o=(null==s&&(s=this.properties.w),this._data);o[0]=t,o[1]=e,o[2]=i,o[3]=s,this.setOutputData(0,o)},s.registerNodeType("math3d/xyzw-to-vec4",G)})(this),(t=>{var e=t.LiteGraph;function a(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}function i(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:i.values}),this._result=vec3.create()}function s(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}function o(){this.addInput("in","vec3"),this.addOutput("out","number")}function n(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}function r(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}function u(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}function h(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()}function p(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}function l(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()}function d(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()}function c(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}function _(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}function g(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}function f(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()}a.title="mat4",a.temp_quat=new Float32Array([0,0,0,1]),a.temp_mat4=new Float32Array(16),a.temp_vec3=new Float32Array(3),a.prototype.onPropertyChanged=function(t,e){this._must_update=!0},a.prototype.onExecute=function(){var t=this._result,e=a.temp_quat,i=a.temp_mat4,s=a.temp_vec3,o=this.getInputData(0),n=this.getInputData(1),r=this.getInputData(2);(this._must_update||o||n||r)&&(o=o||this.properties.T,n=n||this.properties.R,r=r||this.properties.S,mat4.identity(t),mat4.translate(t,t,o),this.properties.R_in_degrees?(s.set(n),vec3.scale(s,s,DEG2RAD),quat.fromEuler(e,s)):quat.fromEuler(e,n),mat4.fromQuat(i,e),mat4.multiply(t,t,i),mat4.scale(t,t,r)),this.setOutputData(0,t)},e.registerNodeType("math3d/mat4",a),i.values=["+","-","*","/","%","^","max","min","dot","cross"],e.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),e.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),i.title="Operation",i.desc="Easy math 3D operators",i["@OP"]={type:"enum",title:"operation",values:i.values},i.size=[100,60],i.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},i.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);if(null!=t&&null!=e){t.constructor===Number&&(t=[t,t,t]),e.constructor===Number&&(e=[e,e,e]);var i=this._result;switch(this.properties.OP){case"+":i=vec3.add(i,t,e);break;case"-":i=vec3.sub(i,t,e);break;case"x":case"X":case"*":i=vec3.mul(i,t,e);break;case"/":i=vec3.div(i,t,e);break;case"%":i[0]=t[0]%e[0],i[1]=t[1]%e[1],i[2]=t[2]%e[2];break;case"^":i[0]=Math.pow(t[0],e[0]),i[1]=Math.pow(t[1],e[1]),i[2]=Math.pow(t[2],e[2]);break;case"max":i[0]=Math.max(t[0],e[0]),i[1]=Math.max(t[1],e[1]),i[2]=Math.max(t[2],e[2]);break;case"min":i[0]=Math.min(t[0],e[0]),i[1]=Math.min(t[1],e[1]),i[2]=Math.min(t[2],e[2]);case"dot":i=vec3.dot(t,e);break;case"cross":vec3.cross(i,t,e);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,i)}},i.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+e.NODE_TITLE_HEIGHT)),t.textAlign="left")},e.registerNodeType("math3d/operation",i),s.title="vec3_scale",s.desc="scales the components of a vec3",s.prototype.onExecute=function(){var t,e,i=this.getInputData(0);null!=i&&(null==(t=this.getInputData(1))&&(t=this.properties.f),(e=this._data)[0]=i[0]*t,e[1]=i[1]*t,e[2]=i[2]*t,this.setOutputData(0,e))},e.registerNodeType("math3d/vec3-scale",s),o.title="vec3_length",o.desc="returns the module of a vector",o.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),this.setOutputData(0,t))},e.registerNodeType("math3d/vec3-length",o),n.title="vec3_normalize",n.desc="returns the vector normalized",n.prototype.onExecute=function(){var t,e,i=this.getInputData(0);null!=i&&(t=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),(e=this._data)[0]=i[0]/t,e[1]=i[1]/t,e[2]=i[2]/t,this.setOutputData(0,e))},e.registerNodeType("math3d/vec3-normalize",n),r.title="vec3_lerp",r.desc="returns the interpolated vector",r.prototype.onExecute=function(){var t,e,i,s=this.getInputData(0);null!=s&&null!=(t=this.getInputData(1))&&(e=this.getInputOrProperty("f"),(i=this._data)[0]=s[0]*(1-e)+t[0]*e,i[1]=s[1]*(1-e)+t[1]*e,i[2]=s[2]*(1-e)+t[2]*e,this.setOutputData(0,i))},e.registerNodeType("math3d/vec3-lerp",r),u.title="vec3_dot",u.desc="returns the dot product",u.prototype.onExecute=function(){var t,e=this.getInputData(0);null!=e&&null!=(t=this.getInputData(1))&&(e=e[0]*t[0]+e[1]*t[1]+e[2]*t[2],this.setOutputData(0,e))},e.registerNodeType("math3d/vec3-dot",u),t.glMatrix?(h.title="Quaternion",h.desc="quaternion",h.prototype.onExecute=function(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)},h.prototype.onGetInputs=function(){return[["x","number"],["y","number"],["z","number"],["w","number"]]},e.registerNodeType("math3d/quaternion",h),p.title="Rotation",p.desc="quaternion rotation",p.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.angle),this.getInputData(1)),e=(null==e&&(e=this.properties.axis),quat.setAxisAngle(this._value,e,.0174532925*t));this.setOutputData(0,e)},e.registerNodeType("math3d/rotation",p),l.title="Euler->Quat",l.desc="Converts euler angles (in degrees) to quaternion",l.prototype.onExecute=function(){var t=this.getInputData(0),t=(null==t&&(t=this.properties.euler),vec3.scale(this._degs,t,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]),quat.fromEuler(this._value,this._degs));this.setOutputData(0,t)},e.registerNodeType("math3d/euler_to_quat",l),d.title="Euler->Quat",d.desc="Converts rotX,rotY,rotZ in degrees to quat",d.prototype.onExecute=function(){var t=this.getInputData(0);t&&(quat.toEuler(this._value,t),vec3.scale(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value))},e.registerNodeType("math3d/quat_to_euler",d),c.title="Rot. Vec3",c.desc="rotate a point",c.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.vec),this.getInputData(1));null==e?this.setOutputData(t):this.setOutputData(0,vec3.transformQuat(vec3.create(),t,e))},e.registerNodeType("math3d/rotate_vec3",c),_.title="Mult. Quat",_.desc="rotate quaternion",_.prototype.onExecute=function(){var t,e=this.getInputData(0);null!=e&&null!=(t=this.getInputData(1))&&(e=quat.multiply(this._value,e,t),this.setOutputData(0,e))},e.registerNodeType("math3d/mult-quat",_),g.title="Quat Slerp",g.desc="quaternion spherical interpolation",g.prototype.onExecute=function(){var t,e,i=this.getInputData(0);null!=i&&null!=(t=this.getInputData(1))&&(e=this.properties.factor,null!=this.getInputData(2)&&(e=this.getInputData(2)),i=quat.slerp(this._value,i,t,e),this.setOutputData(0,i))},e.registerNodeType("math3d/quat-slerp",g),f.title="Remap Range",f.desc="remap a 3D range",f.prototype.onExecute=function(){for(var t=this.getInputData(0),e=(t&&this._value.set(t),this.properties.range_min),i=this.properties.range_max,s=this.properties.target_min,o=this.properties.target_max,n=0;n<3;++n){var r,a=i[n]-e[n];this._clamped[n]=clamp(this._value[n],e[n],i[n]),0==a?this._value[n]=.5*(s[n]+o[n]):(a=(this._value[n]-e[n])/a,r=(this.properties.clamp&&(a=clamp(a,0,1)),o[n]-s[n]),this._value[n]=s[n]+a*r)}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)},e.registerNodeType("math3d/remap_range",f)):e.debug&&console.warn("No glmatrix found, some Math3D nodes may not work")})(this),(t=>{function e(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}(t=t.LiteGraph).wrapFunctionAsNode("string/toString",function(t){if(t&&t.constructor===Object)try{return JSON.stringify(t)}catch(t){}return String(t)},[""],"string"),t.wrapFunctionAsNode("string/compare",function(t,e){return t==e},["string","string"],"boolean"),t.wrapFunctionAsNode("string/concatenate",function(t,e){return void 0===t?e:void 0===e?t:t+e},["string","string"],"string"),t.wrapFunctionAsNode("string/contains",function(t,e){return void 0!==t&&void 0!==e&&-1!=t.indexOf(e)},["string","string"],"boolean"),t.wrapFunctionAsNode("string/toUpperCase",function(t){return null!=t&&t.constructor===String?t.toUpperCase():t},["string"],"string"),t.wrapFunctionAsNode("string/split",function(t,e){if(null==e&&(e=this.properties.separator),null==t)return[];if(t.constructor===String)return t.split(e||" ");if(t.constructor!==Array)return null;for(var i=[],s=0;s<t.length;++s)"string"==typeof t[s]&&(i[s]=t[s].split(e||" "));return i},["string,array","string"],"array",{separator:","}),t.wrapFunctionAsNode("string/toFixed",function(t){return null!=t&&t.constructor===Number?t.toFixed(this.properties.precision):t},["number"],"string",{precision:0}),e.title="toTable",e.desc="Splits a string to table",e.prototype.onExecute=function(){var e,t=this.getInputData(0);t&&(e=this.properties.separator||",",t==this._str&&e==this._last_separator||(this._last_separator=e,this._str=t,this._table=t.split("\n").map(function(t){return t.trim().split(e)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0))},t.registerNodeType("string/toTable",e)})(this),(t=>{var i=t.LiteGraph;function e(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}function s(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}function o(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function n(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function r(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}function a(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function u(){this.properties={},this.addInput("onTrigger",i.ACTION),this.addInput("condition","boolean"),this.addOutput("true",i.EVENT),this.addOutput("false",i.EVENT),this.mode=i.ON_TRIGGER}e.title="Selector",e.desc="selects an output",e.prototype.onDrawBackground=function(t){var e;this.flags.collapsed||(t.fillStyle="#AFB",e=(this.selected+1)*i.NODE_SLOT_HEIGHT+6,t.beginPath(),t.moveTo(50,e),t.lineTo(50,e+i.NODE_SLOT_HEIGHT),t.lineTo(34,e+.5*i.NODE_SLOT_HEIGHT),t.fill())},e.prototype.onExecute=function(){var t=this.getInputData(0),t=(null!=t&&t.constructor===Number||(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1),this.getInputData(t+1));void 0!==t&&this.setOutputData(0,t)},e.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},i.registerNodeType("logic/selector",e),s.title="Sequence",s.desc="select one element from a sequence from a string",s.prototype.onPropertyChanged=function(t,e){"sequence"==t&&(this.values=e.split(","))},s.prototype.onExecute=function(){var t=this.getInputData(1),t=(t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t),this.getInputData(0));null==t&&(t=0),this.index=t=Math.round(t)%this.values.length,this.setOutputData(0,this.values[t])},i.registerNodeType("logic/sequence",s),o.title="AND",o.desc="Return true if all inputs are true",o.prototype.onExecute=function(){var t,e=!0;for(t in this.inputs)if(!this.getInputData(t)){e=!1;break}this.setOutputData(0,e)},o.prototype.onGetInputs=function(){return[["and","boolean"]]},i.registerNodeType("logic/AND",o),n.title="OR",n.desc="Return true if at least one input is true",n.prototype.onExecute=function(){var t,e=!1;for(t in this.inputs)if(this.getInputData(t)){e=!0;break}this.setOutputData(0,e)},n.prototype.onGetInputs=function(){return[["or","boolean"]]},i.registerNodeType("logic/OR",n),r.title="NOT",r.desc="Return the logical negation",r.prototype.onExecute=function(){var t=!this.getInputData(0);this.setOutputData(0,t)},i.registerNodeType("logic/NOT",r),a.title="bool == bool",a.desc="Compare for logical equality",a.prototype.onExecute=function(){var t,e=null,i=!0;for(t in this.inputs)if(null===e)e=this.getInputData(t);else if(e!=this.getInputData(t)){i=!1;break}this.setOutputData(0,i)},a.prototype.onGetInputs=function(){return[["bool","boolean"]]},i.registerNodeType("logic/CompareBool",a),u.title="Branch",u.desc="Branch execution on condition",u.prototype.onExecute=function(t,e){this.getInputData(1)?this.triggerSlot(0):this.triggerSlot(1)},i.registerNodeType("logic/IF",u)})(this),(t=>{var n=t.LiteGraph;function h(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}function e(){this.addOutput("frame","image"),this.properties={url:""}}function i(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}function s(){this.addInput("","image,canvas"),this.size=[200,200]}function o(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}function r(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}function a(){this.addInput("clear",n.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}function u(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}function p(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}function l(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}function d(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}h.title="Plot",h.desc="Plots data over time",h.colors=["#FFF","#F99","#9F9","#99F"],h.prototype.onExecute=function(t){if(!this.flags.collapsed)for(var e=this.size,i=0;i<4;++i){var s,o=this.getInputData(i);null!=o&&((s=this.values[i]).push(o),s.length>e[0])&&s.shift()}},h.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this.size,i=.5*e[1]/this.properties.scale,s=h.colors,o=.5*e[1];if(t.fillStyle="#000",t.fillRect(0,0,e[0],e[1]),t.strokeStyle="#555",t.beginPath(),t.moveTo(0,o),t.lineTo(e[0],o),t.stroke(),this.inputs)for(var n=0;n<4;++n){var r=this.values[n];if(this.inputs[n]&&this.inputs[n].link){t.strokeStyle=s[n],t.beginPath();var a=r[0]*i*-1+o;t.moveTo(0,clamp(a,0,e[1]));for(var u=1;u<r.length&&u<e[0];++u){a=r[u]*i*-1+o;t.lineTo(u,clamp(a,0,e[1]))}t.stroke()}}}},n.registerNodeType("graphics/plot",h),e.title="Image",e.desc="Image loader",e.widgets=[{name:"load",text:"Load",type:"button"}],e.supported_extensions=["jpg","jpeg","png","gif"],e.prototype.onAdded=function(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)},e.prototype.onDrawBackground=function(t){this.flags.collapsed||this.img&&5<this.size[0]&&5<this.size[1]&&this.img.width&&t.drawImage(this.img,0,0,this.size[0],this.size[1])},e.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},e.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadImage(e),!0},e.prototype.loadImage=function(t,e){var i;""==t?this.img=null:(this.img=document.createElement("img"),"http"==t.substr(0,4)&&n.proxy&&(t=n.proxy+t.substr(t.indexOf(":")+3)),this.img.src=t,this.boxcolor="#F95",(i=this).img.onload=function(){e&&e(this),console.log("Image loaded, size: "+i.img.width+"x"+i.img.height),this.dirty=!0,i.boxcolor="#9F9",i.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+t)})},e.prototype.onWidget=function(t,e){"load"==e.name&&this.loadImage(this.properties.url)},e.prototype.onDropFile=function(t){var e=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(t),this.properties.url=this._url,this.loadImage(this._url,function(t){e.size[1]=t.height/t.width*e.size[0]})},n.registerNodeType("graphics/image",e),i.title="Palette",i.desc="Generates a color",i.prototype.onExecute=function(){var t=[],e=(null!=this.properties.colorA&&t.push(hex2num(this.properties.colorA)),null!=this.properties.colorB&&t.push(hex2num(this.properties.colorB)),null!=this.properties.colorC&&t.push(hex2num(this.properties.colorC)),null!=this.properties.colorD&&t.push(hex2num(this.properties.colorD)),this.getInputData(0));if(1<(e=null==e?.5:e)?e=1:e<0&&(e=0),0!=t.length){var i,s=[0,0,0];0==e?s=t[0]:1==e?s=t[t.length-1]:(e=(t.length-1)*e,i=t[Math.floor(e)],t=t[Math.floor(e)+1],e=e-Math.floor(e),s[0]=i[0]*(1-e)+t[0]*e,s[1]=i[1]*(1-e)+t[1]*e,s[2]=i[2]*(1-e)+t[2]*e);for(var o=0;o<s.length;o++)s[o]/=255;this.boxcolor=colorToString(s),this.setOutputData(0,s)}},n.registerNodeType("color/palette",i),s.title="Frame",s.desc="Frame viewerew",s.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],s.prototype.onDrawBackground=function(t){this.frame&&!this.flags.collapsed&&t.drawImage(this.frame,0,0,this.size[0],this.size[1])},s.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},s.prototype.onWidget=function(t,e){var i,s;"resize"==e.name&&this.frame?(i=this.frame.width,s=this.frame.height,i||null==this.frame.videoWidth||(i=this.frame.videoWidth,s=this.frame.videoHeight),i&&s&&(this.size=[i,s]),this.setDirtyCanvas(!0,!0)):"view"==e.name&&this.show()},s.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},n.registerNodeType("graphics/frame",s),o.title="Image fade",o.desc="Fades between images",o.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],o.prototype.onAdded=function(){this.createCanvas();var t=this.canvas.getContext("2d");t.fillStyle="#000",t.fillRect(0,0,this.properties.width,this.properties.height)},o.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},o.prototype.onExecute=function(){var t=this.canvas.getContext("2d"),e=(this.canvas.width=this.canvas.width,this.getInputData(0)),e=(null!=e&&t.drawImage(e,0,0,this.canvas.width,this.canvas.height),this.getInputData(2)),e=(null==e?e=this.properties.fade:this.properties.fade=e,t.globalAlpha=e,this.getInputData(1));null!=e&&t.drawImage(e,0,0,this.canvas.width,this.canvas.height),t.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},n.registerNodeType("graphics/imagefade",o),r.title="Crop",r.desc="Crop Image",r.prototype.onAdded=function(){this.createCanvas()},r.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},r.prototype.onExecute=function(){var t=this.getInputData(0);t&&(t.width?(this.canvas.getContext("2d").drawImage(t,-this.properties.x,-this.properties.y,t.width*this.properties.scale,t.height*this.properties.scale),this.setOutputData(0,this.canvas)):this.setOutputData(0,null))},r.prototype.onDrawBackground=function(t){this.flags.collapsed||this.canvas&&t.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},r.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"scale"==t?(this.properties[t]=parseFloat(e),0==this.properties[t]&&(console.error("Error in scale"),this.properties[t]=1)):this.properties[t]=parseInt(e),this.createCanvas(),!0},n.registerNodeType("graphics/cropImage",r),a.title="Canvas",a.desc="Canvas to render stuff",a.prototype.onExecute=function(){var t=this.canvas,e=0|this.properties.width,i=0|this.properties.height;t.width!=e&&(t.width=e),t.height!=i&&(t.height=i),this.properties.autoclear&&this.ctx.clearRect(0,0,t.width,t.height),this.setOutputData(0,t)},a.prototype.onAction=function(t,e){"clear"==t&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},n.registerNodeType("graphics/canvas",a),u.title="DrawImage",u.desc="Draws image into a canvas",u.prototype.onExecute=function(){var t,e,i,s=this.getInputData(0);s&&(t=this.getInputOrProperty("img"))&&(e=this.getInputOrProperty("x"),i=this.getInputOrProperty("y"),s.getContext("2d").drawImage(t,e,i))},n.registerNodeType("graphics/drawImage",u),p.title="DrawRectangle",p.desc="Draws rectangle in canvas",p.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);o&&(t=this.getInputOrProperty("x"),e=this.getInputOrProperty("y"),i=this.getInputOrProperty("w"),s=this.getInputOrProperty("h"),o.getContext("2d").fillRect(t,e,i,s))},n.registerNodeType("graphics/drawRectangle",p),l.title="Video",l.desc="Video playback",l.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],l.prototype.onExecute=function(){var t;this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video)&&0!=this._video.width&&((t=this.getInputData(0))&&0<=t&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0))},l.prototype.onStart=function(){this.play()},l.prototype.onStop=function(){this.stop()},l.prototype.loadVideo=function(t){var e=(this._video_url=t).substr(0,10).indexOf(":"),i="",s="",o=((i=-1!=e?t.substr(0,e):i)&&(s=(s=t.substr(0,t.indexOf("/",i.length+3))).substr(i.length+3)),this.properties.use_proxy&&i&&n.proxy&&s!=location.host&&(t=n.proxy+t.substr(t.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=t,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0,this);this._video.addEventListener("loadedmetadata",function(t){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),o.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(t){console.log("video loading...")}),this._video.addEventListener("error",function(t){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.")}}),this._video.addEventListener("ended",function(t){console.log("Video Ended."),this.play()})},l.prototype.onPropertyChanged=function(t,e){return this.properties[t]=e,"url"==t&&""!=e&&this.loadVideo(e),!0},l.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},l.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},l.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},l.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},l.prototype.onWidget=function(t,e){},n.registerNodeType("graphics/video",l),d.title="Webcam",d.desc="Webcam image",d.is_webcam_open=!1,d.prototype.openStream=function(){var t,e;navigator.mediaDevices.getUserMedia?(t={audio:!(this._waiting_confirmation=!0),video:!this.properties.filterFacingMode||{facingMode:this.properties.facingMode}},navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch(function(t){console.log("Webcam rejected",t),e._webcam_stream=!1,d.is_webcam_open=!1,e.boxcolor="red",e.trigger("stream_error")}),e=this):console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")},d.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();d.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},d.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},d.prototype.onRemoved=function(){this.closeStream()},d.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,(this._video=e).onloadedmetadata=function(t){console.log(t),d.is_webcam_open=!0}),this.trigger("stream_ready",e)},d.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var t=1;t<this.outputs.length;++t)if(this.outputs[t])switch(this.outputs[t].name){case"width":this.setOutputData(t,this._video.videoWidth);break;case"height":this.setOutputData(t,this._video.videoHeight)}}},d.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Frame":"Show Frame",callback:function(){e.properties.show=!e.properties.show}}]},d.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(t.save(),t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},d.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",n.EVENT],["stream_closed",n.EVENT],["stream_error",n.EVENT]]},n.registerNodeType("graphics/webcam",d)})(this),(P=>{var a=P.LiteGraph,M=P.LGraphCanvas;function c(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[c.image_preview_size,c.image_preview_size]}function s(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[c.image_preview_size,c.image_preview_size]}function z(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}function p(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:c.DEFAULT},this.has_error=!1}function t(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:c.DEFAULT},this.properties.code=t.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}function u(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:c.DEFAULT}}function r(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:c.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}function o(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}function F(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:c.DEFAULT}}function _(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:c.DEFAULT}}function B(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:c.DEFAULT}}function h(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}function l(){this.addInput("Texture","Texture"),this.addOutput("min_t","Texture"),this.addOutput("max_t","Texture"),this.addOutput("min","vec4"),this.addOutput("max","vec4"),this.properties={mode:"max",use_previous_frame:!0},this._uniforms={u_texture:0},this._max=new Float32Array(4),this._min=new Float32Array(4),this._textures_chain=[]}function n(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}function d(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}function H(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}function g(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:c.DEFAULT,texture:null},g._shader||(g._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,g.pixel_shader))}function f(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:c.DEFAULT,generate_mipmaps:!1,texture:null},f._shader||(f._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,f.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}function v(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),v._shader||(v._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,v.pixel_shader))}function m(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:c.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}function e(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:c.DEFAULT}}function y(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},y._shader||(y._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,y.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}function x(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:c.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}function b(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:c.DEFAULT},b._shader||(b._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,b.pixel_shader))}function T(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}function E(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:c.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}function w(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:c.DEFAULT}}function L(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}function i(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:c.DEFAULT},this.fx=new L}function O(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}function I(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}function C(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}function D(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:c.LOW},this._uniforms={u_texture:0,u_factor:1}}function U(){this.addInput("in",""),this.properties={precision:c.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}function N(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:c.LOW,split_channels:!1},this._values=new Uint8Array(1024),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}function G(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:c.LOW},this._uniforms={u_texture:0,u_exposition:1}}function S(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:c.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}function A(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:c.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}function k(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:k.default_code,width:512,height:512,clear:!0,precision:c.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}function R(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:c.DEFAULT}}function V(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}P.LGraphTexture=null,"undefined"!=typeof GL&&(M.link_type_colors.Texture="#987",(P.LGraphTexture=c).title="Texture",c.desc="Texture",c.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},c.loadTextureCallback=null,c.image_preview_size=256,c.MODE_VALUES={undefined:c.UNDEFINED=0,"pass through":c.PASS_THROUGH=1,copy:c.COPY=2,low:c.LOW=3,high:c.HIGH=4,reuse:c.REUSE=5,default:c.DEFAULT=2},c.getTexturesContainer=function(){return gl.textures},c.loadTexture=function(t,e){e=e||{};var i=t;return"http://"==i.substr(0,7)&&a.proxy&&(i=a.proxy+i.substr(7)),c.getTexturesContainer()[t]=GL.Texture.fromURL(i,e)},c.getTexture=function(t){var e=this.getTexturesContainer();if(e)return!(e=e[t])&&t&&":"!=t[0]?this.loadTexture(t):e;throw"Cannot load texture, container of textures not found"},c.getTargetTexture=function(t,e,i){if(!t)throw"LGraphTexture.getTargetTexture expects a reference texture";var s=null;switch(i){case c.LOW:s=gl.UNSIGNED_BYTE;break;case c.HIGH:s=gl.HIGH_PRECISION_FORMAT;break;case c.REUSE:return t;default:s=t?t.type:gl.UNSIGNED_BYTE}return e=e&&e.width==t.width&&e.height==t.height&&e.type==s&&e.format==t.format?e:new GL.Texture(t.width,t.height,{type:s,format:t.format,filter:gl.LINEAR})},c.getTextureType=function(t,e){var i=e?e.type:gl.UNSIGNED_BYTE;switch(t){case c.HIGH:i=gl.HIGH_PRECISION_FORMAT;break;case c.LOW:i=gl.UNSIGNED_BYTE}return i},c.getWhiteTexture=function(){return this._white_texture||(this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST}))},c.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var t=new Uint8Array(1048576),e=0;e<1048576;++e)t[e]=255*Math.random();var i=GL.Texture.fromMemory(512,512,t,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=i},c.prototype.onDropFile=function(t,e,i){var s;t?(s=null,s="string"==typeof t?GL.Texture.fromURL(t):-1!=e.toLowerCase().indexOf(".dds")?GL.Texture.fromDDSInMemory(t):(t=new Blob([i]),i=URL.createObjectURL(t),GL.Texture.fromURL(i)),this._drop_texture=s,this.properties.name=e):(this._drop_texture=null,this.properties.name="")},c.prototype.getExtraMenuOptions=function(t){var e=this;if(this._drop_texture)return[{content:"Clear",callback:function(){e._drop_texture=null,e.properties.name=""}}]},c.prototype.onExecute=function(){var t=null;if(t=!(t=!(t=this.isOutputConnected(1)?this.getInputData(0):t)&&this._drop_texture?this._drop_texture:t)&&this.properties.name?c.getTexture(this.properties.name):t){this._last_tex=t,!1===this.properties.filter?t.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):t.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,t),this.setOutputData(1,t.fullpath||t.filename);for(var e=2;e<this.outputs.length;e++){var i,s=this.outputs[e];s&&(i=null,"width"==s.name?i=t.width:"height"==s.name?i=t.height:"aspect"==s.name&&(i=t.width/t.height),this.setOutputData(e,i))}}else this.setOutputData(0,null),this.setOutputData(1,"")},c.prototype.onResourceRenamed=function(t,e){this.properties.name==t&&(this.properties.name=e)},c.prototype.onDrawBackground=function(t){if(!(this.flags.collapsed||this.size[1]<=20))if(this._drop_texture&&t.webgl)t.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);else{if(this._last_preview_tex!=this._last_tex)if(t.webgl)this._canvas=this._last_tex;else{var e=c.generateLowResTexturePreview(this._last_tex);if(!e)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(e)}this._canvas&&(t.save(),t.webgl||(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(this._canvas,0,0,this.size[0],this.size[1]),t.restore())}},c.generateLowResTexturePreview=function(t){if(!t)return null;var e=c.image_preview_size,i=t;if(t.format==gl.DEPTH_COMPONENT)return null;(e<t.width||t.height>e)&&(i=this._preview_temp_tex,this._preview_temp_tex||(i=new GL.Texture(e,e,{minFilter:gl.NEAREST}),this._preview_temp_tex=i),t.copyTo(i),t=i);t=this._preview_canvas;return t||(t=createCanvas(e,e),this._preview_canvas=t),i&&i.toCanvas(t),t},c.prototype.getResources=function(t){return this.properties.name&&(t[this.properties.name]=GL.Texture),t},c.prototype.onGetInputs=function(){return[["in","Texture"]]},c.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},c.replaceCode=function(t,e){return t.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(t){return t=t.replace(/[\{\}]/g,""),e[t]||""})},a.registerNodeType("texture/texture",c),s.title="Preview",s.desc="Show a texture in the graph canvas",s.allow_preview=!1,s.prototype.onDrawBackground=function(t){var e,i;this.flags.collapsed||(t.webgl||s.allow_preview)&&(e=this.getInputData(0))&&(i=null,i=!e.handle&&t.webgl?e:c.generateLowResTexturePreview(e),t.save(),this.properties.flipY&&(t.translate(0,this.size[1]),t.scale(1,-1)),t.drawImage(i,0,0,this.size[0],this.size[1]),t.restore())},a.registerNodeType("texture/preview",s),z.title="Save",z.desc="Save a texture in the repository",z.prototype.getPreviewTexture=function(){return this._texture},z.prototype.onExecute=function(){var t=this.getInputData(0);t&&(this.properties.generate_mipmaps&&(t.bind(0),t.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(t.texture_type),t.unbind(0)),this.properties.name&&(c.storeTexture?c.storeTexture(this.properties.name,t):c.getTexturesContainer()[this.properties.name]=t),this._texture=t,this.setOutputData(0,t),this.setOutputData(1,this.properties.name))},a.registerNodeType("texture/save",z),p.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:c.MODE_VALUES}},p.title="Operation",p.desc="Texture shader operation",p.presets={},p.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:e.properties.show?"Hide Texture":"Show Texture",callback:function(){e.properties.show=!e.properties.show}}]},p.prototype.onPropertyChanged=function(){this.has_error=!1},p.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==t&&(t.save(),t.drawImage(this._tex,0,0,this.size[0],this.size[1]),t.restore())},p.prototype.onExecute=function(){var e=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision===c.PASS_THROUGH)this.setOutputData(0,e);else{var i=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var s,o,n=512,r=512,t=(e?(n=e.width,r=e.height):i&&(n=i.width,r=i.height),i=i||GL.Texture.getWhiteTexture(),c.getTextureType(this.properties.precision,e)),t=(e||this._tex?this._tex=c.getTargetTexture(e||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(n,r,{type:t,format:gl.RGBA,filter:gl.LINEAR}),""),a=(this.properties.uvcode&&(t="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";"))&&(t=this.properties.uvcode),""),u=(this.properties.pixelcode&&(a="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";"))&&(a=this.properties.pixelcode),this._shader);if(!(this.has_error||u&&this._shader_code==t+"|"+a)){var h=c.replaceCode(p.pixel_shader,{UV_CODE:t,PIXEL_CODE:a});try{u=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h),this.boxcolor="#00FF00"}catch(t){return GL.Shader.dumpErrorToConsole(t,Shader.SCREEN_VERTEX_SHADER,h),this.boxcolor="#FF0000",void(this.has_error=!0)}this._shader=u,this._shader_code=t+"|"+a}this._shader&&(null!=(s=this.getInputData(2))?this.properties.value=s:s=parseFloat(this.properties.value),o=this.graph.getTime(),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),e&&e.bind(0),i&&i.bind(1);var t=Mesh.getScreenQuad();u.uniforms({u_texture:0,u_textureB:1,value:s,texSize:[n,r,1/n,1/r],time:o}).draw(t)}),this.setOutputData(0,this._tex))}}},p.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec4 texSize;\n\t\tuniform float time;\n\t\tuniform float value;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\t{{UV_CODE}};\n\t\t\tvec4 color4 = texture2D(u_texture, uv);\n\t\t\tvec3 color = color4.rgb;\n\t\t\tvec4 color4B = texture2D(u_textureB, uv);\n\t\t\tvec3 colorB = color4B.rgb;\n\t\t\tvec3 result = color;\n\t\t\tfloat alpha = 1.0;\n\t\t\t{{PIXEL_CODE}};\n\t\t\tgl_FragColor = vec4(result, alpha);\n\t\t}\n\t\t",(p.registerPreset=function(t,e){p.presets[t]=e})("",""),p.registerPreset("bypass","color"),p.registerPreset("add","color + colorB * value"),p.registerPreset("substract","(color - colorB) * value"),p.registerPreset("mate","mix( color, colorB, color4B.a * value)"),p.registerPreset("invert","vec3(1.0) - color"),p.registerPreset("multiply","color * colorB * value"),p.registerPreset("divide","(color / colorB) / value"),p.registerPreset("difference","abs(color - colorB) * value"),p.registerPreset("max","max(color, colorB) * value"),p.registerPreset("min","min(color, colorB) * value"),p.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),p.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),p.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),p.registerPreset("normalmap","\n\t\tfloat z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;\n\t\tfloat z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;\n\t\tfloat z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;\n\t\tfloat z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;\n\t\tfloat z4 = color.x;\n\t\tfloat z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;\n\t\tfloat z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;\n\t\tfloat z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;\n\t\tfloat z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;\n\t\tvec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );\n\t\tnormal.xy *= value;\n\t\tresult.xyz = normalize(normal) * 0.5 + vec3(0.5);\n\t"),p.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),p.prototype.onInspect=function(i){var s=this;i.addCombo("Presets","",{values:Object.keys(p.presets),callback:function(t){var e=p.presets[t];e&&(s.setProperty("pixelcode",e),s.title=t,i.refresh())}})},a.registerNodeType("texture/operation",p),t.title="Shader",t.desc="Texture shader",t.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:c.MODE_VALUES}},t.prototype.onPropertyChanged=function(t,e){if("code"==t){var i=this.getShader();if(i){var s=i.uniformInfo;if(this.inputs)for(var o={},n=0;n<this.inputs.length;++n)(r=this.getInputInfo(n))&&(s[r.name]&&!o[r.name]?o[r.name]=!0:(this.removeInput(n),n--));for(n in s){var r=i.uniformInfo[n];if(null!==r.loc&&"time"!=n){var a="number";if(this._shader.samplers[n])a="texture";else switch(r.size){case 1:a="number";break;case 2:a="vec2";break;case 3:a="vec3";break;case 4:a="vec4";break;case 9:a="mat3";break;case 16:a="mat4";break;default:continue}var u,h=this.findInputSlot(n);-1!=h&&(u=this.getInputInfo(h))?u.type!=a&&(this.removeInput(h,a),this.addInput(n,a)):this.addInput(n,a)}}}}},t.prototype.getShader=function(){if(!this._shader||this._shader_code!=this.properties.code){if(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),!this._shader)return this.boxcolor="red",null;this.boxcolor="green"}return this._shader},t.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getShader();if(t){var e=0,i=null;if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.getInputInfo(s),n=this.getInputData(s);null!=n&&(n.constructor===GL.Texture&&(n.bind(e),i=i||n,n=e,e++),t.setUniform(o.name,n))}var r=this._uniforms,a=c.getTextureType(this.properties.precision,i),u=0|this.properties.width,h=0|this.properties.height;0==u&&(u=(i||gl.canvas).width),0==h&&(h=(i||gl.canvas).height),r.texSize[0]=u,r.texSize[1]=h,r.texSize[2]=1/u,r.texSize[3]=1/h,r.time=this.graph.getTime(),r.u_value=this.properties.u_value,r.u_color.set(this.properties.u_color),this._tex&&this._tex.type==a&&this._tex.width==u&&this._tex.height==h||(this._tex=new GL.Texture(u,h,{type:a,format:gl.RGBA,filter:gl.LINEAR})),this._tex.drawTo(function(){t.uniforms(r).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},t.pixel_shader="precision highp float;\n\nvarying vec2 v_coord;\nuniform float time; //time in seconds\nuniform vec4 texSize; //tex resolution\nuniform float u_value;\nuniform vec4 u_color;\n\nvoid main() {\n\tvec2 uv = v_coord;\n\tvec3 color = vec3(0.0);\n\t//your code here\n\tcolor.xy=uv;\n\n\tgl_FragColor = vec4(color, 1.0);\n}\n",a.registerNodeType("texture/shader",t),u.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},u.title="Scale/Offset",u.desc="Applies an scaling and offseting",u.prototype.onExecute=function(){var t,e,i,s,o,n,r=this.getInputData(0);this.isOutputConnected(0)&&r&&(this.properties.precision===c.PASS_THROUGH?this.setOutputData(0,r):(t=r.width,e=r.height,i=this.precision===c.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,this.precision===c.DEFAULT&&(i=r.type),this._tex&&this._tex.width==t&&this._tex.height==e&&this._tex.type==i||(this._tex=new GL.Texture(t,e,{type:i,format:gl.RGBA,filter:gl.LINEAR})),s=(s=this._shader)||new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,u.pixel_shader),(o=this.getInputData(1))?(this.properties.scale[0]=o[0],this.properties.scale[1]=o[1]):o=this.properties.scale,(n=this.getInputData(2))?(this.properties.offset[0]=n[0],this.properties.offset[1]=n[1]):n=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),r.bind(0);var t=Mesh.getScreenQuad();s.uniforms({u_texture:0,u_scale:o,u_offset:n}).draw(t)}),this.setOutputData(0,this._tex)))},u.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_scale;\n\t\tuniform vec2 u_offset;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tuv = uv / u_scale - u_offset;\n\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t}\n\t\t",a.registerNodeType("texture/scaleOffset",u),r.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},r.title="Warp",r.desc="Texture warp operation",r.prototype.onExecute=function(){var e,t,i,s,o,n=this.getInputData(0);this.isOutputConnected(0)&&(this.properties.precision===c.PASS_THROUGH?this.setOutputData(0,n):(e=this.getInputData(1),t=s=512,gl.UNSIGNED_BYTE,n?(s=n.width,t=n.height,n.type):e&&(s=e.width,t=e.height,e.type),n||this._tex?this._tex=c.getTargetTexture(n||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(s,t,{type:this.precision===c.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR}),i=(i=this._shader)||new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,r.pixel_shader),null!=(s=this.getInputData(2))?this.properties.factor=s:s=parseFloat(this.properties.factor),(o=this._uniforms).u_factor=s,o.u_scale.set(this.properties.scale),o.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),n&&n.bind(0),e&&e.bind(1);var t=Mesh.getScreenQuad();i.uniforms(o).draw(t)}),this.setOutputData(0,this._tex)))},r.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tvarying vec2 v_coord;\n\t\tuniform float u_factor;\n\t\tuniform vec2 u_scale;\n\t\tuniform vec2 u_offset;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tuv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;\n\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t}\n\t\t",a.registerNodeType("texture/warp",r),o.title="to Viewport",o.desc="Texture to viewport",o._prev_viewport=new Float32Array(4),o.prototype.onDrawBackground=function(t){var e;this.flags.collapsed||this.size[1]<=40||(e=this.getInputData(0))&&t.drawImage(t==gl?e:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)},o.prototype.onExecute=function(){var t,e,i,s=this.getInputData(0);s&&(this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST),t=this.properties.gamma||1,this.isInputConnected(1)&&(t=this.getInputData(1)),s.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),(e=o._prev_viewport).set(gl.viewport_data),i=this.properties.viewport,gl.viewport(e[0]+e[2]*i[0],e[1]+e[3]*i[1],e[2]*i[2],e[3]*i[3]),gl.getViewport(),this.properties.antialiasing?(o._shader||(o._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,o.aa_pixel_shader)),i=Mesh.getScreenQuad(),s.bind(0),o._shader.uniforms({u_texture:0,uViewportSize:[s.width,s.height],u_igamma:1/t,inverseVP:[1/s.width,1/s.height]}).draw(i)):1!=t?(o._gamma_shader||(o._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,o.gamma_pixel_shader)),s.toViewport(o._gamma_shader,{u_texture:0,u_igamma:1/t})):s.toViewport(),gl.viewport(e[0],e[1],e[2],e[3]))},o.prototype.onGetInputs=function(){return[["gamma","number"]]},o.aa_pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 uViewportSize;\n\t\tuniform vec2 inverseVP;\n\t\tuniform float u_igamma;\n\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\n\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t{\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\n\t\t\tvec2 dir;\n\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\n\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\n\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\n\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\n\t\t\t//return vec4(rgbA,1.0);\n\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\telse\n\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\tif(u_igamma != 1.0)\n\t\t\t\tcolor.xyz = pow( color.xyz, vec3(u_igamma) );\n\t\t\treturn color;\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t}\n\t\t",o.gamma_pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_igamma;\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord);\n\t\t\tcolor.xyz = pow(color.xyz, vec3(u_igamma) );\n\t\t   gl_FragColor = color;\n\t\t}\n\t\t",a.registerNodeType("texture/toviewport",o),F.title="Copy",F.desc="Copy Texture",F.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:c.MODE_VALUES}},F.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);(o||this._temp_texture)&&this.isOutputConnected(0)&&(o&&(t=o.width,e=o.height,0!=this.properties.size&&(t=this.properties.size,e=this.properties.size),s=this._temp_texture,i=o.type,this.properties.precision===c.LOW?i=gl.UNSIGNED_BYTE:this.properties.precision===c.HIGH&&(i=gl.HIGH_PRECISION_FORMAT),s&&s.width==t&&s.height==e&&s.type==i||(s=gl.LINEAR,this.properties.generate_mipmaps&&isPowerOfTwo(t)&&isPowerOfTwo(e)&&(s=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(t,e,{type:i,format:gl.RGBA,minFilter:s,magFilter:gl.LINEAR})),o.copyTo(this._temp_texture),this.properties.generate_mipmaps)&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0)),this.setOutputData(0,this._temp_texture))},a.registerNodeType("texture/copy",F),_.title="Downsample",_.desc="Downsample Texture",_.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:c.MODE_VALUES}},_.prototype.onExecute=function(){var t=this.getInputData(0);if((t||this._temp_texture)&&this.isOutputConnected(0)&&t&&t.texture_type===GL.TEXTURE_2D)if(this.properties.iterations<1)this.setOutputData(0,t);else{var e,i=_._shader,s=(i||(_._shader=i=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,_.pixel_shader)),0|t.width),o=0|t.height,n=t.type,r=(this.properties.precision===c.LOW?n=gl.UNSIGNED_BYTE:this.properties.precision===c.HIGH&&(n=gl.HIGH_PRECISION_FORMAT),this.properties.iterations||1),a=t,u=[],h={type:n,format:t.format},p=vec2.create(),l={u_offset:p};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var d=0;d<r&&(p[0]=1/s,p[1]=1/o,s=s>>1||0,o=o>>1||0,e=GL.Texture.getTemporary(s,o,h),u.push(e),a.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),a.copyTo(e,i,l),1!=s||1!=o);++d)a=e;this._texture=u.pop();for(d=0;d<u.length;++d)GL.Texture.releaseTemporary(u[d]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},_.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D(u_texture, v_coord );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n\t\t   gl_FragColor = color * 0.25;\n\t\t}\n\t\t",a.registerNodeType("texture/downsample",_),B.title="Resize",B.desc="Resize Texture",B.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:c.MODE_VALUES}},B.prototype.onExecute=function(){var t,e,i,s=this.getInputData(0);(s||this._temp_texture)&&this.isOutputConnected(0)&&s&&s.texture_type===GL.TEXTURE_2D&&(t=0|this.properties.size[0],e=0|this.properties.size[1],0==t&&(t=s.width),0==e&&(e=s.height),i=s.type,this.properties.precision===c.LOW?i=gl.UNSIGNED_BYTE:this.properties.precision===c.HIGH&&(i=gl.HIGH_PRECISION_FORMAT),this._texture&&this._texture.width==t&&this._texture.height==e&&this._texture.type==i||(this._texture=new GL.Texture(t,e,{type:i})),s.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture))},a.registerNodeType("texture/resize",B),h.title="Average",h.desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.\n If high_quality is true, then it generates the mipmaps first and reads from the lower one.",h.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var t=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,t),this.setOutputData(2,(t[0]+t[1]+t[2])/3)},h.prototype.onPreRenderExecute=function(){this.updateAverage()},h.prototype.updateAverage=function(){var t=this.getInputData(0);if(t&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!h._shader){h._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,h.pixel_shader);for(var e=new Float32Array(16),i=0;i<e.length;++i)e[i]=Math.random();h._shader.uniforms({u_samples_a:e.subarray(0,16),u_samples_b:e.subarray(16,32)})}var s,o=this._temp_texture,n=gl.UNSIGNED_BYTE,r=(t.type!=n&&(n=gl.FLOAT),o&&o.type==n||(this._temp_texture=new GL.Texture(1,1,{type:n,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&(this._temp_pot2_texture&&this._temp_pot2_texture.type==n||(this._temp_pot2_texture=new GL.Texture(512,512,{type:n,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),t.copyTo(this._temp_pot2_texture),(t=this._temp_pot2_texture).bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9),h._shader),a=this._uniforms;a.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){t.toViewport(r,a)}),(this.isOutputConnected(1)||this.isOutputConnected(2))&&(o=this._temp_texture.getPixels())&&(s=this._luminance,n=this._temp_texture.type,s.set(o),n==gl.UNSIGNED_BYTE?vec4.scale(s,s,1/255):n!=GL.HALF_FLOAT&&GL.HALF_FLOAT_OES)}},h.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform mat4 u_samples_a;\n\t\tuniform mat4 u_samples_b;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_mipmap_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t//random average\n\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t{\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t}\n\t\t   gl_FragColor = color * 0.03125;\n\t\t}\n\t\t",a.registerNodeType("texture/average",h),l.widgets_info={mode:{widget:"combo",values:["min","max","avg"]}},l.title="MinMax",l.desc="Compute the scene min max",l.prototype.onExecute=function(){this.properties.use_previous_frame||this.update(),this.setOutputData(0,this._temp_texture),this.setOutputData(1,this._luminance)},l.prototype.onPreRenderExecute=function(){this.update()},l.prototype.update=function(){var t=this.getInputData(0);if(t&&(this.isOutputConnected(0)||this.isOutputConnected(1))){l._shader||(l._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,l.pixel_shader));this._temp_texture;var e=gl.UNSIGNED_BYTE,i=(t.type!=e&&(e=gl.FLOAT),512);if(!this._textures_chain.length||this._textures_chain[0].type!=e)for(;s&&(this._textures_chain[s]=new GL.Texture(i,i,{type:e,format:gl.RGBA,filter:gl.NEAREST}),s++,1!=(i>>=2)););t.copyTo(this._textures_chain[0]);this._textures_chain[0];for(var s=1;s<=this._textures_chain.length;++s)t=this._textures_chain[s];var o=l._shader,n=this._uniforms;n.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){t.toViewport(o,n)})}},l.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform mat4 u_samples_a;\n\t\tuniform mat4 u_samples_b;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_mipmap_offset;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\t//random average\n\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t{\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t}\n\t\t   gl_FragColor = color * 0.03125;\n\t\t}\n\t\t",n.title="Smooth",n.desc="Smooth texture over time",n.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);o&&this.isOutputConnected(0)&&(n._shader||(n._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,n.pixel_shader)),(t=this._temp_texture)&&t.type==o.type&&t.width==o.width&&t.height==o.height||(t={type:o.type,format:gl.RGBA,filter:gl.NEAREST},this._temp_texture=new GL.Texture(o.width,o.height,t),this._temp_texture2=new GL.Texture(o.width,o.height,t),o.copyTo(this._temp_texture2)),t=this._temp_texture,e=this._temp_texture2,i=n._shader,(s=this._uniforms).u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),t.drawTo(function(){e.bind(1),o.toViewport(i,s)}),this.setOutputData(0,t),this._temp_texture=e,this._temp_texture2=t)},n.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_factor;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tgl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );\n\t\t}\n\t\t",a.registerNodeType("texture/temporal_smooth",n),d.title="Lineal Avg Smooth",d.desc="Smooth texture linearly over time",d["@samples"]={type:"number",min:1,max:64,step:1,precision:1},d.prototype.getPreviewTexture=function(){return this._temp_texture2},d.prototype.onExecute=function(){var t,e,i,s,o,n,r,a,u=this.getInputData(0);u&&this.isOutputConnected(0)&&(d._shader||(d._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader_copy),d._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader_avg)),t=clamp(this.properties.samples,0,64),e=this.frame,0==(i=this.properties.frames_interval)||e%i==0?((e=this._temp_texture)&&e.type==u.type&&e.width==t||(i={type:u.type,format:gl.RGBA,filter:gl.NEAREST},this._temp_texture=new GL.Texture(t,1,i),this._temp_texture2=new GL.Texture(t,1,i),this._temp_texture_out=new GL.Texture(1,1,i)),s=this._temp_texture,o=this._temp_texture2,n=d._shader_copy,r=d._shader_avg,(a=this._uniforms).u_samples=t,a.u_isamples=1/t,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),s.drawTo(function(){o.bind(1),u.toViewport(n,a)}),this._temp_texture_out.drawTo(function(){s.toViewport(r,a)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=o,this._temp_texture2=s):this.setOutputData(0,this._temp_texture_out),this.setOutputData(1,this._temp_texture2),this.frame++)},d.pixel_shader_copy="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_isamples;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tif( v_coord.x <= u_isamples )\n\t\t\t\tgl_FragColor = texture2D( u_texture, vec2(0.5) );\n\t\t\telse\n\t\t\t\tgl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );\n\t\t}\n\t\t",d.pixel_shader_avg="precision highp float;\n\t\tprecision highp float;\n\t\tuniform sampler2D u_texture;\n\t\tuniform int u_samples;\n\t\tuniform float u_isamples;\n\t\tvarying vec2 v_coord;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = vec4(0.0);\n\t\t\tfor(int i = 0; i < 64; ++i)\n\t\t\t{\n\t\t\t\tcolor += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );\n\t\t\t\tif(i == (u_samples - 1))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tgl_FragColor = color * u_isamples;\n\t\t}\n\t\t",a.registerNodeType("texture/linear_avg_smooth",d),H.title="Image to Texture",H.desc="Uploads an image to the GPU",H.prototype.onExecute=function(){var t=this.getInputData(0);if(t){var e=t.videoWidth||t.width,i=t.videoHeight||t.height;if(t.gltexture)this.setOutputData(0,t.gltexture);else{var s=this._temp_texture;s&&s.width==e&&s.height==i||(this._temp_texture=new GL.Texture(e,i,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(t)}catch(t){return void console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+t)}this.setOutputData(0,this._temp_texture)}}},a.registerNodeType("texture/imageToTexture",H),g.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:c.MODE_VALUES}},g.title="LUT",g.desc="Apply LUT to Texture",g.prototype.onExecute=function(){var t,e,i;this.isOutputConnected(0)&&(t=this.getInputData(0),this.properties.precision===c.PASS_THROUGH||!1===this.properties.enabled?this.setOutputData(0,t):t&&((i=(i=this.getInputData(1))||c.getTexture(this.properties.texture))?(i.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),e=this.properties.intensity,this.isInputConnected(2)&&(this.properties.intensity=e=this.getInputData(2)),this._tex=c.getTargetTexture(t,this._tex,this.properties.precision),this._tex.drawTo(function(){i.bind(1),t.toViewport(g._shader,{u_texture:0,u_textureB:1,u_amount:e})}),this.setOutputData(0,this._tex)):this.setOutputData(0,t)))},g.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_amount;\n\t\t\n\t\tvoid main() {\n\t\t\t lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t\t mediump vec2 quad1;\n\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t\t mediump vec2 quad2;\n\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t\t highp vec2 texPos1;\n\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t highp vec2 texPos2;\n\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n\t\t\t lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\t\t}\n\t\t",a.registerNodeType("texture/LUT",g),f.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:c.MODE_VALUES}},f.title="Encode",f.desc="Apply a texture atlas to encode a texture",f.prototype.onExecute=function(){var t,e,i;this.isOutputConnected(0)&&(t=this.getInputData(0),this.properties.precision===c.PASS_THROUGH||!1===this.properties.enabled?this.setOutputData(0,t):t&&((i=(i=this.getInputData(1))||c.getTexture(this.properties.texture))?(i.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),(e=this._uniforms).u_row_simbols=Math.floor(this.properties.num_row_symbols),e.u_symbol_size=this.properties.symbol_size,e.u_brightness=this.properties.brightness,e.u_invert=this.properties.invert?1:0,e.u_colorize=this.properties.colorize?1:0,this._tex=c.getTargetTexture(t,this._tex,this.properties.precision),e.u_res[0]=this._tex.width,e.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){i.bind(1),t.toViewport(f._shader,e)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)):this.setOutputData(0,t)))},f.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform float u_row_simbols;\n\t\tuniform float u_symbol_size;\n\t\tuniform float u_brightness;\n\t\tuniform float u_invert;\n\t\tuniform float u_colorize;\n\t\tuniform vec2 u_res;\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 total_symbols = u_res / u_symbol_size;\n\t\t\tvec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate \n\t\t\tvec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;\n\t\t\tlowp vec4 textureColor = texture2D(u_texture, uv );\n\t\t\tfloat lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);\n\t\t\tif( u_invert == 1.0 ) lum = 1.0 - lum;\n\t\t\tfloat index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));\n\t\t\tfloat col = mod( index, u_row_simbols );\n\t\t\tfloat row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;\n\t\t\tvec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;\n\t\t\tvec4 color = texture2D( u_textureB, simbol_uv );\n\t\t\tif(u_colorize == 1.0)\n\t\t\t\tcolor *= textureColor;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t",a.registerNodeType("texture/encode",f),v.title="Texture to Channels",v.desc="Split texture channels",v.prototype.onExecute=function(){var t=this.getInputData(0);if(t){this._channels||(this._channels=Array(4));for(var e=gl.RGB,i=0,s=0;s<4;s++)this.isOutputConnected(s)?(this._channels[s]&&this._channels[s].width==t.width&&this._channels[s].height==t.height&&this._channels[s].type==t.type&&this._channels[s].format==e||(this._channels[s]=new GL.Texture(t.width,t.height,{type:t.type,format:e,filter:gl.LINEAR})),i++):this._channels[s]=null;if(i){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var o=Mesh.getScreenQuad(),n=v._shader,r=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],s=0;s<4;s++)this._channels[s]&&(this._channels[s].drawTo(function(){t.bind(0),n.uniforms({u_texture:0,u_mask:r[s]}).draw(o)}),this.setOutputData(s,this._channels[s]))}}},v.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec4 u_mask;\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t}\n\t\t",a.registerNodeType("texture/textureChannels",v),m.title="Channels to Texture",m.desc="Split texture channels",m.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},m.prototype.onExecute=function(){var t=c.getWhiteTexture(),e=this.getInputData(0)||t,i=this.getInputData(1)||t,s=this.getInputData(2)||t,o=this.getInputData(3)||t,n=(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),Mesh.getScreenQuad()),r=m._shader=m._shader?m._shader:new GL.Shader(Shader.SCREEN_VERTEX_SHADER,m.pixel_shader),t=Math.max(e.width,i.width,s.width,o.width),a=Math.max(e.height,i.height,s.height,o.height),u=this.properties.precision==c.HIGH?c.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,t=(this._texture&&this._texture.width==t&&this._texture.height==a&&this._texture.type==u||(this._texture=new GL.Texture(t,a,{type:u,format:gl.RGBA,filter:gl.LINEAR})),this._color),h=(t[0]=this.properties.R,t[1]=this.properties.G,t[2]=this.properties.B,t[3]=this.properties.A,this._uniforms);this._texture.drawTo(function(){e.bind(0),i.bind(1),s.bind(2),o.bind(3),r.uniforms(h).draw(n)}),this.setOutputData(0,this._texture)},m.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_textureR;\n\t\tuniform sampler2D u_textureG;\n\t\tuniform sampler2D u_textureB;\n\t\tuniform sampler2D u_textureA;\n\t\tuniform vec4 u_color;\n\t\t\n\t\tvoid main() {\n\t\t   gl_FragColor = u_color * vec4( \t\t\t\t\ttexture2D(u_textureR, v_coord).r,\t\t\t\t\ttexture2D(u_textureG, v_coord).r,\t\t\t\t\ttexture2D(u_textureB, v_coord).r,\t\t\t\t\ttexture2D(u_textureA, v_coord).r);\n\t\t}\n\t\t",a.registerNodeType("texture/channelsTexture",m),e.title="Color",e.desc="Generates a 1x1 texture with a constant color",e.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},e.prototype.onDrawBackground=function(t){var e=this.properties.color;t.fillStyle="rgb("+Math.floor(255*clamp(e[0],0,1))+","+Math.floor(255*clamp(e[1],0,1))+","+Math.floor(255*clamp(e[2],0,1))+")",this.flags.collapsed?this.boxcolor=t.fillStyle:t.fillRect(0,0,this.size[0],this.size[1])},e.prototype.onExecute=function(){var t=this.properties.precision==c.HIGH?c.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,e=(this._tex&&this._tex.type==t||(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:t,minFilter:gl.NEAREST})),this.properties.color);if(this.inputs)for(var i=0;i<this.inputs.length;i++){var s=this.inputs[i],o=this.getInputData(i);if(void 0!==o)switch(s.name){case"RGB":case"RGBA":e.set(o);break;case"R":e[0]=o;break;case"G":e[1]=o;break;case"B":e[2]=o;break;case"A":e[3]=o}}.001<vec4.sqrDist(this._tex_color,e)&&(this._tex_color.set(e),this._tex.fill(e)),this.setOutputData(0,this._tex)},e.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},a.registerNodeType("texture/color",e),y.title="Gradient",y.desc="Generates a gradient",y["@A"]={type:"color"},y["@B"]={type:"color"},y["@texture_size"]={type:"enum",values:[32,64,128,256,512]},y.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var t=GL.Mesh.getScreenQuad(),e=y._shader,i=(i=this.getInputData(0))||this.properties.A,s=(s=this.getInputData(1))||this.properties.B,o=2;o<this.inputs.length;o++){var n=this.inputs[o],r=this.getInputData(o);void 0!==r&&(this.properties[n.name]=r)}var a=this._uniforms,i=(this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(a.u_colorA,i),vec3.copy(a.u_colorB,s),parseInt(this.properties.texture_size));this._tex&&this._tex.width==i||(this._tex=new GL.Texture(i,i,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){e.uniforms(a).draw(t)}),this.setOutputData(0,this._tex)},y.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},y.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform float u_angle;\n\t\tuniform float u_scale;\n\t\tuniform vec3 u_colorA;\n\t\tuniform vec3 u_colorB;\n\t\t\n\t\tvec2 rotate(vec2 v, float angle)\n\t\t{\n\t\t\tvec2 result;\n\t\t\tfloat _cos = cos(angle);\n\t\t\tfloat _sin = sin(angle);\n\t\t\tresult.x = v.x * _cos - v.y * _sin;\n\t\t\tresult.y = v.x * _sin + v.y * _cos;\n\t\t\treturn result;\n\t\t}\n\t\tvoid main() {\n\t\t\tfloat f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n\t\t\tvec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n\t\t   gl_FragColor = vec4(color,1.0);\n\t\t}\n\t\t",a.registerNodeType("texture/gradient",y),x.title="Mix",x.desc="Generates a texture mixing two textures",x.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},x.prototype.onExecute=function(){var t,e,i,s,o,n,r,a=this.getInputData(0);this.isOutputConnected(0)&&(this.properties.precision===c.PASS_THROUGH?this.setOutputData(0,a):(t=this.getInputData(1),a&&t&&(e=this.getInputData(2),n=this.getInputData(3),this._tex=c.getTargetTexture(this.properties.size_from_biggest&&t.width>a.width?t:a,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),i=Mesh.getScreenQuad(),o=null,s=this._uniforms,e?o=(o=x._shader_tex)||(x._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,x.pixel_shader,{MIX_TEX:""})):(o=(o=x._shader_factor)||(x._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,x.pixel_shader)),n=null==n?this.properties.factor:n,s.u_mix.set([n,n,n,n])),r=this.properties.invert,this._tex.drawTo(function(){a.bind(r?1:0),t.bind(r?0:1),e&&e.bind(2),o.uniforms(s).draw(i)}),this.setOutputData(0,this._tex))))},x.prototype.onGetInputs=function(){return[["factor","number"]]},x.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_textureA;\n\t\tuniform sampler2D u_textureB;\n\t\t#ifdef MIX_TEX\n\t\t\tuniform sampler2D u_textureMix;\n\t\t#else\n\t\t\tuniform vec4 u_mix;\n\t\t#endif\n\t\t\n\t\tvoid main() {\n\t\t\t#ifdef MIX_TEX\n\t\t\t   vec4 f = texture2D(u_textureMix, v_coord);\n\t\t\t#else\n\t\t\t   vec4 f = u_mix;\n\t\t\t#endif\n\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );\n\t\t}\n\t\t",a.registerNodeType("texture/mix",x),b.title="Edges",b.desc="Detects edges",b.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},b.prototype.onExecute=function(){var t,e,i,s,o,n;this.isOutputConnected(0)&&(t=this.getInputData(0),this.properties.precision===c.PASS_THROUGH?this.setOutputData(0,t):t&&(this._tex=c.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),e=Mesh.getScreenQuad(),i=b._shader,s=this.properties.invert,o=this.properties.factor,n=this.properties.threshold?1:0,this._tex.drawTo(function(){t.bind(0),i.uniforms({u_texture:0,u_isize:[1/t.width,1/t.height],u_factor:o,u_threshold:n,u_invert:s?1:0}).draw(e)}),this.setOutputData(0,this._tex)))},b.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_isize;\n\t\tuniform int u_invert;\n\t\tuniform float u_factor;\n\t\tuniform float u_threshold;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 center = texture2D(u_texture, v_coord);\n\t\t\tvec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n\t\t\tvec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n\t\t\tvec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n\t\t\tvec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n\t\t\tvec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n\t\t\tdiff *= u_factor;\n\t\t\tif(u_invert == 1)\n\t\t\t\tdiff.xyz = vec3(1.0) - diff.xyz;\n\t\t\tif( u_threshold == 0.0 )\n\t\t\t\tgl_FragColor = vec4( diff.xyz, center.a );\n\t\t\telse\n\t\t\t\tgl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n\t\t}\n\t\t",a.registerNodeType("texture/edges",b),T.title="Depth Range",T.desc="Generates a texture with a depth range",T.prototype.onExecute=function(){var t,e,i,s,o,n;this.isOutputConnected(0)&&(t=this.getInputData(0))&&(n=gl.UNSIGNED_BYTE,this.properties.high_precision&&(n=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==n&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:n,format:gl.RGBA,filter:gl.LINEAR})),e=this._uniforms,n=this.properties.distance,this.isInputConnected(1)&&(n=this.getInputData(1),this.properties.distance=n),i=this.properties.range,this.isInputConnected(2)&&(i=this.getInputData(2),this.properties.range=i),e.u_distance=n,e.u_range=i,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),s=Mesh.getScreenQuad(),T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader),T._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader,{ONLY_DEPTH:""})),o=this.properties.only_depth?T._shader_onlydepth:T._shader,n=null,n=t.near_far_planes||(window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3]),e.u_camera_planes=n,this._temp_texture.drawTo(function(){t.bind(0),o.uniforms(e).draw(s)}),this._temp_texture.near_far_planes=n,this.setOutputData(0,this._temp_texture))},T.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform float u_distance;\n\t\tuniform float u_range;\n\t\t\n\t\tfloat LinearDepth()\n\t\t{\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\tfloat depth = texture2D(u_texture, v_coord).x;\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\treturn zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t\tfloat depth = LinearDepth();\n\t\t\t#ifdef ONLY_DEPTH\n\t\t\t   gl_FragColor = vec4(depth);\n\t\t\t#else\n\t\t\t\tfloat diff = abs(depth * u_camera_planes.y - u_distance);\n\t\t\t\tfloat dof = 1.0;\n\t\t\t\tif(diff <= u_range)\n\t\t\t\t\tdof = diff / u_range;\n\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t#endif\n\t\t}\n\t\t",a.registerNodeType("texture/depth_range",T),E.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},E.title="Linear Depth",E.desc="Creates a color texture with linear depth",E.prototype.onExecute=function(){var t,e,i,s,o;!this.isOutputConnected(0)||!(t=this.getInputData(0))||t.format!=gl.DEPTH_COMPONENT&&t.format!=gl.DEPTH_STENCIL||(o=this.properties.precision==c.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,this._temp_texture&&this._temp_texture.type==o&&this._temp_texture.width==t.width&&this._temp_texture.height==t.height||(this._temp_texture=new GL.Texture(t.width,t.height,{type:o,format:gl.RGB,filter:gl.LINEAR})),(e=this._uniforms).u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),i=Mesh.getScreenQuad(),s=E._shader=E._shader||new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,E.pixel_shader),o=null,o=t.near_far_planes||(window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3]),e.u_camera_planes=o,e.u_ires.set([0,0]),this._temp_texture.drawTo(function(){t.bind(0),s.uniforms(e).draw(i)}),this._temp_texture.near_far_planes=o,this.setOutputData(0,this._temp_texture))},E.pixel_shader="precision highp float;\n\t\tprecision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform int u_invert;\n\t\tuniform vec2 u_ires;\n\t\t\n\t\tvoid main() {\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\tfloat depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;\n\t\t\tfloat f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tif( u_invert == 1 )\n\t\t\t\tf = 1.0 - f;\n\t\t\tgl_FragColor = vec4(vec3(f),1.0);\n\t\t}\n\t\t",a.registerNodeType("texture/linear_depth",E),w.title="Blur",w.desc="Blur a texture",w.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},w.max_iterations=20,w.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&this.isOutputConnected(0)){var e=this._final_texture,i=(e&&e.width==t.width&&e.height==t.height&&e.type==t.type||(e=this._final_texture=new GL.Texture(t.width,t.height,{type:t.type,format:gl.RGBA,filter:gl.LINEAR})),this.properties.iterations);if(this.isInputConnected(1)&&(i=this.getInputData(1),this.properties.iterations=i),0==(i=Math.min(Math.floor(i),w.max_iterations)))this.setOutputData(0,t);else{var s=this.properties.intensity,o=(this.isInputConnected(2)&&(s=this.getInputData(2),this.properties.intensity=s),a.camera_aspect),n=(o=(o=o||void 0===window.gl?o:gl.canvas.height/gl.canvas.width)||1,o=this.properties.preserve_aspect?o:1,this.properties.scale||[1,1]);t.applyBlur(o*n[0],n[1],s,e);for(var r=1;r<i;++r)e.applyBlur(o*n[0]*(r+1),n[1]*(r+1),s);this.setOutputData(0,e)}}},a.registerNodeType("texture/blur",w),L.prototype.applyFX=function(t,e,i,s){var o=t.width,n=t.height,r={format:t.format,type:t.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},a=this._uniforms,u=this._textures,h=L._cut_shader,p=(h=h||(L._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),a.u_threshold=this.threshold,u[0]=GL.Texture.getTemporary(o,n,r)),l=(t.blit(p,h.uniforms(a)),p),d=this.iterations,d=0|clamp(d,1,16),c=a.u_texel_size,_=this.intensity;a.u_intensity=1,a.u_delta=this.scale;h=(h=L._shader)||(L._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.scale_pixel_shader));for(var g,f,v=1;v<d&&(1<(0|n)&&(n>>=1),!((o>>=1)<2));v++)p=u[v]=GL.Texture.getTemporary(o,n,r),c[0]=1/l.width,c[1]=1/l.height,l.blit(p,h.uniforms(a)),l=p;for(s&&(c[0]=1/l.width,c[1]=1/l.height,a.u_intensity=_,a.u_delta=1,l.blit(s,h.uniforms(a))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),a.u_intensity=this.persistence,a.u_delta=.5,v-=2;0<=v;v--)p=u[v],u[v]=null,c[0]=1/l.width,c[1]=1/l.height,l.blit(p,h.uniforms(a)),GL.Texture.releaseTemporary(l),l=p;gl.disable(gl.BLEND),i&&l.blit(i),e&&(s=e,g=this.dirt_texture,f=this.dirt_factor,a.u_intensity=_,h=(h=g?L._dirt_final_shader:L._final_shader)||(g?L._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.final_pixel_shader,{USE_DIRT:""}):L._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,L.final_pixel_shader)),s.drawTo(function(){t.bind(0),l.bind(1),g&&(h.setUniform("u_dirt_factor",f),h.setUniform("u_dirt_texture",g.bind(2))),h.toViewport(a)})),GL.Texture.releaseTemporary(l)},L.cut_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform float u_threshold;\n\tvoid main() {\n\t\tgl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n\t}",L.scale_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform vec2 u_texel_size;\n\tuniform float u_delta;\n\tuniform float u_intensity;\n\t\n\tvec4 sampleBox(vec2 uv) {\n\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\tvec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n\t\treturn s * 0.25;\n\t}\n\tvoid main() {\n\t\tgl_FragColor = u_intensity * sampleBox( v_coord );\n\t}",L.final_pixel_shader="precision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform sampler2D u_glow_texture;\n\t#ifdef USE_DIRT\n\t\tuniform sampler2D u_dirt_texture;\n\t#endif\n\tuniform vec2 u_texel_size;\n\tuniform float u_delta;\n\tuniform float u_intensity;\n\tuniform float u_dirt_factor;\n\t\n\tvec4 sampleBox(vec2 uv) {\n\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\tvec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n\t\treturn s * 0.25;\n\t}\n\tvoid main() {\n\t\tvec4 glow = sampleBox( v_coord );\n\t\t#ifdef USE_DIRT\n\t\t\tglow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n\t\t#endif\n\t\tgl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n\t}",i.title="Glow",i.desc="Filters a texture giving it a glow effect",i.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:c.MODE_VALUES}},i.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},i.prototype.onGetOutputs=function(){return[["average","Texture"]]},i.prototype.onExecute=function(){var t,e,i,s,o,n=this.getInputData(0);n&&this.isAnyOutputConnected()&&(this.properties.precision===c.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,n):(n.width,n.height,(t=this.fx).threshold=this.getInputOrProperty("threshold"),t.iterations=this.getInputOrProperty("iterations"),t.intensity=this.getInputOrProperty("intensity"),t.persistence=this.getInputOrProperty("persistence"),t.dirt_texture=this.getInputData(1),t.dirt_factor=this.getInputOrProperty("dirt_factor"),t.scale=this.properties.scale,e=c.getTextureType(this.properties.precision,n),i=null,!this.isOutputConnected(2)||(i=this._average_texture)&&i.type==n.type&&i.format==n.format||(i=this._average_texture=new GL.Texture(1,1,{type:n.type,format:n.format,filter:gl.LINEAR})),s=null,!this.isOutputConnected(1)||(s=this._glow_texture)&&s.width==n.width&&s.height==n.height&&s.type==e&&s.format==n.format||(s=this._glow_texture=new GL.Texture(n.width,n.height,{type:e,format:n.format,filter:gl.LINEAR})),o=null,!this.isOutputConnected(0)||(o=this._final_texture)&&o.width==n.width&&o.height==n.height&&o.type==e&&o.format==n.format||(o=this._final_texture=new GL.Texture(n.width,n.height,{type:e,format:n.format,filter:gl.LINEAR})),t.applyFX(n,o,s,i),this.isOutputConnected(0)&&this.setOutputData(0,o),this.isOutputConnected(1)&&this.setOutputData(1,i),this.isOutputConnected(2)&&this.setOutputData(2,s)))},a.registerNodeType("texture/glow",i),O.title="Kuwahara Filter",O.desc="Filters a texture giving an artistic oil canvas painting",O.max_radius=10,O._shaders=[],O.prototype.onExecute=function(){var t,e,i,s,o,n=this.getInputData(0);n&&this.isOutputConnected(0)&&((o=this._temp_texture)&&o.width==n.width&&o.height==n.height&&o.type==n.type||(this._temp_texture=new GL.Texture(n.width,n.height,{type:n.type,format:gl.RGBA,filter:gl.LINEAR})),o=this.properties.radius,0==(o=Math.min(Math.floor(o),O.max_radius))?this.setOutputData(0,n):(t=this.properties.intensity,e=(e=(e=a.camera_aspect)||void 0===window.gl?e:gl.canvas.height/gl.canvas.width)||1,e=this.properties.preserve_aspect?e:1,O._shaders[o]||(O._shaders[o]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,O.pixel_shader,{RADIUS:o.toFixed(0)})),i=O._shaders[o],s=GL.Mesh.getScreenQuad(),n.bind(0),this._temp_texture.drawTo(function(){i.uniforms({u_texture:0,u_intensity:t,u_resolution:[n.width,n.height],u_iResolution:[1/n.width,1/n.height]}).draw(s)}),this.setOutputData(0,this._temp_texture)))},O.pixel_shader="\nprecision highp float;\nvarying vec2 v_coord;\nuniform sampler2D u_texture;\nuniform float u_intensity;\nuniform vec2 u_resolution;\nuniform vec2 u_iResolution;\n#ifndef RADIUS\n\t#define RADIUS 7\n#endif\nvoid main() {\n\n\tconst int radius = RADIUS;\n\tvec2 fragCoord = v_coord;\n\tvec2 src_size = u_iResolution;\n\tvec2 uv = v_coord;\n\tfloat n = float((radius + 1) * (radius + 1));\n\tint i;\n\tint j;\n\tvec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n\tvec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n\tvec3 c;\n\t\n\tfor (int j = -radius; j <= 0; ++j)  {\n\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm0 += c;\n\t\t\ts0 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = -radius; j <= 0; ++j)  {\n\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm1 += c;\n\t\t\ts1 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = 0; j <= radius; ++j)  {\n\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm2 += c;\n\t\t\ts2 += c * c;\n\t\t}\n\t}\n\t\n\tfor (int j = 0; j <= radius; ++j)  {\n\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\tm3 += c;\n\t\t\ts3 += c * c;\n\t\t}\n\t}\n\t\n\tfloat min_sigma2 = 1e+2;\n\tm0 /= n;\n\ts0 = abs(s0 / n - m0 * m0);\n\t\n\tfloat sigma2 = s0.r + s0.g + s0.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m0, 1.0);\n\t}\n\t\n\tm1 /= n;\n\ts1 = abs(s1 / n - m1 * m1);\n\t\n\tsigma2 = s1.r + s1.g + s1.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m1, 1.0);\n\t}\n\t\n\tm2 /= n;\n\ts2 = abs(s2 / n - m2 * m2);\n\t\n\tsigma2 = s2.r + s2.g + s2.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m2, 1.0);\n\t}\n\t\n\tm3 /= n;\n\ts3 = abs(s3 / n - m3 * m3);\n\t\n\tsigma2 = s3.r + s3.g + s3.b;\n\tif (sigma2 < min_sigma2) {\n\t\tmin_sigma2 = sigma2;\n\t\tgl_FragColor = vec4(m3, 1.0);\n\t}\n}\n",a.registerNodeType("texture/kuwahara",O),I.title="XDoG Filter",I.desc="Filters a texture giving an artistic ink style",I.max_radius=10,I._shaders=[],I.prototype.onExecute=function(){var t,e,i,s,o,n,r,a,u=this.getInputData(0);u&&this.isOutputConnected(0)&&((t=this._temp_texture)&&t.width==u.width&&t.height==u.height&&t.type==u.type||(this._temp_texture=new GL.Texture(u.width,u.height,{type:u.type,format:gl.RGBA,filter:gl.LINEAR})),e=I._xdog_shader=I._xdog_shader||new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.xdog_pixel_shader),i=GL.Mesh.getScreenQuad(),s=this.properties.sigma,o=this.properties.k,n=this.properties.p,r=this.properties.epsilon,a=this.properties.phi,u.bind(0),this._temp_texture.drawTo(function(){e.uniforms({src:0,sigma:s,k:o,p:n,epsilon:r,phi:a,cvsWidth:u.width,cvsHeight:u.height}).draw(i)}),this.setOutputData(0,this._temp_texture))},I.xdog_pixel_shader="\nprecision highp float;\nuniform sampler2D src;\n\nuniform float cvsHeight;\nuniform float cvsWidth;\n\nuniform float sigma;\nuniform float k;\nuniform float p;\nuniform float epsilon;\nuniform float phi;\nvarying vec2 v_coord;\n\nfloat cosh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat cosH = (tmp + 1.0 / tmp) / 2.0;\n\treturn cosH;\n}\n\nfloat tanh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);\n\treturn tanH;\n}\n\nfloat sinh(float val)\n{\n\tfloat tmp = exp(val);\n\tfloat sinH = (tmp - 1.0 / tmp) / 2.0;\n\treturn sinH;\n}\n\nvoid main(void){\n\tvec3 destColor = vec3(0.0);\n\tfloat tFrag = 1.0 / cvsHeight;\n\tfloat sFrag = 1.0 / cvsWidth;\n\tvec2 Frag = vec2(sFrag,tFrag);\n\tvec2 uv = gl_FragCoord.st;\n\tfloat twoSigmaESquared = 2.0 * sigma * sigma;\n\tfloat twoSigmaRSquared = twoSigmaESquared * k * k;\n\tint halfWidth = int(ceil( 1.0 * sigma * k ));\n\n\tconst int MAX_NUM_ITERATION = 99999;\n\tvec2 sum = vec2(0.0);\n\tvec2 norm = vec2(0.0);\n\n\tfor(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){\n\t\tif(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}\n\t\tint i = int(cnt / (2*halfWidth+1)) - halfWidth;\n\t\tint j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);\n\n\t\tfloat d = length(vec2(i,j));\n\t\tvec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), \n\t\t\t\t\t\t\texp( -d * d / twoSigmaRSquared ));\n\n\t\tvec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;\n\n\t\tnorm += kernel;\n\t\tsum += kernel * L;\n\t}\n\n\tsum /= norm;\n\n\tfloat H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);\n\tfloat edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));\n\tdestColor = vec3(edge);\n\tgl_FragColor = vec4(destColor, 1.0);\n}",a.registerNodeType("texture/xDoG",I),C.title="Webcam",C.desc="Webcam texture",C.is_webcam_open=!1,C.prototype.openStream=function(){var t,e;navigator.getUserMedia&&(t={audio:!(this._waiting_confirmation=!0),video:{facingMode:this.properties.facingMode}},navigator.mediaDevices.getUserMedia(t).then(this.streamReady.bind(this)).catch(function(t){C.is_webcam_open=!1,console.log("Webcam rejected",t),e._webcam_stream=!1,e.boxcolor="red",e.trigger("stream_error")}),e=this)},C.prototype.closeStream=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();C.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},C.prototype.streamReady=function(t){this._webcam_stream=t,this.boxcolor="green";var e=this._video;e||((e=document.createElement("video")).autoplay=!0,e.srcObject=t,(this._video=e).onloadedmetadata=function(t){C.is_webcam_open=!0,console.log(t)}),this.trigger("stream_ready",e)},C.prototype.onPropertyChanged=function(t,e){"facingMode"==t&&(this.properties.facingMode=e,this.closeStream(),this.openStream())},C.prototype.onRemoved=function(){if(this._webcam_stream){var t=this._webcam_stream.getTracks();if(t.length)for(var e=0;e<t.length;++e)t[e].stop();this._webcam_stream=null,this._video=null}},C.prototype.onDrawBackground=function(t){this.flags.collapsed||this.size[1]<=20||this._video&&(t.save(),t.webgl?this._video_texture&&t.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):t.drawImage(this._video,0,0,this.size[0],this.size[1]),t.restore())},C.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){var t=this._video.videoWidth,e=this._video.videoHeight,i=this._video_texture;i&&i.width==t&&i.height==e||(this._video_texture=new GL.Texture(t,e,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name&&(c.getTexturesContainer()[this.properties.texture_name]=this._video_texture),this.setOutputData(0,this._video_texture);for(var s=1;s<this.outputs.length;++s)if(this.outputs[s])switch(this.outputs[s].name){case"width":this.setOutputData(s,this._video.videoWidth);break;case"height":this.setOutputData(s,this._video.videoHeight)}}},C.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",a.EVENT],["stream_closed",a.EVENT],["stream_error",a.EVENT]]},a.registerNodeType("texture/webcam",C),D.title="Lens FX",D.desc="distortion and chromatic aberration",D.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},D.prototype.onGetInputs=function(){return[["enabled","boolean"]]},D.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);o&&this.isOutputConnected(0)&&(this.properties.precision===c.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,o):((t=this._temp_texture)&&t.width==o.width&&t.height==o.height&&t.type==o.type||(t=this._temp_texture=new GL.Texture(o.width,o.height,{type:o.type,format:gl.RGBA,filter:gl.LINEAR})),e=(e=D._shader)||(D._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,D.pixel_shader)),null==(i=this.getInputData(1))&&(i=this.properties.factor),(s=this._uniforms).u_factor=i,gl.disable(gl.DEPTH_TEST),t.drawTo(function(){o.bind(0),e.uniforms(s).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,t)))},D.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_factor;\n\t\tvec2 barrelDistortion(vec2 coord, float amt) {\n\t\t\tvec2 cc = coord - 0.5;\n\t\t\tfloat dist = dot(cc, cc);\n\t\t\treturn coord + cc * dist * amt;\n\t\t}\n\t\t\n\t\tfloat sat( float t )\n\t\t{\n\t\t\treturn clamp( t, 0.0, 1.0 );\n\t\t}\n\t\t\n\t\tfloat linterp( float t ) {\n\t\t\treturn sat( 1.0 - abs( 2.0*t - 1.0 ) );\n\t\t}\n\t\t\n\t\tfloat remap( float t, float a, float b ) {\n\t\t\treturn sat( (t - a) / (b - a) );\n\t\t}\n\t\t\n\t\tvec4 spectrum_offset( float t ) {\n\t\t\tvec4 ret;\n\t\t\tfloat lo = step(t,0.5);\n\t\t\tfloat hi = 1.0-lo;\n\t\t\tfloat w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n\t\t\tret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n\t\t\n\t\t\treturn pow( ret, vec4(1.0/2.2) );\n\t\t}\n\t\t\n\t\tconst float max_distort = 2.2;\n\t\tconst int num_iter = 12;\n\t\tconst float reci_num_iter_f = 1.0 / float(num_iter);\n\t\t\n\t\tvoid main()\n\t\t{\t\n\t\t\tvec2 uv=v_coord;\n\t\t\tvec4 sumcol = vec4(0.0);\n\t\t\tvec4 sumw = vec4(0.0);\t\n\t\t\tfor ( int i=0; i<num_iter;++i )\n\t\t\t{\n\t\t\t\tfloat t = float(i) * reci_num_iter_f;\n\t\t\t\tvec4 w = spectrum_offset( t );\n\t\t\t\tsumw += w;\n\t\t\t\tsumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n\t\t\t}\n\t\t\tgl_FragColor = sumcol / sumw;\n\t\t}",a.registerNodeType("texture/lensfx",D),U.title="Data->Tex",U.desc="Generates or applies a curve to a texture",U.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},U.prototype.onExecute=function(){var t,e,i,s,o,n;this.isOutputConnected(0)&&(t=this.getInputData(0))&&(o=this.properties.channels,e=this.properties.width,i=this.properties.height,e&&i||(e=Math.floor(t.length/o),i=1),s=gl.RGBA,3==o?s=gl.RGB:1==o&&(s=gl.LUMINANCE),o=this._temp_texture,n=c.getTextureType(this.properties.precision),(o=o&&o.width==e&&o.height==i&&o.type==n?o:this._temp_texture=new GL.Texture(e,i,{type:n,format:s,filter:gl.LINEAR})).uploadData(t),this.setOutputData(0,o))},a.registerNodeType("texture/fromdata",U),N.title="Curve",N.desc="Generates or applies a curve to a texture",N.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},N.prototype.onExecute=function(){var t,e,i,s,o,n;this.isOutputConnected(0)&&(t=this.getInputData(0),e=this._temp_texture,t?(i=c.getTextureType(this.properties.precision,t),e&&e.type==i&&e.width==t.width&&e.height==t.height&&e.format==t.format||(e=this._temp_texture=new GL.Texture(t.width,t.height,{type:i,format:t.format,filter:gl.LINEAR})),s=(s=N._shader)||(N._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,N.pixel_shader)),!this._must_update&&this._curve_texture||this.updateCurve(),o=this._uniforms,n=this._curve_texture,e.drawTo(function(){gl.disable(gl.DEPTH_TEST),t.bind(0),n.bind(1),s.uniforms(o).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,e)):(!this._must_update&&this._curve_texture||this.updateCurve(),this.setOutputData(0,this._curve_texture)))},N.prototype.sampleCurve=function(t,e){if(e=e||this._points.RGB){for(var i=0;i<e.length-1;++i){var s,o=e[i],n=e[i+1];if(!(n[0]<t))return s=n[0]-o[0],Math.abs(s)<1e-5?o[1]:(s=(t-o[0])/s,o[1]*(1-s)+n[1]*s)}return 0}},N.prototype.updateCurve=function(){for(var t,e=this._values,i=e.length/4,s=this.properties.split_channels,o=0;o<i;++o)s?(e[4*o]=clamp(255*this.sampleCurve(o/i,this._points.R),0,255),e[4*o+1]=clamp(255*this.sampleCurve(o/i,this._points.G),0,255),e[4*o+2]=clamp(255*this.sampleCurve(o/i,this._points.B),0,255)):(t=this.sampleCurve(o/i),e[4*o]=e[4*o+1]=e[4*o+2]=clamp(255*t,0,255)),e[4*o+3]=255;this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(e,null,!0)},N.prototype.onSerialize=function(t){var e,i={};for(e in this._points)i[e]=this._points[e].concat();t.curves=i},N.prototype.onConfigure=function(t){this._points=t.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},N.prototype.onMouseDown=function(t,e,i){if(this.curve_editor)return(e=this.curve_editor.onMouseDown([e[0],e[1]-this.curve_offset],i))&&this.captureInput(!0),e},N.prototype.onMouseMove=function(t,e,i){if(this.curve_editor)return this.curve_editor.onMouseMove([e[0],e[1]-this.curve_offset],i)},N.prototype.onMouseUp=function(t,e,i){if(this.curve_editor)return this.curve_editor.onMouseUp([e[0],e[1]-this.curve_offset],i);this.captureInput(!1)},N.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},N.prototype.onDrawBackground=function(t,e){var i;this.flags.collapsed||(this.curve_editor||(this.curve_editor=new a.CurveEditor(this._points.R)),t.save(),t.translate(0,this.curve_offset),i=this.widgets[1].value,this.properties.split_channels?("RGB"==i&&(this.widgets[1].value=i="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],e,"#111",N.channel_line_colors.R,!0),t.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],e,null,N.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],e,null,N.channel_line_colors.B,!0),t.globalCompositeOperation="source-over"):(this.widgets[1].value=i="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[i],this.curve_editor.draw(t,[this.size[0],this.size[1]-this.curve_offset],e,this.properties.split_channels?null:"#111",N.channel_line_colors[i]),t.restore())},N.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_curve;\n\t\tuniform float u_range;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord ) * u_range;\n\t\t\tcolor.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;\n\t\t\tcolor.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;\n\t\t\tcolor.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;\n\t\t\t//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;\n\t\t\tgl_FragColor = color;\n\t\t}",a.registerNodeType("texture/curve",N),G.title="Exposition",G.desc="Controls texture exposition",G.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:c.MODE_VALUES}},G.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);o&&this.isOutputConnected(0)&&((t=this._temp_texture)&&t.width==o.width&&t.height==o.height&&t.type==o.type||(t=this._temp_texture=new GL.Texture(o.width,o.height,{type:o.type,format:gl.RGBA,filter:gl.LINEAR})),e=(e=G._shader)||(G._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,G.pixel_shader)),this.properties.exposition,null!=(i=this.getInputData(1))&&(this.properties.exposition=i),s=this._uniforms,t.drawTo(function(){gl.disable(gl.DEPTH_TEST),o.bind(0),e.uniforms(s).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,t))},G.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_exposition;\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\tgl_FragColor = vec4( color.xyz * u_exposition, color.a );\n\t\t}",a.registerNodeType("texture/exposition",G),S.title="Tone Mapping",S.desc="Applies Tone Mapping to convert from high to low",S.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES}},S.prototype.onGetInputs=function(){return[["enabled","boolean"]]},S.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);o&&this.isOutputConnected(0)&&(this.properties.precision===c.PASS_THROUGH||!1===this.getInputOrProperty("enabled")?this.setOutputData(0,o):((t=this._temp_texture)&&t.width==o.width&&t.height==o.height&&t.type==o.type||(t=this._temp_texture=new GL.Texture(o.width,o.height,{type:o.type,format:gl.RGBA,filter:gl.LINEAR})),null==(e=this.getInputData(1))&&(e=this.properties.average_lum),i=this._uniforms,s=null,e.constructor===Number?(this.properties.average_lum=e,i.u_average_lum=this.properties.average_lum,s=(s=S._shader)||(S._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,S.pixel_shader))):e.constructor===GL.Texture&&(i.u_average_texture=e.bind(1),s=(s=S._shader_texture)||(S._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,S.pixel_shader,{AVG_TEXTURE:""}))),i.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,i.u_scale=this.properties.scale,i.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),t.drawTo(function(){o.bind(0),s.uniforms(i).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)))},S.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_scale;\n\t\t#ifdef AVG_TEXTURE\n\t\t\tuniform sampler2D u_average_texture;\n\t\t#else\n\t\t\tuniform float u_average_lum;\n\t\t#endif\n\t\tuniform float u_lumwhite2;\n\t\tuniform float u_igamma;\n\t\tvec3 RGB2xyY (vec3 rgb)\n\t\t{\n\t\t\t const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n\t\t\t\t\t\t\t\t\t   0.2126, 0.7152, 0.0722,\n\t\t\t\t\t\t\t\t\t   0.0193, 0.1192, 0.9505);\n\t\t\tvec3 XYZ = RGB2XYZ * rgb;\n\t\t\t\n\t\t\tfloat f = (XYZ.x + XYZ.y + XYZ.z);\n\t\t\treturn vec3(XYZ.x / f,\n\t\t\t\t\t\tXYZ.y / f,\n\t\t\t\t\t\tXYZ.y);\n\t\t}\n\t\t\n\t\tvoid main() {\n\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\tvec3 rgb = color.xyz;\n\t\t\tfloat average_lum = 0.0;\n\t\t\t#ifdef AVG_TEXTURE\n\t\t\t\tvec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;\n\t\t\t\taverage_lum = (pixel.x + pixel.y + pixel.z) / 3.0;\n\t\t\t#else\n\t\t\t\taverage_lum = u_average_lum;\n\t\t\t#endif\n\t\t\t//Ld - this part of the code is the same for both versions\n\t\t\tfloat lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n\t\t\tfloat L = (u_scale / average_lum) * lum;\n\t\t\tfloat Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n\t\t\t//first\n\t\t\t//vec3 xyY = RGB2xyY(rgb);\n\t\t\t//xyY.z *= Ld;\n\t\t\t//rgb = xyYtoRGB(xyY);\n\t\t\t//second\n\t\t\trgb = (rgb / lum) * Ld;\n\t\t\trgb = max(rgb,vec3(0.001));\n\t\t\trgb = pow( rgb, vec3( u_igamma ) );\n\t\t\tgl_FragColor = vec4( rgb, color.a );\n\t\t}",a.registerNodeType("texture/tonemapping",S),A.title="Perlin",A.desc="Generates a perlin noise texture",A.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},A.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},A.prototype.onExecute=function(){var t,e,i,s,o,n,r,a,u,h,p,l;this.isOutputConnected(0)&&(t=0|this.properties.width,e=0|this.properties.height,0==t&&(t=gl.viewport_data[2]),0==e&&(e=gl.viewport_data[3]),u=c.getTextureType(this.properties.precision),(i=this._texture)&&i.width==t&&i.height==e&&i.type==u||(i=this._texture=new GL.Texture(t,e,{type:u,format:gl.RGB,filter:gl.LINEAR})),s=this.getInputOrProperty("persistence"),o=this.getInputOrProperty("octaves"),n=this.getInputOrProperty("offset"),r=this.getInputOrProperty("scale"),a=this.getInputOrProperty("amplitude"),(h=""+t+e+u+s+o+r+(u=this.getInputOrProperty("seed"))+n[0]+n[1]+a)!=this._key&&(this._key=h,(p=this._uniforms).u_persistence=s,p.u_octaves=o,p.u_offset.set(n),p.u_scale=r,p.u_amplitude=a,p.u_seed=128*u,p.u_viewport[0]=t,p.u_viewport[1]=e,l=(l=A._shader)||(A._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,A.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),i.drawTo(function(){l.uniforms(p).draw(GL.Mesh.getScreenQuad())})),this.setOutputData(0,i))},A.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_offset;\n\t\tuniform float u_scale;\n\t\tuniform float u_persistence;\n\t\tuniform int u_octaves;\n\t\tuniform float u_amplitude;\n\t\tuniform vec2 u_viewport;\n\t\tuniform float u_seed;\n\t\t#define M_PI 3.14159265358979323846\n\t\t\n\t\tfloat rand(vec2 c){\treturn fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n\t\t\n\t\tfloat noise(vec2 p, float freq ){\n\t\t\tfloat unit = u_viewport.x/freq;\n\t\t\tvec2 ij = floor(p/unit);\n\t\t\tvec2 xy = mod(p,unit)/unit;\n\t\t\t//xy = 3.*xy*xy-2.*xy*xy*xy;\n\t\t\txy = .5*(1.-cos(M_PI*xy));\n\t\t\tfloat a = rand((ij+vec2(0.,0.)));\n\t\t\tfloat b = rand((ij+vec2(1.,0.)));\n\t\t\tfloat c = rand((ij+vec2(0.,1.)));\n\t\t\tfloat d = rand((ij+vec2(1.,1.)));\n\t\t\tfloat x1 = mix(a, b, xy.x);\n\t\t\tfloat x2 = mix(c, d, xy.x);\n\t\t\treturn mix(x1, x2, xy.y);\n\t\t}\n\t\t\n\t\tfloat pNoise(vec2 p, int res){\n\t\t\tfloat persistance = u_persistence;\n\t\t\tfloat n = 0.;\n\t\t\tfloat normK = 0.;\n\t\t\tfloat f = 4.;\n\t\t\tfloat amp = 1.0;\n\t\t\tint iCount = 0;\n\t\t\tfor (int i = 0; i<50; i++){\n\t\t\t\tn+=amp*noise(p, f);\n\t\t\t\tf*=2.;\n\t\t\t\tnormK+=amp;\n\t\t\t\tamp*=persistance;\n\t\t\t\tif (iCount >= res)\n\t\t\t\t\tbreak;\n\t\t\t\tiCount++;\n\t\t\t}\n\t\t\tfloat nf = n/normK;\n\t\t\treturn nf*nf*nf*nf;\n\t\t}\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n\t\t\tvec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n\t\t\tgl_FragColor = color;\n\t\t}",a.registerNodeType("texture/perlin",A),k.title="Canvas2D",k.desc="Executes Canvas2D code inside a texture or the viewport.",k.help="Set width and height to 0 to match viewport size.",k.default_code="//vars: canvas,ctx,time\nctx.fillStyle='red';\nctx.fillRect(0,0,50,50);\n",k.widgets_info={precision:{widget:"combo",values:c.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},k.prototype.onPropertyChanged=function(t,e){"code"==t&&this.compileCode(e)},k.prototype.compileCode=function(t){if(this._func=null,a.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",t),this.boxcolor="#00FF00"}catch(t){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(t)}},k.prototype.onExecute=function(){var t=this._func;t&&this.isOutputConnected(0)&&this.executeDraw(t)},k.prototype.executeDraw=function(t){var e=this.properties.width||gl.canvas.width,i=this.properties.height||gl.canvas.height,s=this._temp_texture,o=c.getTextureType(this.properties.precision),n=(s&&s.width==e&&s.height==i&&s.type==o||(s=this._temp_texture=new GL.Texture(e,i,{format:gl.RGBA,filter:gl.LINEAR,type:o})),this.getInputData(0)),r=this.properties,a=this,u=this.graph.getTime(),h=gl,p=gl.canvas;if(!this.properties.use_html_canvas&&P.enableWebGLCanvas||(h=this._canvas?(p=this._canvas,this._ctx):(p=this._canvas=createCanvas(e.height),this._ctx=p.getContext("2d")),p.width=e,p.height=i),h==gl)s.drawTo(function(){gl.start2D(),r.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{(t.draw||t).call(a,p,h,u,t,n),a.boxcolor="#00FF00"}catch(t){a.boxcolor="#FF0000",console.error("Error executing script"),console.error(t)}gl.finish2D()});else{r.clear&&h.clearRect(0,0,p.width,p.height);try{(t.draw||t).call(this,p,h,u,t,n),this.boxcolor="#00FF00"}catch(t){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(t)}s.uploadImage(p)}this.setOutputData(0,s)},a.registerNodeType("texture/canvas2D",k),R.title="Matte",R.desc="Extracts background",R.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:c.MODE_VALUES}},R.prototype.onExecute=function(){var t,e,i,s;this.isOutputConnected(0)&&(t=this.getInputData(0),this.properties.precision===c.PASS_THROUGH?this.setOutputData(0,t):t&&(this._tex=c.getTargetTexture(t,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1}),e=this._uniforms,i=Mesh.getScreenQuad(),s=(s=R._shader)||(R._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,R.pixel_shader)),e.u_key_color=this.properties.key_color,e.u_threshold=this.properties.threshold,e.u_slope=this.properties.slope,this._tex.drawTo(function(){t.bind(0),s.uniforms(e).draw(i)}),this.setOutputData(0,this._tex)))},R.pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec3 u_key_color;\n\t\tuniform float u_threshold;\n\t\tuniform float u_slope;\n\t\t\n\t\tvoid main() {\n\t\t\tvec3 color = texture2D( u_texture, v_coord ).xyz;\n\t\t\tfloat diff = length( normalize(color) - normalize(u_key_color) );\n\t\t\tfloat edge = u_threshold * (1.0 - u_slope);\n\t\t\tfloat alpha = smoothstep( edge, u_threshold, diff);\n\t\t\tgl_FragColor = vec4( color, alpha );\n\t\t}",a.registerNodeType("texture/matte",R),V.title="CubemapToTexture2D",V.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",V.prototype.onExecute=function(){var t,e;this.isOutputConnected(0)&&(t=this.getInputData(0))&&t.texture_type==GL.TEXTURE_CUBE_MAP&&(!this._last_tex||this._last_tex.height==t.height&&this._last_tex.type==t.type||(this._last_tex=null),e=this.getInputOrProperty("yaw"),this._last_tex=GL.Texture.cubemapToTexture2D(t,t.height,this._last_tex,!0,e),this.setOutputData(0,this._last_tex))},a.registerNodeType("texture/cubemapToTexture2D",V))})(this),(t=>{var a,n,h,u,l,d,c,o,_;function e(){for(var t in d.length=0,u){var e,i=u[t],s=i.indexOf(" "),o=i.substr(0,s),n=i.indexOf("(",s),s=i.substr(s,n-s).trim(),r=i.substr(n+1,i.length-n-2).split(",");for(e in r){var a=r[e].split(" ").filter(function(t){return t});r[e]={type:a[0].trim(),name:a[1].trim()},"="==a[2]&&(r[e].value=a[3].trim())}l[t]={return_type:o,func:s,params:r},d.push(s)}}function i(t,e){e.color="#345",e.filter="shader",e.prototype.clearDestination=function(){this.shader_destination={}},e.prototype.propagateDestination=function(t){if(this.shader_destination[t]=!0,this.inputs)for(var e=0;e<this.inputs.length;++e){var i=this.getInputNode(e);i&&i.propagateDestination(t)}},e.prototype.onPropertyChanged||(e.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),a.registerNodeType("shader::"+t,e)}function g(t,e){return"VAR_"+(e||"TEMP")+"_"+t.id}function f(t,e){return t.inputs&&(e=t.getInputLink(e))&&(t=t.graph.getNodeById(e.origin_id))?t.getOutputVarName?t.getOutputVarName(e.origin_slot):"link_"+t.id+"_"+e.origin_slot:null}function v(t,e){return t.isOutputConnected(e)?"link_"+t.id+"_"+e:null}function s(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}function r(){this.subgraph=new a.LGraph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:"undefined"!=typeof LGraphTexture?LGraphTexture.DEFAULT:2};var t=this.subgraph.findNodesByType("shader::input/uniform")[0],e=(t.pos=[200,300],a.createNode("shader::texture/sampler2D")),i=(e.pos=[400,300],this.subgraph.add(e),a.createNode("shader::output/fragcolor"));i.pos=[600,300],this.subgraph.add(i),t.connect(0,e),e.connect(0,i),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new s,this._context.vs_template="#define VERTEX\n"+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=r.template}function m(){this.addOutput("out",""),this.properties={name:"",type:""}}function y(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}function x(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}function b(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:h,property:"type"}),this.updateWidgets()}function T(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}function E(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}function w(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}function L(){this.addInput("color",n.ALL_TYPES),this.block_delete=!0}function O(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:O.operations})}function I(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:d})}function C(){this.addInput("A",n.ALL_TYPES),this.addInput("B",n.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}function D(){this.addOutput("out","float")}function N(){this.addInput("out",n.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:N.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}function G(){this.addOutput("out","float")}function S(){this.addInput("in","T"),this.addOutput("out","float")}function A(){this.addInput("",n.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}"undefined"!=typeof GL&&(a=t.LiteGraph,(n=a.Shaders={}).GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"],h=n.GLSL_types_const=["float","vec2","vec3","vec4"],u={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},l={},d=[],e(),n.ALL_TYPES="float,vec2,vec3,vec4",n.registerShaderNode=i,n.getInputLinkID=f,n.getOutputLinkID=v,n.getShaderNodeVarName=g,n.parseGLSLDescriptions=e,c=a.valueToGLSL=function(t,e,i){var s=null!=i?i:5;if(!e)if(t.constructor===Number)e="float";else{if(!t.length)throw"unknown type for glsl value: "+t.constructor;switch(t.length){case 2:e="vec2";break;case 3:e="vec3";break;case 4:e="vec4";break;case 9:e="mat3";break;case 16:e="mat4";break;default:throw"unknown type for glsl value size"}}switch(e){case"float":return t.toFixed(s);case"vec2":return"vec2("+t[0].toFixed(s)+","+t[1].toFixed(s)+")";case"color3":case"vec3":return"vec3("+t[0].toFixed(s)+","+t[1].toFixed(s)+","+t[2].toFixed(s)+")";case"color4":case"vec4":return"vec4("+t[0].toFixed(s)+","+t[1].toFixed(s)+","+t[2].toFixed(s)+","+t[3].toFixed(s)+")";case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw e}return""},o=a.varToTypeGLSL=function(t,e,i){if(e==i)return t;if(null==t)switch(i){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!i)throw"error: no output type specified";if("float"==i)switch(e){case"vec2":case"vec3":case"vec4":return t+".x";default:return"0.0"}else if("vec2"==i)switch(e){case"float":return"vec2("+t+")";case"vec3":case"vec4":return t+".xy";default:return"vec2(0.0)"}else if("vec3"==i)switch(e){case"float":return"vec3("+t+")";case"vec2":return"vec3("+t+",0.0)";case"vec4":return t+".xyz";default:return"vec3(0.0)"}else if("vec4"==i)switch(e){case"float":return"vec4("+t+")";case"vec2":return"vec4("+t+",0.0,1.0)";case"vec3":return"vec4("+t+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw"type cannot be converted"},_=a.convertVarToGLSLType=function(t,e,i){if(e==i)return t;if("float"==e)return i+"("+t+")";if("vec2"==i)return"vec2("+t+".xy)";if("vec3"==i){if("vec2"==e)return"vec3("+t+",0.0)";if("vec4"==e)return"vec4("+t+".xyz)"}if("vec4"==i){if("vec2"==e)return"vec4("+t+",0.0,0.0)";if("vec3"==i)return"vec4("+t+",1.0)"}return null},s.prototype.clear=function(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}},s.prototype.addUniform=function(t,e,i){this._uniforms[t]=e,null!=i&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[t]=i)},s.prototype.addFunction=function(t,e){this._functions[t]=e},s.prototype.addCode=function(t,e,i){for(var s in i=i||{"":""}){s=s?s+"_"+t:t;this._codeparts[s]?this._codeparts[s]+=e+"\n":this._codeparts[s]=e+"\n"}},s.prototype.computeCodeBlocks=function(t,e){this.clear();var i=(i=t.findNodesByType("shader::output/vertex"))&&i.length?i[0]:null,s=t.findNodesByType("shader::output/fragcolor");if(!(s=s&&s.length?s[0]:null))return null;t.sendEventToAllNodes("clearDestination"),i&&i.propagateDestination("vs"),s&&s.propagateDestination("fs"),t.sendEventToAllNodes("onGetCode",this);var o="";for(n in this._uniforms)o+="uniform "+this._uniforms[n]+" "+n+";\n";if(e)for(var n in e)o+="uniform "+e[n]+" "+n+";\n";var r="";for(n in this._functions)r+="//"+n+"\n"+this._functions[n]+"\n";i=this._codeparts;return i.uniforms=o,i.functions=r,i},s.prototype.computeShaderCode=function(t){t=this.computeCodeBlocks(t);return{vs_code:GL.Shader.replaceCodeUsingContext(this.vs_template,t),fs_code:GL.Shader.replaceCodeUsingContext(this.fs_template,t)}},s.prototype.computeShader=function(e,t){e=this.computeShaderCode(e);if(console.log(e.vs_code,e.fs_code),!a.catch_exceptions)return this._shader_error=!0,t?t.updateShader(e.vs_code,e.fs_code):t=new GL.Shader(e.vs_code,e.fs_code),this._shader_error=!1,t;try{return t?t.updateShader(e.vs_code,e.fs_code):t=new GL.Shader(e.vs_code,e.fs_code),this._shader_error=!1,t}catch(t){this._shader_error||(console.error(t),-1!=t.indexOf("Fragment shader")?console.log(e.fs_code.split("\n").map(function(t,e){return e+".- "+t}).join("\n")):console.log(e.vs_code)),this._shader_error=!0}return null},s.prototype.getShader=function(t){var e;return this._shader&&this._shader._version==t._version?this._shader:(e=this.computeShader(t,this._shader))?((this._shader=e)._version=t._version,e):null},s.prototype.fillUniforms=function(t,e){if(this._uniform_value)for(var i in this._uniform_value){var s=this._uniform_value[i];null!=s&&(s.constructor===Function?t[i]=s.call(this,e):s.constructor!==GL.Texture&&(t[i]=s))}},a.ShaderContext=a.Shaders.Context=s,r.template="\n#define FRAGMENT\nprecision highp float;\nvarying vec2 v_coord;\n{{varying}}\n{{uniforms}}\n{{functions}}\n{{fs_functions}}\nvoid main() {\n\nvec2 uv = v_coord;\nvec4 fragcolor = vec4(0.0);\nvec4 fragcolor1 = vec4(0.0);\n{{fs_code}}\ngl_FragColor = fragcolor;\n}\n\t",r.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},r.title="ShaderGraph",r.desc="Builds a shader using a graph",r.input_node_type="input/uniform",r.output_node_type="output/fragcolor",r.title_color="#345",r.prototype.onSerialize=function(t){t.subgraph=this.subgraph.serialize()},r.prototype.onConfigure=function(t){this.subgraph.configure(t.subgraph)},r.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0),e=(t&&t.constructor!=GL.Texture&&(t=null),0|this.properties.width),i=0|this.properties.height,t=(0==e&&(e=t?t.width:gl.viewport_data[2]),0==i&&(i=t?t.height:gl.viewport_data[3]),LGraphTexture.getTextureType(this.properties.precision,t)),s=this._texture,o=(s&&s.width==e&&s.height==i&&s.type==t||(s=this._texture=new GL.Texture(e,i,{type:t,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR})),this.getShader(this.subgraph));if(o){var n=this._uniforms,r=(this._context.fillUniforms(n),0);if(this.inputs)for(var a=0;a<this.inputs.length;++a){var u=this.inputs[a],h=this.getInputData(a);null!=(h="texture"==u.type?(h=h||GL.Texture.getWhiteTexture()).bind(r++):h)&&(n["u_"+u.name]=h)}var p=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),s.drawTo(function(){o.uniforms(n),o.draw(p)}),this.setOutputData(0,s)}}},r.prototype.onInputAdded=function(t){var e=a.createNode("shader::input/uniform");e.setProperty("name",t.name),e.setProperty("type",t.type),this.subgraph.add(e)},r.prototype.onInputRemoved=function(t,e){for(var i=this.subgraph.findNodesByType("shader::input/uniform"),s=0;s<i.length;++s){var o=i[s];o.properties.name==e.name&&this.subgraph.remove(o)}},r.prototype.computeSize=function(){var t=this.inputs?this.inputs.length:0,e=this.outputs?this.outputs.length:0;return[200,Math.max(t,e)*a.NODE_SLOT_HEIGHT+a.NODE_TITLE_HEIGHT+10]},r.prototype.getShader=function(){var t=this._context.getShader(this.subgraph);return this.boxcolor=t?null:"red",t},r.prototype.onDrawBackground=function(t,e,i,s){var o,n,r;this.flags.collapsed||(r=this.getOutputData(0),o=this.inputs?this.inputs.length*a.NODE_SLOT_HEIGHT:0,r&&t==r.gl&&this.size[1]>o+a.NODE_TITLE_HEIGHT&&t.drawImage(r,10,n,this.size[0]-20,this.size[1]-o-a.NODE_TITLE_HEIGHT),n=this.size[1]-a.NODE_TITLE_HEIGHT+.5,r=a.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+n,this.size[0],a.NODE_TITLE_HEIGHT),t.fillStyle=r?"#555":"#222",t.beginPath(),this._shape==a.BOX_SHAPE?t.rect(0,n,this.size[0]+1,a.NODE_TITLE_HEIGHT):t.roundRect(0,n,this.size[0]+1,a.NODE_TITLE_HEIGHT,0,8),t.fill(),t.textAlign="center",t.font="24px Arial",t.fillStyle=r?"#DDD":"#999",t.fillText("+",.5*this.size[0],n+24))},r.prototype.onMouseDown=function(t,e,i){var s=this.size[1]-a.NODE_TITLE_HEIGHT+.5;e[1]>s&&i.showSubgraphPropertiesDialog(this)},r.prototype.onDrawSubgraphBackground=function(t){},r.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Print Code",callback:function(){var t=e._context.computeShaderCode();console.log(t.vs_code,t.fs_code)}}]},a.registerNodeType("texture/shaderGraph",r),m.title="Uniform",m.desc="Input data for the shader",m.prototype.getTitle=function(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"},m.prototype.onPropertyChanged=function(t,e){this.outputs[0].name=this.properties.type+" "+this.properties.name},m.prototype.onGetCode=function(t){if(this.shader_destination){var e=this.properties.type;if(!e){if(!t.onGetPropertyInfo)return;var i=t.onGetPropertyInfo(this.property.name);if(!i)return;e=i.type}"number"==e?e="float":"texture"==e&&(e="sampler2D"),-1!=n.GLSL_types.indexOf(e)&&(t.addUniform("u_"+this.properties.name,e),this.setOutputData(0,e))}},m.prototype.getOutputVarName=function(t){return"u_"+this.properties.name},i("input/uniform",m),y.title="Attribute",y.desc="Input data from mesh attribute",y.prototype.getTitle=function(){return"att. "+this.properties.name},y.prototype.onGetCode=function(t){var e;this.shader_destination&&(e=this.properties.type)&&-1!=n.GLSL_types.indexOf(e)&&("number"==e&&(e="float"),"coord"!=this.properties.name&&t.addCode("varying"," varying "+e+" v_"+this.properties.name+";"),this.setOutputData(0,e))},y.prototype.getOutputVarName=function(t){return"v_"+this.properties.name},i("input/attribute",y),x.title="Sampler2D",x.desc="Reads a pixel from a texture",x.prototype.onGetCode=function(t){var e,i,s;this.shader_destination&&(e=f(this,0),s="vec4 "+(i=g(this))+" = vec4(0.0);\n",e&&(s+=i+" = texture2D("+e+","+(f(this,1)||t.buffer_names.uvs)+");\n"),v(this,0)&&(s+="vec4 "+v(this,0)+" = "+i+";\n"),v(this,1)&&(s+="vec3 "+v(this,1)+" = "+i+".xyz;\n"),t.addCode("code",s,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3"))},i("texture/sampler2D",x),b.title="const",b.prototype.getTitle=function(){return this.flags.collapsed?c(this.properties.value,this.properties.type,2):"Const"},b.prototype.onPropertyChanged=function(t,e){"type"==t&&(this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e),this.widgets.length=1,this.updateWidgets()),"value"==t&&(e.length?(this.widgets[1].value=e[1],2<e.length&&(this.widgets[2].value=e[2]),3<e.length&&(this.widgets[3].value=e[3])):this.widgets[1].value=e)},b.prototype.updateWidgets=function(t){var e=this,t=this.properties.value,i={step:.01};switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=t&&2==t.length?[t[0],t[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},i),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},i);break;case"vec3":this.properties.value=t&&3==t.length?[t[0],t[1],t[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},i),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},i),this.addWidget("number","z",this.properties.value[2],function(t){e.properties.value[2]=t},i);break;case"vec4":this.properties.value=t&&4==t.length?[t[0],t[1],t[2],t[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(t){e.properties.value[0]=t},i),this.addWidget("number","y",this.properties.value[1],function(t){e.properties.value[1]=t},i),this.addWidget("number","z",this.properties.value[2],function(t){e.properties.value[2]=t},i),this.addWidget("number","w",this.properties.value[3],function(t){e.properties.value[3]=t},i);break;default:console.error("unknown type for constant")}},b.prototype.onGetCode=function(t){var e,i;this.shader_destination&&(e=c(this.properties.value,this.properties.type),i=v(this,0))&&(i="\t"+this.properties.type+" "+i+" = "+e+";",t.addCode("code",i,this.shader_destination),this.setOutputData(0,this.properties.type))},i("const/const",b),T.title="vec2",T.varmodes=["xy","x","y"],T.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},T.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=g(this),s="\tvec2 "+i+" = "+c([e.x,e.y])+";\n",o=0;o<T.varmodes.length;++o){var n=T.varmodes[o],r=f(this,o);r&&(s+="\t"+i+"."+n+" = "+r+";\n")}for(o=0;o<T.varmodes.length;++o){var a,n=T.varmodes[o],u=v(this,o);u&&(s+="\t"+(a=h[n.length-1])+" "+u+" = "+i+"."+n+";\n",this.setOutputData(o,a))}t.addCode("code",s,this.shader_destination)}},i("const/vec2",T),E.title="vec3",E.varmodes=["xyz","x","y","z","xy","xz","yz"],E.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},E.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=g(this),s="vec3 "+i+" = "+c([e.x,e.y,e.z])+";\n",o=0;o<E.varmodes.length;++o){var n=E.varmodes[o],r=f(this,o);r&&(s+="\t"+i+"."+n+" = "+r+";\n")}for(o=0;o<E.varmodes.length;++o){var a,n=E.varmodes[o],u=v(this,o);u&&(s+="\t"+(a=h[n.length-1])+" "+u+" = "+i+"."+n+";\n",this.setOutputData(o,a))}t.addCode("code",s,this.shader_destination)}},i("const/vec3",E),w.title="vec4",w.varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"],w.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},w.prototype.onGetCode=function(t){if(this.shader_destination){for(var e=this.properties,i=g(this),s="vec4 "+i+" = "+c([e.x,e.y,e.z,e.w])+";\n",o=0;o<w.varmodes.length;++o){var n=w.varmodes[o],r=f(this,o);r&&(s+="\t"+i+"."+n+" = "+r+";\n")}for(o=0;o<w.varmodes.length;++o){var a,n=w.varmodes[o],u=v(this,o);u&&(s+="\t"+(a=h[n.length-1])+" "+u+" = "+i+"."+n+";\n",this.setOutputData(o,a))}t.addCode("code",s,this.shader_destination)}},i("const/vec4",w),L.title="FragColor",L.desc="Pixel final color",L.prototype.onGetCode=function(t){var e,i=f(this,0);i&&(e=this.getInputData(0),i=o(i,e,"vec4"),t.addCode("fs_code","fragcolor = "+i+";"))},i("output/fragcolor",L),O.title="Operation",O.operations=["+","-","*","/"],O.prototype.getTitle=function(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"},O.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],i=0;i<3;++i)e.push({name:f(this,i),type:this.getInputData(i)||"float"});var s=v(this,0);if(s){for(var o=e[0].type,n=o,r=this.properties.operation,a=[],i=0;i<2;++i){var u=e[i].name;null==u&&(u=null!=p.value?p.value:"(1.0)",e[i].type="float"),e[i].type!=o&&("float"!=e[i].type||"*"!=r&&"/"!=r)&&(u=_(u,e[i].type,o)),a.push(u)}t.addCode("code",n+" "+s+" = "+a[0]+r+a[1]+";",this.shader_destination),this.setOutputData(0,n)}}},i("math/operation",O),I.title="Func",I.prototype.onPropertyChanged=function(t,e){if(this.graph&&this.graph._version++,"func"==t){var i=l[e];if(i){for(var s=i.params.length;s<this.inputs.length;++s)this.removeInput(s);for(s=0;s<i.params.length;++s){var o=i.params[s];this.inputs[s]?this.inputs[s].name=o.name+(o.value?" ("+o.value+")":""):this.addInput(o.name,n.ALL_TYPES)}}}},I.prototype.getTitle=function(){return this.flags.collapsed?this.properties.func:"Func"},I.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){for(var e=[],i=0;i<3;++i)e.push({name:f(this,i),type:this.getInputData(i)||"float"});var s=v(this,0);if(s){var o=l[this.properties.func];if(o){for(var n=e[0].type,r=o.return_type,a=("T"==r&&(r=n),[]),i=0;i<o.params.length;++i){var u=o.params[i],h=e[i].name;null==h&&(h=null!=u.value?u.value:"(1.0)",e[i].type="float"),("T"==u.type&&e[i].type!=n||"T"!=u.type&&e[i].type!=n)&&(h=_(h,e[i].type,n)),a.push(h)}t.addFunction("round","float round(float v){ return floor(v+0.5); }\nvec2 round(vec2 v){ return floor(v+vec2(0.5));}\nvec3 round(vec3 v){ return floor(v+vec3(0.5));}\nvec4 round(vec4 v){ return floor(v+vec4(0.5)); }\n"),t.addCode("code",r+" "+s+" = "+o.func+"("+a.join(",")+");",this.shader_destination),this.setOutputData(0,r)}}}},i("math/func",I),C.title="Snippet",C.prototype.onPropertyChanged=function(t,e){this.graph&&this.graph._version++,"type"==t&&this.outputs[0].type!=e&&(this.disconnectOutput(0),this.outputs[0].type=e)},C.prototype.getTitle=function(){return this.flags.collapsed?this.properties.code:"Snippet"},C.prototype.onGetCode=function(t){if(this.shader_destination&&this.isOutputConnected(0)){var e=(e=f(this,0))||"1.0",i=(i=f(this,1))||"1.0",s=v(this,0);if(s){var o=this.getInputData(0)||"float",n=this.getInputData(1)||"float",r=this.properties.type;if("T"==o||"T"==n)return null;var a="funcSnippet"+this.id,o=(o="\n"+r+" "+a+"( "+o+" A, "+n+" B) {\n")+("\t"+r+" C = "+r+"(0.0);\n")+("\t"+this.properties.code+";\n");t.addCode("functions",o+="\treturn C;\n}\n",this.shader_destination),t.addCode("code",r+" "+s+" = "+a+"("+e+","+i+");",this.shader_destination),this.setOutputData(0,r)}}},i("utils/snippet",C),D.title="Rand",D.prototype.onGetCode=function(t){var e;this.shader_destination&&this.isOutputConnected(0)&&(e=v(this,0),t.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),t.addCode("code","float "+e+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float"))},i("input/rand",D),N.NOISE_TYPES=["noise","rand"],N.title="noise",N.prototype.onGetCode=function(t){var e,i,s;this.shader_destination&&this.isOutputConnected(0)&&(e=f(this,0),i=v(this,0),s=this.getInputData(0),e||(s="vec2",e=t.buffer_names.uvs),t.addFunction("noise",N.shader_functions),t.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),"float"==s?t.addCode("code","float "+i+" = snoise( vec2("+e+") * u_noise_scale"+this.id+");",this.shader_destination):"vec2"==s||"vec3"==s?t.addCode("code","float "+i+" = snoise("+e+" * u_noise_scale"+this.id+");",this.shader_destination):"vec4"==s&&t.addCode("code","float "+i+" = snoise("+e+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float"))},i("math/noise",N),N.shader_functions="\nvec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }\n\nfloat snoise(vec2 v){\n  const vec4 C = vec4(0.211324865405187, 0.366025403784439,-0.577350269189626, 0.024390243902439);\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod(i, 289.0);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n  + i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );\n}\n\nvec3 hash3( vec2 p ){\n    vec3 q = vec3( dot(p,vec2(127.1,311.7)), \n\t\t\t\t   dot(p,vec2(269.5,183.3)), \n\t\t\t\t   dot(p,vec2(419.2,371.9)) );\n\treturn fract(sin(q)*43758.5453);\n}\nvec4 hash4( vec3 p ){\n    vec4 q = vec4( dot(p,vec3(127.1,311.7,257.3)), \n\t\t\t\t   dot(p,vec3(269.5,183.3,335.1)), \n\t\t\t\t   dot(p,vec3(314.5,235.1,467.3)), \n\t\t\t\t   dot(p,vec3(419.2,371.9,114.9)) );\n\treturn fract(sin(q)*43758.5453);\n}\n\nfloat iqnoise( in vec2 x, float u, float v ){\n    vec2 p = floor(x);\n    vec2 f = fract(x);\n\t\n\tfloat k = 1.0+63.0*pow(1.0-v,4.0);\n\t\n\tfloat va = 0.0;\n\tfloat wt = 0.0;\n    for( int j=-2; j<=2; j++ )\n    for( int i=-2; i<=2; i++ )\n    {\n        vec2 g = vec2( float(i),float(j) );\n\t\tvec3 o = hash3( p + g )*vec3(u,u,1.0);\n\t\tvec2 r = g - f + o.xy;\n\t\tfloat d = dot(r,r);\n\t\tfloat ww = pow( 1.0-smoothstep(0.0,1.414,sqrt(d)), k );\n\t\tva += o.z*ww;\n\t\twt += ww;\n    }\n\t\n    return va/wt;\n}\n",G.title="Time",G.prototype.onGetCode=function(t){var e;this.shader_destination&&this.isOutputConnected(0)&&(e=v(this,0),t.addUniform("u_time"+this.id,"float",function(){return.001*getTime()}),t.addCode("code","float "+e+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float"))},i("input/time",G),S.title="Dither",S.prototype.onGetCode=function(t){var e,i,s;this.shader_destination&&this.isOutputConnected(0)&&(s=f(this,0),e=v(this,0),i=this.getInputData(0),s=o(s,i,"float"),t.addFunction("dither8x8",S.dither_func),t.addCode("code","float "+e+" = dither8x8("+s+");",this.shader_destination),this.setOutputData(0,"float"))},S.dither_func="\n\t\tfloat dither8x8(float brightness) {\n\t\t  vec2 position = vec2(0.0);\n\t\t  #ifdef FRAGMENT\n\t\t\tposition = gl_FragCoord.xy;\n\t\t  #endif\n\t\t  int x = int(mod(position.x, 8.0));\n\t\t  int y = int(mod(position.y, 8.0));\n\t\t  int index = x + y * 8;\n\t\t  float limit = 0.0;\n\t\t  if (x < 8) {\n\t\t\tif(index==0) limit = 0.015625;\n\t\t\t"+(S.dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375]).map(function(t,e){return"else if(index== "+(e+1)+") limit = "+t+";"}).join("\n")+"\n\t\t  }\n\t\t  return brightness < limit ? 0.0 : 1.0;\n\t\t}\n",i("math/dither",S),A.title="Remap",A.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},A.prototype.onConnectionsChange=function(){var t=this.getInputDataType(0);this.outputs[0].type=t||"T"},A.prototype.onGetCode=function(t){var e,i,s,o,n,r,a;this.shader_destination&&this.isOutputConnected(0)&&(e=f(this,0),i=v(this,0),e||i)&&(s=this.getInputDataType(0),"T"==(this.outputs[0].type=s)?console.warn("node type is T and cannot be resolved"):e?(o=c(this.properties.min_value),n=c(this.properties.max_value),r=c(this.properties.min_value2),a=c(this.properties.max_value2),t.addCode("code",s+" "+i+" = ( ("+e+" - "+o+") / ("+n+" - "+o+") ) * ("+a+" - "+r+") + "+r+";",this.shader_destination),this.setOutputData(0,s)):t.addCode("code","\t"+s+" "+i+" = "+s+"(0.0);\n"))},i("math/remap",A))})(this),(t=>{var o=t.LiteGraph,n=new Float32Array(16),r=new Float32Array(16),a=new Float32Array(16),s=new Float32Array(16),u={u_view:n,u_projection:r,u_viewprojection:a,u_model:s};function v(){return 1e5*Math.random()|0}function g(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:g.SPHERE,force_update:!1},this.points=new Float32Array(3*this.properties.num_points),this.normals=new Float32Array(3*this.properties.num_points),this.must_update=!0,this.version=0;var t=this;this.addWidget("button","update",null,function(){t.must_update=!0}),this.geometry={vertices:null,_id:v()},this._old_obj=null,this._last_radius=null}function m(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}function e(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:v(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}function h(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:v()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}function p(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}function l(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}function d(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}function c(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}function _(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}function f(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}function y(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=1e5*Math.random()|0,this.last_info={type:-1,size:-1,subdivisions:-1}}function x(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}o.LGraphRender={onRequestCameraMatrices:null},(t.LGraphPoints3D=g).widgets_info={mode:{widget:"combo",values:g.MODE_VALUES={rectangle:g.RECTANGLE=1,circle:g.CIRCLE=2,cube:g.CUBE=10,sphere:g.SPHERE=11,hemisphere:g.HEMISPHERE=12,inside_sphere:g.INSIDE_SPHERE=13,object:g.OBJECT=20,object_uniformly:g.OBJECT_UNIFORMLY=21,object_inside:g.OBJECT_INSIDE=22}}},g.title="list of points",g.desc="returns an array of points",g.prototype.onPropertyChanged=function(t,e){this.must_update=!0},g.prototype.onExecute=function(){var t=this.getInputData(0),t=((t!=this._old_obj||t&&t._version!=this._old_obj_version)&&(this._old_obj=t,this.must_update=!0),this.getInputData(1));null==t&&(t=this.properties.radius),this._last_radius!=t&&(this._last_radius=t,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)},g.prototype.updatePoints=function(){var t=0|this.properties.num_points,e=(t<1&&(t=1),this.points&&this.points.length==3*t||(this.points=new Float32Array(3*t)),this.properties.generate_normals?this.normals&&this.normals.length==this.points.length||(this.normals=new Float32Array(this.points.length)):this.normals=null,this._last_radius||this.properties.radius),i=this.properties.mode,s=this.getInputData(0);this._old_obj_version=s?s._version:null,this.points=g.generatePoints(e,t,i,this.points,this.normals,this.properties.regular,s),this.version++},g.generatePoints=function(t,e,i,s,o,n,r){var a=3*e,u=(s&&s.length==a||(s=new Float32Array(a)),new Float32Array(3)),h=new Float32Array([0,1,0]);if(n){if(i==g.RECTANGLE){for(var p=Math.floor(Math.sqrt(e)),l=0;l<p;++l)for(var d=0;d<p;++d)s[c=3*l+3*d*p]=(l/p-.5)*t*2,s[c+1]=0,s[c+2]=(d/p-.5)*t*2;if(s=new Float32Array(s.subarray(0,p*p*3)),o)for(l=0;l<o.length;l+=3)o.set(h,l)}else if(i==g.SPHERE){for(p=Math.floor(Math.sqrt(e)),l=0;l<p;++l)for(d=0;d<p;++d){var c=3*l+3*d*p;polarToCartesian(u,l/p*2*Math.PI,2*(d/p-.5)*Math.PI,t),s[c]=u[0],s[c+1]=u[1],s[c+2]=u[2]}s=new Float32Array(s.subarray(0,p*p*3)),o&&g.generateSphericalNormals(s,o)}else if(i==g.CIRCLE){for(l=0;l<a;l+=3){var _=2*Math.PI*(l/a);s[l]=Math.cos(_)*t,s[l+1]=0,s[l+2]=Math.sin(_)*t}if(o)for(l=0;l<o.length;l+=3)o.set(h,l)}}else if(i==g.RECTANGLE){for(l=0;l<a;l+=3)s[l]=(Math.random()-.5)*t*2,s[l+1]=0,s[l+2]=(Math.random()-.5)*t*2;if(o)for(l=0;l<o.length;l+=3)o.set(h,l)}else if(i==g.CUBE){for(l=0;l<a;l+=3)s[l]=(Math.random()-.5)*t*2,s[l+1]=(Math.random()-.5)*t*2,s[l+2]=(Math.random()-.5)*t*2;if(o)for(l=0;l<o.length;l+=3)o.set(h,l)}else i==g.SPHERE?(g.generateSphere(s,a,t),o&&g.generateSphericalNormals(s,o)):i==g.HEMISPHERE?(g.generateHemisphere(s,a,t),o&&g.generateSphericalNormals(s,o)):i==g.CIRCLE?(g.generateInsideCircle(s,a,t),o&&g.generateSphericalNormals(s,o)):i==g.INSIDE_SPHERE?(g.generateInsideSphere(s,a,t),o&&g.generateSphericalNormals(s,o)):i==g.OBJECT?g.generateFromObject(s,o,a,r,!1):i==g.OBJECT_UNIFORMLY?g.generateFromObject(s,o,a,r,!0):i==g.OBJECT_INSIDE?g.generateFromInsideObject(s,a,r):console.warn("wrong mode in LGraphPoints3D");return s},g.generateSphericalNormals=function(t,e){for(var i=new Float32Array(3),s=0;s<e.length;s+=3)i[0]=t[s],i[1]=t[s+1],i[2]=t[s+2],vec3.normalize(i,i),e.set(i,s)},g.generateSphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),n=Math.random(),r=2*Math.cos(2*Math.PI*o)*Math.sqrt(n*(1-n)),a=1-2*n,o=2*Math.sin(2*Math.PI*o)*Math.sqrt(n*(1-n));t[s]=r*i,t[s+1]=a*i,t[s+2]=o*i}},g.generateHemisphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),n=Math.random(),r=Math.cos(2*Math.PI*o)*Math.sqrt(1-n*n),a=n,o=Math.sin(2*Math.PI*o)*Math.sqrt(1-n*n);t[s]=r*i,t[s+1]=a*i,t[s+2]=o*i}},g.generateInsideCircle=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),n=Math.random(),r=Math.cos(2*Math.PI*o)*Math.sqrt(1-n*n),o=Math.sin(2*Math.PI*o)*Math.sqrt(1-n*n);t[s]=r*i,t[s+1]=0,t[s+2]=o*i}},g.generateInsideSphere=function(t,e,i){for(var s=0;s<e;s+=3){var o=Math.random(),n=Math.random(),o=2*o*Math.PI,n=Math.acos(2*n-1),r=Math.cbrt(Math.random())*i,a=Math.sin(o),o=Math.cos(o),u=Math.sin(n),n=Math.cos(n);t[s]=r*u*o,t[s+1]=r*u*a,t[s+2]=r*n}},g.generateFromObject=function(t,e,i,s,o){if(s){var n=null,r=null,a=null,u=null;if(s.constructor===GL.Mesh&&(n=s.vertexBuffers.vertices.data,r=s.vertexBuffers.normals?s.vertexBuffers.normals.data:null,a=(a=s.indexBuffers.indices?s.indexBuffers.indices.data:null)||(s.indexBuffers.triangles?s.indexBuffers.triangles.data:null)),!n)return null;var h=a?a.length/3:n.length/9,p=0;if(o){for(var u=new Float32Array(h),l=0;l<h;++l){var d=a?(y=3*a[3*l],x=3*a[3*l+1],3*a[3*l+2]):(x=(y=9*l)+3,9*l+6),c=n.subarray(y,y+3),_=n.subarray(x,x+3),g=n.subarray(d,d+3),f=vec3.distance(c,_),_=vec3.distance(_,g),g=vec3.distance(g,c),v=(f+_+g)/2;p+=Math.sqrt(v*(v-f)*(v-_)*(v-g)),u[l]=p}for(l=0;l<h;++l)u[l]/=p}for(l=0;l<i;l+=3){var m=Math.random(),m=o?((t,e)=>{var i=t.length,s=0,o=0,n=i;if(0==i)return-1;if(1==i)return 0;for(;s<=n;){var r=t[o=.5*(n+s)|0];if(r==e)return o;if(s==n-1)return s;r<e?s=o:n=o}return o})(u,m):Math.floor(m*h),y=0,x=0,d=0,v=(d=a?(y=3*a[3*m],x=3*a[3*m+1],3*a[3*m+2]):(x=(y=9*m)+3,9*m+6),Math.random()),m=Math.random(),b=Math.sqrt(v),T=1-b,E=b*(1-m),m=m*b;t[l]=T*n[y]+E*n[x]+m*n[d],t[l+1]=T*n[y+1]+E*n[x+1]+m*n[d+1],t[l+2]=T*n[y+2]+E*n[x+2]+m*n[d+2],e&&r&&(e[l]=T*r[y]+E*r[x]+m*r[d],e[l+1]=T*r[y+1]+E*r[x+1]+m*r[d+1],e[l+2]=T*r[y+2]+E*r[x+2]+m*r[d+2],b=e.subarray(l,l+3),vec3.normalize(b,b))}}},g.generateFromInsideObject=function(t,e,i){if(i&&i.constructor===GL.Mesh)for(var s=i.getBoundingBox(),o=(i.octree||(i.octree=new GL.Octree(i)),i.octree),n=vec3.create(),r=vec3.fromValues(1,0,0),a=vec3.create(),u=0,h=0;u<e&&h<10*t.length;){h+=1;var p=vec3.random(a),l=(p[0]=(2*p[0]-1)*s[3]+s[0],p[1]=(2*p[1]-1)*s[4]+s[1],p[2]=(2*p[2]-1)*s[5]+s[2],n.set(p),o.testRay(n,r,0,1e4,!0,GL.Octree.ALL));l&&l.length%2!=0&&(t.set(p,u),u+=3)}},o.registerNodeType("geometry/points3D",g),m.NORMAL=0,m.VERTICAL=1,m.SPHERICAL=2,m.RANDOM=3,m.RANDOM_VERTICAL=4,m.widgets_info={mode:{widget:"combo",values:m.modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4}}},m.title="points to inst",m.prototype.onExecute=function(){var t=this.getInputData(0);t?this.isOutputConnected(0)&&(((t._version!=this._version||t._id!=this._geometry_id)&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(t)),this.setOutputData(0,this.matrices)):this.setOutputData(0,null)},m.prototype.updateInstances=function(t){var e=t.vertices;if(!e)return null;for(var i=t.normals,s=this.matrices,o=e.length/3,n=(s.length!=o&&(s.length=o),mat4.create()),r=vec3.create(),a=(vec3.create(),vec3.fromValues(0,1,0)),u=vec3.fromValues(0,0,-1),h=(vec3.fromValues(1,0,0),quat.create()),p=vec3.create(),l=vec3.create(),d=vec3.create(),c=0;c<e.length;c+=3){var _,g=c/3,f=s[g],v=((f=f||(s[g]=mat4.create())).set(n),e.subarray(c,c+3));switch(this.properties.mode){case m.NORMAL:mat4.setTranslation(f,v),i&&(_=i.subarray(c,c+3),d.set(_),vec3.normalize(d,d),vec3.cross(l,u,d),vec3.normalize(l,l),vec3.cross(p,l,d),vec3.normalize(p,p),f.set(l,0),f.set(d,4),f.set(p,8),mat4.setTranslation(f,v));break;case m.VERTICAL:mat4.setTranslation(f,v);break;case m.SPHERICAL:p.set(v),vec3.normalize(p,p),vec3.cross(l,a,p),vec3.normalize(l,l),vec3.cross(d,p,l),vec3.normalize(d,d),f.set(l,0),f.set(d,4),f.set(p,8),mat4.setTranslation(f,v);break;case m.RANDOM:r[0]=2*Math.random()-1,r[1]=2*Math.random()-1,r[2]=2*Math.random()-1,vec3.normalize(r,r),quat.setAxisAngle(h,r,2*Math.random()*Math.PI),mat4.fromQuat(f,h),mat4.setTranslation(f,v);break;case m.RANDOM_VERTICAL:quat.setAxisAngle(h,a,2*Math.random()*Math.PI),mat4.fromQuat(f,h),mat4.setTranslation(f,v)}}this._version=t._version,this._geometry_id=t._id},o.registerNodeType("geometry/points_to_instances",m),e.title="Transform",e.prototype.onExecute=function(){var t,e,i=this.getInputData(0),s=this.getInputData(1);if(i)if(i.constructor===Array){if(0!=i.length&&(this.outputs[0].type="[mat4]",this.isOutputConnected(0)))if(s){this._output||(this._output=new Array),this._output.length!=i.length&&(this._output.length=i.length);for(var o=0;o<i.length;++o){var n=(n=this._output[o])||(this._output[o]=mat4.create());mat4.multiply(n,i[o],s)}this.setOutputData(0,this._output)}else this.setOutputData(0,i)}else i.vertices&&i.vertices.length&&(t=i,this.outputs[0].type="geometry",this.isOutputConnected(0))&&(s?(e=typedArrayToArray(s).join(","),!this.must_update&&t._id==this._last_geometry_id&&t._version==this._last_version&&e==this._last_key||(this.updateGeometry(t,s),this._last_key=e,this._last_version=t._version,this._last_geometry_id=t._id,this.must_update=!1),this.setOutputData(0,this.geometry)):this.setOutputData(0,t))},e.prototype.updateGeometry=function(t,e){for(var i=t.vertices,s=this.geometry.vertices,o=(s&&s.length==i.length||(s=this.geometry.vertices=new Float32Array(i.length)),vec3.create()),n=0,r=s.length;n<r;n+=3)o[0]=i[n],o[1]=i[n+1],o[2]=i[n+2],mat4.multiplyVec3(o,e,o),s[n]=o[0],s[n+1]=o[1],s[n+2]=o[2];if(t.normals){this.geometry.normals&&this.geometry.normals.length==t.normals.length||(this.geometry.normals=new Float32Array(t.normals.length));for(var a=this.geometry.normals,u=mat4.invert(mat4.create(),e),h=(u&&mat4.transpose(u,u),t.normals),n=0,r=a.length;n<r;n+=3)o[0]=h[n],o[1]=h[n+1],o[2]=h[n+2],mat4.multiplyVec3(o,u,o),a[n]=o[0],a[n+1]=o[1],a[n+2]=o[2]}this.geometry.type=t.type,this.geometry._version++},o.registerNodeType("geometry/transform",e),h.title="Polygon",h.prototype.onExecute=function(){var t,e;this.isOutputConnected(0)&&(e=this.getInputOrProperty("sides"),t=this.getInputOrProperty("radius"),e=0|Math.max(3,e),this.last_info.sides==e&&this.last_info.radius==t||this.updateGeometry(e,t),this.setOutputData(0,this.geometry))},h.prototype.updateGeometry=function(t,e){var i=this.geometry.vertices,s=(i&&i.length==3*t||(i=this.geometry.vertices=new Float32Array(3*t)),2*Math.PI/t),o=this.properties.uvs;o&&(uvs=this.geometry.coords=new Float32Array(3*t));for(var n=0;n<t;++n){var r=s*-n,a=Math.cos(r)*e,r=Math.sin(r)*e;i[3*n]=a,i[3*n+1]=0,i[3*n+2]=r}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=t,this.last_info.radius=e},o.registerNodeType("geometry/polygon",h),p.title="extrude",p.prototype.onPropertyChanged=function(t,e){this._must_update=!0},p.prototype.onExecute=function(){var t=this.getInputData(0);t&&this.isOutputConnected(0)&&(t.version==this._last_geo_version&&!this._must_update||(this._geo=this.extrudeGeometry(t,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))},p.prototype.extrudeGeometry=function(t){var e=t.vertices,i=e.length/3,s=vec3.create(),o=vec3.create(),n=vec3.create(),r=vec3.create(),a=new Float32Array(this.properties.offset);if("line_loop"==t.type)for(var u=new Float32Array(6*i*3),h=0,p=0,l=e.length;p<l;p+=3)s[0]=e[p],s[1]=e[p+1],s[2]=e[p+2],p+3<l?(o[0]=e[p+3],o[1]=e[p+4],o[2]=e[p+5]):(o[0]=e[0],o[1]=e[1],o[2]=e[2]),vec3.add(n,s,a),vec3.add(r,o,a),u.set(s,h),u.set(o,h+=3),u.set(n,h+=3),u.set(o,h+=3),u.set(r,h+=3),u.set(n,h+=3),h+=3;return{_id:v(),type:"triangles",vertices:u}},o.registerNodeType("geometry/extrude",p),l.title="geoeval",l.desc="eval code",l.widgets_info={code:{widget:"code"}},l.prototype.onConfigure=function(t){this.compileCode()},l.prototype.compileCode=function(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch(t){this.boxcolor="red"}},l.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.compileCode())},l.prototype.onExecute=function(){var t=this.getInputData(0);if(t)if(this.func){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=t._id,this.properties.execute_every_frame?this.version++:this.version=t._version;var e=this.func,i=getTime();for(n in this.geometry||(this.geometry={}),t)null!=t[n]&&(t[n].constructor==Float32Array?this.geometry[n]=new Float32Array(t[n]):this.geometry[n]=t[n]);this.geometry._id=t._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=t._version+1;var s=vec3.create(),o=this.vertices;o&&this.vertices.length==t.vertices.length?o.set(t.vertices):o=this.vertices=new Float32Array(t.vertices);for(var n=0;n<o.length;n+=3)s[0]=o[n],s[1]=o[n+1],s[2]=o[n+2],e(s,n/3,i),o[n]=s[0],o[n+1]=s[1],o[n+2]=s[2];this.geometry.vertices=o}this.setOutputData(0,this.geometry)}else this.setOutputData(0,t)},o.registerNodeType("geometry/eval",l),d.title="connect points",d.desc="adds indices between near points",d.prototype.onPropertyChanged=function(t,e){this.must_update=!0},d.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(this.geometry_id!=t._id||this.version!=t._version||this.must_update){for(var e in this.must_update=!1,this.geometry_id=t._id,this.version=t._version,this.geometry={},t)this.geometry[e]=t[e];this.geometry._id=v(),this.geometry._version=this.my_version++;for(var i=t.vertices,s=i.length,o=this.properties.min_dist,n=this.properties.max_dist,r=this.properties.probability,a=this.properties.max_connections,u=[],e=0;e<s;e+=3)for(var h=i[e],p=i[e+1],l=i[e+2],d=0,c=e+3;c<s;c+=3){var _=i[c],g=i[c+1],f=i[c+2],_=Math.sqrt((h-_)*(h-_)+(p-g)*(p-g)+(l-f)*(l-f));if(!(n<_||_<o||r<1&&r<Math.random())&&(u.push(e/3,c/3),d+=1,a&&a<d))break}this.geometry.indices=this.indices=new Uint32Array(u)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}},o.registerNodeType("geometry/connectPoints",d),"undefined"!=typeof GL&&(c.title="to geometry",c.desc="converts a mesh to geometry",c.prototype.onExecute=function(){var t=this.getInputData(0);if(t){if(t!=this.last_mesh){for(i in(this.last_mesh=t).vertexBuffers){var e=t.vertexBuffers[i];this.geometry[i]=e.data}t.indexBuffers.triangles&&(this.geometry.indices=t.indexBuffers.triangles.data),this.geometry._id=v(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}},o.registerNodeType("geometry/toGeometry",c),_.title="Geo to Mesh",_.prototype.updateMesh=function(t){for(var e in this.mesh||(this.mesh=new GL.Mesh),t){var i,s,o;"_"!=e[0]&&(i=t[e],(s=GL.Mesh.common_buffers[e])||"indices"==e)&&(s=s?s.spacing:3,(o=this.mesh.vertexBuffers[e])&&o.data.length==i.length?(o.data.set(i),o.upload(GL.DYNAMIC_DRAW)):o=new GL.Buffer("indices"==e?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,i,s,GL.DYNAMIC_DRAW),this.mesh.addBuffer(e,o))}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){for(var n=new Float32Array([0,1,0]),r=new Float32Array(this.mesh.vertexBuffers.vertices.data.length),e=0;e<r.length;e+=3)r.set(n,e);o=new GL.Buffer(GL.ARRAY_BUFFER,r,3),this.mesh.addBuffer("normals",o)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version,this.mesh},_.prototype.onExecute=function(){var t=this.getInputData(0);t&&(this.version==t._version&&this.geometry_id==t._id||this.updateMesh(t),this.setOutputData(0,this.mesh))},o.registerNodeType("geometry/toMesh",_),f.title="Render Mesh",f.desc="renders a mesh flat",f.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP},f.widgets_info={primitive:{widget:"combo",values:f.PRIMITIVE_VALUES},color:{widget:"color"}},f.prototype.onExecute=function(){var t,e,i,s;this.properties.enabled&&(t=this.getInputData(0))&&(o.LGraphRender.onRequestCameraMatrices?(o.LGraphRender.onRequestCameraMatrices(n,r,a),e=null,e=this.getInputData(2)?(e=gl.shaders.textured)||(gl.shaders.textured=new GL.Shader(x.vertex_shader_code,x.fragment_shader_code,{USE_TEXTURE:""})):(e=gl.shaders.flat)||(gl.shaders.flat=new GL.Shader(x.vertex_shader_code,x.fragment_shader_code)),this.color.set(this.properties.color),this.color[3]=this.properties.opacity,s=this.model_matrix,(i=this.getInputData(1))?s.set(i):mat4.identity(s),this.uniforms.u_point_size=1,i=this.properties.primitive,e.uniforms(u),e.uniforms(this.uniforms),1<=this.properties.opacity?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),s="indices",t.indexBuffers.triangles&&(s="triangles"),e.draw(t,i,s),gl.disable(gl.BLEND),gl.depthMask(!0)):console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph"))},o.registerNodeType("geometry/render_mesh",f),y.title="Primitive",y.widgets_info={type:{widget:"combo",values:y.VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9}}},y.prototype.onExecute=function(){var t;this.isOutputConnected(0)&&(t=this.getInputOrProperty("size"),this.last_info.type==this.properties.type&&this.last_info.size==t&&this.last_info.subdivisions==this.properties.subdivisions||this.updateMesh(this.properties.type,t,this.properties.subdivisions),this.setOutputData(0,this._mesh))},y.prototype.updateMesh=function(t,e,i){switch(i=0|Math.max(0,i),t){case 1:this._mesh=GL.Mesh.cube({size:e,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:e,xz:!0,detail:i,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:e,subdivisions:i,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:e,long:i,lat:i,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:e,slices:i,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:e,long:i,lat:i,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:e,subdivisions:i});break;case 8:this._mesh=GL.Mesh.cone({radius:e,height:e,subdivisions:i});break;case 9:this._mesh=GL.Mesh.plane({size:e,xz:!1,detail:i,normals:!0,coords:!0})}this.last_info.type=t,this.last_info.size=e,this.last_info.subdivisions=i,this._mesh.version=this.version++},o.registerNodeType("geometry/mesh_primitive",y),x.title="renderPoints",x.desc="render points with a texture",x.widgets_info={color:{widget:"color"}},x.prototype.updateMesh=function(t){this.buffer;this.buffer&&this.buffer.data&&this.buffer.data.length==t.vertices.length?(this.buffer.data.set(t.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)):this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,t.vertices,3,GL.DYNAMIC_DRAW),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=t._id,this.version=this.mesh.version=t._version},x.prototype.onExecute=function(){var t,e;this.properties.enabled&&(t=this.getInputData(0))&&(this.version==t._version&&this.geometry_id==t._id||this.updateMesh(t),o.LGraphRender.onRequestCameraMatrices?(o.LGraphRender.onRequestCameraMatrices(n,r,a),t=null,t=this.getInputData(2)?(t=gl.shaders.textured_points)||(gl.shaders.textured_points=new GL.Shader(x.vertex_shader_code,x.fragment_shader_code,{USE_TEXTURED_POINTS:""})):(t=gl.shaders.points)||(gl.shaders.points=new GL.Shader(x.vertex_shader_code,x.fragment_shader_code,{USE_POINTS:""})),this.color.set(this.properties.color),this.color[3]=this.properties.opacity,(e=this.getInputData(1))?s.set(e):mat4.identity(s),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*r[5],t.uniforms(u),t.uniforms(this.uniforms),1<=this.properties.opacity?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),t.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)):console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph"))},o.registerNodeType("geometry/render_points",x),x.vertex_shader_code="\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tvarying vec3 v_vertex;\n\t\tattribute vec3 a_normal;\n\t\tvarying vec3 v_normal;\n\t\t#ifdef USE_COLOR\n\t\t\tattribute vec4 a_color;\n\t\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tattribute vec2 a_coord;\n\t\tvarying vec2 v_coord;\n\t\t#ifdef USE_SIZE\n\t\t\tattribute float a_extra;\n\t\t#endif\n\t\t#ifdef USE_INSTANCING\n\t\t\tattribute mat4 u_model;\n\t\t#else\n\t\t\tuniform mat4 u_model;\n\t\t#endif\n\t\tuniform mat4 u_viewprojection;\n\t\tuniform float u_point_size;\n\t\tuniform float u_perspective;\n\t\tuniform float u_point_perspective;\n\t\tfloat computePointSize(float radius, float w)\n\t\t{\n\t\t\tif(radius < 0.0)\n\t\t\t\treturn -radius;\n\t\t\treturn u_perspective * radius / w;\n\t\t}\n\t\tvoid main() {\n\t\t\tv_coord = a_coord;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tv_color = a_color;\n\t\t\t#endif\n\t\t\tv_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\tv_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;\n\t\t\tgl_Position = u_viewprojection * vec4(v_vertex,1.0);\n\t\t\tgl_PointSize = u_point_size;\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tgl_PointSize = a_extra;\n\t\t\t#endif\n\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t}\t",x.fragment_shader_code="\t\tprecision mediump float;\n\t\tuniform vec4 u_color;\n\t\t#ifdef USE_COLOR\n\t\t\tvarying vec4 v_color;\n\t\t#endif\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tvoid main() {\n\t\t\tvec4 color = u_color;\n\t\t\t#ifdef USE_TEXTURED_POINTS\n\t\t\t\tcolor *= texture2D(u_texture, gl_PointCoord.xy);\n\t\t\t#else\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t\tfloat dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tcolor *= v_color;\n\t\t\t#endif\n\t\t\tgl_FragColor = color;\n\t\t}\t")})(this),(h=>{var t=h.LiteGraph,d=h.LGraphTexture;function r(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:d.DEFAULT},r._shader||(r._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,r.pixel_shader),r._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}function c(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}function p(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:d.DEFAULT}}function n(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:d.DEFAULT},n._shader||(n._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,n.pixel_shader))}"undefined"!=typeof GL&&(r.title="Lens",r.desc="Camera Lens distortion",r.widgets_info={precision:{widget:"combo",values:d.MODE_VALUES}},r.prototype.onExecute=function(){var t,e,i,s,o,n=this.getInputData(0);this.properties.precision===d.PASS_THROUGH?this.setOutputData(0,n):n&&(this._tex=d.getTargetTexture(n,this._tex,this.properties.precision),t=this.properties.aberration,this.isInputConnected(1)&&(t=this.getInputData(1),this.properties.aberration=t),e=this.properties.distortion,this.isInputConnected(2)&&(e=this.getInputData(2),this.properties.distortion=e),i=this.properties.blur,this.isInputConnected(3)&&(i=this.getInputData(3),this.properties.blur=i),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),s=Mesh.getScreenQuad(),o=r._shader,this._tex.drawTo(function(){n.bind(0),o.uniforms({u_texture:0,u_aberration:t,u_distortion:e,u_blur:i}).draw(s)}),this.setOutputData(0,this._tex))},r.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_aberration;\n\t\t\tuniform float u_distortion;\n\t\t\tuniform float u_blur;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = v_coord;\n\t\t\t\tfloat dist = distance(vec2(0.5), coord);\n\t\t\t\tvec2 dist_coord = coord - vec2(0.5);\n\t\t\t\tfloat percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n\t\t\t\tdist_coord *= percent;\n\t\t\t\tcoord = dist_coord + vec2(0.5);\n\t\t\t\tvec4 color = texture2D(u_texture,coord, u_blur * dist);\n\t\t\t\tcolor.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n\t\t\t\tcolor.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t",t.registerNodeType("fx/lens",r),h.LGraphFXLens=r,c.title="Bokeh",c.desc="applies an Bokeh effect",c.widgets_info={shape:{widget:"texture"}},c.prototype.onExecute=function(){var t,e,i,s,o,n,r,a,u,h=this.getInputData(0),p=this.getInputData(1),l=this.getInputData(2);h&&l&&this.properties.shape?(p=p||h,(t=d.getTexture(this.properties.shape))&&(e=this.properties.threshold,this.isInputConnected(3)&&(e=this.getInputData(3),this.properties.threshold=e),i=gl.UNSIGNED_BYTE,this.properties.high_precision&&(i=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==i&&this._temp_texture.width==h.width&&this._temp_texture.height==h.height||(this._temp_texture=new GL.Texture(h.width,h.height,{type:i,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size,s=(s=c._first_shader)||(c._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,c._first_pixel_shader)),o=(o=c._second_shader)||(c._second_shader=new GL.Shader(c._second_vertex_shader,c._second_pixel_shader)),(n=this._points_mesh)&&n._width==h.width&&n._height==h.height&&2==n._spacing||(n=this.createPointsMesh(h.width,h.height,2)),r=Mesh.getScreenQuad(),a=this.properties.size,this.properties.min_light,u=this.properties.alpha,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){h.bind(0),p.bind(1),l.bind(2),s.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[h.width,h.height]}).draw(r)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),h.bind(0),t.bind(3),o.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:u,u_threshold:e,u_pointSize:a,u_itexsize:[1/h.width,1/h.height]}).draw(n,gl.POINTS)}),this.setOutputData(0,this._temp_texture))):this.setOutputData(0,h)},c.prototype.createPointsMesh=function(t,e,i){for(var s=Math.round(t/i),o=Math.round(e/i),n=new Float32Array(s*o*2),r=-1,a=2/t*i,u=2/e*i,h=0;h<o;++h){for(var p=-1,l=0;l<s;++l){var d=h*s*2+2*l;n[d]=p,n[1+d]=r,p+=a}r+=u}return this._points_mesh=GL.Mesh.load({vertices2D:n}),this._points_mesh._width=t,this._points_mesh._height=e,this._points_mesh._spacing=i,this._points_mesh},c._first_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_blur;\n\t\t\tuniform sampler2D u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 blurred_color = texture2D(u_texture_blur, v_coord);\n\t\t\t\tfloat mask = texture2D(u_mask, v_coord).x;\n\t\t\t   gl_FragColor = mix(color, blurred_color, mask);\n\t\t\t}\n\t\t\t",c._second_vertex_shader="precision highp float;\n\t\t\tattribute vec2 a_vertex2D;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_mask;\n\t\t\tuniform vec2 u_itexsize;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform float u_threshold;\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = a_vertex2D * 0.5 + 0.5;\n\t\t\t\tv_color = texture2D( u_texture, coord );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n\t\t\t\tv_color += texture2D( u_texture, coord + u_itexsize);\n\t\t\t\tv_color *= 0.25;\n\t\t\t\tfloat mask = texture2D(u_mask, coord).x;\n\t\t\t\tfloat luminance = length(v_color) * mask;\n\t\t\t\t/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n\t\t\t\tluminance -= u_threshold;\n\t\t\t\tif(luminance < 0.0)\n\t\t\t\t{\n\t\t\t\t\tgl_Position.x = -100.0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\tgl_Position = vec4(a_vertex2D,0.0,1.0);\n\t\t\t}\n\t\t\t",c._second_pixel_shader="precision highp float;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_shape;\n\t\t\tuniform float u_alpha;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_shape, gl_PointCoord );\n\t\t\t\tcolor *= v_color * u_alpha;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",t.registerNodeType("fx/bokeh",c),h.LGraphFXBokeh=c,p.title="FX",p.desc="applies an FX from a list",p.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:d.MODE_VALUES}},p.shaders={},p.prototype.onExecute=function(){if(this.isOutputConnected(0)){var t=this.getInputData(0);if(this.properties.precision===d.PASS_THROUGH)this.setOutputData(0,t);else if(t){this._tex=d.getTargetTexture(t,this._tex,this.properties.precision);var e=this.properties.value1,i=(this.isInputConnected(1)&&(e=this.getInputData(1),this.properties.value1=e),this.properties.value2),s=(this.isInputConnected(2)&&(i=this.getInputData(2),this.properties.value2=i),this.properties.fx),o=p.shaders[s];if(!o){var n=p["pixel_shader_"+s];if(!n)return;o=p.shaders[s]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,n)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var r=Mesh.getScreenQuad(),a=(h.LS?LS.Renderer._current_camera:null)?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100],u=null;"noise"==s&&(u=d.getNoiseTexture()),this._tex.drawTo(function(){t.bind(0),"noise"==s&&u.bind(1),o.uniforms({u_texture:0,u_noise:1,u_size:[t.width,t.height],u_rand:[Math.random(),Math.random()],u_value1:e,u_value2:i,u_camera_planes:a}).draw(r)}),this.setOutputData(0,this._tex)}}},p.pixel_shader_halftone="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tfloat pattern() {\n\t\t\t\tfloat s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_size.xy;\n\t\t\t\tvec2 point = vec2(\n\t\t\t\t   c * tex.x - s * tex.y ,\n\t\t\t\t   s * tex.x + c * tex.y \n\t\t\t\t) * u_value2;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\n\t\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n\t\t\t}\n",p.pixel_shader_pixelate="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n\t\t\t\tvec4 color = texture2D(u_texture, coord);\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",p.pixel_shader_lowpalette="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tgl_FragColor = floor(color * u_value1) / u_value1;\n\t\t\t}\n",p.pixel_shader_noise="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_noise;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\tuniform vec2 u_rand;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n\t\t\t\tgl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n\t\t\t}\n",p.pixel_shader_gamma="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_value1;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat gamma = 1.0 / u_value1;\n\t\t\t\tgl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n\t\t\t}\n",t.registerNodeType("fx/generic",p),h.LGraphFXGeneric=p,n.title="Vigneting",n.desc="Vigneting",n.widgets_info={precision:{widget:"combo",values:d.MODE_VALUES}},n.prototype.onExecute=function(){var t,e,i,s,o=this.getInputData(0);this.properties.precision===d.PASS_THROUGH?this.setOutputData(0,o):o&&(this._tex=d.getTargetTexture(o,this._tex,this.properties.precision),t=this.properties.intensity,this.isInputConnected(1)&&(t=this.getInputData(1),this.properties.intensity=t),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),e=Mesh.getScreenQuad(),i=n._shader,s=this.properties.invert,this._tex.drawTo(function(){o.bind(0),i.uniforms({u_texture:0,u_intensity:t,u_isize:[1/o.width,1/o.height],u_invert:s?1:0}).draw(e)}),this.setOutputData(0,this._tex))},n.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_intensity;\n\t\t\tuniform int u_invert;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tluminance = 1.0 - luminance;\n\t\t\t\tluminance = mix(1.0, luminance, u_intensity);\n\t\t\t   gl_FragColor = vec4( luminance * color.xyz, color.a);\n\t\t\t}\n\t\t\t",t.registerNodeType("fx/vigneting",n),h.LGraphFXVigneting=n)})(this),(t=>{var e,o=t.LiteGraph,t="#243";function n(t){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),t&&this.setup(t)}for(e in(o.MIDIEvent=n).prototype.fromJSON=function(t){this.setup(t.data)},n.prototype.setup=function(t){var e=t,t=(t.constructor===Object&&(e=t.data),this.data.set(e),e[0]),e=240&(this.status=t);this.cmd=240<=t?t:e,this.cmd==n.NOTEON&&0==this.velocity&&(this.cmd=n.NOTEOFF),this.cmd_str=n.commands[this.cmd]||"",(n.NOTEON<=e||e<=n.NOTEOFF)&&(this.channel=15&t)},Object.defineProperty(n.prototype,"velocity",{get:function(){return this.cmd==n.NOTEON?this.data[2]:-1},set:function(t){this.data[2]=t},enumerable:!0}),n.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],n.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(n.prototype,"note",{get:function(){return this.cmd!=n.NOTEON?-1:n.toNoteString(this.data[1],!0)},set:function(t){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(n.prototype,"octave",{get:function(){var t;return this.cmd!=n.NOTEON?-1:(t=this.data[1]-24,Math.floor(t/12+1))},set:function(t){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),n.prototype.getPitch=function(){return 440*Math.pow(2,(this.data[1]-69)/12)},n.computePitch=function(t){return 440*Math.pow(2,(t-69)/12)},n.prototype.getCC=function(){return this.data[1]},n.prototype.getCCValue=function(){return this.data[2]},n.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},n.computePitchBend=function(t,e){return t+(e<<7)-8192},n.prototype.setCommandFromString=function(t){this.cmd=n.computeCommandFromString(t)},n.computeCommandFromString=function(t){if(!t)return 0;if(t&&t.constructor===Number)return t;switch(t=t.toUpperCase()){case"NOTE ON":case"NOTEON":return n.NOTEON;case"NOTE OFF":case"NOTEOFF":return n.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return n.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return n.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return n.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return n.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return n.PITCHBEND;case"TIME TICK":case"TIMETICK":return n.TIMETICK;default:return Number(t)}},n.toNoteString=function(t,e){var i=(t=Math.round(t))-21,t=Math.floor((t-24)/12+1);return n.notes[i=(i%=12)<0?12+i:i]+(e?"":t)},n.NoteStringToPitch=function(t){var e=(t=t.toUpperCase())[0],i=4,t=("#"==t[1]?(e+="#",2<t.length&&(i=Number(t[2]))):1<t.length&&(i=Number(t[1])),n.note_to_index[e]);return null==t?null:12*(i-1)+t+21},n.prototype.toString=function(){var t=this.channel+". ";switch(this.cmd){case n.NOTEON:t+="NOTEON "+n.toNoteString(this.data[1]);break;case n.NOTEOFF:t+="NOTEOFF "+n.toNoteString(this.data[1]);break;case n.CONTROLLERCHANGE:t+="CC "+this.data[1]+" "+this.data[2];break;case n.PROGRAMCHANGE:t+="PC "+this.data[1];break;case n.PITCHBEND:t+="PITCHBEND "+this.getPitchBend();break;case n.KEYPRESSURE:t+="KEYPRESS "+this.data[1]}return t},n.prototype.toHexString=function(){for(var t=0;t<this.data.length;t++)this.data[t].toString(16)},n.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},n.NOTEOFF=128,n.NOTEON=144,n.KEYPRESSURE=160,n.CONTROLLERCHANGE=176,n.PROGRAMCHANGE=192,n.CHANNELPRESSURE=208,n.PITCHBEND=224,n.TIMETICK=248,n.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},n.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},n.commands_reversed={},n.commands)n.commands_reversed[n.commands[e]]=e;function r(t,e){navigator.requestMIDIAccess?(this.on_ready=t,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))):(this.error="not suppoorted",e?e("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags"))}function i(){this.addOutput("on_midi",o.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var e=this;new r(function(t){e._midi=t,e._waiting&&e.onStart(),e._waiting=!1})}function s(){this.addInput("send",o.EVENT),this.properties={port:0};var e=this;new r(function(t){e._midi=t,e.widget.options.values=e.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}function a(){this.addInput("on_midi",o.EVENT),this._str="",this.size=[200,40]}function u(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var t=this;this._learning=!1,this.addWidget("button","Learn","",function(){t._learning=!0,t.boxcolor="#FA3"}),this.addInput("in",o.EVENT),this.addOutput("on_midi",o.EVENT),this.boxcolor="#AAA"}function h(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",o.EVENT),this.addInput("assign",o.EVENT),this.addOutput("on_midi",o.EVENT),this.midi_event=new n,this.gate=!1}function p(){this.properties={cc:1,value:0},this.addOutput("value","number")}function l(){this.addInput("generate",o.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",o.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=l.processScale(this.properties.notes),this.sequence_index=0}function d(){this.properties={amount:0},this.addInput("in",o.ACTION),this.addInput("amount","number"),this.addOutput("out",o.EVENT),this.midi_event=new n}function c(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",o.ACTION),this.addInput("scale","string"),this.addOutput("out",o.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}function _(){this.properties={url:"",autoplay:!0},this.addInput("play",o.ACTION),this.addInput("pause",o.ACTION),this.addOutput("note",o.EVENT),this._midi=null,this._current_time=0,this._playing=!1,"undefined"==typeof MidiParser&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}function g(){var t;this.properties={volume:.5,duration:1},this.addInput("note",o.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",o.EVENT),"undefined"==typeof AudioSynth?(console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red"):(t=this.synth=new AudioSynth,this.instrument=t.createInstrument("piano"))}function f(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",o.ACTION),this.addInput("reset",o.ACTION),this.addOutput("note",o.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}r.input=null,r.MIDIEvent=n,r.prototype.onMIDISuccess=function(t){console.log("MIDI ready!"),console.log(t),this.midi=t,this.updatePorts(),this.on_ready&&this.on_ready(this)},r.prototype.updatePorts=function(){for(var t=this.midi,e=(this.input_ports=t.inputs,this.input_ports_info=[],this.output_ports=t.outputs,this.output_ports_info=[],0),i=this.input_ports.values(),s=i.next();s&&!1===s.done;){var o=s.value;this.input_ports_info.push(o),console.log("Input port [type:'"+o.type+"'] id:'"+o.id+"' manufacturer:'"+o.manufacturer+"' name:'"+o.name+"' version:'"+o.version+"'"),e++,s=i.next()}this.num_input_ports=e;for(e=0,s=(i=this.output_ports.values()).next();s&&!1===s.done;){o=s.value;this.output_ports_info.push(o),console.log("Output port [type:'"+o.type+"'] id:'"+o.id+"' manufacturer:'"+o.manufacturer+"' name:'"+o.name+"' version:'"+o.version+"'"),e++,s=i.next()}this.num_output_ports=e},r.prototype.onMIDIFailure=function(t){console.error("Failed to get MIDI access - "+t)},r.prototype.openInputPort=function(t,i){var s,t=this.input_ports.get("input-"+t);return!!t&&(s=r.input=this,t.onmidimessage=function(t){var e=new n(t.data);s.updateState(e),i&&i(t.data,e),r.on_message&&r.on_message(t.data,e)},console.log("port open: ",t),!0)},r.parseMsg=function(t){},r.prototype.updateState=function(t){switch(t.cmd){case n.NOTEON:this.state.note[0|t.value1]=t.value2;break;case n.NOTEOFF:this.state.note[0|t.value1]=0;break;case n.CONTROLLERCHANGE:this.state.cc[t.getCC()]=t.getCCValue()}},r.prototype.sendMIDI=function(t,e){e&&(t=this.output_ports_info[t])&&(r.output=this,e.constructor===n?t.send(e.data):t.send(e))},i.MIDIInterface=r,i.title="MIDI Input",i.desc="Reads MIDI from a input port",i.color=t,i.prototype.getPropertyInfo=function(t){if(this._midi&&"port"==t){for(var e={},i=0;i<this._midi.input_ports_info.length;++i){var s=this._midi.input_ports_info[i];e[i]=i+".- "+s.name+" version:"+s.version}return{type:"enum",values:e}}},i.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},i.prototype.onMIDIEvent=function(t,e){this._last_midi_event=e,this.boxcolor="#AFA",this._last_time=o.getTime(),this.trigger("on_midi",e),e.cmd==n.NOTEON?this.trigger("on_noteon",e):e.cmd==n.NOTEOFF?this.trigger("on_noteoff",e):e.cmd==n.CONTROLLERCHANGE?this.trigger("on_cc",e):e.cmd==n.PROGRAMCHANGE?this.trigger("on_pc",e):e.cmd==n.PITCHBEND&&this.trigger("on_pitchbend",e)},i.prototype.onDrawBackground=function(t){var e,i;this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event&&(t.fillStyle="white",e=o.getTime(),0<(e=1-Math.max(0,.001*(e-this._last_time))))&&(i=t.globalAlpha,t.globalAlpha*=e,t.font="12px Tahoma",t.fillText(this._last_midi_event.toString(),2,.5*this.size[1]+3),t.globalAlpha=i)},i.prototype.onExecute=function(){if(this.outputs)for(var t=this._last_midi_event,e=0;e<this.outputs.length;++e){var i=null;switch(this.outputs[e].name){case"midi":i=this._midi;break;case"last_midi":i=t;break;default:continue}this.setOutputData(e,i)}},i.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",o.EVENT],["on_noteon",o.EVENT],["on_noteoff",o.EVENT],["on_cc",o.EVENT],["on_pc",o.EVENT],["on_pitchbend",o.EVENT]]},o.registerNodeType("midi/input",i),s.MIDIInterface=r,s.title="MIDI Output",s.desc="Sends MIDI to output channel",s.color=t,s.prototype.onGetPropertyInfo=function(t){return this._midi&&"port"==t?{type:"enum",values:this.getMIDIOutputs()}:void 0},s.default_ports={0:"unknown"},s.prototype.getMIDIOutputs=function(){var t={};if(!this._midi)return s.default_ports;if(this._midi.output_ports_info)for(var e=0;e<this._midi.output_ports_info.length;++e){var i=this._midi.output_ports_info[e];i&&(i=e+".- "+i.name+" version:"+i.version,t[e]=i)}return t},s.prototype.onAction=function(t,e){this._midi&&("send"==t&&this._midi.sendMIDI(this.properties.port,e),this.trigger("midi",e))},s.prototype.onGetInputs=function(){return[["send",o.ACTION]]},s.prototype.onGetOutputs=function(){return[["on_midi",o.EVENT]]},o.registerNodeType("midi/output",s),a.title="MIDI Show",a.desc="Shows MIDI in the graph",a.color=t,a.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},a.prototype.onAction=function(t,e){e&&(e.constructor===n?this._str=e.toString():this._str="???")},a.prototype.onDrawForeground=function(t){this._str&&!this.flags.collapsed&&(t.font="30px Arial",t.fillText(this._str,10,.8*this.size[1]))},a.prototype.onGetInputs=function(){return[["in",o.ACTION]]},a.prototype.onGetOutputs=function(){return[["on_midi",o.EVENT]]},o.registerNodeType("midi/show",a),u.title="MIDI Filter",u.desc="Filters MIDI messages",u.color=t,u["@cmd"]={type:"enum",title:"Command",values:n.commands_reversed},u.prototype.getTitle=function(){var t=null,t=-1==this.properties.cmd?"Nothing":n.commands_short[this.properties.cmd]||"Unknown";return-1!=this.properties.min_value&&-1!=this.properties.max_value&&(t+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+t},u.prototype.onPropertyChanged=function(t,e){"cmd"==t&&(t=Number(e),isNaN(t)&&(t=n.commands[e]||0),this.properties.cmd=t)},u.prototype.onAction=function(t,e){if(e&&e.constructor===n){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.min_value=this.properties.max_value=e.data[1];else{if(-1!=this.properties.channel&&e.channel!=this.properties.channel)return;if(-1!=this.properties.cmd&&e.cmd!=this.properties.cmd)return;if(-1!=this.properties.min_value&&e.data[1]<this.properties.min_value)return;if(-1!=this.properties.max_value&&e.data[1]>this.properties.max_value)return}this.trigger("on_midi",e)}},o.registerNodeType("midi/filter",u),h.title="MIDIEvent",h.desc="Create a MIDI Event",h.color=t,h.prototype.onAction=function(t,e){"assign"==t?(this.properties.channel=e.channel,this.properties.cmd=e.cmd,this.properties.value1=e.data[1],this.properties.value2=e.data[2],e.cmd==n.NOTEON?this.gate=!0:e.cmd==n.NOTEOFF&&(this.gate=!1)):((e=this.midi_event).channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?e.setCommandFromString(this.properties.cmd):e.cmd=this.properties.cmd,e.data[0]=e.cmd|e.channel,e.data[1]=Number(this.properties.value1),e.data[2]=Number(this.properties.value2),this.trigger("on_midi",e))},h.prototype.onExecute=function(){var t=this.properties;if(this.inputs)for(var e=0;e<this.inputs.length;++e){var i=this.inputs[e];if(-1!=i.link)switch(i.name){case"note":null!=(s=this.getInputData(e))&&(s.constructor===String&&(s=n.NoteStringToPitch(s)),this.properties.value1=(0|s)%255);break;case"cmd":null!=(s=this.getInputData(e))&&(this.properties.cmd=s);break;case"value1":null!=(s=this.getInputData(e))&&(this.properties.value1=clamp(0|s,0,127));break;case"value2":null!=(s=this.getInputData(e))&&(this.properties.value2=clamp(0|s,0,127))}}if(this.outputs)for(e=0;e<this.outputs.length;++e){var s=null;switch(this.outputs[e].name){case"midi":(s=new n).setup([t.cmd,t.value1,t.value2]),s.channel=t.channel;break;case"command":s=t.cmd;break;case"cc":s=t.value1;break;case"cc_value":s=t.value2;break;case"note":s=t.cmd==n.NOTEON||t.cmd==n.NOTEOFF?t.value1:null;break;case"velocity":s=t.cmd==n.NOTEON?t.value2:null;break;case"pitch":s=t.cmd==n.NOTEON?n.computePitch(t.value1):null;break;case"pitchbend":s=t.cmd==n.PITCHBEND?n.computePitchBend(t.value1,t.value2):null;break;case"gate":s=this.gate;break;default:continue}null!==s&&this.setOutputData(e,s)}},h.prototype.onPropertyChanged=function(t,e){"cmd"==t&&(this.properties.cmd=n.computeCommandFromString(e))},h.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},h.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",o.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},o.registerNodeType("midi/event",h),p.title="MIDICC",p.desc="gets a Controller Change",p.color=t,p.prototype.onExecute=function(){this.properties;r.input&&(this.properties.value=r.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},o.registerNodeType("midi/cc",p),l.title="MIDI Generator",l.desc="Generates a random MIDI note",l.color=t,l.processScale=function(t){for(var e=t.split(","),i=0;i<e.length;++i){var s=e[i];2==s.length&&"#"!=s[1]||2<s.length?e[i]=-o.MIDIEvent.NoteStringToPitch(s):e[i]=n.note_to_index[s]||0}return e},l.prototype.onPropertyChanged=function(t,e){"notes"==t&&(this.notes_pitches=l.processScale(e))},l.prototype.onExecute=function(){var t=this.getInputData(2),t=(null!=t&&(this.properties.octave=t),this.getInputData(1));t&&(this.notes_pitches=l.processScale(t))},l.prototype.onAction=function(t,e){var i=0,s=this.notes_pitches.length,o=0,s=("sequence"==this.properties.mode?o=this.sequence_index=(this.sequence_index+1)%s:"random"==this.properties.mode&&(o=Math.floor(Math.random()*s)),this.notes_pitches[o]),i=0<=s?s+12*(this.properties.octave-1)+33:-s,o=((e=new n).setup([n.NOTEON,i,10]),this.properties.duration||1);this.trigger("note",e),setTimeout(function(){var t=new n;t.setup([n.NOTEOFF,i,0]),this.trigger("note",t)}.bind(this),1e3*o)},o.registerNodeType("midi/generator",l),d.title="MIDI Transpose",d.desc="Transpose a MIDI note",d.color=t,d.prototype.onAction=function(t,e){e&&e.constructor===n&&(e.data[0]==n.NOTEON||e.data[0]==n.NOTEOFF?(this.midi_event=new n,this.midi_event.setup(e.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",e))},d.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&(this.properties.amount=t)},o.registerNodeType("midi/transpose",d),c.title="MIDI Quantize Pitch",c.desc="Transpose a MIDI note tp fit an scale",c.color=t,c.prototype.onPropertyChanged=function(t,e){"scale"==t&&this.processScale(e)},c.prototype.processScale=function(t){this._current_scale=t,this.notes_pitches=l.processScale(t);for(var e=0;e<12;++e)this.valid_notes[e]=-1!=this.notes_pitches.indexOf(e);for(e=0;e<12;++e)if(this.valid_notes[e])this.offset_notes[e]=0;else for(var i=1;i<12;++i){if(this.valid_notes[(e-i)%12]){this.offset_notes[e]=-i;break}if(this.valid_notes[(e+i)%12]){this.offset_notes[e]=i;break}}},c.prototype.onAction=function(t,e){var i;e&&e.constructor===n&&(e.data[0]==n.NOTEON||e.data[0]==n.NOTEOFF?(this.midi_event=new n,this.midi_event.setup(e.data),i=e.note,i=n.note_to_index[i],i=this.offset_notes[i],this.midi_event.data[1]+=i,this.trigger("out",this.midi_event)):this.trigger("out",e))},c.prototype.onExecute=function(){var t=this.getInputData(1);null!=t&&t!=this._current_scale&&this.processScale(t)},o.registerNodeType("midi/quantize",c),_.title="MIDI fromFile",_.desc="Plays a MIDI file",_.color=t,_.prototype.onAction=function(t){"play"==t?this.play():"pause"==t&&(this._playing=!this._playing)},_.prototype.onPropertyChanged=function(t,e){"url"==t&&this.loadMIDIFile(e)},_.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var t=100*this._current_time,e=0;e<this._midi.tracks;++e){var i,s=this._midi.track[e],o=(s._last_pos||(s._last_pos=0,s._time=0),s.event[s._last_pos]);o&&s._time+o.deltaTime<=t&&(s._last_pos++,s._time+=o.deltaTime,o.data)&&(s=o.type<<4+o.channel,(i=new n).setup([s,o.data[0],o.data[1]]),this.trigger("note",i))}}},_.prototype.play=function(){if(this._playing=!0,this._current_time=0,this._midi)for(var t=0;t<this._midi.tracks;++t){var e=this._midi.track[t];e._last_pos=0,e._time=0}},_.prototype.loadMIDIFile=function(t){var e=this;o.fetchFile(t,"arraybuffer",function(t){e.boxcolor="#AFA",e._midi=MidiParser.parse(new Uint8Array(t)),e.properties.autoplay&&e.play()},function(t){e.boxcolor="#FAA",e._midi=null})},_.prototype.onDropFile=function(t){this.properties.url="",this.loadMIDIFile(t)},o.registerNodeType("midi/fromFile",_),g.title="MIDI Play",g.desc="Plays a MIDI note",g.color=t,g.prototype.onAction=function(t,e){if(e&&e.constructor===n){if(this.instrument&&e.data[0]==n.NOTEON){var i=e.note;if(!i||"undefined"==i||i.constructor!==String)return;this.instrument.play(i,e.octave,this.properties.duration,this.properties.volume)}this.trigger("note",e)}},g.prototype.onExecute=function(){var t=this.getInputData(1),t=(null!=t&&(this.properties.volume=t),this.getInputData(2));null!=t&&(this.properties.duration=t)},o.registerNodeType("midi/play",g),f.title="MIDI Keys",f.desc="Keyboard to play notes",f.color=t,f.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],f.prototype.onDrawForeground=function(t){if(!this.flags.collapsed){var e=12*this.properties.num_octaves,i=(this.keys.length=e,this.size[0]/(7*this.properties.num_octaves)),s=this.size[1];t.globalAlpha=1;for(var o=0;o<2;o++)for(var n=0;n<e;++n){var r,a=f.keys[n%12];a.t==o&&(r=7*Math.floor(n/12)*i+a.x*i,t.fillStyle=0==o?this.keys[n]?"#CCC":"white":this.keys[n]?"#333":"black",t.fillRect(1+r,0,i*a.w-2,s*a.h))}}},f.prototype.getKeyIndex=function(t){this.properties.num_octaves;for(var e=this.size[0]/(7*this.properties.num_octaves),i=this.size[1],s=1;0<=s;s--)for(var o=0;o<this.keys.length;++o){var n=f.keys[o%12];if(n.t==s){var r=7*Math.floor(o/12)*e+n.x*e,a=e*n.w,n=i*n.h;if(!(t[0]<r||t[0]>r+a||t[1]>n))return o}}return-1},f.prototype.onAction=function(t,e){if("reset"==t)for(var i=0;i<this.keys.length;++i)this.keys[i]=!1;else e&&e.constructor===n&&(t=12*(this.properties.start_octave-1)+29,0<=(t=(e=e).data[1]-t)&&t<this.keys.length&&(e.data[0]==n.NOTEON?this.keys[t]=!0:e.data[0]==n.NOTEOFF&&(this.keys[t]=!1)),this.trigger("note",e))},f.prototype.onMouseDown=function(t,e){var i;if(!(e[1]<0))return e=this.getKeyIndex(e),this.keys[e]=!0,this._last_key=e,e=12*(this.properties.start_octave-1)+29+e,(i=new n).setup([n.NOTEON,e,100]),this.trigger("note",i),!0},f.prototype.onMouseMove=function(t,e){var i,s;if(!(e[1]<0||-1==this._last_key))return this.setDirtyCanvas(!0),e=this.getKeyIndex(e),this._last_key!=e&&(this.keys[this._last_key]=!1,i=12*(this.properties.start_octave-1)+29+this._last_key,(s=new n).setup([n.NOTEOFF,i,100]),this.trigger("note",s),this.keys[e]=!0,i=12*(this.properties.start_octave-1)+29+e,(s=new n).setup([n.NOTEON,i,100]),this.trigger("note",s),this._last_key=e),!0},f.prototype.onMouseUp=function(t,e){var i;if(!(e[1]<0))return e=this.getKeyIndex(e),this.keys[e]=!1,this._last_key=-1,e=12*(this.properties.start_octave-1)+29+e,(i=new n).setup([n.NOTEOFF,e,100]),this.trigger("note",i),!0},o.registerNodeType("midi/keys",f)})(this),(t=>{var n=t.LiteGraph,p={};function e(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=p.getAudioContext();this.audionode=t.createGain(),(this.audionode.graphnode=this).audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}function i(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var t=p.getAudioContext();this.audionode=t.createGain(),(this.audionode.graphnode=this).audionode.gain.value=this.properties.gain}function s(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var t=p.getAudioContext();this.audionode=t.createAnalyser(),(this.audionode.graphnode=this).audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}function o(){this.properties={gain:1},this.audionode=p.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}function r(){this.properties={impulse_src:"",normalize:!0},this.audionode=p.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}function a(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=p.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}function u(){this.properties={},this.audionode=p.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}function h(){this.properties={gain1:.5,gain2:.5},this.audionode=p.getAudioContext().createGain(),this.audionode1=p.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=p.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}function l(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=p.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}function d(){this.properties={delayTime:.5},this.audionode=p.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}function c(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=p.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}function _(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=p.getAudioContext().createOscillator(),this.addOutput("out","audio")}function g(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}function f(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}function v(){v.default_code||(t=(i=v.default_function.toString()).indexOf("{")+1,e=i.lastIndexOf("}"),v.default_code=i.substr(t,e-t)),this.properties={code:v.default_code};var t,e,i=p.getAudioContext();i.createScriptProcessor?this.audionode=i.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=i.createGain()),this.processCode(),v._bypass_function||(v._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}function m(){this.audionode=p.getAudioContext().destination,this.addInput("in","audio")}(t.LGAudio=p).getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(t){console.log("msg",t)},this._audio_context.onended=function(t){console.log("ended",t)},this._audio_context.oncomplete=function(t){console.log("complete",t)}}return this._audio_context},p.connect=function(t,e){try{t.connect(e)}catch(t){console.warn("LGraphAudio:",t)}},p.disconnect=function(t,e){try{t.disconnect(e)}catch(t){console.warn("LGraphAudio:",t)}},p.changeAllAudiosConnections=function(t,e){if(t.inputs)for(var i=0;i<t.inputs.length;++i){var s=t.inputs[i];(o=t.graph.links[s.link])&&(n=null,n=(s=t.graph.getNodeById(o.origin_id)).getAudioNodeInOutputSlot?s.getAudioNodeInOutputSlot(o.origin_slot):s.audionode,a=null,a=t.getAudioNodeInInputSlot?t.getAudioNodeInInputSlot(i):t.audionode,e?p.connect(n,a):p.disconnect(n,a))}if(t.outputs)for(i=0;i<t.outputs.length;++i)for(var o,n,r,a,u=t.outputs[i],h=0;h<u.links.length;++h)(o=t.graph.links[u.links[h]])&&(n=null,n=t.getAudioNodeInOutputSlot?t.getAudioNodeInOutputSlot(i):t.audionode,a=null,a=(r=t.graph.getNodeById(o.target_id)).getAudioNodeInInputSlot?r.getAudioNodeInInputSlot(o.target_slot):r.audionode,e?p.connect(n,a):p.disconnect(n,a))},p.onConnectionsChange=function(t,e,i,s){var o;t==n.OUTPUT&&(t=null,t=s?this.graph.getNodeById(s.target_id):t)&&(o=null,o=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(e):this.audionode,e=null,e=t.getAudioNodeInInputSlot?t.getAudioNodeInInputSlot(s.target_slot):t.audionode,i?p.connect(o,e):p.disconnect(o,e))},p.createAudioNodeWrapper=function(t){var i=t.prototype.onPropertyChanged;t.prototype.onPropertyChanged=function(t,e){i&&i.call(this,t,e),this.audionode&&void 0!==this.audionode[t]&&(void 0!==this.audionode[t].value?this.audionode[t].value=e:this.audionode[t]=e)},t.prototype.onConnectionsChange=p.onConnectionsChange},p.cached_audios={},p.loadSound=function(e,i,s){var t,o;if(!p.cached_audios[e]||-1!=e.indexOf("blob:"))return p.onProcessAudioURL&&(e=p.onProcessAudioURL(e)),(t=new XMLHttpRequest).open("GET",e,!0),t.responseType="arraybuffer",o=p.getAudioContext(),t.onload=function(){console.log("AudioSource loaded"),o.decodeAudioData(t.response,function(t){console.log("AudioSource decoded"),p.cached_audios[e]=t,i&&i(t)},n)},t.send(),t;function n(t){console.log("Audio loading sample error:",t),s&&s(t)}i&&i(p.cached_audios[e])},e.desc="Plays an audio file",e["@src"]={widget:"resource"},e.supported_extensions=["wav","ogg","mp3"],e.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},e.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},e.prototype.onStop=function(){this.stopAllSounds()},e.prototype.onPause=function(){this.pauseAllSounds()},e.prototype.onUnpause=function(){this.unpauseAllSounds()},e.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},e.prototype.stopAllSounds=function(){for(var t=0;t<this._audionodes.length;++t)this._audionodes[t].started&&(this._audionodes[t].started=!1,this._audionodes[t].stop());this._audionodes.length=0},e.prototype.pauseAllSounds=function(){p.getAudioContext().suspend()},e.prototype.unpauseAllSounds=function(){p.getAudioContext().resume()},e.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;++t){var e=this.inputs[t];if(null!=e.link){var i=this.getInputData(t);if(void 0!==i)if("gain"==e.name)this.audionode.gain.value=i;else if("src"==e.name)this.setProperty("src",i);else if("playbackRate"==e.name){this.properties.playbackRate=i;for(var s=0;s<this._audionodes.length;++s)this._audionodes[s].playbackRate.value=i}}}if(this.outputs)for(t=0;t<this.outputs.length;++t)"buffer"==this.outputs[t].name&&this._audiobuffer&&this.setOutputData(t,this._audiobuffer)},e.prototype.onAction=function(t){this._audiobuffer&&("Play"==t?this.playBuffer(this._audiobuffer):"Stop"==t&&this.stopAllSounds())},e.prototype.onPropertyChanged=function(t,e){if("src"==t)this.loadSound(e);else if("gain"==t)this.audionode.gain.value=e;else if("playbackRate"==t)for(var i=0;i<this._audionodes.length;++i)this._audionodes[i].playbackRate.value=e},e.prototype.playBuffer=function(t){var e=this,i=p.getAudioContext().createBufferSource();return(this._last_sourcenode=i).graphnode=this,i.buffer=t,i.loop=this.properties.loop,i.playbackRate.value=this.properties.playbackRate,this._audionodes.push(i),i.connect(this.audionode),this._audionodes.push(i),this.trigger("start"),i.onended=function(){e.trigger("ended");var t=e._audionodes.indexOf(i);-1!=t&&e._audionodes.splice(t,1)},i.started||(i.started=!0,i.start()),i},e.prototype.loadSound=function(t){var e=this;this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,t&&(this._request=p.loadSound(t,function(t){this.boxcolor=n.NODE_DEFAULT_BOXCOLOR,e._audiobuffer=t,e._loading_audio=!1,e.graph&&e.graph.status===LGraph.STATUS_RUNNING&&e.onStart()}),this._loading_audio=!0,this.boxcolor="#AA4")},e.prototype.onConnectionsChange=p.onConnectionsChange,e.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",n.ACTION],["Stop",n.ACTION]]},e.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",n.EVENT],["ended",n.EVENT]]},e.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);t=URL.createObjectURL(t);this.properties.src=t,this.loadSound(t),this._dropped_url=t},e.title="Source",e.desc="Plays audio",n.registerNodeType("audio/source",e),i.prototype.onAdded=function(t){t.status===LGraph.STATUS_RUNNING&&this.onStart()},i.prototype.onStart=function(){null!=this._media_stream||this._waiting_confirmation||this.openStream()},i.prototype.onStop=function(){this.audionode.gain.value=0},i.prototype.onPause=function(){this.audionode.gain.value=0},i.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},i.prototype.onRemoved=function(){var t;this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream&&(t=this._media_stream.getTracks()).length&&t[0].stop()},i.prototype.openStream=function(){var e;navigator.mediaDevices?(this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(function(t){console.log("Media rejected",t),e._media_stream=!1,e.boxcolor="red"}),e=this):console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")},i.prototype.streamReady=function(t){this._media_stream=t,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var e=p.getAudioContext();this.audiosource_node=e.createMediaStreamSource(t),(this.audiosource_node.graphnode=this).audiosource_node.connect(this.audionode),this.boxcolor="white"},i.prototype.onExecute=function(){if(null!=this._media_stream||this._waiting_confirmation||this.openStream(),this.inputs)for(var t=0;t<this.inputs.length;++t){var e,i=this.inputs[t];null!=i.link&&(void 0!==(e=this.getInputData(t))&&"gain"==i.name)&&(this.audionode.gain.value=this.properties.gain=e)}},i.prototype.onAction=function(t){"Play"==t?this.audionode.gain.value=this.properties.gain:"Stop"==t&&(this.audionode.gain.value=0)},i.prototype.onPropertyChanged=function(t,e){"gain"==t&&(this.audionode.gain.value=e)},i.prototype.onConnectionsChange=p.onConnectionsChange,i.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",n.ACTION],["Stop",n.ACTION]]},i.title="MediaSource",i.desc="Plays microphone",n.registerNodeType("audio/media_source",i),s.prototype.onPropertyChanged=function(t,e){this.audionode[t]=e},s.prototype.onExecute=function(){var t;this.isOutputConnected(0)&&(t=this.audionode.frequencyBinCount,this._freq_bin&&this._freq_bin.length==t||(this._freq_bin=new Uint8Array(t)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)),this.isOutputConnected(1)&&(t=this.audionode.frequencyBinCount,this._time_bin&&this._time_bin.length==t||(this._time_bin=new Uint8Array(t)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin));for(var e=1;e<this.inputs.length;++e){var i,s=this.inputs[e];null!=s.link&&void 0!==(i=this.getInputData(e))&&(this.audionode[s.name].value=i)}},s.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},s.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},s.title="Analyser",s.desc="Audio Analyser",n.registerNodeType("audio/analyser",s),o.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t],i=this.getInputData(t);void 0!==i&&(this.audionode[e.name].value=i)}},p.createAudioNodeWrapper(o),o.title="Gain",o.desc="Audio gain",n.registerNodeType("audio/gain",o),p.createAudioNodeWrapper(r),r.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},r.prototype.onPropertyChanged=function(t,e){"impulse_src"==t?this.loadImpulse(e):"normalize"==t&&(this.audionode.normalize=e)},r.prototype.onDropFile=function(t){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(t),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},r.prototype.loadImpulse=function(t){var e=this;this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,t&&(this._request=p.loadSound(t,function(t){e._impulse_buffer=t,e.audionode.buffer=t,console.log("Impulse signal set"),e._loading_impulse=!1}),this._loading_impulse=!0)},r.title="Convolver",r.desc="Convolves the signal (used for reverb)",n.registerNodeType("audio/convolver",r),p.createAudioNodeWrapper(a),a.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e,i=this.inputs[t];null!=i.link&&void 0!==(e=this.getInputData(t))&&(this.audionode[i.name].value=e)}},a.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},a.title="DynamicsCompressor",a.desc="Dynamics Compressor",n.registerNodeType("audio/dynamicsCompressor",a),u.prototype.onExecute=function(){var t;this.inputs&&this.inputs.length&&void 0!==(t=this.getInputData(1))&&(this.audionode.curve=t)},u.prototype.setWaveShape=function(t){this.audionode.curve=t},p.createAudioNodeWrapper(u),h.prototype.getAudioNodeInInputSlot=function(t){return 0==t?this.audionode1:2==t?this.audionode2:void 0},h.prototype.onPropertyChanged=function(t,e){"gain1"==t?this.audionode1.gain.value=e:"gain2"==t&&(this.audionode2.gain.value=e)},h.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e=this.inputs[t];null!=e.link&&"audio"!=e.type&&void 0!==(e=this.getInputData(t))&&(1==t?this.audionode1.gain.value=e:3==t&&(this.audionode2.gain.value=e))}},p.createAudioNodeWrapper(h),h.title="Mixer",h.desc="Audio mixer",n.registerNodeType("audio/mixer",h),l.prototype.onExecute=function(){var t=p.getAudioContext().currentTime,e=this.audionode.gain,i=this.getInputData(1),s=this.getInputOrProperty("A"),o=this.getInputOrProperty("D"),n=this.getInputOrProperty("S"),r=this.getInputOrProperty("R");!this.gate&&i?(e.cancelScheduledValues(0),e.setValueAtTime(0,t),e.linearRampToValueAtTime(1,t+s),e.linearRampToValueAtTime(n,t+s+o)):this.gate&&!i&&(e.cancelScheduledValues(0),e.setValueAtTime(e.value,t),e.linearRampToValueAtTime(0,t+r)),this.gate=i},l.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},p.createAudioNodeWrapper(l),l.title="ADSR",l.desc="Audio envelope",n.registerNodeType("audio/adsr",l),p.createAudioNodeWrapper(d),d.prototype.onExecute=function(){var t=this.getInputData(1);void 0!==t&&(this.audionode.delayTime.value=t)},d.title="Delay",d.desc="Audio delay",n.registerNodeType("audio/delay",d),c.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=1;t<this.inputs.length;++t){var e,i=this.inputs[t];null!=i.link&&void 0!==(e=this.getInputData(t))&&(this.audionode[i.name].value=e)}},c.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},p.createAudioNodeWrapper(c),c.title="BiquadFilter",c.desc="Audio filter",n.registerNodeType("audio/biquadfilter",c),_.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch(t){}}},_.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},_.prototype.onPause=function(){this.onStop()},_.prototype.onUnpause=function(){this.onStart()},_.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var t=0;t<this.inputs.length;++t){var e,i=this.inputs[t];null!=i.link&&void 0!==(e=this.getInputData(t))&&(this.audionode[i.name].value=e)}},_.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},p.createAudioNodeWrapper(_),_.title="Oscillator",_.desc="Oscillator",n.registerNodeType("audio/oscillator",_),g.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var t=this.getInputData(1);void 0!==t&&(this.properties.mark=t),this.setDirtyCanvas(!0,!1)},g.prototype.onDrawForeground=function(t){if(this._last_buffer){var e,i=this._last_buffer,s=i.length/this.size[0],o=this.size[1],n=(t.fillStyle="black",t.fillRect(0,0,this.size[0],this.size[1]),t.strokeStyle="white",t.beginPath(),0);if(this.properties.continuous){t.moveTo(n,o);for(var r=0;r<i.length;r+=s)t.lineTo(n,o-i[0|r]/255*o),n++}else for(r=0;r<i.length;r+=s)t.moveTo(n+.5,o),t.lineTo(n+.5,o-i[0|r]/255*o),n++;t.stroke(),0<=this.properties.mark&&(e=p.getAudioContext().sampleRate/i.length,(n=this.properties.mark/e*2/s)>=this.size[0]&&(n=this.size[0]-1),t.strokeStyle="red",t.beginPath(),t.moveTo(n,o),t.lineTo(n,0),t.stroke())}},g.title="Visualization",g.desc="Audio Visualization",n.registerNodeType("audio/visualization",g),f.prototype.onExecute=function(){var t,e,i;this._freqs=this.getInputData(0),this._freqs&&(i=this.properties.band,(i=(i=void 0!==(t=this.getInputData(1))?t:i)/(p.getAudioContext().sampleRate/this._freqs.length)*2)<(t=0)&&(t=this._freqs[0]),t=i>=this._freqs.length?this._freqs[this._freqs.length-1]:this._freqs[e=0|i]*(1-(i=i-e))+this._freqs[1+e]*i,this.setOutputData(0,t/255*this.properties.amplitude))},f.prototype.onGetInputs=function(){return[["band","number"]]},f.title="Signal",f.desc="extract the signal of some frequency",n.registerNodeType("audio/signal",f),v.prototype.onAdded=function(t){t.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},v["@code"]={widget:"code",type:"code"},v.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},v.prototype.onStop=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.onPause=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},v.prototype.onExecute=function(){},v.prototype.onRemoved=function(){this.audionode.onaudioprocess=v._bypass_function},v.prototype.processCode=function(){try{var t=new Function("properties",this.properties.code);this._script=new t(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(t){console.error("Error in onaudioprocess code",t),this._callback=v._bypass_function,this.audionode.onaudioprocess=this._callback}},v.prototype.onPropertyChanged=function(t,e){"code"==t&&(this.properties.code=e,this.processCode(),this.graph)&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},v.default_function=function(){this.onaudioprocess=function(t){for(var e=t.inputBuffer,i=t.outputBuffer,s=0;s<i.numberOfChannels;s++)for(var o=e.getChannelData(s),n=i.getChannelData(s),r=0;r<e.length;r++)n[r]=o[r]}},p.createAudioNodeWrapper(v),v.title="Script",v.desc="apply script to signal",n.registerNodeType("audio/script",v),m.title="Destination",m.desc="Audio output",n.registerNodeType("audio/destination",m)})(this),(t=>{var n=t.LiteGraph;function e(){this.size=[60,20],this.addInput("send",n.ACTION),this.addOutput("received",n.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}function i(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",n.ACTION),this.addOutput("received",n.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],"undefined"==typeof SillyClient&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}function s(){this.addInput("request",n.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",n.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}e.title="WebSocket",e.desc="Send data through a websocket",e.prototype.onPropertyChanged=function(t,e){"url"==t&&this.connectSocket()},e.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){for(var t=this.properties.room,e=this.properties.only_send_changes,i=1;i<this.inputs.length;++i){var s,o=this.getInputData(i);if(null!=o){try{s=JSON.stringify({type:0,room:t,channel:i,data:o})}catch(t){continue}e&&this._last_sent_data[i]==s||(this._last_sent_data[i]=s,this._ws.send(s))}}for(i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},e.prototype.connectSocket=function(){var i=this,t=this.properties.url;"ws"!=t.substr(0,2)&&(t="ws://"+t),this._ws=new WebSocket(t),this._ws.onopen=function(){console.log("ready"),i.boxcolor="#6C6"},this._ws.onmessage=function(t){i.boxcolor="#AFA";t=JSON.parse(t.data);if(!t.room||t.room==i.properties.room)if(1==t.type)if(t.data.object_class&&n[t.data.object_class]){var e;try{e=new n[t.data.object_class](t.data),i.triggerSlot(0,e)}catch(t){}}else i.triggerSlot(0,t.data);else i._last_received_data[t.channel||0]=t.data},this._ws.onerror=function(t){console.log("couldnt connect to websocket"),i.boxcolor="#E88"},this._ws.onclose=function(t){console.log("connection closed"),i.boxcolor="#000"}},e.prototype.send=function(t){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:t}))},e.prototype.onAction=function(t,e){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:t,data:e})},e.prototype.onGetInputs=function(){return[["in",0]]},e.prototype.onGetOutputs=function(){return[["out",0]]},n.registerNodeType("network/websocket",e),i.title="SillyClient",i.desc="Connects to SillyServer to broadcast messages",i.prototype.onPropertyChanged=function(t,e){"room"==t&&(this.room_widget.value=e),this.connectSocket()},i.prototype.setRoom=function(t){this.properties.room=t,this.room_widget.value=t,this.connectSocket()},i.prototype.onDrawForeground=function(){for(var t=1;t<this.inputs.length;++t)this.inputs[t].label="in_"+t;for(t=1;t<this.outputs.length;++t)this.outputs[t].label="out_"+t},i.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var t=this.properties.only_send_changes,e=1;e<this.inputs.length;++e){var i=this.getInputData(e),s=this._last_sent_data[e];if(null!=i){if(t){var o=!0;if(i&&i.length&&s&&s.length==i.length&&i.constructor!==String){for(var n=0;n<i.length;++n)if(s[n]!=i[n]){o=!1;break}}else this._last_sent_data[e]!=i&&(o=!1);if(o)continue}if(this._server.sendMessage({type:0,channel:e,data:i}),i.length&&i.constructor!==String)if(this._last_sent_data[e]){this._last_sent_data[e].length=i.length;for(n=0;n<i.length;++n)this._last_sent_data[e][n]=i[n]}else i.constructor===Array?this._last_sent_data[e]=i.concat():this._last_sent_data[e]=new i.constructor(i);else this._last_sent_data[e]=i}}for(e=1;e<this.outputs.length;++e)this.setOutputData(e,this._last_received_data[e]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},i.prototype.connectSocket=function(){var o=this;if("undefined"==typeof SillyClient)this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;else if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),o.boxcolor="#6C6"},this._server.on_message=function(t,e){var i=null;try{i=JSON.parse(e)}catch(t){return}if(1==i.type)if(i.data.object_class&&n[i.data.object_class]){var s;try{s=new n[i.data.object_class](i.data),o.triggerSlot(0,s)}catch(t){return}}else o.triggerSlot(0,i.data);else o._last_received_data[i.channel||0]=i.data;o.boxcolor="#AFA"},this._server.on_error=function(t){console.log("couldnt connect to websocket"),o.boxcolor="#E88"},this._server.on_close=function(t){console.log("connection closed"),o.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(t){return console.error("SillyServer error: "+t),void(this._server=null)}this._final_url=this.properties.url+"/"+this.properties.room}},i.prototype.send=function(t){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,data:t})},i.prototype.onAction=function(t,e){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:t,data:e})},i.prototype.onGetInputs=function(){return[["in",0]]},i.prototype.onGetOutputs=function(){return[["out",0]]},n.registerNodeType("network/sillyclient",i),s.title="HTTP Request",s.desc="Fetch data through HTTP",s.prototype.fetch=function(){var e,t=this.properties.url;t&&(this.boxcolor="#FF0",(e=this)._fetching=fetch(t).then(t=>{if(t.ok)return this.boxcolor="#0F0",t.text();this.boxcolor="#F00",e.trigger("error")}).then(t=>{e._data=t,e._fetching=null,e.trigger("ready")}))},s.prototype.onAction=function(t){"request"==t&&this.fetch()},s.prototype.onExecute=function(){this.setOutputData(1,this._data)},s.prototype.onGetOutputs=function(){return[["error",n.EVENT]]},n.registerNodeType("network/httprequest",s)})(this);