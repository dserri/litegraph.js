!function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,LiteGraph.debug&&console.log("Node registered: "+t);var i,n=e.name,s=t.lastIndexOf("/");for(i in e.category=t.substring(0,s),e.title||(e.title=n),LGraphNode.prototype)e.prototype[i]||(e.prototype[i]=LGraphNode.prototype[i]);s=this.registered_node_types[t];if(s&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(e.prototype,"shape")&&(Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=t}},get:function(){return this._shape},enumerable:!0,configurable:!0}),e.supported_extensions))for(var o in e.supported_extensions){o=e.supported_extensions[o];o&&o.constructor===String&&(this.node_types_by_file_extension[o.toLowerCase()]=e)}(this.registered_node_types[t]=e).constructor.name&&(this.Nodes[n]=e),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(t,e),s&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(t,e,s),e.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new e(e.title||"tmpnode")},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},registerNodeAndSlotType:function(t,e,i){i=i||!1;var n=(t.constructor===String&&"anonymous"!==this.registered_node_types[t]?this.registered_node_types[t]:t).constructor.type;let s=[];s="string"==typeof e?e.split(","):e==this.EVENT||e==this.ACTION?["_event_"]:["*"];for(let e=0;e<s.length;++e){let t=s[e];""===t&&(t="*");var o=i?"registered_slot_out_types":"registered_slot_in_types";void 0===this[o][t]&&(this[o][t]={nodes:[]}),this[o][t].nodes.includes(n)||this[o][t].nodes.push(n),i?this.slot_types_out.includes(t.toLowerCase())||(this.slot_types_out.push(t.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(t.toLowerCase())||(this.slot_types_in.push(t.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(t,e){var i,n="";if(e.inputs)for(var s=0;s<e.inputs.length;++s)n+="this.addInput('"+e.inputs[s][0]+"',"+(i=(i=e.inputs[s][1])&&i.constructor===String?'"'+i+'"':i)+");\n";if(e.outputs)for(s=0;s<e.outputs.length;++s)n+="this.addOutput('"+e.outputs[s][0]+"',"+(i=(i=e.outputs[s][1])&&i.constructor===String?'"'+i+'"':i)+");\n";if(e.properties)for(var s in e.properties){var o=e.properties[s];n+="this.addProperty('"+s+"',"+(o=o&&o.constructor===String?'"'+o+'"':o)+");\n"}n+="if(this.onCreate)this.onCreate()";var r=Function(n);for(s in e)"inputs"!=s&&"outputs"!=s&&"properties"!=s&&(r.prototype[s]=e[s]);return r.title=e.title||t.split("/").pop(),r.desc=e.desc||"Generated from object",this.registerNodeType(t,r),r},wrapFunctionAsNode:function(t,i,e,n,s){var o=Array(i.length),r="";if(null!==e)for(var a=LiteGraph.getParameterNames(i),h=0;h<a.length;++h){var p=0;e&&(null!=e[h]&&e[h].constructor===String?p="'"+e[h]+"'":null!=e[h]&&(p=e[h])),r+="this.addInput('"+a[h]+"',"+p+");\n"}null!==n&&(r+="this.addOutput('out',"+(null!=n?n.constructor===String?"'"+n+"'":n:0)+");\n"),s&&(r+="this.properties = "+JSON.stringify(s)+";\n");n=Function(r);return n.title=t.split("/").pop(),n.desc="Generated from "+i.name,n.prototype.onExecute=function(){for(var t=0;t<o.length;++t)o[t]=this.getInputData(t);var e=i.apply(this,o);this.setOutputData(0,e)},this.registerNodeType(t,n),n},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var i in LGraphNode.prototype[t]=e,this.registered_node_types){i=this.registered_node_types[i];i.prototype[t]&&(i.prototype["_"+t]=i.prototype[t]),i.prototype[t]=e}},createNode:function(t,e,i){var n=this.registered_node_types[t];if(!n)return LiteGraph.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;n.prototype;e=e||n.title||t;var s=null;if(LiteGraph.catch_exceptions)try{s=new n(e)}catch(t){return console.error(t),null}else s=new n(e);if(s.type=t,!s.title&&e&&(s.title=e),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=LiteGraph.DEFAULT_POSITION.concat()),s.mode||(s.mode=LiteGraph.ALWAYS),i)for(var o in i)s[o]=i[o];return s.onNodeCreated&&s.onNodeCreated(),s},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var i,n=[];for(i in this.registered_node_types){var s=this.registered_node_types[i];s.filter==e&&(""==t?null==s.category&&n.push(s):s.category==t&&n.push(s))}return this.auto_sort_node_types&&n.sort(function(t,e){return t.title.localeCompare(e.title)}),n},getNodeTypesCategories:function(t){var e={"":1};for(n in this.registered_node_types){var i=this.registered_node_types[n];i.category&&!i.skip_list&&i.filter==t&&(e[i.category]=1)}var n,s=[];for(n in e)s.push(n);return this.auto_sort_node_types?s.sort():s},reloadNodes:function(t){for(var e=document.getElementsByTagName("script"),i=[],n=0;n<e.length;n++)i.push(e[n]);var s=document.getElementsByTagName("head")[0];t=document.location.href+t;for(n=0;n<i.length;n++){var o=i[n].src;if(o&&o.substr(0,t.length)==t)try{LiteGraph.debug&&console.log("Reloading: "+o);var r=document.createElement("script");r.type="text/javascript",r.src=o,s.appendChild(r),s.removeChild(i[n])}catch(t){if(LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error while reloading "+o)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var i,n=JSON.parse(JSON.stringify(t));if(!e)return n;for(i in n)e[i]=n[i];return e},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^16*Math.random()>>t/4).toString(16))},isValidConnection:function(t,e){if(""!=e&&"*"!==e||(e=0),!(t=""!=t&&"*"!==t?t:0)||!e||t==e||t==LiteGraph.EVENT&&e==LiteGraph.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var i=t.split(","),n=e.split(","),s=0;s<i.length;++s)for(var o=0;o<n.length;++o)if(this.isValidConnection(i[s],n[o]))return!0;return!1},registerSearchboxExtra:function(t,e,i){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:i}},fetchFile:function(e,i,n,s){if(e){if(i=i||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(t){if(t.ok)return"arraybuffer"==i?t.arrayBuffer():"text"==i||"string"==i?t.text():"json"==i?t.json():"blob"==i?t.blob():void 0;throw new Error("File not found")}).then(function(t){n&&n(t)}).catch(function(t){console.error("error fetching file:",e),s&&s(t)});if(e.constructor===File||e.constructor===Blob){var t=new FileReader;if(t.onload=function(t){t=t.target.result;"json"==i&&(t=JSON.parse(t)),n&&n(t)},"arraybuffer"==i)return t.readAsArrayBuffer(e);if("text"==i||"json"==i)return t.readAsText(e);if("blob"==i)return t.readAsBinaryString(e)}}return null}};function LGraph(t){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function LLink(t,e,i,n,s,o){this.id=t,this.type=e,this.origin_id=i,this.origin_slot=n,this.target_id=s,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(t){this._ctor(t)}function LGraphGroup(t){this._ctor(t)}function DragAndScale(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function LGraphCanvas(t,e,i){this.options=i=i||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=i.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,i.skip_events),this.clear(),i.skip_render||this.startRendering(),this.autoresize=i.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(t){if(t.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),(t.graph=this).list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},LGraph.prototype.detachCanvas=function(t){var e;this.list_of_graphcanvas&&-1!=(e=this.list_of_graphcanvas.indexOf(t))&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))},LGraph.prototype.start=function(t){var e;this.status!=LGraph.STATUS_RUNNING&&(this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=this,0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,function t(){-1==e.execution_timer_id&&(window.requestAnimationFrame(t),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep)&&e.onAfterStep()}()):this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t))},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(t,e,i){t=t||1;var n=LiteGraph.getTime(),s=(this.globaltime=.001*(n-this.starttime),this._nodes_executable||this._nodes);if(s){if(i=i||s.length,e){for(var o=0;o<t;o++){for(var r=0;r<i;++r){var a=s[r];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(o=0;o<t;o++){for(r=0;r<i;++r){a=s[r];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error during execution: "+t),this.stop()}e=LiteGraph.getTime(),n=e-n;this.execution_time=.001*(n=0==n?1:n),this.globaltime+=.001*n,this.iteration+=1,this.elapsed_time=.001*(e-this.last_update_time),this.last_update_time=e,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},LGraph.prototype.computeExecutionOrder=function(t,e){for(var i=[],n=[],s={},o={},r={},a=0,h=this._nodes.length;a<h;++a){var p=this._nodes[a];if(!t||p.onExecute){var l=0;if((s[p.id]=p).inputs)for(var u=0,c=p.inputs.length;u<c;u++)p.inputs[u]&&null!=p.inputs[u].link&&(l+=1);0==l?(n.push(p),e&&(p._level=1)):(e&&(p._level=0),r[p.id]=l)}}for(;;){if(0==n.length)break;p=n.shift();if(i.push(p),delete s[p.id],p.outputs)for(var a=0;a<p.outputs.length;a++){var d=p.outputs[a];if(null!=d&&null!=d.links&&0!=d.links.length)for(u=0;u<d.links.length;u++){var g,_=d.links[u],_=this.links[_];!_||o[_.id]||(null==(g=this.getNodeById(_.target_id))?o[_.id]=!0:(e&&(!g._level||g._level<=p._level)&&(g._level=p._level+1),o[_.id]=!0,--r[g.id],0==r[g.id]&&n.push(g)))}}}for(a in s)i.push(s[a]);i.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(h=i.length,a=0;a<h;++a)i[a].order=a;for(i=i.sort(function(t,e){var i=t.constructor.priority||t.priority||0,n=e.constructor.priority||e.priority||0;return i==n?t.order-e.order:i-n}),a=0;a<h;++a)i[a].order=a;return i},LGraph.prototype.getAncestors=function(t){for(var e=[],i=[t],n={};i.length;){var s=i.shift();if(s.inputs){n[s.id]||s==t||(n[s.id]=!0,e.push(s));for(var o=0;o<s.inputs.length;++o){var r=s.getInputNode(o);r&&-1==e.indexOf(r)&&i.push(r)}}}return e.sort(function(t,e){return t.order-e.order}),e},LGraph.prototype.arrange=function(n,s){n=n||100;var e=this.computeExecutionOrder(!1,!0),i=[];for(let t=0;t<e.length;++t){var o=e[t],r=o._level||1;i[r]||(i[r]=[]),i[r].push(o)}let a=n;for(let t=0;t<i.length;++t){var h=i[t];if(h){let e=100,i=n+LiteGraph.NODE_TITLE_HEIGHT;for(let t=0;t<h.length;++t){var p=h[t],l=(p.pos[0]=s==LiteGraph.VERTICAL_LAYOUT?i:a,p.pos[1]=s==LiteGraph.VERTICAL_LAYOUT?a:i,s==LiteGraph.VERTICAL_LAYOUT?1:0),l=(p.size[l]>e&&(e=p.size[l]),s==LiteGraph.VERTICAL_LAYOUT?0:1);i+=p.size[l]+n+LiteGraph.NODE_TITLE_HEIGHT}a+=e+n}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(t,e,i){i=i||LiteGraph.ALWAYS;var n=this._nodes_in_order||this._nodes;if(n)for(var s=0,o=n.length;s<o;++s){var r=n[s];r.constructor===LiteGraph.Subgraph&&"onExecute"!=t?r.mode==i&&r.sendEventToAllNodes(t,e,i):r[t]&&r.mode==i&&(void 0===e?r[t]():e&&e.constructor===Array?r[t].apply(r,e):r[t](e))}},LGraph.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var n=this.list_of_graphcanvas[i];n[t]&&n[t].apply(n,e)}},LGraph.prototype.add=function(t,e){if(t){if(t.constructor!==LGraphGroup){if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?null!=t.id&&-1!=t.id||(t.id=LiteGraph.uuidv4()):null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),(t.graph=this)._version++,this._nodes.push(t),(this._nodes_by_id[t.id]=t).onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}this._groups.push(t),this.setDirtyCanvas(!0),this.change(),(t.graph=this)._version++}},LGraph.prototype.remove=function(t){if(t.constructor===LiteGraph.LGraphGroup)-1!=(s=this._groups.indexOf(t))&&this._groups.splice(s,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var e=0;e<t.inputs.length;e++)null!=(i=t.inputs[e]).link&&t.disconnectInput(e);if(t.outputs)for(var i,e=0;e<t.outputs.length;e++)null!=(i=t.outputs[e]).links&&i.links.length&&t.disconnectOutput(e);if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(e=0;e<this.list_of_graphcanvas.length;++e){var n=this.list_of_graphcanvas[e];n.selected_nodes[t.id]&&delete n.selected_nodes[t.id],n.node_dragged==t&&(n.node_dragged=null)}var s=this._nodes.indexOf(t);-1!=s&&this._nodes.splice(s,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},LGraph.prototype.findNodesByClass=function(t,e){for(var i=(e=e||[]).length=0,n=this._nodes.length;i<n;++i)this._nodes[i].constructor===t&&e.push(this._nodes[i]);return e},LGraph.prototype.findNodesByType=function(t,e){for(var t=t.toLowerCase(),i=(e=e||[]).length=0,n=this._nodes.length;i<n;++i)this._nodes[i].type.toLowerCase()==t&&e.push(this._nodes[i]);return e},LGraph.prototype.findNodeByTitle=function(t){for(var e=0,i=this._nodes.length;e<i;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},LGraph.prototype.findNodesByTitle=function(t){for(var e=[],i=0,n=this._nodes.length;i<n;++i)this._nodes[i].title==t&&e.push(this._nodes[i]);return e},LGraph.prototype.getNodeOnPos=function(t,e,i,n){for(var s=(i=i||this._nodes).length-1;0<=s;s--){var o=i[s];if(o.isPointInside(t,e,n))return o}return null},LGraph.prototype.getGroupOnPos=function(t,e){for(var i=this._groups.length-1;0<=i;i--){var n=this._groups[i];if(n.isPointInside(t,e,2,!0))return n}return null},LGraph.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var e=this._nodes[t],i=LiteGraph.registered_node_types[e.type];e.constructor!=i&&(console.log("node being replaced by newer version: "+e.type),i=LiteGraph.createNode(e.type),(this._nodes[t]=i).configure(e.serialize()),(i.graph=this)._nodes_by_id[i.id]=i,e.inputs&&(i.inputs=e.inputs.concat()),e.outputs)&&(i.outputs=e.outputs.concat())}this.updateExecutionOrder()},LGraph.prototype.onAction=function(t,e,i){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var n=0;n<this._input_nodes.length;++n){var s=this._input_nodes[n];if(s.properties.name==t){s.actionDo(t,e,i);break}}},LGraph.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},LGraph.prototype.addInput=function(t,e,i){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:i},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(t,e){t=this.inputs[t];t&&(t.value=e)},LGraph.prototype.getInputData=function(t){t=this.inputs[t];return t?t.value:null},LGraph.prototype.renameInput=function(t,e){if(e!=t)return!!this.inputs[t]&&(this.inputs[e]?(console.error("there is already one input with that name"),!1):(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},LGraph.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(t,e,i){this.outputs[t]={name:t,type:e,value:i},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(t,e){t=this.outputs[t];t&&(t.value=e)},LGraph.prototype.getOutputData=function(t){t=this.outputs[t];return t?t.value:null},LGraph.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},LGraph.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(t,e){for(var i=this.findNodesByTitle(t),n=0;n<i.length;++n)i[n].onTrigger(e)},LGraph.prototype.setCallback=function(t,e){for(var i=this.findNodesByTitle(t),n=0;n<i.length;++n)i[n].setTrigger(e)},LGraph.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(this.list_of_graphcanvas)for(var t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var t in this.links){t=this.links[t];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},LGraph.prototype.removeLink=function(t){var e,t=this.links[t];t&&(e=this.getNodeById(t.target_id))&&e.disconnectInput(t.target_slot)},LGraph.prototype.serialize=function(){for(var t=[],e=0,i=this._nodes.length;e<i;++e)t.push(this._nodes[e].serialize());var n=[];for(e in this.links){var s=this.links[e];if(!s.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var o,r=new LLink;for(o in s)r[o]=s[o];s=this.links[e]=r}n.push(s.serialize())}for(var a=[],e=0;e<this._groups.length;++e)a.push(this._groups[e].serialize());var h={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:n,groups:a,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(h),h},LGraph.prototype.configure=function(t,e){if(t){e||this.clear();var i=t.nodes;if(t.links&&t.links.constructor===Array){for(var n=[],s=0;s<t.links.length;++s){var o,r=t.links[s];r?((o=new LLink).configure(r),n[o.id]=o):console.warn("serialized graph link data contains errors, skipping.")}t.links=n}for(s in t)"nodes"!=s&&"groups"!=s&&(this[s]=t[s]);var a=!1;if(this._nodes=[],i){for(var s=0,h=i.length;s<h;++s){var p=i[s];(l=LiteGraph.createNode(p.type,p.title))||(LiteGraph.debug&&console.log("Node not found or has errors: "+p.type),(l=new LGraphNode).last_serialization=p,a=l.has_errors=!0),l.id=p.id,this.add(l,!0)}for(s=0,h=i.length;s<h;++s){var l,p=i[s];(l=this.getNodeById(p.id))&&l.configure(p)}}if(this._groups.length=0,t.groups)for(s=0;s<t.groups.length;++s){var u=new LiteGraph.LGraphGroup;u.configure(t.groups[s]),this.add(u)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),a}},LGraph.prototype.load=function(t,i){var e,n,s=this;t.constructor===File||t.constructor===Blob?((e=new FileReader).addEventListener("load",function(t){t=JSON.parse(t.target.result);s.configure(t),i&&i()}),e.readAsText(t)):((n=new XMLHttpRequest).open("GET",t,!0),n.send(null),n.onload=function(t){var e;200!==n.status?console.error("Error loading graph:",n.status,n.response):(e=JSON.parse(n.response),s.configure(e),i&&i())},n.onerror=function(t){console.error("Error loading graph:",t)})},LGraph.prototype.onNodeTrace=function(t,e,i){},LLink.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink,global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(t){for(var e in this.graph&&this.graph._version++,t)if("properties"==e)for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);else null!=t[e]&&("object"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=LiteGraph.cloneObject(t[e],this[e]):this[e]=t[e]);if(t.title||(this.title=this.constructor.title),this.inputs)for(var n=0;n<this.inputs.length;++n){var s=this.inputs[n],o=this.graph?this.graph.links[s.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,n,!0,o,s),this.onInputAdded&&this.onInputAdded(s)}if(this.outputs)for(n=0;n<this.outputs.length;++n){var r=this.outputs[n];if(r.links){for(e=0;e<r.links.length;++e){o=this.graph?this.graph.links[r.links[e]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,n,!0,o,r)}this.onOutputAdded&&this.onOutputAdded(r)}}if(this.widgets){for(n=0;n<this.widgets.length;++n){var a=this.widgets[n];a&&a.options&&a.options.property&&null!=this.properties[a.options.property]&&(a.value=JSON.parse(JSON.stringify(this.properties[a.options.property])))}if(t.widgets_values)for(n=0;n<t.widgets_values.length;++n)this.widgets[n]&&(this.widgets[n].value=t.widgets_values[n])}this.onConfigure&&this.onConfigure(t)},LGraphNode.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},LGraphNode.prototype.clone=function(){var t=LiteGraph.createNode(this.type);if(!t)return null;var e=LiteGraph.cloneObject(this.serialize());if(e.inputs)for(var i=0;i<e.inputs.length;++i)e.inputs[i].link=null;if(e.outputs)for(i=0;i<e.outputs.length;++i)e.outputs[i].links&&(e.outputs[i].links.length=0);return delete e.id,LiteGraph.use_uuids&&(e.id=LiteGraph.uuidv4()),t.configure(e),t},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var i=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,i)&&(this.properties[t]=i),this.widgets)for(var n=0;n<this.widgets.length;++n){var s=this.widgets[n];if(s&&s.options.property==t){s.value=e;break}}}},LGraphNode.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i._data=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n],s=this.graph.links[s];s&&(s.data=e)}}},LGraphNode.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var i=this.outputs[t];if(i&&(i.type=e,this.outputs[t].links))for(var n=0;n<this.outputs[t].links.length;n++){var s=this.outputs[t].links[n];this.graph.links[s].type=e}}},LGraphNode.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link))return t=this.inputs[t].link,(t=this.graph.links[t])?(e&&(e=this.graph.getNodeById(t.origin_id))&&(e.updateOutputData?e.updateOutputData(t.origin_slot):e.onExecute&&e.onExecute()),t.data):null},LGraphNode.prototype.getInputDataType=function(t){var e;return this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)&&(t=this.inputs[t].link,t=this.graph.links[t])?(e=this.graph.getNodeById(t.origin_id))?(e=e.outputs[t.origin_slot])?e.type:null:t.type:null},LGraphNode.prototype.getInputDataByName=function(t,e){t=this.findInputSlot(t);return-1==t?null:this.getInputData(t,e)},LGraphNode.prototype.isInputConnected=function(t){return!!this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link},LGraphNode.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},LGraphNode.prototype.getInputLink=function(t){return this.inputs&&t<this.inputs.length?(t=this.inputs[t],this.graph.links[t.link]):null},LGraphNode.prototype.getInputNode=function(t){return this.inputs&&!(t>=this.inputs.length)&&(t=this.inputs[t])&&null!==t.link&&(t=this.graph.links[t.link])?this.graph.getNodeById(t.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,i=this.inputs.length;e<i;++e){var n=this.inputs[e];if(t==n.name&&null!=n.link){n=this.graph.links[n.link];if(n)return n.data}}return this.properties[t]},LGraphNode.prototype.getOutputData=function(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data},LGraphNode.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},LGraphNode.prototype.isOutputConnected=function(t){return!!this.outputs&&t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length},LGraphNode.prototype.isAnyOutputConnected=function(){if(this.outputs)for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var i=[],n=0;n<e.links.length;n++){var s=e.links[n],s=this.graph.links[s];s&&(s=this.graph.getNodeById(s.target_id))&&i.push(s)}return i},LGraphNode.prototype.addOnTriggerInput=function(){var t=this.findInputSlot("onTrigger");return-1==t?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):t},LGraphNode.prototype.addOnExecutedOutput=function(){var t=this.findOutputSlot("onExecuted");return-1==t?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):t},LGraphNode.prototype.onAfterExecuteNode=function(t,e){var i=this.findOutputSlot("onExecuted");-1!=i&&this.triggerSlot(i,t,null,e)},LGraphNode.prototype.changeMode=function(t){switch(t){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0},LGraphNode.prototype.executePendingActions=function(){if(this._waiting_actions&&this._waiting_actions.length){for(var t=0;t<this._waiting_actions.length;++t){var e=this._waiting_actions[t];this.onAction(e[0],e[1],e[2],e[3],e[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(t,e){e=e||{},this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e)&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)},LGraphNode.prototype.actionDo=function(t,e,i,n){i=i||{},this.onAction&&(i.action_call||(i.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,i,n),this.graph.nodes_actioning[this.id]=!1,i)&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,i)},LGraphNode.prototype.trigger=function(t,e,i){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var n=0;n<this.outputs.length;++n){var s=this.outputs[n];!s||s.type!==LiteGraph.EVENT||t&&s.name!=t||this.triggerSlot(n,e,null,i)}}},LGraphNode.prototype.triggerSlot=function(t,e,i,n){if(n=n||{},this.outputs)if(null==t)console.error("slot must be a number");else{t.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");t=this.outputs[t];if(t){var s=t.links;if(s&&s.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var o=0;o<s.length;++o){var r,a,h=s[o];null!=i&&i!=h||(h=this.graph.links[s[o]])&&(h._last_time=LiteGraph.getTime(),r=this.graph.getNodeById(h.target_id))&&(a=r.inputs[h.target_slot],r.mode===LiteGraph.ON_TRIGGER?(n.action_call||(n.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),r.onExecute&&r.doExecute(e,n)):r.onAction&&(n.action_call||(n.action_call=this.id+"_act_"+Math.floor(9999*Math.random())),a=r.inputs[h.target_slot],LiteGraph.use_deferred_actions&&r.onExecute?(r._waiting_actions||(r._waiting_actions=[]),r._waiting_actions.push([a.name,e,n,h.target_slot])):r.actionDo(a.name,e,n,h.target_slot)))}}}}},LGraphNode.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){t=this.outputs[t];if(t){var i=t.links;if(i&&i.length)for(var n=0;n<i.length;++n){var s=i[n];null!=e&&e!=s||(s=this.graph.links[i[n]])&&(s._last_time=0)}}}},LGraphNode.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(t,e,i,n){var s={name:t,type:i,default_value:e};if(n)for(var o in n)s[o]=n[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s},LGraphNode.prototype.addOutput=function(t,e,i){var n={name:t,type:e,links:null};if(i)for(var s in i)n[s]=i[s];return this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),n},LGraphNode.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],n={name:i[0],type:i[1],link:null};if(t[2])for(var s in i[2])n[s]=i[2][s];this.outputs||(this.outputs=[]),this.outputs.push(n),this.onOutputAdded&&this.onOutputAdded(n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,i[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var i=this.outputs[e].links,n=0;n<i.length;++n){var s=this.graph.links[i[n]];s&&--s.origin_slot}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(t,e,i){var n={name:t,type:e=e||0,link:null};if(i)for(var s in i)n[s]=i[s];return this.inputs||(this.inputs=[]),this.inputs.push(n),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(n),LiteGraph.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),n},LGraphNode.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var i=t[e],n={name:i[0],type:i[1],link:null};if(t[2])for(var s in i[2])n[s]=i[2][s];this.inputs||(this.inputs=[]),this.inputs.push(n),this.onInputAdded&&this.onInputAdded(n),LiteGraph.registerNodeAndSlotType(this,i[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(t){this.disconnectInput(t);for(var e,i=this.inputs.splice(t,1),n=t;n<this.inputs.length;++n)this.inputs[n]&&(e=this.graph.links[this.inputs[n].link])&&--e.target_slot;this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,i[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(t,e,i,n){t={name:t,type:e,pos:i,direction:n,links:null};return this.connections.push(t),t},LGraphNode.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),i=t||new Float32Array([0,0]),e=Math.max(e,1),n=LiteGraph.NODE_TEXT_SIZE,t=c(this.title),s=0,o=0;if(this.inputs)for(var r=0,a=this.inputs.length;r<a;++r){var h=this.inputs[r];s<(p=c(h.label||h.name||""))&&(s=p)}if(this.outputs)for(r=0,a=this.outputs.length;r<a;++r){var p,l=this.outputs[r];o<(p=c(l.label||l.name||""))&&(o=p)}i[0]=Math.max(s+o+10,t),i[0]=Math.max(i[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(i[0]=Math.max(i[0],1.5*LiteGraph.NODE_WIDTH)),i[1]=(this.constructor.slot_start_y||0)+e*LiteGraph.NODE_SLOT_HEIGHT;var u=0;if(this.widgets&&this.widgets.length){for(r=0,a=this.widgets.length;r<a;++r)this.widgets[r].computeSize?u+=this.widgets[r].computeSize(i[0])[1]+4:u+=LiteGraph.NODE_WIDGET_HEIGHT+4;u+=8}function c(t){return t?n*t.length*.6:0}return this.widgets_up?i[1]=Math.max(i[1],u):null!=this.widgets_start_y?i[1]=Math.max(i[1],u+this.widgets_start_y):i[1]+=u,this.constructor.min_height&&i[1]<this.constructor.min_height&&(i[1]=this.constructor.min_height),i[1]+=6,i},LGraphNode.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==t){e=this.properties_info[i];break}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),(e=(e=!(e=this.constructor.widgets_info&&this.constructor.widgets_info[t]?this.constructor.widgets_info[t]:e)&&this.onGetPropertyInfo?this.onGetPropertyInfo(t):e)||{}).type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},LGraphNode.prototype.addWidget=function(t,e,i,n,s){this.widgets||(this.widgets=[]),!s&&n&&n.constructor===Object&&(s=n,n=null),s&&s.constructor===String&&(s={property:s}),n&&n.constructor===String&&((s=s||{}).property=n,n=null),n&&n.constructor!==Function&&(console.warn("addWidget: callback must be a function"),n=null);e={type:t.toLowerCase(),name:e,value:i,callback:n,options:s||{}};if(void 0!==e.options.y&&(e.y=e.options.y),n||e.options.callback||e.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"!=t||e.options.values)return this.widgets.push(e),this.setSize(this.computeSize()),e;throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }"},LGraphNode.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},LGraphNode.prototype.getBounding=function(t,e){t=t||new Float32Array(4);var i=this.pos,n=this.flags.collapsed,s=this.size;let o=0,r=1,a=0,h=0;return e&&(o=4,r=6+o,a=4,h=5+a),t[0]=i[0]-o,t[1]=i[1]-LiteGraph.NODE_TITLE_HEIGHT-a,t[2]=n?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+r:s[0]+r,t[3]=n?LiteGraph.NODE_TITLE_HEIGHT+h:s[1]+LiteGraph.NODE_TITLE_HEIGHT+h,this.onBounding&&this.onBounding(t),t},LGraphNode.prototype.isPointInside=function(t,e,i,n){i=i||0;var s=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(n&&(s=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(t,e,this.pos[0]-i,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-i,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*i,LiteGraph.NODE_TITLE_HEIGHT+2*i))return!0}else if(this.pos[0]-4-i<t&&this.pos[0]+this.size[0]+4+i>t&&this.pos[1]-s-i<e&&this.pos[1]+this.size[1]+i>e)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(t,e){var i=new Float32Array(2);if(this.inputs)for(var n=0,s=this.inputs.length;n<s;++n){var o=this.inputs[n];if(this.getConnectionPos(!0,n,i),isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{input:o,slot:n,link_pos:i}}if(this.outputs)for(n=0,s=this.outputs.length;n<s;++n){var r=this.outputs[n];if(this.getConnectionPos(!1,n,i),isInsideRectangle(t,e,i[0]-10,i[1]-5,20,10))return{output:r,slot:n,link_pos:i}}return null},LGraphNode.prototype.findInputSlot=function(t,e){if(this.inputs)for(var i=0,n=this.inputs.length;i<n;++i)if(t==this.inputs[i].name)return e?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlot=function(t,e){if(e=e||!1,this.outputs)for(var i=0,n=this.outputs.length;i<n;++i)if(t==this.outputs[i].name)return e?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.inputs)for(var i=0,n=this.inputs.length;i<n;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.inputs[i].type)))return e.returnObj?this.inputs[i]:i;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.outputs)for(var i=0,n=this.outputs.length;i<n;++i)if(!(this.outputs[i].links&&null!=this.outputs[i].links||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.outputs[i].type)))return e.returnObj?this.outputs[i]:i;return-1},LGraphNode.prototype.findInputSlotByType=function(t,e,i,n){return this.findSlotByType(!0,t,e,i,n)},LGraphNode.prototype.findOutputSlotByType=function(t,e,i,n){return this.findSlotByType(!1,t,e,i,n)},LGraphNode.prototype.findSlotByType=function(t,e,i,n,s){i=i||!1,n=n||!1,s=s||!1;var o=(t=t||!1)?this.inputs:this.outputs;if(o){""!=e&&"*"!=e||(e=0);for(var r=0,a=o.length;r<a;++r){var h=(e+"").toLowerCase().split(",");u=((u="0"==o[r].type||"*"==o[r].type?"0":o[r].type)+"").toLowerCase().split(",");for(var p=0;p<h.length;p++)for(var l=0;l<u.length;l++)if("_event_"==h[p]&&(h[p]=LiteGraph.EVENT),"_event_"==u[p]&&(u[p]=LiteGraph.EVENT),"*"==h[p]&&(h[p]=0),"*"==u[p]&&(u[p]=0),!(h[p]!=u[l]||n&&o[r].links&&null!==o[r].links))return i?o[r]:r}if(n&&!s)for(r=0,a=o.length;r<a;++r){var u,h=(e+"").toLowerCase().split(",");u=((u="0"==o[r].type||"*"==o[r].type?"0":o[r].type)+"").toLowerCase().split(",");for(p=0;p<h.length;p++)for(l=0;l<u.length;l++)if("*"==h[p]&&(h[p]=0),"*"==u[p]&&(u[p]=0),h[p]==u[l])return i?o[r]:r}}return-1},LGraphNode.prototype.connectByType=function(t,e,i,n){var n=n||{},n=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},n),s=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findInputSlotByType(i,!1,!0);return 0<=s&&null!==s?this.connect(t,e,s):n.createEventInCase&&i==LiteGraph.EVENT?this.connect(t,e,-1):n.generalTypeInCase&&0<=(s=e.findInputSlotByType(0,!1,!0,!0))||n.firstFreeIfOutputGeneralInCase&&(0==i||"*"==i||""==i)&&0<=(s=e.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?this.connect(t,e,s):(console.debug("no way to connect type: ",i," to targetNODE ",e),null)},LGraphNode.prototype.connectByTypeOutput=function(t,e,i,n){var n=n||{},n=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},n),s=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findOutputSlotByType(i,!1,!0);return 0<=s&&null!==s||n.generalTypeInCase&&0<=(s=e.findOutputSlotByType(0,!1,!0,!0))?e.connect(s,this,t):n.createEventInCase&&i==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(s=e.addOnExecutedOutput(),e.connect(s,this,t)):n.firstFreeIfInputGeneralInCase&&(0==i||"*"==i||""==i)&&0<=(s=e.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?e.connect(s,this,t):(console.debug("no way to connect byOUT type: ",i," to sourceNODE ",e),null)},LGraphNode.prototype.connect=function(t,e,i){if(i=i||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(!(e=e&&e.constructor===Number?this.graph.getNodeById(e):e))throw"target node is null";if(e==this)return null;if(i.constructor===String){if(-1==(i=e.findInputSlot(i)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+i),null}else if(i===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;e.changeMode(LiteGraph.ON_TRIGGER),i=e.findInputSlot("onTrigger")}else if(!e.inputs||i>=e.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var n,s=!1,o=e.inputs[i],r=this.outputs[t];return this.outputs[t]?!1!==(i=e.onBeforeConnectInput?e.onBeforeConnectInput(i):i)&&null!==i&&LiteGraph.isValidConnection(r.type,o.type)?e.onConnectInput&&!1===e.onConnectInput(i,r.type,r,this,t)||this.onConnectOutput&&!1===this.onConnectOutput(t,o.type,o,e,i)?null:(e.inputs[i]&&null!=e.inputs[i].link&&(this.graph.beforeChange(),e.disconnectInput(i,{doProcessChange:!1}),s=!0),null!==r.links&&r.links.length&&r.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),s=!0),n=new LLink(LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,o.type||r.type,this.id,t,e.id,i),this.graph.links[n.id]=n,null==r.links&&(r.links=[]),r.links.push(n.id),e.inputs[i].link=n.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!0,n,r),e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,i,!0,n,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,i,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,e,i)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,n),n):(this.setDirtyCanvas(!1,!0),s&&this.graph.connectionChange(this,null),null):null},LGraphNode.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.outputs[t];if(!i||!i.links||0==i.links.length)return!1;if(e){if(!(e=e.constructor===Number?this.graph.getNodeById(e):e))throw"Target Node not found";for(var n=0,s=i.links.length;n<s;n++){var o=i.links[n];if((r=this.graph.links[o]).target_id==e.id){i.links.splice(n,1),(a=e.inputs[r.target_slot]).link=null,delete this.graph.links[o],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,r.target_slot,!1,r,a),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,r,i),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot));break}}}else{for(n=0,s=i.links.length;n<s;n++){var r,a,o=i.links[n];(r=this.graph.links[o])&&(e=this.graph.getNodeById(r.target_id),a=null,this.graph&&this.graph._version++,e&&((a=e.inputs[r.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,r.target_slot,!1,r,a),this.graph)&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,r,i),this.graph)&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,r.target_slot))}i.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var i=this.inputs[t].link;if(null!=i){this.inputs[t].link=null;var n=this.graph.links[i];if(n){var s=this.graph.getNodeById(n.origin_id);if(!s)return!1;var o=s.outputs[n.origin_slot];if(!o||!o.links||0==o.links.length)return!1;for(var r=0,a=o.links.length;r<a;r++)if(o.links[r]==i){o.links.splice(r,1);break}delete this.graph.links[i],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,n,e),s.onConnectionsChange&&s.onConnectionsChange(LiteGraph.OUTPUT,r,!1,n,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,s,r),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(t,e,i){i=i||new Float32Array(2);var n,s=0,o=(t&&this.inputs&&(s=this.inputs.length),!t&&this.outputs&&(s=this.outputs.length),.5*LiteGraph.NODE_SLOT_HEIGHT),r=!1,r=t?void 0!==this.inputs_horizontal?this.inputs_horizontal:this.horizontal:void 0!==this.outputs_horizontal?this.outputs_horizontal:this.horizontal;return this.flags.collapsed?(n=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,r?(i[0]=this.pos[0]+.5*n,i[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(i[0]=t?this.pos[0]:this.pos[0]+n,i[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT)):t&&-1==e?(i[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,i[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT):t&&e<s&&this.inputs[e].pos?(i[0]=this.pos[0]+this.inputs[e].pos[0],i[1]=this.pos[1]+this.inputs[e].pos[1]):!t&&e<s&&this.outputs[e].pos?(i[0]=this.pos[0]+this.outputs[e].pos[0],i[1]=this.pos[1]+this.outputs[e].pos[1]):r?(i[0]=this.pos[0]+(e+.5)*(this.size[0]/s),i[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(i[0]=t?this.pos[0]+o:this.pos[0]+this.size[0]+1-o,i[1]=this.pos[1]+(e+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),i},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},LGraphNode.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},LGraphNode.prototype.loadImage=function(t){var e=new Image,i=(e.src=LiteGraph.node_images_path+t,e.ready=!1,this);return e.onload=function(){this.ready=!0,i.setDirtyCanvas(!0)},e},LGraphNode.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,i=0;i<e.length;++i){var n=e[i];!t&&n.node_capturing_input!=this||(n.node_capturing_input=t?this:null)}},LGraphNode.prototype.collapse=function(t){this.graph._version++,!1===this.constructor.collapsable&&!t||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},LGraphNode.prototype.localToScreen=function(t,e,i){return[(t+this.pos[0])*i.scale+i.offset[0],(e+this.pos[1])*i.scale+i.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font_size=t.font_size},LGraphGroup.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(t,e,i){if(this._pos[0]+=t,this._pos[1]+=e,!i)for(var n=0;n<this._nodes.length;++n){var s=this._nodes[n];s.pos[0]+=t,s.pos[1]+=e}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),i=0;i<t.length;++i){var n=t[i];n.getBounding(e),overlapBounding(this._bounding,e)&&this._nodes.push(n)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(t){var e,i,n,s;this.element?(s=this.element.width,e=this.element.height,i=-this.offset[0],n=-this.offset[1],t&&(i+=t[0]/this.scale,n+=t[1]/this.scale,s=t[2],e=t[3]),t=i+s/this.scale,s=n+e/this.scale,this.visible_area[0]=i,this.visible_area[1]=n,this.visible_area[2]=t-i,this.visible_area[3]=s-n):this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},DragAndScale.prototype.onMouse=function(t){var e,i,n,s,o,r;if(this.enabled)return n=(e=this.element).getBoundingClientRect(),i=t.clientX-n.left,n=t.clientY-n.top,t.canvasx=i,t.canvasy=n,t.dragging=this.dragging,s=!this.viewport||(this.viewport,i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3]),o=!1,this.onmouse&&(o=this.onmouse(t)),t.type==LiteGraph.pointerevents_method+"down"&&s?(this.dragging=!0,LiteGraph.pointerListenerRemove(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback)):t.type==LiteGraph.pointerevents_method+"move"?o||(o=i-this.last_mouse[0],r=n-this.last_mouse[1],this.dragging&&this.mouseDrag(o,r)):t.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback)):!s||"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel",t.wheel="wheel"==t.type?-t.deltaY:null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta)),this.last_mouse[0]=i,this.last_mouse[1]=n,s?(t.preventDefault(),t.stopPropagation(),!1):void 0},DragAndScale.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},DragAndScale.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(t,e){var i;t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element&&(i=this.element.getBoundingClientRect())&&(e=e||[.5*i.width,.5*i.height],i=this.convertCanvasToOffset(e),this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1),e=[(t=this.convertCanvasToOffset(e))[0]-i[0],t[1]-i[1]],this.offset[0]+=e[0],this.offset[1]+=e[1],this.onredraw)&&this.onredraw(this)},DragAndScale.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),!t&&this.graph?this.graph.detachCanvas(this):(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)))},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){var t,e;this._graph_stack&&0!=this._graph_stack.length&&(t=this.graph._subgraph_node,e=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1)},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(t||!this.canvas||e||this.unbindEvents(),this.canvas=t,this.ds.element=t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),e||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){var t,e;this._events_binded?console.warn("LGraphCanvas: events already binded"):(t=this.canvas,e=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(t,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.setAttribute("tabindex",1),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0)},LGraphCanvas.prototype.unbindEvents=function(){var t;this._events_binded?(t=this.getCanvasWindow().document,LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1):console.warn("LGraphCanvas: no events binded")},LGraphCanvas.getFileExtension=function(t){var e=t.indexOf("?"),e=(t=-1!=e?t.substr(0,e):t).lastIndexOf(".");return-1==e?"":t.substr(e+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){var t;return this.canvas?(t=this.canvas.ownerDocument).defaultView||t.parentWindow:window},LGraphCanvas.prototype.startRendering=function(){function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}this.is_rendering||(this.is_rendering=!0,e.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow(),i=(e.document,LGraphCanvas.active_canvas=this),n=t.clientX,s=t.clientY,n=(this.ds.viewport=this.viewport,!this.viewport||(this.viewport,n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]));if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(e.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(e.document,"up",this._mouseup_callback,!0)),n){var o=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),r=!1,s=LiteGraph.getTime(),n=void 0===t.isPrimary||!t.isPrimary,a=s-this.last_mouseclick<300&&n;if(this.mouse[0]=t.clientX,this.mouse[1]=t.clientY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&n?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(e),!this.onMouse||1!=this.onMouse(t)){if(1!=t.which||this.pointer_is_double)if(2==t.which)if(LiteGraph.middle_click_slot_add_default_node){if(o&&this.allow_interaction&&!r&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var h=!1,p=!1,l=!1;if(o.outputs)for(d=0,f=o.outputs.length;d<f;++d){v=o.outputs[d],y=o.getConnectionPos(!1,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){h=v,p=d,l=!0;break}}if(o.inputs)for(d=0,f=o.inputs.length;d<f;++d){m=o.inputs[d],y=o.getConnectionPos(!0,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){h=m,p=d,l=!1;break}}h&&!1!==p&&(s=.5-(p+1)/(l?o.outputs:o.inputs).length,n=o.getBounding(),n=[l?n[0]+n[2]:n[0],t.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:l?o:null,slotFrom:l?p:null,nodeTo:l?null:o,slotTo:l?null:p,position:n,nodeType:"AUTO",posAdd:[l?30:-30,130*-s],posSizeFix:[l?0:-1,0]}))}}else!r&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else 3!=t.which&&!this.pointer_is_double||!this.allow_interaction||r||this.read_only||(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||t.shiftKey||t.ctrlKey||t.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,t));else{t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,r=!0),LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&o&&this.allow_interaction&&!r&&!this.read_only&&(cloned=o.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),o=cloned,r=!0,u||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id])||this.processNodeSelected(o,t));var u,c,n=!1;if(!o||!this.allow_interaction&&!o.flags.allow_interaction||r||this.read_only){if(!r){if(!this.read_only)for(var d=0;d<this.visible_links.length;++d){var g=this.visible_links[d],_=g._pos;if(!(!_||t.canvasX<_[0]-4||t.canvasX>_[0]+4||t.canvasY<_[1]-4||t.canvasY>_[1]+4)){this.showLinkMenu(g,t),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(t.ctrlKey&&(this.dragging_rectangle=null),distance([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),a&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault(),t.stopPropagation()),n=!0}}else{if(this.live_mode||o.flags.pinned||this.bringToFront(o),this.allow_interaction&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!r&&!1!==o.resizable&&isInsideRectangle(t.canvasX,t.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",r=!0;else{if(o.outputs)for(var d=0,f=o.outputs.length;d<f;++d){var v=o.outputs[d],y=o.getConnectionPos(!1,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){this.connecting_node=o,this.connecting_output=v,this.connecting_output.slot_index=d,this.connecting_pos=o.getConnectionPos(!1,d),this.connecting_slot=d,LiteGraph.shift_click_do_break_link_from&&t.shiftKey&&o.disconnectOutput(d),a?o.onOutputDblClick&&o.onOutputDblClick(d,t):o.onOutputClick&&o.onOutputClick(d,t),r=!0;break}}if(o.inputs)for(var d=0,f=o.inputs.length;d<f;++d){var b,m=o.inputs[d],y=o.getConnectionPos(!0,d);isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)&&(a?o.onInputDblClick&&o.onInputDblClick(d,t):o.onInputClick&&o.onInputClick(d,t),null!==m.link&&(b=this.graph.links[m.link],LiteGraph.click_do_break_link_to&&(o.disconnectInput(d),r=this.dirty_bgcanvas=!0),this.allow_reconnect_links||t.shiftKey)&&(LiteGraph.click_do_break_link_to||o.disconnectInput(d),this.connecting_node=this.graph._nodes_by_id[b.origin_id],this.connecting_slot=b.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),r=this.dirty_bgcanvas=!0),r||(this.connecting_node=o,this.connecting_input=m,this.connecting_input.slot_index=d,this.connecting_pos=o.getConnectionPos(!0,d),this.connecting_slot=d,r=this.dirty_bgcanvas=!0))}}r||(u=!1,s=[t.canvasX-o.pos[0],t.canvasY-o.pos[1]],(c=this.processNodeWidgets(o,this.graph_mouse,t))&&(u=!0,this.node_widget=[o,c]),this.allow_interaction&&a&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(t,s,this),this.processNodeDblClicked(o),u=!0),o.onMouseDown&&o.onMouseDown(t,s,this)?u=!0:(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&s[0]>o.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&s[1]<0&&(i=this,setTimeout(function(){i.openSubgraph(o.subgraph)},10)),this.live_mode&&(u=n=!0)),u?o.is_selected||this.processNodeSelected(o,t):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.processNodeSelected(o,t)),this.dirty_canvas=!0)}!r&&n&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=t.clientX,this.last_mouse[1]=t.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),e.document.activeElement&&("input"==e.document.activeElement.nodeName.toLowerCase()||"textarea"==e.document.activeElement.nodeName.toLowerCase())||t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},LGraphCanvas.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(LGraphCanvas.active_canvas=this).adjustMouseEvent(t);var e=[t.clientX,t.clientY],i=(this.mouse[0]=e[0],this.mouse[1]=e[1],[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]]);if(this.last_mouse=e,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,!this.block_click){t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0);var n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]]:(e=i[0]/this.ds.scale,a=i[1]/this.ds.scale,this.selected_group.move(e,a,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||n&&n.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var s,o,r,a,h=0,p=this.graph._nodes.length;h<p;++h)this.graph._nodes[h].mouseOver&&n!=this.graph._nodes[h]&&(this.graph._nodes[h].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(n)n.redraw_on_mouse&&(this.dirty_canvas=!0),n.mouseOver||(n.mouseOver=!0,this.node_over=n,this.dirty_canvas=!0,n.onMouseEnter&&n.onMouseEnter(t)),n.onMouseMove&&n.onMouseMove(t,[t.canvasX-n.pos[0],t.canvasY-n.pos[1]],this),this.connecting_node&&(this.connecting_output?(s=this._highlight_input||[0,0],this.isOverNodeBox(n,t.canvasX,t.canvasY)||(-1!=(o=this.isOverNodeInput(n,t.canvasX,t.canvasY,s))&&n.inputs[o]?(r=n.inputs[o].type,LiteGraph.isValidConnection(this.connecting_output.type,r)&&(this._highlight_input=s,this._highlight_input_slot=n.inputs[o])):(this._highlight_input=null,this._highlight_input_slot=null))):this.connecting_input&&(s=this._highlight_output||[0,0],this.isOverNodeBox(n,t.canvasX,t.canvasY)||(-1!=(o=this.isOverNodeOutput(n,t.canvasX,t.canvasY,s))&&n.outputs[o]?(r=n.outputs[o].type,LiteGraph.isValidConnection(this.connecting_input.type,r)&&(this._highlight_output=s)):this._highlight_output=null))),this.canvas&&(isInsideRectangle(t.canvasX,t.canvasY,n.pos[0]+n.size[0]-5,n.pos[1]+n.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair");else{for(var l=null,h=0;h<this.visible_links.length;++h){var u=this.visible_links[h],c=u._pos;if(!(!c||t.canvasX<c[0]-4||t.canvasX>c[0]+4||t.canvasY<c[1]-4||t.canvasY>c[1]+4)){l=u;break}}l!=this.over_link_center&&(this.over_link_center=l,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=n&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var h in this.selected_nodes){var d=this.selected_nodes[h];d.pos[0]+=i[0]/this.ds.scale,d.pos[1]+=i[1]/this.ds.scale,d.is_selected||this.processNodeSelected(d,t)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(e=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],a=this.resizing_node.computeSize(),e[0]=Math.max(a[0],e[0]),e[1]=Math.max(a[1],e[1]),this.resizing_node.setSize(e),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}}return t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(t){var e=void 0===t.isPrimary||t.isPrimary;if(!e)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var i=this.getCanvasWindow().document,i=((LGraphCanvas.active_canvas=this).options.skip_events||(LiteGraph.pointerListenerRemove(i,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(i,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(t),LiteGraph.getTime());if(t.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==t.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group&&(i=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),r=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(i,r,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null),this.selected_group_resizing=!1;var n,i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var s=this.graph._nodes,o=new Float32Array(4),r=Math.abs(this.dragging_rectangle[2]),a=Math.abs(this.dragging_rectangle[3]),h=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-r:this.dragging_rectangle[0],p=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-a:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=h,this.dragging_rectangle[1]=p,this.dragging_rectangle[2]=r,this.dragging_rectangle[3]=a,!i||10<r&&10<a){for(var l=[],u=0;u<s.length;++u){var c=s[u];c.getBounding(o),overlapBounding(this.dragging_rectangle,o)&&l.push(c)}l.length&&this.selectNodes(l,t.shiftKey)}else this.selectNodes([i],t.shiftKey||t.ctrlKey)}this.dragging_rectangle=null}else this.connecting_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,h=(this.connecting_output||this.connecting_input).type,i?this.connecting_output?-1!=(n=this.isOverNodeInput(i,t.canvasX,t.canvasY))?this.connecting_node.connect(this.connecting_slot,i,n):this.connecting_node.connectByType(this.connecting_slot,i,h):this.connecting_input&&(-1!=(n=this.isOverNodeOutput(i,t.canvasX,t.canvasY))?i.connect(n,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,i,h)):LiteGraph.release_link_on_empty_shows_menu&&(t.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(t,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(t,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:t}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:t})),this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1):this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?((i=this.node_dragged)&&t.click_time<300&&isInsideRectangle(t.canvasX,t.canvasY,i.pos[0],i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&i.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(!(i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]]))}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return e&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,i=(this.adjustMouseEvent(t),t.clientX),n=t.clientY;if(!this.viewport||(this.viewport,i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3]))return i=this.ds.scale,0<e?i*=1.1:e<0&&(i*=1/1.1),this.ds.changeScale(i,[t.clientX,t.clientY]),this.graph.change(),t.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeBox=function(t,e,i){var n=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(e,i,t.pos[0]+2,t.pos[1]+2-n,n-4,n-4)},LGraphCanvas.prototype.isOverNodeInput=function(t,e,i,n){if(t.inputs)for(var s=0,o=t.inputs.length;s<o;++s){t.inputs[s];var r=t.getConnectionPos(!0,s);if((void 0!==t.inputs_horizontal?t.inputs_horizontal:t.horizontal)?isInsideRectangle(e,i,r[0]-5,r[1]-10,10,20):isInsideRectangle(e,i,r[0]-10,r[1]-5,40,10))return n&&(n[0]=r[0],n[1]=r[1]),s}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(t,e,i,n){if(t.outputs)for(var s=0,o=t.outputs.length;s<o;++s){t.outputs[s];var r=t.getConnectionPos(!1,s);if((void 0!==t.outputs_horizontal?t.outputs_horizontal:t.horizontal)?isInsideRectangle(e,i,r[0]-5,r[1]-10,10,20):isInsideRectangle(e,i,r[0]-10,r[1]-5,40,10))return n&&(n[0]=r[0],n[1]=r[1]),s}return-1},LGraphCanvas.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(e=this.dragging_canvas=!0),27==t.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),67!==t.keyCode||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),86===t.keyCode&&(t.metaKey||t.ctrlKey)&&this.pasteFromClipboard(t.shiftKey),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,i=[];for(n in this.selected_nodes)!1!==(s=this.selected_nodes[n]).clonable&&(s._relative_id=e,i.push(s),e+=1);for(var n=0;n<i.length;++n){var s=i[n];if(!1!==s.clonable){var o=s.clone();if(o){if(t.nodes.push(o.serialize()),s.inputs&&s.inputs.length)for(var r=0;r<s.inputs.length;++r){var a,h=s.inputs[r];h&&null!=h.link&&(h=this.graph.links[h.link])&&(a=this.graph.getNodeById(h.origin_id))&&t.links.push([a._relative_id,h.origin_slot,s._relative_id,h.target_slot,a.id])}}else console.warn("node type not found: "+s.type)}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},LGraphCanvas.prototype.pasteFromClipboard=function(t=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!t){var e=localStorage.getItem("litegrapheditor_clipboard");if(e){this.graph.beforeChange();for(var i=JSON.parse(e),n=!1,s=!1,o=0;o<i.nodes.length;++o)n?(n[0]>i.nodes[o].pos[0]&&(n[0]=i.nodes[o].pos[0],s[0]=o),n[1]>i.nodes[o].pos[1]&&(n[1]=i.nodes[o].pos[1],s[1]=o)):(n=[i.nodes[o].pos[0],i.nodes[o].pos[1]],s=[o,o]);for(var r=[],o=0;o<i.nodes.length;++o){var a=i.nodes[o],h=LiteGraph.createNode(a.type);h&&(h.configure(a),h.pos[0]+=this.graph_mouse[0]-n[0],h.pos[1]+=this.graph_mouse[1]-n[1],this.graph.add(h,{doProcessChange:!1}),r.push(h))}for(o=0;o<i.links.length;++o){var p,l=i.links[o],u=l[0],u=(null!=u?p=r[u]:LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&t&&(u=l[4])&&(p=this.graph.getNodeById(u)),r[l[2]]);p&&u?p.connect(l[1],u,l[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(r),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=t.clientX,i=t.clientY;if(!this.viewport||(this.viewport,e>=this.viewport[0]&&e<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3])){var e=[t.canvasX,t.canvasY],n=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(n){if(n.onDropFile||n.onDropData){var s=t.dataTransfer.files;if(s&&s.length)for(var o=0;o<s.length;o++){var r,a,h=t.dataTransfer.files[0],p=h.name;LGraphCanvas.getFileExtension(p);n.onDropFile&&n.onDropFile(h),n.onDropData&&((r=new FileReader).onload=function(t){t=t.target.result;n.onDropData(t,p,h)},"text"==(a=h.type.split("/")[0])||""==a?r.readAsText(h):"image"==a?r.readAsDataURL(h):r.readAsArrayBuffer(h))}}return!(!n.onDropItem||!n.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}i=null,(i=this.onDropItem?this.onDropItem(event):i)||this.checkDropItem(t)}},LGraphCanvas.prototype.checkDropItem=function(t){var e,i;t.dataTransfer.files.length&&(e=t.dataTransfer.files[0],i=LGraphCanvas.getFileExtension(e.name).toLowerCase(),i=LiteGraph.node_types_by_file_extension[i])&&(this.graph.beforeChange(),(i=LiteGraph.createNode(i.type)).pos=[t.canvasX,t.canvasY],this.graph.add(i),i.onDropFile&&i.onDropFile(e),this.graph.afterChange())},LGraphCanvas.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)},LGraphCanvas.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},LGraphCanvas.prototype.selectNodes=function(t,e){for(var i in e||this.deselectAllNodes(),t="string"==typeof(t=t||this.graph._nodes)?[t]:t){var n=t[i];if(n.is_selected)this.deselectNode(n);else{if(!n.is_selected&&n.onSelected&&n.onSelected(),n.is_selected=!0,(this.selected_nodes[n.id]=n).inputs)for(var s=0;s<n.inputs.length;++s)this.highlighted_links[n.inputs[s].link]=!0;if(n.outputs)for(s=0;s<n.outputs.length;++s){var o=n.outputs[s];if(o.links)for(var r=0;r<o.links.length;++r)this.highlighted_links[o.links[r]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var i=t.outputs[e];if(i.links)for(var n=0;n<i.links.length;++n)delete this.highlighted_links[i.links[n]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,i=t.length;e<i;++e){var n=t[e];n.is_selected&&(n.onDeselected&&n.onDeselected(),n.is_selected=!1,this.onNodeDeselected)&&this.onNodeDeselected(n)}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e,i,n,s,t=this.selected_nodes[t];t.block_delete||(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length&&(e=t.graph.links[t.inputs[0].link],i=t.graph.links[t.outputs[0].links[0]],n=t.getInputNode(0),s=t.getOutputNodes(0)[0],n)&&s&&n.connect(e.origin_slot,s,i.target_slot),this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(t){var e,i=0,n=0;n=this.canvas?(e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,t.clientY-e.top):(i=t.clientX,t.clientY),this.last_mouse_position[0]=i,this.last_mouse_position[1]=n,t.canvasX=i/this.ds.scale-this.ds.offset[0],t.canvasY=n/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},LGraphCanvas.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},LGraphCanvas.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},LGraphCanvas.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var temp=new Float32Array(4),temp_vec2=(LGraphCanvas.prototype.computeVisibleNodes=function(t,e){for(var i=e||[],n=i.length=0,s=(t=t||this.graph._nodes).length;n<s;++n){var o=t[n];(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&overlapBounding(this.visible_area,o.getBounding(temp,!0))&&i.push(o)}return i},LGraphCanvas.prototype.draw=function(t,e){var i;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(i=LiteGraph.getTime(),this.render_time=.001*(i-this.last_draw_time),this.last_draw_time=i,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&i-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1)},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas,i=(t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(i&&(t.save(),t.beginPath(),t.rect(i[0],i[1],i[2],i[3]),t.clip()),this.clear_background&&(i?t.clearRect(i[0],i[1],i[2],i[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,i?i[0]:0,i?i[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var n,s,o,r,a=this.computeVisibleNodes(null,this.visible_nodes),h=0;h<a.length;++h){var p=a[h];t.save(),t.translate(p.pos[0],p.pos[1]),this.drawNode(p,t),t.restore()}this.render_execution_order&&this.drawExecutionOrder(t),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(t),null!=this.connecting_pos&&(t.lineWidth=this.connections_width,n=(e=this.connecting_output||this.connecting_input).type,(r=null)==(s=e.dir)&&(s=this.connecting_output?(void 0!==this.connecting_node.outputs_horizontal?this.connecting_node.outputs_horizontal:this.connecting_node.horizontal)?LiteGraph.DOWN:LiteGraph.RIGHT:(void 0!==this.connecting_node.inputs_horizontal?this.connecting_node.inputs_horizontal:this.connecting_node.horizontal)?LiteGraph.UP:LiteGraph.LEFT),e=e.shape,r=n===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,r,s,LiteGraph.CENTER),t.beginPath(),n===LiteGraph.EVENT||e===LiteGraph.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):e===LiteGraph.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),(o=this._highlight_input_slot.shape)===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()),this._highlight_output)&&(t.beginPath(),o===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),t.fill()),this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),i&&t.restore(),t.finish2D&&t.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(t){var e=this.graph,i=e._subgraph_node;i?(this.drawSubgraphPanelLeft(e,i,t),this.drawSubgraphPanelRight(e,i,t)):console.warn("subgraph without subnode")},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(t,e,i){var n=e.inputs?e.inputs.length:0,s=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(10,10,200,(n+1)*s+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left",i.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var o=50;if(i.font="14px Arial",e.inputs)for(var r=0;r<e.inputs.length;++r){var a,h,p=e.inputs[r];p.not_subgraph_input||(this.drawButton(20,o+2,180,s-2)&&(a=e.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(h=LiteGraph.createNode(a))?(t.add(h),this.block_click=!1,this.last_click_position=null,this.selectNodes([h]),this.node_dragged=h,this.dragging_canvas=!1,h.setProperty("name",p.name),h.setProperty("type",p.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",a)),i.fillStyle="#9C9",i.beginPath(),i.arc(184,o+.5*s,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(p.name,30,o+.75*s),i.fillStyle="#777",i.fillText(p.type,130,o+.75*s),o+=s)}this.drawButton(20,o+2,180,s-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)}},LGraphCanvas.prototype.drawSubgraphPanelRight=function(t,e,i){var n=e.outputs?e.outputs.length:0,s=this.bgcanvas.width,o=200,r=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT),n=(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(s-o-10,10,o,(n+1)*r+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left","Graph Outputs"),a=i.measureText(n).width;if(i.fillText(n,s-a-20,34),this.drawButton(s-o,20,20,20,"X","#151515"))this.closeSubgraph();else{var h=50;if(i.font="14px Arial",e.outputs)for(var p=0;p<e.outputs.length;++p){var l,u,c=e.outputs[p];c.not_subgraph_input||(this.drawButton(s-o,h+2,180,r-2)&&(l=e.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(u=LiteGraph.createNode(l))?(t.add(u),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",c.name),u.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",l)),i.fillStyle="#9C9",i.beginPath(),i.arc(s-o+16,h+.5*r,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(c.name,s-o+30,h+.75*r),i.fillStyle="#777",i.fillText(c.type,s-o+130,h+.75*r),h+=r)}this.drawButton(s-o,h+2,180,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)}},LGraphCanvas.prototype.drawButton=function(t,e,i,n,s,o,r,a){var h=this.ctx,p=(o=o||LiteGraph.NODE_DEFAULT_COLOR,r=r||"#555",a=a||LiteGraph.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),l=LiteGraph.isInsideRectangle(p[0],p[1],t,e,i,n),u=((p=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(u=this.canvas.getBoundingClientRect(),p[0]-=u.left,p[1]-=u.top),p&&LiteGraph.isInsideRectangle(p[0],p[1],t,e,i,n)),p=(h.fillStyle=l?r:o,u&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(t,e,i,n,[4]),h.fill(),null!=s&&s.constructor==String&&(h.fillStyle=a,h.textAlign="center",h.font=(.65*n|0)+"px Arial",h.fillText(s,t+.5*i,e+.75*n),h.textAlign="left"),u&&!this.block_click);return u&&this.blockClick(),p},LGraphCanvas.prototype.isAreaClicked=function(t,e,i,n,s){var o=this.mouse,o=(LiteGraph.isInsideRectangle(o[0],o[1],t,e,i,n),(o=this.last_click_position)&&LiteGraph.isInsideRectangle(o[0],o[1],t,e,i,n)),t=o&&!this.block_click;return o&&s&&this.blockClick(),t},LGraphCanvas.prototype.renderInfo=function(t,e,i){e=e||10,i=i||this.canvas.height-80,t.save(),t.translate(e,i),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var t=this.bgcanvas,e=(t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),i=(e.start&&e.start(),this.viewport||[0,0,e.canvas.width,e.canvas.height]);if(this.clear_background&&e.clearRect(i[0],i[1],i[2],i[3]),this._graph_stack&&this._graph_stack.length){e.save();this._graph_stack[this._graph_stack.length-1];for(var i=this.graph._subgraph_node,n=(e.strokeStyle=i.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=i.bgcolor||"#AAA",""),s=1;s<this._graph_stack.length;++s)n+=this._graph_stack[s]._subgraph_node.getTitle()+" >> ";e.fillText(n+i.getTitle(),.5*t.width,40),e.restore()}var o,i=!1;this.onRenderBackground&&(i=this.onRenderBackground(t,e)),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(e.save(),this.ds.toCanvasContext(e),this.ds.scale<1.5&&!i&&this.clear_background_color&&(e.fillStyle=this.clear_background_color,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!i&&(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(o=this)._bg_img.onload=function(){o.draw(!0,!0)}),(i=null)==this._pattern&&0<this._bg_img.width?(i=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=i):i=this._pattern,i&&(e.fillStyle=i,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()),e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},new Float32Array(2)),tmp_area=(LGraphCanvas.prototype.drawNode=function(t,e){var i=(this.current_node=t).color||t.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,n=t.bgcolor||t.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,s=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else{var o=this.editor_alpha;if(e.globalAlpha=o,this.render_shadows&&!s?(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var r,a=t._shape||LiteGraph.BOX_SHAPE,h=temp_vec2,p=(temp_vec2.set(t.size),t.horizontal),l=void 0!==t.inputs_horizontal?t.inputs_horizontal:p,u=void 0!==t.outputs_horizontal?t.outputs_horizontal:p,c=(t.flags.collapsed&&(e.font=this.inner_text_font,null!=(r=t.getTitle?t.getTitle():t.title))&&(t._collapsed_width=Math.min(t.size[0],e.measureText(r).width+2*LiteGraph.NODE_TITLE_HEIGHT),h[0]=t._collapsed_width,h[1]=0),t.clip_area&&(e.save(),e.beginPath(),a==LiteGraph.BOX_SHAPE?e.rect(0,0,h[0],h[1]):a==LiteGraph.ROUND_SHAPE?e.roundRect(0,0,h[0],h[1],[10]):a==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*h[0],.5*h[1],.5*h[0],0,2*Math.PI),e.clip()),this.drawNodeShape(t,e,h,i,n=t.has_errors?"red":n,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=l?"center":"left",e.font=this.inner_text_font,!s),d=this.connecting_output,g=this.connecting_input,_=(e.lineWidth=1,0),f=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var v,y,b=null,m=null;if(t.inputs)for(L=0;L<t.inputs.length;L++){C=t.inputs[L];if(null!=C.link){b=C;break}}if(t.outputs)for(L=0;L<t.outputs.length;L++)(C=t.outputs[L]).links&&C.links.length&&(m=C);b&&(y=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void(v=0)!==t.inputs_horizontal?t.inputs_horizontal:p)&&(v=.5*t._collapsed_width,y=-LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),C.type===LiteGraph.EVENT||C.shape===LiteGraph.BOX_SHAPE?e.rect(v-7+.5,y-4,14,8):C.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(v+8,y),e.lineTo(v+-4,y-4),e.lineTo(v+-4,y+4),e.closePath()):e.arc(v,y,4,0,2*Math.PI),e.fill()),m&&(v=t._collapsed_width,y=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void 0!==t.outputs_horizontal?t.outputs_horizontal:p)&&(v=.5*t._collapsed_width,y=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),C.type===LiteGraph.EVENT||C.shape===LiteGraph.BOX_SHAPE?e.rect(v-7+.5,y-4,14,8):C.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(v+6,y),e.lineTo(v-6,y-4),e.lineTo(v-6,y+4),e.closePath()):e.arc(v,y,4,0,2*Math.PI),e.fill())}}else{if(t.inputs)for(var L=0;L<t.inputs.length;L++){var G=(C=t.inputs[L]).type,T=C.shape;e.globalAlpha=o,this.connecting_output&&!LiteGraph.isValidConnection(C.type,d.type)&&(e.globalAlpha=.4*o),e.fillStyle=null!=C.link?C.color_on||this.default_connection_color_byType[G]||this.default_connection_color.input_on:C.color_off||this.default_connection_color_byTypeOff[G]||this.default_connection_color_byType[G]||this.default_connection_color.input_off;(w=t.getConnectionPos(!0,L,f))[0]-=t.pos[0],w[1]-=t.pos[1],_<w[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(_=w[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.beginPath(),"array"==G&&(T=LiteGraph.GRID_SHAPE);var O=!0;C.type===LiteGraph.EVENT||C.shape===LiteGraph.BOX_SHAPE?l?e.rect(w[0]-5+.5,w[1]-8+.5,10,14):e.rect(w[0]-6+.5,w[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(e.moveTo(w[0]+8,w[1]+.5),e.lineTo(w[0]-4,w[1]+6+.5),e.lineTo(w[0]-4,w[1]-6+.5),e.closePath()):T===LiteGraph.GRID_SHAPE?(e.rect(w[0]-4,w[1]-4,2,2),e.rect(w[0]-1,w[1]-4,2,2),e.rect(w[0]+2,w[1]-4,2,2),e.rect(w[0]-4,w[1]-1,2,2),e.rect(w[0]-1,w[1]-1,2,2),e.rect(w[0]+2,w[1]-1,2,2),e.rect(w[0]-4,w[1]+2,2,2),e.rect(w[0]-1,w[1]+2,2,2),e.rect(w[0]+2,w[1]+2,2,2),O=!1):s?e.rect(w[0]-4,w[1]-4,8,8):e.arc(w[0],w[1],4,0,2*Math.PI),e.fill(),c&&(E=null!=C.label?C.label:C.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||C.dir==LiteGraph.UP?e.fillText(E,w[0],w[1]-10):e.fillText(E,w[0]+10,w[1]+5))}if(e.textAlign=u?"center":"right",e.strokeStyle="black",t.outputs)for(var L=0;L<t.outputs.length;L++){var C,G=(C=t.outputs[L]).type,T=C.shape;this.connecting_input&&!LiteGraph.isValidConnection(G,g.type)&&(e.globalAlpha=.4*o);(w=t.getConnectionPos(!1,L,f))[0]-=t.pos[0],w[1]-=t.pos[1],_<w[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(_=w[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.fillStyle=C.links&&C.links.length?C.color_on||this.default_connection_color_byType[G]||this.default_connection_color.output_on:C.color_off||this.default_connection_color_byTypeOff[G]||this.default_connection_color_byType[G]||this.default_connection_color.output_off,e.beginPath(),"array"==G&&(T=LiteGraph.GRID_SHAPE);var w,E,O=!0;G===LiteGraph.EVENT||T===LiteGraph.BOX_SHAPE?u?e.rect(w[0]-5+.5,w[1]-8+.5,10,14):e.rect(w[0]-6+.5,w[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(e.moveTo(w[0]+8,w[1]+.5),e.lineTo(w[0]-4,w[1]+6+.5),e.lineTo(w[0]-4,w[1]-6+.5),e.closePath()):T===LiteGraph.GRID_SHAPE?(e.rect(w[0]-4,w[1]-4,2,2),e.rect(w[0]-1,w[1]-4,2,2),e.rect(w[0]+2,w[1]-4,2,2),e.rect(w[0]-4,w[1]-1,2,2),e.rect(w[0]-1,w[1]-1,2,2),e.rect(w[0]+2,w[1]-1,2,2),e.rect(w[0]-4,w[1]+2,2,2),e.rect(w[0]-1,w[1]+2,2,2),e.rect(w[0]+2,w[1]+2,2,2),O=!1):s?e.rect(w[0]-4,w[1]-4,8,8):e.arc(w[0],w[1],4,0,2*Math.PI),e.fill(),!s&&O&&e.stroke(),c&&(E=null!=C.label?C.label:C.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,u||C.dir==LiteGraph.DOWN?e.fillText(E,w[0],w[1]-8):e.fillText(E,w[0]-10,w[1]+5))}e.textAlign="left",e.globalAlpha=1,t.widgets&&(r=_,(l||u||t.widgets_up)&&(r=2),null!=t.widgets_start_y&&(r=t.widgets_start_y),this.drawNodeWidgets(t,r,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null))}t.clip_area&&e.restore(),e.globalAlpha=1}}},LGraphCanvas.prototype.drawLinkTooltip=function(t,e){var i,n=e._pos;t.fillStyle="black",t.beginPath(),t.arc(n[0],n[1],3,0,2*Math.PI),t.fill(),null==e.data||this.onDrawLinkTooltip&&1==this.onDrawLinkTooltip(t,e,this)||(i=null)!=(i=(e=e.data).constructor===Number?e.toFixed(2):e.constructor===String?'"'+e+'"':e.constructor===Boolean?String(e):e.toToolTip?e.toToolTip():"["+e.constructor.name+"]")&&(i=i.substr(0,30),t.font="14px Courier New",e=t.measureText(i).width+20,t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-.5*e,n[1]-15-24,e,24,[3]),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(i,n[0],n[1]-15-24*.3))},new Float32Array(4)),margin_area=(LGraphCanvas.prototype.drawNodeShape=function(t,e,i,n,s,o,r){e.strokeStyle=n,e.fillStyle=s;var a,s=LiteGraph.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,p=t._shape||t.constructor.shape||LiteGraph.ROUND_SHAPE,l=t.constructor.title_mode,u=!0,r=(l==LiteGraph.TRANSPARENT_TITLE||l==LiteGraph.NO_TITLE?u=!1:l==LiteGraph.AUTOHIDE_TITLE&&r&&(u=!0),tmp_area),c=(r[0]=0,r[1]=u?-s:0,r[2]=i[0]+1,r[3]=u?i[1]+s:i[1],e.globalAlpha);e.beginPath(),p==LiteGraph.BOX_SHAPE||h?e.fillRect(r[0],r[1],r[2],r[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE?e.roundRect(r[0],r[1],r[2],r[3],p==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):p==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),e.fill(),!t.flags.collapsed&&u&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,r[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),(u||l==LiteGraph.TRANSPARENT_TITLE)&&(t.onDrawTitleBar?t.onDrawTitleBar(e,s,i,this.ds.scale,n):l!=LiteGraph.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)&&(u=t.constructor.title_color||n,t.flags.collapsed&&(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients?((a=LGraphCanvas.gradients[u])||((a=LGraphCanvas.gradients[u]=e.createLinearGradient(0,0,400,0)).addColorStop(0,u),a.addColorStop(1,"#000")),e.fillStyle=a):e.fillStyle=u,e.beginPath(),p==LiteGraph.BOX_SHAPE||h?e.rect(0,-s,i[0]+1,s):p!=LiteGraph.ROUND_SHAPE&&p!=LiteGraph.CARD_SHAPE||e.roundRect(0,-s,i[0]+1,s,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"),a=!1,LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[t.mode]&&(a=LiteGraph.NODE_MODES_COLORS[t.mode]),LiteGraph.node_box_coloured_when_on&&(a=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":a),t.onDrawTitleBox?t.onDrawTitleBox(e,s,i,this.ds.scale):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CIRCLE_SHAPE||p==LiteGraph.CARD_SHAPE?(h&&(e.fillStyle="black",e.beginPath(),e.arc(.5*s,-.5*s,6,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||a||LiteGraph.NODE_DEFAULT_BOXCOLOR,h?e.fillRect(.5*s-5,-.5*s-5,10,10):(e.beginPath(),e.arc(.5*s,-.5*s,5,0,2*Math.PI),e.fill())):(h&&(e.fillStyle="black",e.fillRect(.5*(s-10)-1,-.5*(s+10)-1,12,12)),e.fillStyle=t.boxcolor||a||LiteGraph.NODE_DEFAULT_BOXCOLOR,e.fillRect(.5*(s-10),-.5*(s+10),10,10)),e.globalAlpha=c,t.onDrawTitleText&&t.onDrawTitleText(e,s,i,this.ds.scale,this.title_text_font,o),!h&&(e.font=this.title_text_font,u=String(t.getTitle()))&&(e.fillStyle=o?LiteGraph.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.measureText(u),e.fillText(u.substr(0,20),s,LiteGraph.NODE_TITLE_TEXT_Y-s),e.textAlign="left"):(e.textAlign="left",e.fillText(u,s,LiteGraph.NODE_TITLE_TEXT_Y-s))),t.flags.collapsed||!t.subgraph||t.skip_subgraph_button||(a=LiteGraph.NODE_TITLE_HEIGHT,c=t.size[0]-a,u=LiteGraph.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],2+c,2-a,a-4,a-4),e.fillStyle=u?"#888":"#555",p==LiteGraph.BOX_SHAPE||h?e.fillRect(2+c,2-a,a-4,a-4):(e.beginPath(),e.roundRect(2+c,2-a,a-4,a-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(c+.2*a,.6*-a),e.lineTo(c+.8*a,.6*-a),e.lineTo(c+.5*a,.3*-a),e.fill()),t.onDrawTitle)&&t.onDrawTitle(e),o&&(t.onBounding&&t.onBounding(r),l==LiteGraph.TRANSPARENT_TITLE&&(r[1]-=s,r[3]+=s),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),p==LiteGraph.BOX_SHAPE?e.rect(-6+r[0],-6+r[1],12+r[2],12+r[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+r[0],-6+r[1],12+r[2],12+r[3],[2*this.round_radius]):p==LiteGraph.CARD_SHAPE?e.roundRect(-6+r[0],-6+r[1],12+r[2],12+r[3],[2*this.round_radius,2,2*this.round_radius,2]):p==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),e.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=n,e.globalAlpha=1),0<t.execute_triggered&&t.execute_triggered--,0<t.action_triggered&&t.action_triggered--},new Float32Array(4)),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(t,e){for(var i in t)if(t[i]!=e[i])return!1;return!0}function distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function colorToString(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"}function isInsideRectangle(t,e,i,n,s,o){return i<t&&t<i+s&&n<e&&e<n+o}function growBounding(t,e,i){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),i<t[1]?t[1]=i:i>t[3]&&(t[3]=i)}function isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}function overlapBounding(t,e){var i=t[0]+t[2];return!(e[0]+e[2]<t[0]||t[1]>e[1]+e[3]||i<e[0]||t[1]+t[3]<e[1])}function hex2num(t){t=(t="#"==t.charAt(0)?t.slice(1):t).toUpperCase();for(var e,i,n="0123456789ABCDEF",s=new Array(3),o=0,r=0;r<6;r+=2)e=n.indexOf(t.charAt(r)),i=n.indexOf(t.charAt(r+1)),s[o]=16*e+i,o++;return s}function num2hex(t){for(var e,i,n="0123456789ABCDEF",s="#",o=0;o<3;o++)e=t[o]/16,i=t[o]%16,s+=n.charAt(e)+n.charAt(i);return s}function ContextMenu(t,i){i=i||{},this.options=i;var e=this,n=(i.parentMenu&&(i.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),i.parentMenu=null):(this.parentMenu=i.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),null),s=("MouseEvent"!==(n=i.event?i.event.constructor.name:n)&&"CustomEvent"!==n&&"PointerEvent"!==n&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+n+")"),i.event=null),document.createElement("div"));function o(t){var e=parseInt(s.style.top);return s.style.top=(e+t.deltaY*i.scroll_speed).toFixed()+"px",t.preventDefault(),!0}s.className="litegraph litecontextmenu litemenubar-panel",i.className&&(s.className+=" "+i.className),s.style.minWidth=100,s.style.minHeight=100,s.style.pointerEvents="none",setTimeout(function(){s.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(s,"up",function(t){return t.preventDefault(),!0},!0),s.addEventListener("contextmenu",function(t){return 2==t.button&&t.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(s,"down",function(t){if(2==t.button)return e.close(),t.preventDefault(),!0},!0),i.scroll_speed||(i.scroll_speed=.1),s.addEventListener("wheel",o,!0),s.addEventListener("mousewheel",o,!0),this.root=s,i.title&&((n=document.createElement("div")).className="litemenu-title",n.innerHTML=i.title,s.appendChild(n));for(var r=0;r<t.length;r++){var a=t.constructor==Array?t[r]:r,h=(null!=a&&a.constructor!==String&&(a=void 0===a.content?String(a):a.content),t[r]);this.addItem(a,h,i),0}LiteGraph.pointerListenerAdd(s,"enter",function(t){s.closing_timer&&clearTimeout(s.closing_timer)});var p,l,n=document,n=(((n=(n=i.event?i.event.target.ownerDocument:n)||document).fullscreenElement||n.body).appendChild(s),i.left||0),u=i.top||0;i.event&&(n=i.event.clientX-10,u=i.event.clientY-10,i.title&&(u-=20),i.parentMenu&&(n=(p=i.parentMenu.root.getBoundingClientRect()).left+p.width),p=document.body.getBoundingClientRect(),l=s.getBoundingClientRect(),0==p.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),p.width&&n>p.width-l.width-10&&(n=p.width-l.width-10),p.height)&&u>p.height-l.height-10&&(u=p.height-l.height-10),s.style.left=n+"px",s.style.top=u+"px",i.scale&&(s.style.transform="scale("+i.scale+")")}function CurveEditor(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}function clamp(t,e,i){return t<e?e:i<t?i:t}LGraphCanvas.prototype.drawConnections=function(t){for(var e=LiteGraph.getTime(),i=this.visible_area,n=(margin_area[0]=i[0]-20,margin_area[1]=i[1]-20,margin_area[2]=i[2]+40,margin_area[3]=i[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha,this.graph._nodes),s=0,o=n.length;s<o;++s){var r=n[s];if(r.inputs&&r.inputs.length)for(var a=0;a<r.inputs.length;++a){var h,p,l,u,c,d,g=r.inputs[a];g&&null!=g.link&&(g=g.link,g=this.graph.links[g])&&null!=(u=this.graph.getNodeById(g.origin_id))&&(h=null,h=-1==(l=g.origin_slot)?[u.pos[0]+10,u.pos[1]+10]:u.getConnectionPos(!1,l,tempA),p=r.getConnectionPos(!0,a,tempB),link_bounding[0]=h[0],link_bounding[1]=h[1],link_bounding[2]=p[0]-h[0],link_bounding[3]=p[1]-h[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area))&&(l=u.outputs[l],c=r.inputs[a],l)&&c&&(l=l.dir||(void 0!==u.outputs_horizontal?u.outputs_horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:u.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),u=c.dir||(void 0!==r.inputs_horizontal?r.inputs_horizontal?LiteGraph.UP:LiteGraph.LEFT:r.horizontal?LiteGraph.UP:LiteGraph.LEFT),this.renderLink(t,h,p,g,!1,0,null,l,u),g)&&g._last_time&&e-g._last_time<1e3&&(c=2-.002*(e-g._last_time),d=t.globalAlpha,t.globalAlpha=d*c,this.renderLink(t,h,p,g,!0,c,"white",l,u),t.globalAlpha=d)}}t.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(t,e,i,n,s,o,r,a,h,p){n&&this.visible_links.push(n),r=(r=!r&&n?n.color||LGraphCanvas.link_type_colors[n.type]:r)||this.default_link_color,null!=n&&this.highlighted_links[n.id]&&(r="#FFF"),a=a||LiteGraph.RIGHT,h=h||LiteGraph.LEFT;var l=distance(e,i),u=!1,c=Math.abs(e[0]-i[0]),d=Math.abs(e[1]-i[1]);this.links_render_mode==LiteGraph.SPLINE_LINK&&(a==LiteGraph.RIGHT&&h==LiteGraph.LEFT||a==LiteGraph.LEFT&&h==LiteGraph.RIGHT?c<50&&20<d&&(u=!0):(a==LiteGraph.DOWN&&h==LiteGraph.UP||a==LiteGraph.UP&&h==LiteGraph.DOWN)&&d<50&&20<c&&(u=!0)),this.render_connections_border&&.6<this.ds.scale&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",1<(p=p||1)&&(t.lineWidth=.5),t.beginPath();for(var g=0;g<p;g+=1){var _=5*(g-.5*(p-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK)if(t.moveTo(e[0],e[1]+_),u){var f=e[0],v=e[1]+_,y=i[0],b=i[1]+_;a==LiteGraph.RIGHT?f+=10:a==LiteGraph.LEFT?f-=10:a==LiteGraph.DOWN?v+=10:a==LiteGraph.UP&&(v-=10),h==LiteGraph.LEFT?y-=10:h==LiteGraph.RIGHT?y+=10:h==LiteGraph.UP?b-=10:h==LiteGraph.DOWN&&(b+=10),t.lineTo(f,v),t.lineTo(.5*(f+y),v),t.lineTo(.5*(f+y),b),t.lineTo(y,b),t.lineTo(i[0],i[1]+_)}else{var m=0,L=0,G=0,T=0;switch(a){case LiteGraph.LEFT:m=-.25*l;break;case LiteGraph.RIGHT:m=.25*l;break;case LiteGraph.UP:L=-.25*l;break;case LiteGraph.DOWN:L=.25*l}switch(h){case LiteGraph.LEFT:G=-.25*l;break;case LiteGraph.RIGHT:G=.25*l;break;case LiteGraph.UP:T=-.25*l;break;case LiteGraph.DOWN:T=.25*l}t.bezierCurveTo(e[0]+m,e[1]+L+_,i[0]+G,i[1]+T+_,i[0],i[1]+_)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){t.moveTo(e[0],e[1]+_);m=0,L=0,G=0,T=0;switch(a){case LiteGraph.LEFT:m=-1;break;case LiteGraph.RIGHT:m=1;break;case LiteGraph.UP:L=-1;break;case LiteGraph.DOWN:L=1}switch(h){case LiteGraph.LEFT:G=-1;break;case LiteGraph.RIGHT:G=1;break;case LiteGraph.UP:T=-1;break;case LiteGraph.DOWN:T=1}t.lineTo(e[0]+15*m,e[1]+15*L+_),t.lineTo(i[0]+15*G,i[1]+15*T+_),t.lineTo(i[0],i[1]+_)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);f=e[0],v=e[1],y=i[0],b=i[1];a==LiteGraph.RIGHT?f+=10:v+=10,h==LiteGraph.LEFT?y-=10:b-=10,t.lineTo(f,v),t.lineTo(.5*(f+y),v),t.lineTo(.5*(f+y),b),t.lineTo(y,b),t.lineTo(i[0],i[1])}}this.render_connections_border&&.6<this.ds.scale&&!s&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=r,t.stroke();var O,C,w=this.computeConnectionPoint(e,i,.5,a,h);if(n&&n._pos&&(n._pos[0]=w[0],n._pos[1]=w[1]),.6<=this.ds.scale&&this.highquality_render&&h!=LiteGraph.CENTER&&(this.render_connection_arrows&&(d=this.computeConnectionPoint(e,i,.25,a,h),c=this.computeConnectionPoint(e,i,.26,a,h),s=this.computeConnectionPoint(e,i,.75,a,h),n=this.computeConnectionPoint(e,i,.76,a,h),C=O=0,C=this.render_curved_connections?(O=-Math.atan2(c[0]-d[0],c[1]-d[1]),-Math.atan2(n[0]-s[0],n[1]-s[1])):O=i[1]>e[1]?0:Math.PI,t.save(),t.translate(d[0],d[1]),t.rotate(O),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(s[0],s[1]),t.rotate(C),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()),t.beginPath(),t.arc(w[0],w[1],5,0,2*Math.PI),t.fill()),o){t.fillStyle=r;for(g=0;g<5;++g){var E=(.001*LiteGraph.getTime()+.2*g)%1,w=this.computeConnectionPoint(e,i,E,a,h);t.beginPath(),t.arc(w[0],w[1],5,0,2*Math.PI),t.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(t,e,i,n,s){n=n||LiteGraph.RIGHT,s=s||LiteGraph.LEFT;var o=distance(t,e),r=t,a=[t[0],t[1]],h=[e[0],e[1]],t=e;switch(n){case LiteGraph.LEFT:a[0]+=-.25*o;break;case LiteGraph.RIGHT:a[0]+=.25*o;break;case LiteGraph.UP:a[1]+=-.25*o;break;case LiteGraph.DOWN:a[1]+=.25*o}switch(s){case LiteGraph.LEFT:h[0]+=-.25*o;break;case LiteGraph.RIGHT:h[0]+=.25*o;break;case LiteGraph.UP:h[1]+=-.25*o;break;case LiteGraph.DOWN:h[1]+=.25*o}e=(1-i)*(1-i)*(1-i),n=(1-i)*(1-i)*3*i,s=3*(1-i)*(i*i),i*=i*i;return[e*r[0]+n*a[0]+s*h[0]+i*t[0],e*r[1]+n*a[1]+s*h[1]+i*t[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,i=0;i<e.length;++i){var n=e[i];t.fillStyle="black",t.fillRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==n.order&&t.strokeRect(n.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(n.order,n.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,n.pos[1]-6)}t.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(t,e,i,n){if(!t.widgets||!t.widgets.length)return 0;for(var s=t.size[0],o=t.widgets,r=(e+=2,LiteGraph.NODE_WIDGET_HEIGHT),a=.5<this.ds.scale,h=(i.save(),i.globalAlpha=this.editor_alpha,LiteGraph.WIDGET_OUTLINE_COLOR),p=LiteGraph.WIDGET_BGCOLOR,l=LiteGraph.WIDGET_TEXT_COLOR,u=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,c=0;c<o.length;++c){var d,g=o[c],_=e,f=(g.y&&(_=g.y),g.last_y=_,i.strokeStyle=h,i.fillStyle="#222",i.textAlign="left",g.disabled&&(i.globalAlpha*=.5),g.width||s);switch(g.type){case"button":g.clicked&&(i.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),i.fillRect(15,_,f-30,r),a&&!g.disabled&&i.strokeRect(15,_,f-30,r),a&&(i.textAlign="center",i.fillStyle=l,i.fillText(g.label||g.name,.5*f,_+.7*r));break;case"toggle":i.textAlign="left",i.strokeStyle=h,i.fillStyle=p,i.beginPath(),a?i.roundRect(15,_,f-30,r,[.5*r]):i.rect(15,_,f-30,r),i.fill(),a&&!g.disabled&&i.stroke(),i.fillStyle=g.value?"#89A":"#333",i.beginPath(),i.arc(f-30,_+.5*r,.36*r,0,2*Math.PI),i.fill(),a&&(i.fillStyle=u,null!=(v=g.label||g.name)&&i.fillText(v,30,_+.7*r),i.fillStyle=g.value?l:u,i.textAlign="right",i.fillText(g.value?g.options.on||"true":g.options.off||"false",f-40,_+.7*r));break;case"slider":i.fillStyle=p,i.fillRect(15,_,f-30,r);var v=g.options.max-g.options.min,y=(g.value-g.options.min)/v;1<(y=y<0?0:y)&&(y=1),i.fillStyle=g.options.hasOwnProperty("slider_color")?g.options.slider_color:n==g?"#89A":"#678",i.fillRect(15,_,y*(f-30),r),a&&!g.disabled&&i.strokeRect(15,_,f-30,r),g.marker&&(1<(y=(y=(g.marker-g.options.min)/v)<0?0:y)&&(y=1),i.fillStyle=g.options.hasOwnProperty("marker_color")?g.options.marker_color:"#AA9",i.fillRect(15+y*(f-30),_,2,r)),a&&(i.textAlign="center",i.fillStyle=l,i.fillText(g.label||g.name+"  "+Number(g.value).toFixed(null!=g.options.precision?g.options.precision:3),.5*f,_+.7*r));break;case"number":case"combo":i.textAlign="left",i.strokeStyle=h,i.fillStyle=p,i.beginPath(),a?i.roundRect(15,_,f-30,r,[.5*r]):i.rect(15,_,f-30,r),i.fill(),a&&(g.disabled||i.stroke(),i.fillStyle=l,g.disabled||(i.beginPath(),i.moveTo(31,_+5),i.lineTo(21,_+.5*r),i.lineTo(31,_+r-5),i.fill(),i.beginPath(),i.moveTo(f-15-16,_+5),i.lineTo(f-15-6,_+.5*r),i.lineTo(f-15-16,_+r-5),i.fill()),i.fillStyle=u,i.fillText(g.label||g.name,35,_+.7*r),i.fillStyle=l,i.textAlign="right","number"==g.type?i.fillText(Number(g.value).toFixed(void 0!==g.options.precision?g.options.precision:3),f-30-20,_+.7*r):(y=g.value,g.options.values&&(d=(d=g.options.values).constructor===Function?d():d)&&d.constructor!==Array&&(y=d[g.value]),i.fillText(y,f-30-20,_+.7*r)));break;case"string":case"text":i.textAlign="left",i.strokeStyle=h,i.fillStyle=p,i.beginPath(),a?i.roundRect(15,_,f-30,r,[.5*r]):i.rect(15,_,f-30,r),i.fill(),a&&(g.disabled||i.stroke(),i.save(),i.beginPath(),i.rect(15,_,f-30,r),i.clip(),i.fillStyle=u,null!=(d=g.label||g.name)&&i.fillText(d,30,_+.7*r),i.fillStyle=l,i.textAlign="right",i.fillText(String(g.value).substr(0,30),f-30,_+.7*r),i.restore());break;default:g.draw&&g.draw(i,t,f,_,r)}e+=(g.computeSize?g.computeSize(f)[1]:r)+4,i.globalAlpha=this.editor_alpha}i.restore(),i.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction))for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0);break;case"number":case"combo":var old_value=w.value,values,values_list,delta,index,text_values,menu,delta;function inner_clicked(t,e,i){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),!(that.dirty_canvas=!0)}event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type?(deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):event.type==LiteGraph.pointerevents_method+"down"?(values=w.options.values,values&&values.constructor===Function&&(values=w.options.values(w,node)),values_list=null,"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values)),delta=x<40?-1:widget_width-40<x?1:0,"number"==w.type?(w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):delta?(index=-1,this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index):(text_values=values!=values_list?Object.values(values):values,menu=new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window))):event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type&&(delta=x<40?-1:widget_width-40<x?1:0,event.click_time<200)&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}.bind(w),event),old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,function(t){inner_value_change(this,t)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}return null;function inner_value_change(t,e){"number"==t.type&&(e=Number(e)),t.value=e,t.options&&t.options.property&&void 0!==node.properties[t.options.property]&&node.setProperty(t.options.property,e),t.callback&&t.callback(t.value,that,node,pos,event)}},LGraphCanvas.prototype.drawGroups=function(t,e){if(this.graph){var i=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var n=0;n<i.length;++n){var s,o,r=i[n];overlapBounding(this.visible_area,r._bounding)&&(e.fillStyle=r.color||"#335",e.strokeStyle=r.color||"#335",s=r._pos,o=r._size,e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(s[0]+.5,s[1]+.5,o[0],o[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(s[0]+o[0],s[1]+o[1]),e.lineTo(s[0]+o[0]-10,s[1]+o[1]),e.lineTo(s[0]+o[0],s[1]+o[1]-10),e.fill(),o=r.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,e.font=o+"px Arial",e.textAlign="left",e.fillText(r.title,s[0]+4,s[1]+o))}e.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(t,e){var i;t||e||(t=(i=this.canvas.parentNode).offsetWidth,e=i.offsetHeight),this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(t){var e,i,n;t?(i=(e=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),n=setInterval(function(){e.editor_alpha*=i,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,i<1&&e.editor_alpha<.01&&(clearInterval(n),i<1)&&(e.live_mode=!0),1<i&&.99<e.editor_alpha&&(clearInterval(n),e.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.onNodeSelectionChange=function(t){},LGraphCanvas.onGroupAdd=function(t,e,i){var n=LGraphCanvas.active_canvas,s=(n.getCanvasWindow(),new LiteGraph.LGraphGroup);s.pos=n.convertEventToCanvasOffset(i),n.graph.add(s)},LGraphCanvas.getBoundaryNodes=function(t){let e=null,i=null,n=null,s=null;for(var o in t){var o=t[o],[r,a]=o.pos,[h,p]=o.size;(null===e||a<e.pos[1])&&(e=o),(null===i||r+h>i.pos[0]+i.size[0])&&(i=o),(null===n||a+p>n.pos[1]+n.size[1])&&(n=o),(null===s||r<s.pos[0])&&(s=o)}return{top:e,right:i,bottom:n,left:s}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,i,n){if(e){var s,o,r=LGraphCanvas.active_canvas;let t=[];t=void 0===n?LGraphCanvas.getBoundaryNodes(e):{top:n,right:n,bottom:n,left:n};for([s,o]of Object.entries(r.selected_nodes))switch(i){case"right":o.pos[0]=t.right.pos[0]+t.right.size[0]-o.size[0];break;case"left":o.pos[0]=t.left.pos[0];break;case"top":o.pos[1]=t.top.pos[1];break;case"bottom":o.pos[1]=t.bottom.pos[1]+t.bottom.size[1]-o.size[1]}r.dirty_canvas=!0,r.dirty_bgcanvas=!0}},LGraphCanvas.onNodeAlign=function(t,e,i,n,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase(),s)},parentMenu:n})},LGraphCanvas.onGroupAlign=function(t,e,i,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase())},parentMenu:n})},LGraphCanvas.onMenuAdd=function(t,e,i,n,r){var a=LGraphCanvas.active_canvas,h=a.getCanvasWindow(),p=a.graph;if(p)return function s(n,t){var e=LiteGraph.getNodeTypesCategories(a.filter||p.filter).filter(function(t){return t.startsWith(n)}),o=[];e.map(function(t){var e,i;t&&(i=new RegExp("^("+n+")"),t=t.replace(i,"").split("/")[0],e=""===n?t+"/":n+t+"/",-1!=(i=t).indexOf("::")&&(i=i.split("::")[1]),-1===o.findIndex(function(t){return t.value===e}))&&o.push({value:e,content:i,has_submenu:!0,callback:function(t,e,i,n){s(t.value,n)}})}),LiteGraph.getNodeTypesInCategory(n.slice(0,-1),a.filter||p.filter).map(function(t){t.skip_list||o.push({value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,i,n){n=n.getFirstEvent(),a.graph.beforeChange(),(t=LiteGraph.createNode(t.value))&&(t.pos=a.convertEventToCanvasOffset(n),a.graph.add(t)),r&&r(t),a.graph.afterChange()}})}),new LiteGraph.ContextMenu(o,{event:i,parentMenu:t},h)}("",n),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(t,e,i,n,s){if(s){var o,r=this,a=LGraphCanvas.active_canvas.getCanvasWindow(),e=s.optional_inputs,h=[];if(e=s.onGetInputs?s.onGetInputs():e)for(var p=0;p<e.length;p++){var l,u=e[p];u?(l=u[0],l=(u[2]||(u[2]={}),u[2].label&&(l=u[2].label),u[2].removable=!0,{content:l,value:u}),u[1]==LiteGraph.ACTION&&(l.className="event"),h.push(l)):h.push(null)}if((h=s.onMenuNodeInputs&&(o=s.onMenuNodeInputs(h))?o:h).length)return new LiteGraph.ContextMenu(h,{event:i,callback:function(t,e,i){s&&(t.callback&&t.callback.call(r,s,t,e,i),t.value)&&(s.graph.beforeChange(),s.addInput(t.value[0],t.value[1],t.value[2]),s.onNodeInputAdd&&s.onNodeInputAdd(t.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange())},parentMenu:n,node:s},a),!1;console.log("no input entries")}},LGraphCanvas.showMenuNodeOptionalOutputs=function(t,e,i,a,h){if(h){var n,p=this,s=LGraphCanvas.active_canvas.getCanvasWindow(),e=h.optional_outputs,o=[];if(e=h.onGetOutputs?h.onGetOutputs():e)for(var r=0;r<e.length;r++){var l,u=e[r];u?h.flags&&h.flags.skip_repeated_outputs&&-1!=h.findOutputSlot(u[0])||(l=u[0],u[2]||(u[2]={}),u[2].label&&(l=u[2].label),u[2].removable=!0,l={content:l,value:u},u[1]==LiteGraph.EVENT&&(l.className="event"),o.push(l)):o.push(null)}if(this.onMenuNodeOutputs&&(o=this.onMenuNodeOutputs(o)),LiteGraph.do_add_triggers_slots&&-1==h.findOutputSlot("onExecuted")&&o.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),(o=h.onMenuNodeOutputs&&(n=h.onMenuNodeOutputs(o))?n:o).length)return new LiteGraph.ContextMenu(o,{event:i,callback:function t(e,i,n){if(!h)return;e.callback&&e.callback.call(p,h,e,i,n);if(!e.value)return;var s=e.value[1];{if(s&&(s.constructor===Object||s.constructor===Array)){var o,r=[];for(o in s)r.push({content:o,value:s[o]});return new LiteGraph.ContextMenu(r,{event:i,callback:t,parentMenu:a,node:h}),!1}h.graph.beforeChange(),h.addOutput(e.value[0],e.value[1],e.value[2]),h.onNodeOutputAdd&&h.onNodeOutputAdd(e.value),h.setDirtyCanvas(!0,!0),h.graph.afterChange()}},parentMenu:a,node:h},s),!1}},LGraphCanvas.onShowMenuNodeProperties=function(t,e,i,n,o){if(o&&o.properties){var s,r=LGraphCanvas.active_canvas,a=r.getCanvasWindow(),h=[];for(s in o.properties){"object"==typeof(t=void 0!==o.properties[s]?o.properties[s]:" ")&&(t=JSON.stringify(t));var p=o.getPropertyInfo(s);"enum"!=p.type&&"combo"!=p.type||(t=LGraphCanvas.getPropertyPrintableValue(t,p.values)),t=LGraphCanvas.decodeHTML(t),h.push({content:"<span class='property_name'>"+(p.label||s)+"</span><span class='property_value'>"+t+"</span>",value:s})}if(h.length)return new LiteGraph.ContextMenu(h,{event:i,callback:function(t,e,i,n){var s;o&&(s=this.getBoundingClientRect(),r.showEditPropertyValue(o,t.value,{position:[s.left,s.top]}))},parentMenu:n,allow_html:!0,node:o},a),!1}},LGraphCanvas.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},LGraphCanvas.onMenuResizeNode=function(t,e,i,n,s){if(s){var o=function(t){t.size=t.computeSize(),t.onResize&&t.onResize(t.size)},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)o(s);else for(var a in r.selected_nodes)o(r.selected_nodes[a]);s.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(n,t){var s=this,o=s.graph.getNodeById(n.origin_id),r=s.graph.getNodeById(n.target_id),a=!1,h=(o&&o.outputs&&o.outputs[n.origin_slot]&&(a=o.outputs[n.origin_slot].type),!1),p=(r&&r.outputs&&r.outputs[n.target_slot]&&(h=r.inputs[n.target_slot].type),new LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=n.data?n.data.constructor.name:null,callback:function(t,e,i){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,i,p,function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&o.connectByType(n.origin_slot,t,a)&&(t.connectByType(n.target_slot,r,h),t.pos[0]-=.5*t.size[0])});break;case"Delete":s.graph.removeLink(n.id)}}}));return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},e=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),i=e.nodeFrom&&null!==e.slotFrom,t=!i&&e.nodeTo&&null!==e.slotTo;if(i||t)if(e.nodeType){var n=i?e.nodeFrom:e.nodeTo,s=i?e.slotFrom:e.slotTo,o=!1;switch(typeof s){case"string":o=i?n.findOutputSlot(s,!1):n.findInputSlot(s,!1),s=(i?n.outputs:n.inputs)[s];break;case"object":o=i?n.findOutputSlot(s.name):n.findInputSlot(s.name);break;case"number":o=s,s=(i?n.outputs:n.inputs)[s];break;default:return console.warn("Cant get slot information "+s),!1}!1!==s&&!1!==o||console.warn("createDefaultNodeForSlot bad slotX "+s+" "+o);var r=s.type==LiteGraph.EVENT?"_event_":s.type,a=i?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(a&&a[r]){if(s.link,nodeNewType=!1,"object"==typeof a[r]||"array"==typeof a[r]){for(var h in a[r])if(e.nodeType==a[r][h]||"AUTO"==e.nodeType){nodeNewType=a[r][h];break}}else e.nodeType!=a[r]&&"AUTO"!=e.nodeType||(nodeNewType=a[r]);if(nodeNewType){var p=!1,l=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(p=nodeNewType).node),LiteGraph.createNode(nodeNewType));if(l){if(p){if(p.properties)for(var u in p.properties)l.addProperty(u,p.properties[u]);if(p.inputs)for(var u in l.inputs=[],p.inputs)l.addOutput(p.inputs[u][0],p.inputs[u][1]);if(p.outputs)for(var u in l.outputs=[],p.outputs)l.addOutput(p.outputs[u][0],p.outputs[u][1]);p.title&&(l.title=p.title),p.json&&l.configure(p.json)}return this.graph.add(l),l.pos=[e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*l.size[0]:0),e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*l.size[1]:0)],i?e.nodeFrom.connectByType(o,l,r):e.nodeTo.connectByTypeOutput(o,l,r),!0}console.log("failed creating "+nodeNewType)}}}else console.warn("No type to createDefaultNodeForSlot");else console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo);return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},n=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),s=this,o=n.nodeFrom&&n.slotFrom,t=!o&&n.nodeTo&&n.slotTo;if(o||t){var e=o?n.nodeFrom:n.nodeTo,r=o?n.slotFrom:n.slotTo,a=!1;switch(typeof r){case"string":a=o?e.findOutputSlot(r,!1):e.findInputSlot(r,!1),r=(o?e.outputs:e.inputs)[r];break;case"object":a=o?e.findOutputSlot(r.name):e.findInputSlot(r.name);break;case"number":a=r,r=(o?e.outputs:e.inputs)[r];break;default:return console.warn("Cant get slot information "+r),!1}var i=["Add Node",null],h=(s.allow_searchbox&&(i.push("Search"),i.push(null)),r.type==LiteGraph.EVENT?"_event_":r.type),p=o?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(p&&p[h])if("object"==typeof p[h]||"array"==typeof p[h])for(var l in p[h])i.push(p[h][l]);else i.push(p[h]);var u=new LiteGraph.ContextMenu(i,{event:n.e,title:(r&&""!=r.name?r.name+(h?" | ":""):"")+(r&&h?h:""),callback:function(t,e,i){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,i,u,function(t){o?n.nodeFrom.connectByType(a,t,h):n.nodeTo.connectByTypeOutput(a,t,h)});break;case"Search":o?s.showSearchBox(i,{node_from:n.nodeFrom,slot_from:r,type_filter_in:h}):s.showSearchBox(i,{node_to:n.nodeTo,slot_from:r,type_filter_out:h});break;default:s.createDefaultNodeForSlot(Object.assign(n,{position:[n.e.canvasX,n.e.canvasY],nodeType:t}))}}})}else console.warn("No data passed to showConnectionMenu");return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,i,n,s){var o=e.property||"title",r=s[o],a=document.createElement("div");a.is_modified=!1,a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.close=function(){a.parentNode&&a.parentNode.removeChild(a)};a.querySelector(".name").innerText=o;var h=a.querySelector(".value");h&&(h.value=r,h.addEventListener("blur",function(t){this.focus()}),h.addEventListener("keydown",function(t){if(a.is_modified=!0,27==t.keyCode)a.close();else if(13==t.keyCode)d();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}));var r=LGraphCanvas.active_canvas.canvas,p=r.getBoundingClientRect(),l=-20,u=-20;p&&(l-=p.left,u-=p.top),event?(a.style.left=event.clientX+l+"px",a.style.top=event.clientY+u+"px"):(a.style.left=.5*r.width+l+"px",a.style.top=.5*r.height+u+"px");a.querySelector("button").addEventListener("click",d),r.parentNode.appendChild(a),h&&h.focus();var c=null;function d(){var t;h&&(t=h.value,"Number"==e.type?t=Number(t):"Boolean"==e.type&&(t=Boolean(t)),s[o]=t,a.parentNode&&a.parentNode.removeChild(a),s.setDirtyCanvas(!0,!0))}a.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),a.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&c&&clearTimeout(c)})},LGraphCanvas.prototype.prompt=function(t,e,i,n,s){var o=this,r=(t=t||"",document.createElement("div"));r.is_modified=!1,r.className="graphdialog rounded",r.innerHTML=s?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",r.close=function(){o.prompt_box=null,r.parentNode&&r.parentNode.removeChild(r)};var s=LGraphCanvas.active_canvas.canvas,a=(s.parentNode.appendChild(r),1<this.ds.scale&&(r.style.transform="scale("+this.ds.scale+")"),null),h=!1,p=(LiteGraph.pointerListenerAdd(r,"leave",function(t){h||LiteGraph.dialog_close_on_mouse_leave&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(a=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(r,"enter",function(t){LiteGraph.dialog_close_on_mouse_leave&&a&&clearTimeout(a)}),r.querySelectorAll("select")),p=(p&&p.forEach(function(t){t.addEventListener("click",function(t){h++}),t.addEventListener("blur",function(t){h=0}),t.addEventListener("change",function(t){h=-1})}),o.prompt_box&&o.prompt_box.close(),(o.prompt_box=r).querySelector(".name").innerText=t,r.querySelector(".value")),l=(p.value=e,p);l.addEventListener("keydown",function(t){if(r.is_modified=!0,27!=t.keyCode){if(13!=t.keyCode||"textarea"==t.target.localName)return;i&&i(this.value)}r.close(),t.preventDefault(),t.stopPropagation()});r.querySelector("button").addEventListener("click",function(t){i&&i(l.value),o.setDirty(!0),r.close()});t=s.getBoundingClientRect(),e=-20,p=-20;return t&&(e-=t.left,p-=t.top),n?(r.style.left=n.clientX+e+"px",r.style.top=n.clientY+p+"px"):(r.style.left=.5*s.width+e+"px",r.style.top=.5*s.height+p+"px"),setTimeout(function(){l.focus()},10),r},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(o,c){var t,e,i,n,s={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},d=(c=Object.assign(s,c||{}),this),g=LGraphCanvas.active_canvas,r=g.canvas,a=r.ownerDocument||document,h=document.createElement("div"),_=(h.className="litegraph litesearchbox graphdialog rounded",h.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",c.do_type_filter&&(h.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",h.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),h.innerHTML+="<div class='helper'></div>",a.fullscreenElement?a.fullscreenElement.appendChild(h):(a.body.appendChild(h),a.body.style.overflow="hidden"),c.do_type_filter&&(t=h.querySelector(".slot_in_type_filter"),e=h.querySelector(".slot_out_type_filter")),h.close=function(){d.search_box=null,this.blur(),r.focus(),a.body.style.overflow="",setTimeout(function(){d.canvas.focus()},20),h.parentNode&&h.parentNode.removeChild(h)},1<this.ds.scale&&(h.style.transform="scale("+this.ds.scale+")"),c.hide_on_mouse_leave&&(i=!1,n=null,LiteGraph.pointerListenerAdd(h,"enter",function(t){n&&(clearTimeout(n),n=null)}),LiteGraph.pointerListenerAdd(h,"leave",function(t){i||(n=setTimeout(function(){h.close()},500))}),c.do_type_filter)&&(t.addEventListener("click",function(t){i++}),t.addEventListener("blur",function(t){i=0}),t.addEventListener("change",function(t){i=-1}),e.addEventListener("click",function(t){i++}),e.addEventListener("blur",function(t){i=0}),e.addEventListener("change",function(t){i=-1})),d.search_box&&d.search_box.close(),(d.search_box=h).querySelector(".helper")),f=null,v=null,p=null,y=h.querySelector("input");if(y&&(y.addEventListener("blur",function(t){d.search_box&&this.focus()}),y.addEventListener("keydown",function(t){if(38==t.keyCode)O(!1);else if(40==t.keyCode)O(!0);else if(27==t.keyCode)h.close();else{if(13!=t.keyCode)return v&&clearInterval(v),void(v=setTimeout(C,250));C(),p?T(p.innerHTML):f?T(f):h.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0})),c.do_type_filter){if(t){var l=(b=LiteGraph.slot_types_in).length;c.type_filter_in!=LiteGraph.EVENT&&c.type_filter_in!=LiteGraph.ACTION||(c.type_filter_in="_event_");for(var u=0;u<l;u++)(m=document.createElement("option")).value=b[u],m.innerHTML=b[u],t.appendChild(m),!1!==c.type_filter_in&&(c.type_filter_in+"").toLowerCase()==(b[u]+"").toLowerCase()&&(m.selected=!0);t.addEventListener("change",function(){C()})}if(e){var b,l=(b=LiteGraph.slot_types_out).length;c.type_filter_out!=LiteGraph.EVENT&&c.type_filter_out!=LiteGraph.ACTION||(c.type_filter_out="_event_");for(var m,u=0;u<l;u++)(m=document.createElement("option")).value=b[u],m.innerHTML=b[u],e.appendChild(m),!1!==c.type_filter_out&&(c.type_filter_out+"").toLowerCase()==(b[u]+"").toLowerCase()&&(m.selected=!0);e.addEventListener("change",function(){C()})}}var s=r.getBoundingClientRect(),L=(o?o.clientX:s.left+.5*s.width)-80,G=(o?o.clientY:s.top+.5*s.height)-20;function T(t){if(t)if(d.onSearchBoxSelection)d.onSearchBoxSelection(t,o,g);else{var e=LiteGraph.searchbox_extras[t.toLowerCase()],i=(e&&(t=e.type),g.graph.beforeChange(),LiteGraph.createNode(t));if(i&&(i.pos=g.convertEventToCanvasOffset(o),g.graph.add(i,!1)),e&&e.data){if(e.data.properties)for(var n in e.data.properties)i.addProperty(n,e.data.properties[n]);if(e.data.inputs)for(var n in i.inputs=[],e.data.inputs)i.addOutput(e.data.inputs[n][0],e.data.inputs[n][1]);if(e.data.outputs)for(var n in i.outputs=[],e.data.outputs)i.addOutput(e.data.outputs[n][0],e.data.outputs[n][1]);e.data.title&&(i.title=e.data.title),e.data.json&&i.configure(e.data.json)}if(c.node_from){var s=!1;switch(typeof c.slot_from){case"string":s=c.node_from.findOutputSlot(c.slot_from);break;case"object":-1==(s=c.slot_from.name?c.node_from.findOutputSlot(c.slot_from.name):-1)&&void 0!==c.slot_from.slot_index&&(s=c.slot_from.slot_index);break;case"number":s=c.slot_from;break;default:s=0}void 0!==c.node_from.outputs[s]&&!1!==s&&-1<s&&c.node_from.connectByType(s,i,c.node_from.outputs[s].type)}if(c.node_to){s=!1;switch(typeof c.slot_from){case"string":s=c.node_to.findInputSlot(c.slot_from);break;case"object":-1==(s=c.slot_from.name?c.node_to.findInputSlot(c.slot_from.name):-1)&&void 0!==c.slot_from.slot_index&&(s=c.slot_from.slot_index);break;case"number":s=c.slot_from;break;default:s=0}void 0!==c.node_to.inputs[s]&&!1!==s&&-1<s&&c.node_to.connectByTypeOutput(s,i,c.node_to.inputs[s].type)}g.graph.afterChange()}h.close()}function O(t){var e=p;p&&p.classList.remove("selected"),(p=p?(p=t?p.nextSibling:p.previousSibling)||e:t?_.childNodes[0]:_.childNodes[_.childNodes.length])&&(p.classList.add("selected"),p.scrollIntoView({block:"end",behavior:"smooth"}))}function C(){v=null;var s=y.value;if(f=null,_.innerHTML="",s||c.show_all_if_empty)if(d.onSearchBox){var t=d.onSearchBox(_,s,g);if(t)for(var e=0;e<t.length;++e)u(t[e])}else{var o,r,i=0,s=s.toLowerCase(),a=g.filter||g.graph.filter;for(e in r=c.do_type_filter&&d.search_box?(o=d.search_box.querySelector(".slot_in_type_filter"),d.search_box.querySelector(".slot_out_type_filter")):o=!1,LiteGraph.searchbox_extras){var n=LiteGraph.searchbox_extras[e];if(c.show_all_if_empty&&!s||-1!==n.desc.toLowerCase().indexOf(s)){var h=LiteGraph.registered_node_types[n.type];if((!h||h.filter==a)&&l(n.type)&&(u(n.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit)&&i++>LGraphCanvas.search_limit)break}}var p=null;if(Array.prototype.filter)p=Object.keys(LiteGraph.registered_node_types).filter(l);else for(var e in p=[],LiteGraph.registered_node_types)l(e)&&p.push(e);for(e=0;e<p.length&&(u(p[e]),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);if(c.show_general_after_typefiltered&&(o.value||r.value)){for(var e in filtered_extra=[],LiteGraph.registered_node_types)l(e,{inTypeOverride:!(!o||!o.value)&&"*",outTypeOverride:!(!r||!r.value)&&"*"})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(u(filtered_extra[e],"generic_type"),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);}if((o.value||r.value)&&0==_.childNodes.length&&c.show_general_if_none_on_typefilter){for(var e in filtered_extra=[],LiteGraph.registered_node_types)l(e,{skipFilter:!0})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(u(filtered_extra[e],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&i++>LGraphCanvas.search_limit));e++);}function l(t,e){var e=e||{},e=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},e),i=LiteGraph.registered_node_types[t];if(a&&i.filter!=a)return!1;if((!c.show_all_if_empty||s)&&-1===t.toLowerCase().indexOf(s))return!1;if(c.do_type_filter&&!e.skipFilter){i=t,t=o.value;if(!1!==e.inTypeOverride&&(t=e.inTypeOverride),o&&t&&LiteGraph.registered_slot_in_types[t]&&LiteGraph.registered_slot_in_types[t].nodes){var n=LiteGraph.registered_slot_in_types[t].nodes.includes(i);if(!1===n)return!1}t=r.value;if(!1!==e.outTypeOverride&&(t=e.outTypeOverride),r&&t&&LiteGraph.registered_slot_out_types[t]&&LiteGraph.registered_slot_out_types[t].nodes){n=LiteGraph.registered_slot_out_types[t].nodes.includes(i);if(!1===n)return!1}}return!0}}function u(t,e){var i=document.createElement("div");f=f||t,i.innerText=t,i.dataset.type=escape(t),i.className="litegraph lite-search-item",e&&(i.className+=" "+e),i.addEventListener("click",function(t){T(unescape(this.dataset.type))}),_.appendChild(i)}}return h.style.left=L+"px",h.style.top=G+"px",o.layerY>s.height-200&&(_.style.maxHeight=s.height-o.layerY-20+"px"),y.focus(),c.show_all_on_open&&C(),h},LGraphCanvas.prototype.showEditPropertyValue=function(e,i,n){if(e&&void 0!==e.properties[i]){n=n||{};var s=e.getPropertyInfo(i),o=s.type,t="";if("string"==o||"number"==o||"array"==o||"object"==o)t="<input autofocus type='text' class='value'/>";else if("enum"!=o&&"combo"!=o||!s.values){if("boolean"!=o&&"toggle"!=o)return void console.warn("unknown type: "+o);t="<input autofocus type='checkbox' class='value' "+(e.properties[i]?"checked":"")+"/>"}else{for(var r in t="<select autofocus type='text' class='value'>",s.values){var a=r;t+="<option value='"+(a=s.values.constructor===Array?s.values[r]:a)+"' "+(a==e.properties[i]?"selected":"")+">"+s.values[r]+"</option>"}t+="</select>"}var h=this.createDialog("<span class='name'>"+(s.label||i)+"</span>"+t+"<button>OK</button>",n),p=!1;return"enum"!=o&&"combo"!=o||!s.values?"boolean"==o||"toggle"==o?(p=h.querySelector("input"))&&p.addEventListener("click",function(t){h.modified(),u(!!p.checked)}):(p=h.querySelector("input"))&&(p.addEventListener("blur",function(t){this.focus()}),a=void 0!==e.properties[i]?e.properties[i]:"","string"!==o&&(a=JSON.stringify(a)),p.value=a,p.addEventListener("keydown",function(t){if(27==t.keyCode)h.close();else if(13==t.keyCode)l();else if(13!=t.keyCode)return void h.modified();t.preventDefault(),t.stopPropagation()})):(p=h.querySelector("select")).addEventListener("change",function(t){h.modified(),u(t.target.value)}),p&&p.focus(),h.querySelector("button").addEventListener("click",l),h}function l(){u(p.value)}function u(t){s&&s.values&&s.values.constructor===Object&&null!=s.values[t]&&(t=s.values[t]),"number"==typeof e.properties[i]&&(t=Number(t)),"array"!=o&&"object"!=o||(t=JSON.parse(t)),e.properties[i]=t,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(i,t),n.onclose&&n.onclose(),h.close(),e.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(t,e){e=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},e||{});var i=document.createElement("div"),t=(i.className="graphdialog",i.innerHTML=t,i.is_modified=!1,this.canvas.getBoundingClientRect()),n=-20,s=-20,o=(t&&(n-=t.left,s-=t.top),e.position?(n+=e.position[0],s+=e.position[1]):e.event?(n+=e.event.clientX,s+=e.event.clientY):(n+=.5*this.canvas.width,s+=.5*this.canvas.height),i.style.left=n+"px",i.style.top=s+"px",this.canvas.parentNode.appendChild(i),e.checkForInput&&(t=[],t=i.querySelectorAll("input"))&&t.forEach(function(t){t.addEventListener("keydown",function(t){if(i.modified(),27==t.keyCode)i.close();else if(13!=t.keyCode)return;t.preventDefault(),t.stopPropagation()}),t.focus()}),i.modified=function(){i.is_modified=!0},i.close=function(){i.parentNode&&i.parentNode.removeChild(i)},null),r=!1,n=(i.addEventListener("mouseleave",function(t){r||(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!i.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(o=setTimeout(i.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),i.addEventListener("mouseenter",function(t){(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&o&&clearTimeout(o)}),i.querySelectorAll("select"));return n&&n.forEach(function(t){t.addEventListener("click",function(t){r++}),t.addEventListener("blur",function(t){r=0}),t.addEventListener("change",function(t){r=-1})}),i},LGraphCanvas.prototype.createPanel=function(t,e){var p=(e=e||{}).window||window,l=document.createElement("div");return l.className="litegraph dialog",l.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",l.header=l.querySelector(".dialog-header"),e.width&&(l.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(l.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable&&((e=document.createElement("span")).innerHTML="&#10005;",e.classList.add("close"),e.addEventListener("click",function(){l.close()}),l.header.appendChild(e)),l.title_element=l.querySelector(".dialog-title"),l.title_element.innerText=t,l.content=l.querySelector(".dialog-content"),l.alt_content=l.querySelector(".dialog-alt-content"),l.footer=l.querySelector(".dialog-footer"),l.close=function(){l.onClose&&"function"==typeof l.onClose&&l.onClose(),l.parentNode&&l.parentNode.removeChild(l),this.parentNode&&this.parentNode.removeChild(this)},l.toggleAltContent=function(t){var e;t=void 0!==t?(e=t?"block":"none",t?"none":"block"):(e="block"!=l.alt_content.style.display?"block":"none","block"!=l.alt_content.style.display?"none":"block"),l.alt_content.style.display=e,l.content.style.display=t},l.toggleFooterVisibility=function(t){t=void 0!==t?t?"block":"none":"block"!=l.footer.style.display?"block":"none",l.footer.style.display=t},l.clear=function(){this.content.innerHTML=""},l.addHTML=function(t,e,i){var n=document.createElement("div");return e&&(n.className=e),n.innerHTML=t,(i?l.footer:l.content).appendChild(n),n},l.addButton=function(t,e,i){var n=document.createElement("button");return n.innerText=t,n.options=i,n.classList.add("btn"),n.addEventListener("click",e),l.footer.appendChild(n),n},l.addSeparator=function(){var t=document.createElement("div");t.className="separator",l.content.appendChild(t)},l.addWidget=function(e,t,i,o,n){o=o||{};var s=String(i),r=("number"==(e=e.toLowerCase())&&(s=i.toFixed(3)),document.createElement("div")),a=(r.className="property",r.innerHTML="<span class='property_name'></span><span class='property_value'></span>",r.querySelector(".property_name").innerText=o.label||t,r.querySelector(".property_value"));function h(t,e){o.callback&&o.callback(t,e,o),n&&n(t,e,o)}return a.innerText=s,r.dataset.property=t,r.dataset.type=o.type||e,r.options=o,r.value=i,"code"==e?r.addEventListener("click",function(t){l.inner_showCodePad(this.dataset.property)}):"boolean"==e?(r.classList.add("boolean"),i&&r.classList.add("bool-on"),r.addEventListener("click",function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",h(t,this.value)})):"string"==e||"number"==e?(a.setAttribute("contenteditable",!0),a.addEventListener("keydown",function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())}),a.addEventListener("blur",function(){var t=this.innerText;h(this.parentNode.dataset.property,t="number"==this.parentNode.dataset.type?Number(t):t)})):"enum"!=e&&"combo"!=e||(s=LGraphCanvas.getPropertyPrintableValue(i,o.values),a.innerText=s,a.addEventListener("click",function(t){var e=o.values||[],n=this.parentNode.dataset.property,s=this;new LiteGraph.ContextMenu(e,{event:t,className:"dark",callback:function(t,e,i){return s.innerText=t,h(n,t),!1}},p)})),l.content.appendChild(r),r},l.onOpen&&"function"==typeof l.onOpen&&l.onOpen(),l},LGraphCanvas.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var i,n="";for(i in e)if(e[i]==t){n=i;break}return String(t)+" ("+n+")"}},LGraphCanvas.prototype.closePanels=function(){var t=document.querySelector("#node-panel");t&&t.close(),(t=document.querySelector("#option-panel"))&&t.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(t,e,i,n){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!(e&&e.event&&e.event.target&&e.event.target.lgraphcanvas))return void console.warn("Canvas not found");var s=e.event.target.lgraphcanvas}else s=this;s.closePanels();e=s.getCanvasWindow();function o(t,e,i){i&&i.key&&(t=i.key),i.values&&(e=Object.values(i.values).indexOf(e)),s[t]=e}panel=s.createPanel("Options",{closable:!0,window:e,onOpen:function(){s.OPTIONPANEL_IS_OPEN=!0},onClose:function(){s.OPTIONPANEL_IS_OPEN=!1,s.options_panel=null}}),(s.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var r,a=LiteGraph.availableCanvasOptions;for(r in a.sort(),a){var h=a[r];panel.addWidget("boolean",h,s[h],{key:h,on:"True",off:"False"},o)}s.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[s.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},o),panel.addSeparator(),panel.footer.innerHTML="",s.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(o){this.SELECTED_NODE=o,this.closePanels();var t=this.getCanvasWindow(),r=this,a=this.createPanel(o.title||"",{closable:!0,window:t,onOpen:function(){r.NODEPANEL_IS_OPEN=!0},onClose:function(){r.NODEPANEL_IS_OPEN=!1,r.node_panel=null}});function s(){a.content.innerHTML="",a.addHTML("<span class='node_type'>"+o.type+"</span><span class='node_desc'>"+(o.constructor.desc||"")+"</span><span class='separator'></span>"),a.addHTML("<h3>Properties</h3>");function t(t,e){switch(r.graph.beforeChange(o),t){case"Title":o.title=e;break;case"Mode":var i=Object.values(LiteGraph.NODE_MODES).indexOf(e);0<=i&&LiteGraph.NODE_MODES[i]?o.changeMode(i):console.warn("unexpected mode: "+e);break;case"Color":LGraphCanvas.node_colors[e]?(o.color=LGraphCanvas.node_colors[e].color,o.bgcolor=LGraphCanvas.node_colors[e].bgcolor):console.warn("unexpected color: "+e);break;default:o.setProperty(t,e)}r.graph.afterChange(),r.dirty_canvas=!0}a.addWidget("string","Title",o.title,{},t),a.addWidget("combo","Mode",LiteGraph.NODE_MODES[o.mode],{values:LiteGraph.NODE_MODES},t);var e,i="";for(e in void 0!==o.color&&(i=Object.keys(LGraphCanvas.node_colors).filter(function(t){return LGraphCanvas.node_colors[t].color==o.color})),a.addWidget("combo","Color",i,{values:Object.keys(LGraphCanvas.node_colors)},t),o.properties){var n=o.properties[e],s=o.getPropertyInfo(e);s.type;o.onAddPropertyToPanel&&o.onAddPropertyToPanel(e,a)||a.addWidget(s.widget||s.type,e,n,s,t)}a.addSeparator(),o.onShowCustomPanelInfo&&o.onShowCustomPanelInfo(a),a.footer.innerHTML="",a.addButton("Delete",function(){o.block_delete||(o.graph.remove(o),a.close())}).classList.add("delete")}(r.node_panel=a).id="node-panel",a.node=o,a.classList.add("settings"),a.inner_showCodePad=function(e){a.classList.remove("settings"),a.classList.add("centered"),a.alt_content.innerHTML="<textarea class='code'></textarea>";function i(){a.toggleAltContent(!1),a.toggleFooterVisibility(!0),n.parentNode.removeChild(n),a.classList.add("settings"),a.classList.remove("centered"),s()}var n=a.alt_content.querySelector("textarea"),t=(n.value=o.properties[e],n.addEventListener("keydown",function(t){"Enter"==t.code&&t.ctrlKey&&(o.setProperty(e,n.value),i())}),a.toggleAltContent(!0),a.toggleFooterVisibility(!1),n.style.height="calc(100% - 40px)",a.addButton("Assign",function(){o.setProperty(e,n.value),i()})),t=(a.alt_content.appendChild(t),a.addButton("Close",i));t.style.float="right",a.alt_content.appendChild(t)},s(),this.canvas.parentNode.appendChild(a)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(s){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),n=(t&&t.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function o(){if(n.clear(),s.inputs)for(var t=0;t<s.inputs.length;++t){var e,i=s.inputs[t];i.not_subgraph_input||((e=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=i.name,e.dataset.slot=t,e.querySelector(".name").innerText=i.name,e.querySelector(".type").innerText=i.type,e.querySelector("button").addEventListener("click",function(t){s.removeInput(Number(this.parentNode.dataset.slot)),o()}))}}n.node=s,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(t){var e=this.parentNode,i=e.querySelector(".name").value,n=e.querySelector(".type").value;i&&-1==s.findInputSlot(i)&&(s.addInput(i,n),e.querySelector(".name").value="",e.querySelector(".type").value="",o())}),o(),this.canvas.parentNode.appendChild(n),n},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(n){var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),s=(t&&t.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function o(){if(s.clear(),n.outputs)for(var t=0;t<n.outputs.length;++t){var e,i=n.outputs[t];i.not_subgraph_output||((e=s.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=i.name,e.dataset.slot=t,e.querySelector(".name").innerText=i.name,e.querySelector(".type").innerText=i.type,e.querySelector("button").addEventListener("click",function(t){n.removeOutput(Number(this.parentNode.dataset.slot)),o()}))}}s.node=n,s.classList.add("subgraph_dialog");t=s.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function e(){var t=this.parentNode,e=t.querySelector(".name").value,i=t.querySelector(".type").value;e&&-1==n.findOutputSlot(e)&&(n.addOutput(e,i),t.querySelector(".name").value="",t.querySelector(".type").value="",o())}return t.querySelector(".name").addEventListener("keydown",function(t){13==t.keyCode&&e.apply(this)}),t.querySelector("button").addEventListener("click",function(t){e.apply(this)}),o(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var i=t[e];!i.node||i.node.graph&&i.graph==this.graph||i.close()}},LGraphCanvas.onMenuNodeCollapse=function(t,e,i,n,s){s.graph.beforeChange();function o(t){t.collapse()}var r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)o(s);else for(var a in r.selected_nodes)o(r.selected_nodes[a]);s.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(t,e,i,n,s){s.pin()},LGraphCanvas.onMenuNodeMode=function(t,e,i,n,o){return new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:i,callback:function(e){if(o){var i=Object.values(LiteGraph.NODE_MODES).indexOf(e),t=function(t){0<=i&&LiteGraph.NODE_MODES[i]?t.changeMode(i):(console.warn("unexpected mode: "+e),t.changeMode(LiteGraph.ALWAYS))},n=LGraphCanvas.active_canvas;if(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)t(o);else for(var s in n.selected_nodes)t(n.selected_nodes[s])}},parentMenu:n,node:o}),!1},LGraphCanvas.onMenuNodeColors=function(t,e,i,n,o){if(!o)throw"no node for color";var s,r=[];for(s in r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var a=LGraphCanvas.node_colors[s],t={value:s,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+a.color+"; background-color:"+a.bgcolor+"'>"+s+"</span>"};r.push(t)}return new LiteGraph.ContextMenu(r,{event:i,callback:function(t){if(o){var e=t.value?LGraphCanvas.node_colors[t.value]:null,i=function(t){e?t.constructor===LiteGraph.LGraphGroup?t.color=e.groupcolor:(t.color=e.color,t.bgcolor=e.bgcolor):(delete t.color,delete t.bgcolor)},n=LGraphCanvas.active_canvas;if(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)i(o);else for(var s in n.selected_nodes)i(n.selected_nodes[s]);o.setDirtyCanvas(!0,!0)}},parentMenu:n,node:o}),!1},LGraphCanvas.onMenuNodeShapes=function(t,e,i,n,s){if(s)return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:i,callback:function(e){if(s){s.graph.beforeChange();var t=function(t){t.shape=e},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)t(s);else for(var n in i.selected_nodes)t(i.selected_nodes[n]);s.graph.afterChange(),s.setDirtyCanvas(!0)}},parentMenu:n,node:s}),!1;throw"no node passed"},LGraphCanvas.onMenuNodeRemove=function(t,e,i,n,s){if(!s)throw"no node passed";function o(t){!1!==t.removable&&r.remove(t)}var r=s.graph,a=(r.beforeChange(),LGraphCanvas.active_canvas);if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(s);else for(var h in a.selected_nodes)o(a.selected_nodes[h]);r.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(t,e,i,n,s){var o,r,a=s.graph,h=LGraphCanvas.active_canvas;h&&((o=Object.values(h.selected_nodes||{})).length||(o=[s]),(r=LiteGraph.createNode("graph/subgraph")).pos=s.pos.concat(),a.add(r),r.buildFromNodes(o),h.deselectAllNodes(),s.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(t,e,i,n,s){s.graph.beforeChange();function o(t){var e;!1!==t.clonable&&(e=t.clone())&&(e.pos=[t.pos[0]+5,t.pos[1]+5],t.graph.add(e),r[e.id]=e)}var r={},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(s);else for(var h in a.selected_nodes)o(a.selected_nodes[h]);Object.keys(r).length&&a.selectNodes(r),s.graph.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var t,e=null;return this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],1<Object.keys(this.selected_nodes).length&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),e=this.getExtraMenuOptions&&(t=this.getExtraMenuOptions(this,e))?e.concat(t):e},LGraphCanvas.prototype.getNodeMenuOptions=function(t){var e,i=null;return t.getMenuOptions?i=t.getMenuOptions(this):(!(i=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}])!==t.resizable&&i.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),i.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),t.onGetInputs&&(e=t.onGetInputs())&&e.length&&(i[0].disabled=!1),t.onGetOutputs&&(e=t.onGetOutputs())&&e.length&&(i[1].disabled=!1),t.getExtraMenuOptions&&(e=t.getExtraMenuOptions(this,i))&&(e.push(null),i=e.concat(i)),!1!==t.clonable&&i.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&i.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),i.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(i,t),i},LGraphCanvas.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(h,t){var e,p=this,i=LGraphCanvas.active_canvas.getCanvasWindow(),n=null,s={event:t,callback:function(t,e,i){var n,s,o,r,a;t&&("Remove Slot"==t.content?(n=t.slot,h.graph.beforeChange(),n.input?h.removeInput(n.slot):n.output&&h.removeOutput(n.slot),h.graph.afterChange()):"Disconnect Links"==t.content?(n=t.slot,h.graph.beforeChange(),n.output?h.disconnectOutput(n.slot):n.input&&h.disconnectInput(n.slot),h.graph.afterChange()):"Rename Slot"==t.content&&(s=(n=t.slot).input?h.getInputInfo(n.slot):h.getOutputInfo(n.slot),o=p.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",e),(r=o.querySelector("input"))&&s&&(r.value=s.label||""),a=function(){h.graph.beforeChange(),r.value&&(s&&(s.label=r.value),p.setDirty(!0)),o.close(),h.graph.afterChange()},o.querySelector("button").addEventListener("click",a),r.addEventListener("keydown",function(t){if(o.is_modified=!0,27==t.keyCode)o.close();else if(13==t.keyCode)a();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}),r.focus()))},extra:h},o=(h&&(s.title=h.type),null);h&&(o=h.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=h),o?(n=[],h.getSlotMenuOptions?n=h.getSlotMenuOptions(o):(o&&o.output&&o.output.links&&o.output.links.length&&n.push({content:"Disconnect Links",slot:o}),(e=o.input||o.output).removable&&n.push(e.locked?"Cannot remove":{content:"Remove Slot",slot:o}),e.nameLocked||n.push({content:"Rename Slot",slot:o})),s.title=(o.input||o.output).type||"*",o.input&&o.input.type==LiteGraph.ACTION&&(s.title="Action"),o.output&&o.output.type==LiteGraph.EVENT&&(s.title="Event")):h?n=this.getNodeMenuOptions(h):(n=this.getCanvasMenuOptions(),(e=this.graph.getGroupOnPos(t.canvasX,t.canvasY))&&n.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:e,options:this.getGroupMenuOptions(e)}})),n&&new LiteGraph.ContextMenu(n,s,i)},LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(t,e,n){var s=this,i=(n=n||{},document.createElement("div")),o=!(i.className="litemenu-entry submenu");function r(t){var e=this.value,i=!0;if((s.current_submenu&&s.current_submenu.close(t),n.callback&&!0===n.callback.call(this,e,n,t,s,n.node)&&(i=!1),e)&&(e.callback&&!n.ignore_item_callbacks&&!0!==e.disabled&&!0===e.callback.call(this,e,n,t,s,n.extra)&&(i=!1),e.submenu)){if(!e.submenu.options)throw"ContextMenu submenu needs options";new s.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:s,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:n.autoopen});i=!1}i&&!s.lock&&s.close()}return null===e?i.classList.add("separator"):(i.innerHTML=e&&e.title?e.title:t,(i.value=e)&&(e.disabled&&(o=!0,i.classList.add("disabled")),e.submenu||e.has_submenu)&&i.classList.add("has_submenu"),"function"==typeof e?(i.dataset.value=t,i.onclick_callback=e):i.dataset.value=e,e.className&&(i.className+=" "+e.className)),this.root.appendChild(i),o||i.addEventListener("click",r),!o&&n.autoopen&&LiteGraph.pointerListenerAdd(i,"enter",function(t){var e=this.value;e&&e.has_submenu&&r.call(this,t)}),i},ContextMenu.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(t,e,i,n){var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,!0,!0,i),s.srcElement=n,t.dispatchEvent?t.dispatchEvent(s):t.__events&&t.__events.dispatchEvent(s),s},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(t,e){var i=t.clientX,t=t.clientY,e=e.getBoundingClientRect();return!!e&&t>e.top&&t<e.top+e.height&&i>e.left&&i<e.left+e.width},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var i=[],n=0;n<e.length;n++)i.push(e[n]);for(n=0;n<i.length;n++)i[n].close?i[n].close():i[n].parentNode&&i[n].parentNode.removeChild(i[n])}},LiteGraph.extendClass=function(t,e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i]);if(e.prototype)for(var i in e.prototype)!e.prototype.hasOwnProperty(i)||t.prototype.hasOwnProperty(i)||(e.prototype.__lookupGetter__(i)?t.prototype.__defineGetter__(i,e.prototype.__lookupGetter__(i)):t.prototype[i]=e.prototype[i],e.prototype.__lookupSetter__(i)&&t.prototype.__defineSetter__(i,e.prototype.__lookupSetter__(i)))},CurveEditor.sampleCurve=function(t,e){if(e){for(var i=0;i<e.length-1;++i){var n,s=e[i],o=e[i+1];if(!(o[0]<t))return n=o[0]-s[0],Math.abs(n)<1e-5?s[1]:(n=(t-s[0])/n,s[1]*(1-n)+o[1]*n)}return 0}},CurveEditor.prototype.draw=function(t,e,i,n,s,o){var r=this.points;if(r){var a=(this.size=e)[0]-2*this.margin,h=e[1]-2*this.margin;s=s||"#666",t.save(),t.translate(this.margin,this.margin),n&&(t.fillStyle="#111",t.fillRect(0,0,a,h),t.fillStyle="#222",t.fillRect(.5*a,0,1,h),t.strokeStyle="#333",t.strokeRect(0,0,a,h)),t.strokeStyle=s,o&&(t.globalAlpha=.5),t.beginPath();for(var p=0;p<r.length;++p){var l=r[p];t.lineTo(l[0]*a,(1-l[1])*h)}if(t.stroke(),t.globalAlpha=1,!o)for(p=0;p<r.length;++p){l=r[p];t.fillStyle=this.selected==p?"#FFF":this.nearest==p?"#DDD":"#AAA",t.beginPath(),t.arc(l[0]*a,(1-l[1])*h,2,0,2*Math.PI),t.fill()}t.restore()}},CurveEditor.prototype.onMouseDown=function(t,e){var i,n,s,o=this.points;if(o&&!(t[1]<0))return i=this.size[0]-2*this.margin,n=this.size[1]-2*this.margin,s=t[0]-this.margin,t=t[1]-this.margin,e=30/e.ds.scale,this.selected=this.getCloserPoint([s,t],e),-1==this.selected&&(o.push(e=[s/i,1-t/n]),o.sort(function(t,e){return t[0]-e[0]}),this.selected=o.indexOf(e),this.must_update=!0),-1!=this.selected||void 0},CurveEditor.prototype.onMouseMove=function(t,e){var i,n,s,o,r=this.points;!r||(i=this.selected)<0||(n=(t[0]-this.margin)/(this.size[0]-2*this.margin),s=(t[1]-this.margin)/(this.size[1]-2*this.margin),o=[t[0]-this.margin,t[1]-this.margin],e=30/e.ds.scale,this._nearest=this.getCloserPoint(o,e),(o=r[i])&&(!(e=0==i||i==r.length-1)&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)?(r.splice(i,1),this.selected=-1):(o[0]=e?0==i?0:1:clamp(n,0,1),o[1]=1-clamp(s,0,1),r.sort(function(t,e){return t[0]-e[0]}),this.selected=r.indexOf(o),this.must_update=!0)))},CurveEditor.prototype.onMouseUp=function(t,e){return!(this.selected=-1)},CurveEditor.prototype.getCloserPoint=function(t,e){var i=this.points;if(!i)return-1;e=e||30;for(var n=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=i.length,r=[0,0],a=1e6,h=-1,p=0;p<o;++p){var l=i[p],l=(r[0]=l[0]*n,r[1]=(1-l[1])*s,r[0]<t[0]&&0,vec2.distance(t,r));a<l||e<l||(h=p,a=l)}return h},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(t,e,i,n=!1){if(t&&t.addEventListener&&e&&"function"==typeof i){var s=LiteGraph.pointerevents_method,o=e;if("pointer"==s&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+o+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),o){case"down":s="touch",o="start";break;case"move":s="touch";break;case"up":s="touch",o="end";break;case"cancel":s="touch";break;case"enter":console.log("debug: Should I send a move event?");break;default:console.warn("PointerEvent not available in this browser ? The event "+o+" would not be called")}switch(o){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(s+o,i,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=s)return t.addEventListener(s+o,i,n);default:return t.addEventListener(o,i,n)}}},LiteGraph.pointerListenerRemove=function(t,e,i,n=!1){if(t&&t.removeEventListener&&e&&"function"==typeof i)switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":"pointer"!=LiteGraph.pointerevents_method&&"mouse"!=LiteGraph.pointerevents_method||t.removeEventListener(LiteGraph.pointerevents_method+e,i,n);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return t.removeEventListener(LiteGraph.pointerevents_method+e,i,n);default:return t.removeEventListener(e,i,n)}},global.clamp=clamp,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),"undefined"!=typeof exports&&(exports.LiteGraph=this.LiteGraph,exports.LGraph=this.LGraph,exports.LLink=this.LLink,exports.LGraphNode=this.LGraphNode,exports.LGraphGroup=this.LGraphGroup,exports.DragAndScale=this.DragAndScale,exports.LGraphCanvas=this.LGraphCanvas,exports.ContextMenu=this.ContextMenu),(t=>{var c=t.LiteGraph;function e(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}function i(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new c.LGraph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}function n(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var e=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(t){t&&e.setProperty("name",t)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(t){e.setProperty("type",t)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(t){e.setProperty("value",t)}),this.widgets_up=!0,this.size=[180,90]}function s(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""};this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}function o(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}function r(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}function a(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}function h(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}function p(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}function l(){this.addInput("parse",c.ACTION),this.addInput("json","string"),this.addOutput("done",c.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}function u(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}function d(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}function g(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}function _(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}function f(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}function v(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}function y(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}function b(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}function m(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var t=this;this.addWidget("button","clear","",function(){t._result={}}),this.size=this.computeSize()}function L(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:L.LITEGRAPH},this.value=null}function G(){this.size=[60,30],this.addInput("data",0),this.addInput("download",c.ACTION),this.properties={filename:"data.json"},this.value=null;var e=this;this.addWidget("button","Download","",function(t){e.value&&e.downloadAsFile()})}function T(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}function O(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}function C(){this.mode=c.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",c.EVENT),this.addInput("msg",0)}function w(){this.mode=c.ON_EVENT,this.addProperty("msg",""),this.addInput("",c.EVENT);this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}function E(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}function N(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:N.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:N.values}),this.size=[80,60]}e.title="Time",e.desc="Time",e.prototype.onExecute=function(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)},c.registerNodeType("basic/time",e),i.title="Subgraph",i.desc="Graph inside a node",i.title_color="#334",i.prototype.onGetInputs=function(){return[["enabled","boolean"]]},i.prototype.onDblClick=function(t,e,i){var n=this;setTimeout(function(){i.openSubgraph(n.subgraph)},10)},i.prototype.onAction=function(t,e){this.subgraph.onAction(t,e)},i.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);this.subgraph.setInputData(e.name,i)}if(this.subgraph.runStep(),this.outputs)for(t=0;t<this.outputs.length;t++){var n=this.outputs[t],i=this.subgraph.getOutputData(n.name);this.setOutputData(t,i)}}},i.prototype.sendEventToAllNodes=function(t,e,i){this.enabled&&this.subgraph.sendEventToAllNodes(t,e,i)},i.prototype.onDrawBackground=function(t,e,i,n){var s,o;this.flags.collapsed||(s=this.size[1]-c.NODE_TITLE_HEIGHT+.5,o=c.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+s,this.size[0],c.NODE_TITLE_HEIGHT),n=c.isInsideRectangle(n[0],n[1],this.pos[0],this.pos[1]+s,this.size[0]/2,c.NODE_TITLE_HEIGHT),t.fillStyle=o?"#555":"#222",t.beginPath(),this._shape==c.BOX_SHAPE?n?t.rect(0,s,this.size[0]/2+1,c.NODE_TITLE_HEIGHT):t.rect(this.size[0]/2,s,this.size[0]/2+1,c.NODE_TITLE_HEIGHT):n?t.roundRect(0,s,this.size[0]/2+1,c.NODE_TITLE_HEIGHT,[0,0,8,8]):t.roundRect(this.size[0]/2,s,this.size[0]/2+1,c.NODE_TITLE_HEIGHT,[0,0,8,8]),o?t.fill():t.fillRect(0,s,this.size[0]+1,c.NODE_TITLE_HEIGHT),t.textAlign="center",t.font="24px Arial",t.fillStyle=o?"#DDD":"#999",t.fillText("+",.25*this.size[0],24+s),t.fillText("+",.75*this.size[0],24+s))},i.prototype.onMouseDown=function(t,e,i){var n=this.size[1]-c.NODE_TITLE_HEIGHT+.5;console.log(0),e[1]>n&&(e[0]<this.size[0]/2?(console.log(1),i.showSubgraphPropertiesDialog(this)):(console.log(2),i.showSubgraphPropertiesDialogRight(this)))},i.prototype.computeSize=function(){var t=this.inputs?this.inputs.length:0,e=this.outputs?this.outputs.length:0;return[200,Math.max(t,e)*c.NODE_SLOT_HEIGHT+c.NODE_TITLE_HEIGHT]},i.prototype.onSubgraphTrigger=function(t,e){t=this.findOutputSlot(t);-1!=t&&this.triggerSlot(t)},i.prototype.onSubgraphNewInput=function(t,e){-1==this.findInputSlot(t)&&this.addInput(t,e)},i.prototype.onSubgraphRenamedInput=function(t,e){t=this.findInputSlot(t);-1!=t&&(this.getInputInfo(t).name=e)},i.prototype.onSubgraphTypeChangeInput=function(t,e){t=this.findInputSlot(t);-1!=t&&(this.getInputInfo(t).type=e)},i.prototype.onSubgraphRemovedInput=function(t){t=this.findInputSlot(t);-1!=t&&this.removeInput(t)},i.prototype.onSubgraphNewOutput=function(t,e){-1==this.findOutputSlot(t)&&this.addOutput(t,e)},i.prototype.onSubgraphRenamedOutput=function(t,e){t=this.findOutputSlot(t);-1!=t&&(this.getOutputInfo(t).name=e)},i.prototype.onSubgraphTypeChangeOutput=function(t,e){t=this.findOutputSlot(t);-1!=t&&(this.getOutputInfo(t).type=e)},i.prototype.onSubgraphRemovedOutput=function(t){t=this.findOutputSlot(t);-1!=t&&this.removeOutput(t)},i.prototype.getExtraMenuOptions=function(t){var e=this;return[{content:"Open",callback:function(){t.openSubgraph(e.subgraph)}}]},i.prototype.onResize=function(t){t[1]+=20},i.prototype.serialize=function(){var t=c.LGraphNode.prototype.serialize.call(this);return t.subgraph=this.subgraph.serialize(),t},i.prototype.reassignSubgraphUUIDs=function(t){let e={nodeIDs:{},linkIDs:{}};for(var i of t.nodes){var n=i.id,s=c.uuidv4();if(i.id=s,e.nodeIDs[n]||e.nodeIDs[s])throw new Error(`New/old node UUID wasn't unique in changed map! ${n} `+s);e.nodeIDs[n]=s,e.nodeIDs[s]=n}for(var o of t.links){var r=o[0],a=c.uuidv4();if(o[0]=a,e.linkIDs[r]||e.linkIDs[a])throw new Error(`New/old link UUID wasn't unique in changed map! ${r} `+a);e.linkIDs[r]=a,e.linkIDs[a]=r;a=o[1],r=o[3];if(!e.nodeIDs[a])throw new Error("Old node UUID not found in mapping! "+a);if(o[1]=e.nodeIDs[a],!e.nodeIDs[r])throw new Error("Old node UUID not found in mapping! "+r);o[3]=e.nodeIDs[r]}for(var h of t.nodes){if(h.inputs)for(var p of h.inputs)p.link&&(p.link=e.linkIDs[p.link]);if(h.outputs)for(var l of h.outputs)l.links&&(l.links=l.links.map(t=>e.linkIDs[t]))}for(var u of t.nodes)"graph/subgraph"===u.type&&(u=reassignGraphUUIDs(u.subgraph),e.nodeIDs.assign(u.nodeIDs),e.linkIDs.assign(u.linkIDs))},i.prototype.clone=function(){var t,e=c.createNode(this.type),i=this.serialize();return c.use_uuids&&(t=c.cloneObject(i.subgraph),this.reassignSubgraphUUIDs(t),i.subgraph=t),delete i.id,delete i.inputs,delete i.outputs,e.configure(i),e},i.prototype.buildFromNodes=function(t){for(var e={},i=0,n=0;n<t.length;++n)e[(s=t[n]).id]=s,i=Math.min(s.pos[0],i),Math.max(s.pos[0],i);for(var s,n=0;n<t.length;++n){if((s=t[n]).inputs)for(var o=0;o<s.inputs.length;++o){var r=s.inputs[o];r&&r.link&&((p=s.graph.links[r.link])&&!e[p.origin_id]&&this.subgraph.addInput(r.name,p.type))}if(s.outputs)for(o=0;o<s.outputs.length;++o){var a=s.outputs[o];if(a&&a.links&&a.links.length)for(var h=0;h<a.links.length;++h){var p=s.graph.links[a.links[h]];if(p&&!e[p.target_id]){0;break}}}}},c.Subgraph=i,c.registerNodeType("graph/subgraph",i),n.title="Input",n.desc="Input of the graph",n.prototype.onConfigure=function(){this.updateType()},n.prototype.updateType=function(){var t=this.properties.type;this.type_widget.value=t,this.outputs[0].type!=t&&(c.isValidConnection(this.outputs[0].type,t)||this.disconnectOutput(0),this.outputs[0].type=t),"number"==t?(this.value_widget.type="number",this.value_widget.value=0):"boolean"==t?(this.value_widget.type="toggle",this.value_widget.value=!0):"string"==t?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,t)},n.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,e):this.graph.addInput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},n.prototype.onAction=function(t,e){this.properties.type==c.EVENT&&this.triggerSlot(0,e)},n.prototype.onExecute=function(){var t=this.properties.name,t=this.graph.inputs[t];t?this.setOutputData(0,(void 0!==t.value?t:this.properties).value):this.setOutputData(0,this.properties.value)},n.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},c.GraphInput=n,c.registerNodeType("graph/input",n),s.title="Output",s.desc="Output of the graph",s.prototype.onPropertyChanged=function(t,e){if("name"==t){if(""==e||e==this.name_in_graph||"enabled"==e)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,e):this.graph.addOutput(e,this.properties.type)),this.name_widget.value=e,this.name_in_graph=e}else"type"==t&&this.updateType()},s.prototype.updateType=function(){var t=this.properties.type;this.type_widget&&(this.type_widget.value=t),this.inputs[0].type!=t&&("action"!=t&&"event"!=t||(t=c.EVENT),c.isValidConnection(this.inputs[0].type,t)||this.disconnectInput(0),this.inputs[0].type=t),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,t)},s.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},s.prototype.onAction=function(t,e){this.properties.type==c.ACTION&&this.graph.trigger(this.properties.name,e)},s.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},s.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},c.GraphOutput=s,c.registerNodeType("graph/output",s),o.title="Const Number",o.desc="Constant number",o.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},o.prototype.setValue=function(t){this.setProperty("value",t)},o.prototype.onDrawBackground=function(t){this.outputs[0].label=this.properties.value.toFixed(3)},c.registerNodeType("basic/const",o),r.title="Const Boolean",r.desc="Constant boolean",r.prototype.getTitle=o.prototype.getTitle,r.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},r.prototype.setValue=o.prototype.setValue,r.prototype.onGetInputs=function(){return[["toggle",c.ACTION]]},r.prototype.onAction=function(t){this.setValue(!this.properties.value)},c.registerNodeType("basic/boolean",r),a.title="Const String",a.desc="Constant string",a.prototype.getTitle=o.prototype.getTitle,a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},a.prototype.setValue=o.prototype.setValue,a.prototype.onDropFile=function(t){var e=this,i=new FileReader;i.onload=function(t){e.setProperty("value",t.target.result)},i.readAsText(t)},c.registerNodeType("basic/string",a),h.title="Const Object",h.desc="Constant Object",h.prototype.onExecute=function(){this.setOutputData(0,this._object)},c.registerNodeType("basic/object",h),p.title="Const File",p.desc="Fetches a file from an url",p["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},p.prototype.onPropertyChanged=function(t,e){"url"==t&&(null==e||""==e?this._data=null:this.fetchFile(e))},p.prototype.onExecute=function(){var t=this.getInputData(0)||this.properties.url;!t||t==this._url&&this._type==this.properties.type||this.fetchFile(t),this.setOutputData(0,this._data)},p.prototype.setValue=o.prototype.setValue,p.prototype.fetchFile=function(e){var i=this;e&&e.constructor===String?(this._url=e,this._type=this.properties.type,"http"==e.substr(0,4)&&c.proxy&&(e=c.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(t){if(t.ok)return"arraybuffer"==i.properties.type?t.arrayBuffer():"text"==i.properties.type?t.text():"json"==i.properties.type?t.json():"blob"==i.properties.type?t.blob():void 0;throw new Error("File not found")}).then(function(t){i._data=t,i.boxcolor="#AEA"}).catch(function(t){i._data=null,i.boxcolor="red",console.error("error fetching file:",e)})):(i._data=null,i.boxcolor=null)},p.prototype.onDropFile=function(t){var e=this,i=(this._url=t.name,this._type=this.properties.type,this.properties.url=t.name,new FileReader);if(i.onload=function(t){e.boxcolor="#AEA";t=t.target.result;"json"==e.properties.type&&(t=JSON.parse(t)),e._data=t},"arraybuffer"==e.properties.type)i.readAsArrayBuffer(t);else if("text"==e.properties.type||"json"==e.properties.type)i.readAsText(t);else if("blob"==e.properties.type)return i.readAsBinaryString(t)},c.registerNodeType("basic/file",p),l.title="JSON Parse",l.desc="Parses JSON String into object",l.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch(t){this.boxcolor="red"}},l.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},l.prototype.onAction=function(t){"parse"==t&&this.parse()},c.registerNodeType("basic/jsonparse",l),u.title="Const Data",u.desc="Constant Data",u.prototype.onPropertyChanged=function(t,e){if(null!=(this.widget.value=e)&&""!=e)try{this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},u.prototype.onExecute=function(){this.setOutputData(0,this._value)},u.prototype.setValue=o.prototype.setValue,c.registerNodeType("basic/data",u),d.title="Const Array",d.desc="Constant Array",d.prototype.onPropertyChanged=function(t,e){if(null!=(this.widget.value=e)&&""!=e)try{"["!=e[0]?this._value=JSON.parse("["+e+"]"):this._value=JSON.parse(e),this.boxcolor="#AEA"}catch(t){this.boxcolor="red"}},d.prototype.onExecute=function(){var t=this.getInputData(0);if(t&&t.length){this._value||(this._value=new Array),this._value.length=t.length;for(var e=0;e<t.length;++e)this._value[e]=t[e]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},d.prototype.setValue=o.prototype.setValue,c.registerNodeType("basic/array",d),g.title="Set Array",g.desc="Sets index of array",g.prototype.onExecute=function(){var t,e=this.getInputData(0);e&&void 0!==(t=this.getInputData(1))&&(this.properties.index&&(e[Math.floor(this.properties.index)]=t),this.setOutputData(0,e))},c.registerNodeType("basic/set_array",g),_.title="Array[i]",_.desc="Returns an element from an array",_.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);null==e&&(e=this.properties.index),null!=t&&null!=e&&this.setOutputData(0,t[Math.floor(Number(e))])},c.registerNodeType("basic/array[]",_),f.title="Table[row][col]",f.desc="Returns an element from a table",f.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);null==e&&(e=this.properties.row),null==i&&(i=this.properties.column),null!=t&&null!=e&&null!=i&&((e=t[Math.floor(Number(e))])?this.setOutputData(0,e[Math.floor(Number(i))]):this.setOutputData(0,null))},c.registerNodeType("basic/table[][]",f),v.title="Object property",v.desc="Outputs the property of an object",v.prototype.setValue=function(t){this.properties.value=t,this.widget.value=t},v.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},v.prototype.onPropertyChanged=function(t,e){this.widget.value=e},v.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t[this.properties.value])},c.registerNodeType("basic/object_property",v),y.title="Object keys",y.desc="Outputs an array with the keys of an object",y.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Object.keys(t))},c.registerNodeType("basic/object_keys",y),b.title="Set Object",b.desc="Adds propertiesrty to object",b.prototype.onExecute=function(){var t,e=this.getInputData(0);e&&void 0!==(t=this.getInputData(1))&&(this.properties.property&&(e[this.properties.property]=t),this.setOutputData(0,e))},c.registerNodeType("basic/set_object",b),m.title="Merge Objects",m.desc="Creates an object copying properties from others",m.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1),i=this._result;if(t)for(var n in t)i[n]=t[n];if(e)for(var n in e)i[n]=e[n];this.setOutputData(0,i)},c.registerNodeType("basic/merge_objects",m),L.title="Variable",L.desc="store/read variable value",L["@container"]={type:"enum",values:{litegraph:L.LITEGRAPH=0,graph:L.GRAPH=1,global:L.GLOBALSCOPE=2}},L.prototype.onExecute=function(){var t=this.getContainer();this.isInputConnected(0)?(this.value=this.getInputData(0),t[this.properties.varname]=this.value,this.setOutputData(0,this.value)):this.setOutputData(0,t[this.properties.varname])},L.prototype.getContainer=function(){switch(this.properties.container){case L.GRAPH:return this.graph?this.graph.vars:{};case L.GLOBALSCOPE:return t;default:return c.Globals}},L.prototype.getTitle=function(){return this.properties.varname},c.registerNodeType("basic/variable",L),c.wrapFunctionAsNode("basic/length",function(t){return t&&null!=t.length?Number(t.length):0},[""],"number"),c.wrapFunctionAsNode("basic/not",function(t){return!t},[""],"boolean"),G.title="Download",G.desc="Download some data",G.prototype.downloadAsFile=function(){var t,e;null!=this.value&&(e=null,e=this.value.constructor===String?this.value:JSON.stringify(this.value),e=new Blob([e]),t=URL.createObjectURL(e),(e=document.createElement("a")).setAttribute("href",t),e.setAttribute("download",this.properties.filename),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),setTimeout(function(){URL.revokeObjectURL(t)},6e4))},G.prototype.onAction=function(t,e){var i=this;setTimeout(function(){i.downloadAsFile()},100)},G.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},G.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},c.registerNodeType("basic/download",G),T.title="Watch",T.desc="Show value of input",T.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},T.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},T.toString=function(t){if(null==t)return"null";if(t.constructor===Number)return t.toFixed(3);if(t.constructor!==Array)return String(t);for(var e="[",i=0;i<t.length;++i)e+=T.toString(t[i])+(i+1!=t.length?",":"");return e+="]"},T.prototype.onDrawBackground=function(t){this.inputs[0].label=T.toString(this.value)},c.registerNodeType("basic/watch",T),O.title="Cast",O.desc="Allows to connect different types",O.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},c.registerNodeType("basic/cast",O),C.title="Console",C.desc="Show value inside the console",C.prototype.onAction=function(t,e){var i=this.getInputData(1);i=(i=i||this.properties.msg)||"Event: "+e,"log"==t?console.log(i):"warn"==t?console.warn(i):"error"==t&&console.error(i)},C.prototype.onExecute=function(){var t=this.getInputData(1);null!=(t=t||this.properties.msg)&&void 0!==t&&(this.properties.msg=t,console.log(t))},C.prototype.onGetInputs=function(){return[["log",c.ACTION],["warn",c.ACTION],["error",c.ACTION]]},c.registerNodeType("basic/console",C),w.title="Alert",w.desc="Show an alert window",w.color="#510",w.prototype.onConfigure=function(t){this.widget.value=t.properties.msg},w.prototype.onAction=function(t,e){var i=this.properties.msg;setTimeout(function(){alert(i)},10)},c.registerNodeType("basic/alert",w),E.prototype.onConfigure=function(t){t.properties.onExecute&&c.allow_scripts?this.compileCode(t.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},E.title="Script",E.desc="executes a code (max 256 characters)",E.widgets_info={onExecute:{type:"code"}},E.prototype.onPropertyChanged=function(t,e){"onExecute"==t&&c.allow_scripts?this.compileCode(e):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},E.prototype.compileCode=function(t){if(this._func=null,256<t.length)console.warn("Script too long, max 256 chars");else{for(var e=t.toLowerCase(),i=["script","body","document","eval","nodescript","function"],n=0;n<i.length;++n)if(-1!=e.indexOf(i[n]))return void console.warn("invalid script");try{this._func=new Function("A","B","C","DATA","node",t)}catch(t){console.error("Error parsing script"),console.error(t)}}},E.prototype.onExecute=function(){if(this._func)try{var t=this.getInputData(0),e=this.getInputData(1),i=this.getInputData(2);this.setOutputData(0,this._func(t,e,i,this.data,this))}catch(t){console.error("Error in script"),console.error(t)}},E.prototype.onGetOutputs=function(){return[["C",""]]},c.registerNodeType("basic/script",E),N["@OP"]={type:"enum",title:"operation",values:N.values=["==","!="]},N.title="Compare *",N.desc="evaluates condition between A and B",N.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},N.prototype.onExecute=function(){var t=this.getInputData(0),e=(void 0===t?t=this.properties.A:this.properties.A=t,this.getInputData(1)),i=(void 0===e?e=this.properties.B:this.properties.B=e,!1);if(typeof t==typeof e)switch(this.properties.OP){case"==":case"!=":if(i=!0,"object"==typeof t){var n=Object.getOwnPropertyNames(t),s=Object.getOwnPropertyNames(e);if(n.length!=s.length)i=!1;else for(var o=0;o<n.length;o++){var r=n[o];if(t[r]!==e[r]){i=!1;break}}}else i=t==e;"!="==this.properties.OP&&(i=!i)}this.setOutputData(0,i),this.setOutputData(1,!i)},c.registerNodeType("basic/CompareValues",N)})(this),(t=>{var n=t.LiteGraph;function e(){this.size=[60,30],this.addInput("event",n.ACTION)}function i(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",n.EVENT),this.addOutput("change",n.EVENT),this.addOutput("false",n.EVENT),this.properties={only_on_change:!0},this.prev=0}function s(){var t=this;this.addInput("",n.ACTION),this.addInput("",n.ACTION),this.addInput("",n.ACTION),this.addOutput("",n.EVENT),this.addOutput("",n.EVENT),this.addOutput("",n.EVENT),this.addWidget("button","+",null,function(){t.addInput("",n.ACTION),t.addOutput("",n.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}function o(){var t=this;this.addInput("",n.ACTION),this.addInput("",n.ACTION),this.addOutput("",n.EVENT),this.addWidget("button","+",null,function(){t.addInput("",n.ACTION),t.size[0]=90}),this.size=[90,70],this.ready=[]}function r(){var t=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",n.ACTION),this.addInput("reset",n.ACTION),this.addOutput("index","number"),this.addOutput("",n.EVENT),this.addOutput("",n.EVENT),this.addOutput("",n.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){t.addOutput("",n.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}function a(){this.size=[60,30],this.addInput("event",n.ACTION),this.addOutput("event",n.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}function h(){this.addInput("in",n.ACTION),this.addInput("cond","boolean"),this.addOutput("true",n.EVENT),this.addOutput("false",n.EVENT),this.size=[120,60],this._value=!1}function p(){this.addInput("inc",n.ACTION),this.addInput("dec",n.ACTION),this.addInput("reset",n.ACTION),this.addOutput("change",n.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}function l(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",n.ACTION),this.addOutput("on_time",n.EVENT),this._pending=[]}function u(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",n.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}function c(){this.addInput("go",n.ACTION),this.addInput("green",n.ACTION),this.addInput("red",n.ACTION),this.addOutput("continue",n.EVENT),this.addOutput("blocked",n.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._ready=!1})}function d(){this.addInput("in",n.ACTION),this.addInput("reset",n.ACTION),this.addOutput("out",n.EVENT),this._once=!1,this.properties={};var t=this;this.addWidget("button","reset","",function(){t._once=!1})}function g(){this.addInput("data",0),this.addInput("assign",n.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var t=this;this.addWidget("button","store","",function(){t.properties.data=t._last_value})}e.title="Log Event",e.desc="Log event in console",e.prototype.onAction=function(t,e,i){console.log(t,e)},n.registerNodeType("events/log",e),i.title="TriggerEvent",i.desc="Triggers event if input evaluates to true",i.prototype.onExecute=function(t,e){var i=this.getInputData(0),n=i!=this.prev,s=(n=0===this.prev?!1:n)&&this.properties.only_on_change||!n&&!this.properties.only_on_change;i&&s&&this.triggerSlot(0,t,null,e),!i&&s&&this.triggerSlot(2,t,null,e),n&&this.triggerSlot(1,t,null,e),this.prev=i},n.registerNodeType("events/trigger",i),s.title="Sequence",s.desc="Triggers a sequence of events when an event arrives",s.prototype.getTitle=function(){return""},s.prototype.onAction=function(t,e,i){if(this.outputs){i=i||{};for(var n=0;n<this.outputs.length;++n){this.outputs[n];i.action_call?i.action_call=i.action_call+"_seq_"+n:i.action_call=this.id+"_"+(t||"action")+"_seq_"+n+"_"+Math.floor(9999*Math.random()),this.triggerSlot(n,e,null,i)}}},n.registerNodeType("events/sequence",s),o.title="WaitAll",o.desc="Wait until all input events arrive then triggers output",o.prototype.getTitle=function(){return""},o.prototype.onDrawBackground=function(t){if(!this.flags.collapsed)for(var e=0;e<this.inputs.length;++e){var i=e*n.NODE_SLOT_HEIGHT+10;t.fillStyle=this.ready[e]?"#AFB":"#000",t.fillRect(20,i,10,10)}},o.prototype.onAction=function(t,e,i,n){if(null!=n){this.ready.length=this.outputs.length,this.ready[n]=!0;for(var s=0;s<this.ready.length;++s)if(!this.ready[s])return;this.reset(),this.triggerSlot(0)}},o.prototype.reset=function(){this.ready.length=0},n.registerNodeType("events/waitAll",o),r.title="Stepper",r.desc="Trigger events sequentially when an tick arrives",r.prototype.onDrawBackground=function(t){var e,i;this.flags.collapsed||(i=this.properties.index||0,t.fillStyle="#AFB",e=this.size[0],i=(i+1)*n.NODE_SLOT_HEIGHT+4,t.beginPath(),t.moveTo(e-30,i),t.lineTo(e-30,i+n.NODE_SLOT_HEIGHT),t.lineTo(e-15,i+.5*n.NODE_SLOT_HEIGHT),t.fill())},r.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.floor(t),(t=clamp(t,0,this.outputs?this.outputs.length-2:0))!=this.properties.index)&&(this.properties.index=t,this.triggerSlot(t+1)),this.setOutputData(0,this.properties.index)},r.prototype.onAction=function(t,e){"reset"==t?this.properties.index=0:"step"==t&&(this.triggerSlot(this.properties.index+1,e),t=this.outputs?this.outputs.length-1:0,this.properties.index=(this.properties.index+1)%t)},n.registerNodeType("events/stepper",r),a.title="Filter Event",a.desc="Blocks events that do not match the filter",a.prototype.onAction=function(t,e,i){if(null!=e&&(!this.properties.equal_to||this.properties.equal_to==e)){if(this.properties.has_property){var n=e[this.properties.has_property];if(null==n)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=n)return}this.triggerSlot(0,e,null,i)}},n.registerNodeType("events/filter",a),h.title="Branch",h.desc="If condition is true, outputs triggers true, otherwise false",h.prototype.onExecute=function(){this._value=this.getInputData(1)},h.prototype.onAction=function(t,e,i){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,e,null,i)},n.registerNodeType("events/branch",h),p.title="Counter",p.desc="Counts events",p.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},p.prototype.onAction=function(t,e,i){var n=this.num;"inc"==t?this.num+=1:"dec"==t?--this.num:"reset"==t&&(this.num=0),this.num!=n&&this.trigger("change",this.num)},p.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.fillStyle="#AAA",t.font="20px Arial",t.textAlign="center",t.fillText(this.num,.5*this.size[0],.5*this.size[1]))},p.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},n.registerNodeType("events/counter",p),l.title="Delay",l.desc="Delays one event",l.prototype.onAction=function(t,e,i){var n=this.properties.time_in_ms;n<=0?this.trigger(null,e,i):this._pending.push([n,e])},l.prototype.onExecute=function(t,e){var i=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var n=0;n<this._pending.length;++n){var s=this._pending[n];s[0]-=i,0<s[0]||(this._pending.splice(n,1),--n,this.trigger(null,s[1],e))}},l.prototype.onGetInputs=function(){return[["event",n.ACTION],["time_in_ms","number"]]},n.registerNodeType("events/delay",l),u.title="Timer",u.desc="Sends an event every N milliseconds",u.prototype.onStart=function(){this.time=0},u.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},u.on_color="#AAA",u.off_color="#222",u.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?u.on_color:u.off_color,this.triggered=!1},u.prototype.onExecute=function(){var t=1e3*this.graph.elapsed_time,e=0==this.time;this.time+=t,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),!e&&(this.time<this.last_interval||isNaN(this.last_interval))?this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!1):(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!0))},u.prototype.onGetInputs=function(){return[["interval","number"]]},u.prototype.onGetOutputs=function(){return[["tick","boolean"]]},n.registerNodeType("events/timer",u),c.title="Semaphore Event",c.desc="Until both events are not triggered, it doesnt continue.",c.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},c.prototype.onAction=function(t,e){"go"==t?this.triggerSlot(this._ready?0:1):"green"==t?this._ready=!0:"red"==t&&(this._ready=!1)},n.registerNodeType("events/semaphore",c),d.title="Once",d.desc="Only passes an event once, then gets locked",d.prototype.onAction=function(t,e){"in"!=t||this._once?"reset"==t&&(this._once=!1):(this._once=!0,this.triggerSlot(0,e))},n.registerNodeType("events/once",d),g.title="Data Store",g.desc="Stores data and only changes when event is received",g.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},g.prototype.onAction=function(t,e,i){this.properties.data=this._last_value},g.prototype.onSerialize=function(t){null!=t.data&&(0==this.properties.serialize||t.data.constructor!==String&&t.data.constructor!==Number&&t.data.constructor!==Boolean&&t.data.constructor!==Array&&t.data.constructor!==Object)&&(t.data=null)},n.registerNodeType("basic/data_store",g)})(this),(t=>{var e=t.LiteGraph;function r(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",e.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}r.title="Gamepad",r.desc="gets the input of the gamepad",r.CENTER=0,r.LEFT=1,r.RIGHT=2,r.UP=4,r.DOWN=8,r.zero=new Float32Array(2),r.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],r.prototype.onExecute=function(){var t=this.getGamepad(),e=this.properties.threshold||0;if(t&&(this._left_axis[0]=Math.abs(t.xbox.axes.lx)>e?t.xbox.axes.lx:0,this._left_axis[1]=Math.abs(t.xbox.axes.ly)>e?t.xbox.axes.ly:0,this._right_axis[0]=Math.abs(t.xbox.axes.rx)>e?t.xbox.axes.rx:0,this._right_axis[1]=Math.abs(t.xbox.axes.ry)>e?t.xbox.axes.ry:0,this._triggers[0]=Math.abs(t.xbox.axes.ltrigger)>e?t.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(t.xbox.axes.rtrigger)>e?t.xbox.axes.rtrigger:0),this.outputs)for(var i=0;i<this.outputs.length;i++){var n=this.outputs[i];if(n.links&&n.links.length){var s=null;if(t)switch(n.name){case"left_axis":s=this._left_axis;break;case"right_axis":s=this._right_axis;break;case"left_x_axis":s=this._left_axis[0];break;case"left_y_axis":s=this._left_axis[1];break;case"right_x_axis":s=this._right_axis[0];break;case"right_y_axis":s=this._right_axis[1];break;case"trigger_left":s=this._triggers[0];break;case"trigger_right":s=this._triggers[1];break;case"a_button":s=t.xbox.buttons.a?1:0;break;case"b_button":s=t.xbox.buttons.b?1:0;break;case"x_button":s=t.xbox.buttons.x?1:0;break;case"y_button":s=t.xbox.buttons.y?1:0;break;case"lb_button":s=t.xbox.buttons.lb?1:0;break;case"rb_button":s=t.xbox.buttons.rb?1:0;break;case"ls_button":s=t.xbox.buttons.ls?1:0;break;case"rs_button":s=t.xbox.buttons.rs?1:0;break;case"hat_left":s=t.xbox.hatmap&r.LEFT;break;case"hat_right":s=t.xbox.hatmap&r.RIGHT;break;case"hat_up":s=t.xbox.hatmap&r.UP;break;case"hat_down":s=t.xbox.hatmap&r.DOWN;break;case"hat":s=t.xbox.hatmap;break;case"start_button":s=t.xbox.buttons.start?1:0;break;case"back_button":s=t.xbox.buttons.back?1:0;break;case"button_pressed":for(var o=0;o<this._current_buttons.length;++o)this._current_buttons[o]&&!this._previous_buttons[o]&&this.triggerSlot(i,r.buttons[o])}else switch(n.name){case"button_pressed":break;case"left_axis":case"right_axis":s=r.zero;break;default:s=0}this.setOutputData(i,s)}}},r.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},r.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],r.prototype.getGamepad=function(){var t=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!t)return null;var e=t.call(navigator),i=null;this._previous_buttons.set(this._current_buttons);for(var n=this.properties.gamepad_index;n<4;n++)if(e[n]){var i=e[n],s=this.xbox_mapping;(s=s||(this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:r.CENTER})).axes.lx=i.axes[0],s.axes.ly=i.axes[1],s.axes.rx=i.axes[2],s.axes.ry=i.axes[3],s.axes.ltrigger=i.buttons[6].value,s.axes.rtrigger=i.buttons[7].value,s.hat="",s.hatmap=r.CENTER;for(var o=0;o<i.buttons.length;o++)if(this._current_buttons[o]=i.buttons[o].pressed,o<12)s.buttons[r.mapping_array[o]]=i.buttons[o].pressed,i.buttons[o].was_pressed&&this.trigger(r.mapping_array[o]+"_button_event");else switch(o){case 12:i.buttons[o].pressed&&(s.hat+="up",s.hatmap|=r.UP);break;case 13:i.buttons[o].pressed&&(s.hat+="down",s.hatmap|=r.DOWN);break;case 14:i.buttons[o].pressed&&(s.hat+="left",s.hatmap|=r.LEFT);break;case 15:i.buttons[o].pressed&&(s.hat+="right",s.hatmap|=r.RIGHT);break;case 16:s.buttons.home=i.buttons[o].pressed}return i.xbox=s,i}},r.prototype.onDrawBackground=function(t){if(!this.flags.collapsed){var e=this._left_axis,i=this._right_axis,n=(t.strokeStyle="#88A",t.strokeRect(.5*(e[0]+1)*this.size[0]-4,.5*(e[1]+1)*this.size[1]-4,8,8),t.strokeStyle="#8A8",t.strokeRect(.5*(i[0]+1)*this.size[0]-4,.5*(i[1]+1)*this.size[1]-4,8,8),this.size[1]/this._current_buttons.length);t.fillStyle="#AEB";for(var s=0;s<this._current_buttons.length;++s)this._current_buttons[s]&&t.fillRect(0,n*s,6,n)}},r.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",e.EVENT],["b_button_event",e.EVENT],["x_button_event",e.EVENT],["y_button_event",e.EVENT],["lb_button_event",e.EVENT],["rb_button_event",e.EVENT],["ls_button_event",e.EVENT],["rs_button_event",e.EVENT],["start_button_event",e.EVENT],["back_button_event",e.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",e.EVENT]]},e.registerNodeType("input/gamepad",r)})(this),(t=>{var n=t.LiteGraph;function e(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}function i(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}function s(){this.addInput("in"),this.addOutput("out")}function o(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}function r(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}function p(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}function a(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}function h(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}function l(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}function u(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function d(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}function g(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}function _(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}function f(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}function v(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}function y(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}function b(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:b.values}),this._func=b.funcs[this.properties.OP],this._result=[]}function m(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}function L(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:L.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:L.values}),this.size=[80,60]}function G(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}function T(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}function O(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}function C(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(t,e,i){i.properties.formula=t}),this.addWidget("toggle","allow",n.allow_scripts,function(t){n.allow_scripts=t}),this._func=null}function w(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}function E(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}function N(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}function x(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}function k(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}function I(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}e.title="Converter",e.desc="type A to type B",e.prototype.onExecute=function(){var t=this.getInputData(0);if(null!=t&&this.outputs)for(var e=0;e<this.outputs.length;e++){var i=this.outputs[e];if(i.links&&i.links.length){var n=null;switch(i.name){case"number":n=t.length?t[0]:parseFloat(t);break;case"vec2":case"vec3":case"vec4":var n=null,s=1;switch(i.name){case"vec2":s=2;break;case"vec3":s=3;break;case"vec4":s=4}n=new Float32Array(s);if(t.length)for(var o=0;o<t.length&&o<n.length;o++)n[o]=t[o];else n[0]=parseFloat(t)}this.setOutputData(e,n)}}},e.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},n.registerNodeType("math/converter",e),i.title="Bypass",i.desc="removes the type",i.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,t)},n.registerNodeType("math/bypass",i),s.title="to Number",s.desc="Cast to number",s.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,Number(t))},n.registerNodeType("math/to_number",s),o.title="Range",o.desc="Convert a number from one range to another",o.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},o.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t];void 0!==(i=this.getInputData(t))&&(this.properties[e.name]=i)}null!=(i=this.properties.in)&&i.constructor===Number||(i=0);var i,n=this.properties.in_min,s=this.properties.in_max,o=this.properties.out_min,r=this.properties.out_max;this._last_v=(i-n)/(s-n)*(r-o)+o,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,o,r))},o.prototype.onDrawBackground=function(t){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},o.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},n.registerNodeType("math/range",o),r.title="Rand",r.desc="Random number",r.prototype.onExecute=function(){if(this.inputs)for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],i=this.getInputData(t);void 0!==i&&(this.properties[e.name]=i)}var n=this.properties.min,s=this.properties.max;this._last_v=Math.random()*(s-n)+n,this.setOutputData(0,this._last_v)},r.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},r.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},n.registerNodeType("math/rand",r),p.title="Noise",p.desc="Random number with temporal continuity",p.data=null,p.getValue=function(t,e){if(!p.data){p.data=new Float32Array(1024);for(var i=0;i<p.data.length;++i)p.data[i]=Math.random()}(t%=1024)<0&&(t+=1024);var n=Math.floor(t),t=t-n;return p.data[n]*(1-(t=e?t*t*t*(t*(6*t-15)+10):t))+p.data[1023==n?0:n+1]*t},p.prototype.onExecute=function(){for(var t=this.getInputData(0)||0,e=this.properties.octaves||1,i=0,n=1,s=(t+=this.properties.seed||0,this.properties.speed||1),o=0,r=0;r<e&&(i+=p.getValue(t*(1+r)*s,this.properties.smooth)*n,o+=n,!((n*=this.properties.persistence)<.001));++r);var a=this.properties.min,h=this.properties.max;this._last_v=(i/=o)*(h-a)+a,this.setOutputData(0,this._last_v)},p.prototype.onDrawBackground=function(t){this.outputs[0].label=(this._last_v||0).toFixed(3)},n.registerNodeType("math/noise",p),a.title="Spikes",a.desc="spike every random time",a.prototype.onExecute=function(){var t,e=this.graph.elapsed_time,e=(this._remaining_time-=e,this._blink_time-=e,0);0<this._blink_time&&(t=this._blink_time/this.properties.duration,e=1/(Math.pow(8*t-4,4)+1)),this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,e)},n.registerNodeType("math/spikes",a),h.title="Clamp",h.desc="Clamp number between min and max",h.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(t=Math.max(this.properties.min,t),t=Math.min(this.properties.max,t),this.setOutputData(0,t))},h.prototype.getCode=function(t){var e="";return this.isInputConnected(0)&&(e+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),e},n.registerNodeType("math/clamp",h),l.title="Lerp",l.desc="Linear Interpolation",l.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.getInputData(1)),i=(null==e&&(e=0),this.properties.f),n=this.getInputData(2);this.setOutputData(0,t*(1-(i=void 0!==n?n:i))+e*i)},l.prototype.onGetInputs=function(){return[["f","number"]]},n.registerNodeType("math/lerp",l),u.title="Abs",u.desc="Absolute",u.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.abs(t))},n.registerNodeType("math/abs",u),c.title="Floor",c.desc="Floor number to remove fractional part",c.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,Math.floor(t))},n.registerNodeType("math/floor",c),d.title="Frac",d.desc="Returns fractional part",d.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t%1)},n.registerNodeType("math/frac",d),g.title="Smoothstep",g.desc="Smoothstep",g.prototype.onExecute=function(){var t,e,i=this.getInputData(0);void 0!==i&&(t=this.properties.A,e=this.properties.B,i=clamp((i-t)/(e-t),0,1),this.setOutputData(0,i=i*i*(3-2*i)))},n.registerNodeType("math/smoothstep",g),_.title="Scale",_.desc="v * factor",_.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&this.setOutputData(0,t*this.properties.factor)},n.registerNodeType("math/scale",_),f.title="Gate",f.desc="if v is true, then outputs A, otherwise B",f.prototype.onExecute=function(){var t=this.getInputData(0);this.setOutputData(0,this.getInputData(t?1:2))},n.registerNodeType("math/gate",f),v.title="Average",v.desc="Average Filter",v.prototype.onExecute=function(){for(var t=this.getInputData(0),e=this._values.length,i=(this._values[this._current%e]=t=null==t?0:t,this._current+=1,this._current>e&&(this._current=0),0),n=0;n<e;++n)i+=this._values[n];this.setOutputData(0,i/e)},v.prototype.onPropertyChanged=function(t,e){e<1&&(e=1),this.properties.samples=Math.round(e);e=this._values;this._values=new Float32Array(this.properties.samples),e.length<=this._values.length?this._values.set(e):this._values.set(e.subarray(0,this._values.length))},n.registerNodeType("math/average",v),y.title="TendTo",y.desc="moves the output value always closer to the input",y.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.properties.factor);null==this._value?this._value=t:this._value=this._value*(1-e)+t*e,this.setOutputData(0,this._value)},n.registerNodeType("math/tendTo",y),b.values=["+","-","*","/","%","^","max","min"],b.funcs={"+":function(t,e){return t+e},"-":function(t,e){return t-e},x:function(t,e){return t*e},X:function(t,e){return t*e},"*":function(t,e){return t*e},"/":function(t,e){return t/e},"%":function(t,e){return t%e},"^":function(t,e){return Math.pow(t,e)},max:function(t,e){return Math.max(t,e)},min:function(t,e){return Math.min(t,e)}},b.title="Operation",b.desc="Easy math operators",b["@OP"]={type:"enum",title:"operation",values:b.values},b.size=[100,60],b.prototype.getTitle=function(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},b.prototype.setValue=function(t){"string"==typeof t&&(t=parseFloat(t)),this.properties.value=t},b.prototype.onPropertyChanged=function(t,e){"OP"!=t||(this._func=b.funcs[this.properties.OP],this._func)||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(t){return t})},b.prototype.onExecute=function(){var t,e=this.getInputData(0),i=this.getInputData(1),n=(null!=e?e.constructor===Number&&(this.properties.A=e):e=this.properties.A,null!=i?this.properties.B=i:i=this.properties.B,b.funcs[this.properties.OP]);if(e.constructor===Number)t=0,t=n(e,i);else if(e.constructor===Array){(t=this._result).length=e.length;for(var s=0;s<e.length;++s)t[s]=n(e[s],i)}else for(var s in t={},e)t[s]=n(e[s],i);this.setOutputData(0,t)},b.prototype.onDrawBackground=function(t){this.flags.collapsed||(t.font="40px Arial",t.fillStyle="#666",t.textAlign="center",t.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+n.NODE_TITLE_HEIGHT)),t.textAlign="left")},n.registerNodeType("math/operation",b),n.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),n.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"}),m.title="Compare",m.desc="compares between two values",m.prototype.onExecute=function(){var t=this.getInputData(0),e=this.getInputData(1);void 0!==t?this.properties.A=t:t=this.properties.A,void 0!==e?this.properties.B=e:e=this.properties.B;for(var i=0,n=this.outputs.length;i<n;++i){var s,o=this.outputs[i];if(o.links&&o.links.length){switch(o.name){case"A==B":s=t==e;break;case"A!=B":s=t!=e;break;case"A>B":s=e<t;break;case"A<B":s=t<e;break;case"A<=B":s=t<=e;break;case"A>=B":s=e<=t}this.setOutputData(i,s)}}},m.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},n.registerNodeType("math/compare",m),n.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),n.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),n.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),n.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),n.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),n.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"}),L["@OP"]={type:"enum",title:"operation",values:L.values=[">","<","==","!=","<=",">=","||","&&"]},L.title="Condition",L.desc="evaluates condition between A and B",L.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},L.prototype.onExecute=function(){var t=this.getInputData(0),e=(void 0===t?t=this.properties.A:this.properties.A=t,this.getInputData(1)),i=(void 0===e?e=this.properties.B:this.properties.B=e,!0);switch(this.properties.OP){case">":i=e<t;break;case"<":i=t<e;break;case"==":i=t==e;break;case"!=":i=t!=e;break;case"<=":i=t<=e;break;case">=":i=e<=t;break;case"||":i=t||e;break;case"&&":i=t&&e}this.setOutputData(0,i),this.setOutputData(1,!i)},n.registerNodeType("math/condition",L),G.title="Branch",G.desc="If condition is true, outputs IN in true, otherwise in false",G.prototype.onExecute=function(){var t=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,t),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,t))},n.registerNodeType("math/branch",G),T.title="Accumulate",T.desc="Increments a value every time",T.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var t=this.getInputData(0);this.properties.value+=null!==t?t:this.properties.increment,this.setOutputData(0,this.properties.value)},n.registerNodeType("math/accumulate",T),O.title="Trigonometry",O.desc="Sin Cos Tan",O.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=0),this.properties.amplitude),i=this.findInputSlot("amplitude"),n=(-1!=i&&(e=this.getInputData(i)),this.properties.offset);-1!=(i=this.findInputSlot("offset"))&&(n=this.getInputData(i));for(var s,o=0,r=this.outputs.length;o<r;++o){switch(this.outputs[o].name){case"sin":s=Math.sin(t);break;case"cos":s=Math.cos(t);break;case"tan":s=Math.tan(t);break;case"asin":s=Math.asin(t);break;case"acos":s=Math.acos(t);break;case"atan":s=Math.atan(t)}this.setOutputData(o,e*s+n)}},O.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},O.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},n.registerNodeType("math/trigonometry",O),n.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),n.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),n.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"}),C.title="Formula",C.desc="Compute formula",C.size=[160,100],v.prototype.onPropertyChanged=function(t,e){"formula"==t&&(this.code_widget.value=e)},C.prototype.onExecute=function(){if(n.allow_scripts){var t,e=this.getInputData(0),i=this.getInputData(1);null!=e?this.properties.x=e:e=this.properties.x,null!=i?this.properties.y=i:i=this.properties.y,this.properties.formula;try{this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),t=this._func(e,i,this.graph.globaltime),this.boxcolor=null}catch(t){this.boxcolor="red"}this.setOutputData(0,t)}},C.prototype.getTitle=function(){return this._func_code||"Formula"},C.prototype.onDrawBackground=function(){var t=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=t)},n.registerNodeType("math/formula",C),w.title="Vec2->XY",w.desc="vector 2 to components",w.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]))},n.registerNodeType("math3d/vec2-to-xy",w),E.title="XY->Vec2",E.desc="components to vector2",E.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this._data);i[0]=t,i[1]=e,this.setOutputData(0,i)},n.registerNodeType("math3d/xy-to-vec2",E),N.title="Vec3->XYZ",N.desc="vector 3 to components",N.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]))},n.registerNodeType("math3d/vec3-to-xyz",N),x.title="XYZ->Vec3",x.desc="components to vector3",x.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this.getInputData(2)),n=(null==i&&(i=this.properties.z),this._data);n[0]=t,n[1]=e,n[2]=i,this.setOutputData(0,n)},n.registerNodeType("math3d/xyz-to-vec3",x),k.title="Vec4->XYZW",k.desc="vector 4 to components",k.prototype.onExecute=function(){var t=this.getInputData(0);null!=t&&(this.setOutputData(0,t[0]),this.setOutputData(1,t[1]),this.setOutputData(2,t[2]),this.setOutputData(3,t[3]))},n.registerNodeType("math3d/vec4-to-xyzw",k),I.title="XYZW->Vec4",I.desc="components to vector4",I.prototype.onExecute=function(){var t=this.getInputData(0),e=(null==t&&(t=this.properties.x),this.getInputData(1)),i=(null==e&&(e=this.properties.y),this.getInputData(2)),n=(null==i&&(i=this.properties.z),this.getInputData(3)),s=(null==n&&(n=this.properties.w),this._data);s[0]=t,s[1]=e,s[2]=i,s[3]=n,this.setOutputData(0,s)},n.registerNodeType("math3d/xyzw-to-vec4",I)})(this),(t=>{function e(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}(t=t.LiteGraph).wrapFunctionAsNode("string/toString",function(t){if(t&&t.constructor===Object)try{return JSON.stringify(t)}catch(t){}return String(t)},[""],"string"),t.wrapFunctionAsNode("string/compare",function(t,e){return t==e},["string","string"],"boolean"),t.wrapFunctionAsNode("string/concatenate",function(t,e){return void 0===t?e:void 0===e?t:t+e},["string","string"],"string"),t.wrapFunctionAsNode("string/contains",function(t,e){return void 0!==t&&void 0!==e&&-1!=t.indexOf(e)},["string","string"],"boolean"),t.wrapFunctionAsNode("string/toUpperCase",function(t){return null!=t&&t.constructor===String?t.toUpperCase():t},["string"],"string"),t.wrapFunctionAsNode("string/split",function(t,e){if(null==e&&(e=this.properties.separator),null==t)return[];if(t.constructor===String)return t.split(e||" ");if(t.constructor!==Array)return null;for(var i=[],n=0;n<t.length;++n)"string"==typeof t[n]&&(i[n]=t[n].split(e||" "));return i},["string,array","string"],"array",{separator:","}),t.wrapFunctionAsNode("string/toFixed",function(t){return null!=t&&t.constructor===Number?t.toFixed(this.properties.precision):t},["number"],"string",{precision:0}),e.title="toTable",e.desc="Splits a string to table",e.prototype.onExecute=function(){var e,t=this.getInputData(0);t&&(e=this.properties.separator||",",t==this._str&&e==this._last_separator||(this._last_separator=e,this._str=t,this._table=t.split("\n").map(function(t){return t.trim().split(e)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0))},t.registerNodeType("string/toTable",e)})(this),(t=>{var i=t.LiteGraph;function e(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}function n(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}function s(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function o(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function r(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}function a(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}function h(){this.properties={},this.addInput("onTrigger",i.ACTION),this.addInput("condition","boolean"),this.addOutput("true",i.EVENT),this.addOutput("false",i.EVENT),this.mode=i.ON_TRIGGER}e.title="Selector",e.desc="selects an output",e.prototype.onDrawBackground=function(t){var e;this.flags.collapsed||(t.fillStyle="#AFB",e=(this.selected+1)*i.NODE_SLOT_HEIGHT+6,t.beginPath(),t.moveTo(50,e),t.lineTo(50,e+i.NODE_SLOT_HEIGHT),t.lineTo(34,e+.5*i.NODE_SLOT_HEIGHT),t.fill())},e.prototype.onExecute=function(){var t=this.getInputData(0),t=(null!=t&&t.constructor===Number||(t=0),this.selected=t=Math.round(t)%(this.inputs.length-1),this.getInputData(t+1));void 0!==t&&this.setOutputData(0,t)},e.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},i.registerNodeType("logic/selector",e),n.title="Sequence",n.desc="select one element from a sequence from a string",n.prototype.onPropertyChanged=function(t,e){"sequence"==t&&(this.values=e.split(","))},n.prototype.onExecute=function(){var t=this.getInputData(1),t=(t&&t!=this.current_sequence&&(this.values=t.split(","),this.current_sequence=t),this.getInputData(0));null==t&&(t=0),this.index=t=Math.round(t)%this.values.length,this.setOutputData(0,this.values[t])},i.registerNodeType("logic/sequence",n),s.title="AND",s.desc="Return true if all inputs are true",s.prototype.onExecute=function(){var t,e=!0;for(t in this.inputs)if(!this.getInputData(t)){e=!1;break}this.setOutputData(0,e)},s.prototype.onGetInputs=function(){return[["and","boolean"]]},i.registerNodeType("logic/AND",s),o.title="OR",o.desc="Return true if at least one input is true",o.prototype.onExecute=function(){var t,e=!1;for(t in this.inputs)if(this.getInputData(t)){e=!0;break}this.setOutputData(0,e)},o.prototype.onGetInputs=function(){return[["or","boolean"]]},i.registerNodeType("logic/OR",o),r.title="NOT",r.desc="Return the logical negation",r.prototype.onExecute=function(){var t=!this.getInputData(0);this.setOutputData(0,t)},i.registerNodeType("logic/NOT",r),a.title="bool == bool",a.desc="Compare for logical equality",a.prototype.onExecute=function(){var t,e=null,i=!0;for(t in this.inputs)if(null===e)e=this.getInputData(t);else if(e!=this.getInputData(t)){i=!1;break}this.setOutputData(0,i)},a.prototype.onGetInputs=function(){return[["bool","boolean"]]},i.registerNodeType("logic/CompareBool",a),h.title="Branch",h.desc="Branch execution on condition",h.prototype.onExecute=function(t,e){this.getInputData(1)?this.triggerSlot(0):this.triggerSlot(1)},i.registerNodeType("logic/IF",h)})(this),(t=>{var o=t.LiteGraph;function e(){this.size=[60,20],this.addInput("send",o.ACTION),this.addOutput("received",o.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}function i(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",o.ACTION),this.addOutput("received",o.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],"undefined"==typeof SillyClient&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}function n(){this.addInput("request",o.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",o.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}e.title="WebSocket",e.desc="Send data through a websocket",e.prototype.onPropertyChanged=function(t,e){"url"==t&&this.connectSocket()},e.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){for(var t=this.properties.room,e=this.properties.only_send_changes,i=1;i<this.inputs.length;++i){var n,s=this.getInputData(i);if(null!=s){try{n=JSON.stringify({type:0,room:t,channel:i,data:s})}catch(t){continue}e&&this._last_sent_data[i]==n||(this._last_sent_data[i]=n,this._ws.send(n))}}for(i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},e.prototype.connectSocket=function(){var i=this,t=this.properties.url;"ws"!=t.substr(0,2)&&(t="ws://"+t),this._ws=new WebSocket(t),this._ws.onopen=function(){console.log("ready"),i.boxcolor="#6C6"},this._ws.onmessage=function(t){i.boxcolor="#AFA";t=JSON.parse(t.data);if(!t.room||t.room==i.properties.room)if(1==t.type)if(t.data.object_class&&o[t.data.object_class]){var e;try{e=new o[t.data.object_class](t.data),i.triggerSlot(0,e)}catch(t){}}else i.triggerSlot(0,t.data);else i._last_received_data[t.channel||0]=t.data},this._ws.onerror=function(t){console.log("couldnt connect to websocket"),i.boxcolor="#E88"},this._ws.onclose=function(t){console.log("connection closed"),i.boxcolor="#000"}},e.prototype.send=function(t){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:t}))},e.prototype.onAction=function(t,e){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:t,data:e})},e.prototype.onGetInputs=function(){return[["in",0]]},e.prototype.onGetOutputs=function(){return[["out",0]]},o.registerNodeType("network/websocket",e),i.title="SillyClient",i.desc="Connects to SillyServer to broadcast messages",i.prototype.onPropertyChanged=function(t,e){"room"==t&&(this.room_widget.value=e),this.connectSocket()},i.prototype.setRoom=function(t){this.properties.room=t,this.room_widget.value=t,this.connectSocket()},i.prototype.onDrawForeground=function(){for(var t=1;t<this.inputs.length;++t)this.inputs[t].label="in_"+t;for(t=1;t<this.outputs.length;++t)this.outputs[t].label="out_"+t},i.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var t=this.properties.only_send_changes,e=1;e<this.inputs.length;++e){var i=this.getInputData(e),n=this._last_sent_data[e];if(null!=i){if(t){var s=!0;if(i&&i.length&&n&&n.length==i.length&&i.constructor!==String){for(var o=0;o<i.length;++o)if(n[o]!=i[o]){s=!1;break}}else this._last_sent_data[e]!=i&&(s=!1);if(s)continue}if(this._server.sendMessage({type:0,channel:e,data:i}),i.length&&i.constructor!==String)if(this._last_sent_data[e]){this._last_sent_data[e].length=i.length;for(o=0;o<i.length;++o)this._last_sent_data[e][o]=i[o]}else i.constructor===Array?this._last_sent_data[e]=i.concat():this._last_sent_data[e]=new i.constructor(i);else this._last_sent_data[e]=i}}for(e=1;e<this.outputs.length;++e)this.setOutputData(e,this._last_received_data[e]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}},i.prototype.connectSocket=function(){var s=this;if("undefined"==typeof SillyClient)this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;else if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),s.boxcolor="#6C6"},this._server.on_message=function(t,e){var i=null;try{i=JSON.parse(e)}catch(t){return}if(1==i.type)if(i.data.object_class&&o[i.data.object_class]){var n;try{n=new o[i.data.object_class](i.data),s.triggerSlot(0,n)}catch(t){return}}else s.triggerSlot(0,i.data);else s._last_received_data[i.channel||0]=i.data;s.boxcolor="#AFA"},this._server.on_error=function(t){console.log("couldnt connect to websocket"),s.boxcolor="#E88"},this._server.on_close=function(t){console.log("connection closed"),s.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(t){return console.error("SillyServer error: "+t),void(this._server=null)}this._final_url=this.properties.url+"/"+this.properties.room}},i.prototype.send=function(t){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,data:t})},i.prototype.onAction=function(t,e){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:t,data:e})},i.prototype.onGetInputs=function(){return[["in",0]]},i.prototype.onGetOutputs=function(){return[["out",0]]},o.registerNodeType("network/sillyclient",i),n.title="HTTP Request",n.desc="Fetch data through HTTP",n.prototype.fetch=function(){var e,t=this.properties.url;t&&(this.boxcolor="#FF0",(e=this)._fetching=fetch(t).then(t=>{if(t.ok)return this.boxcolor="#0F0",t.text();this.boxcolor="#F00",e.trigger("error")}).then(t=>{e._data=t,e._fetching=null,e.trigger("ready")}))},n.prototype.onAction=function(t){"request"==t&&this.fetch()},n.prototype.onExecute=function(){this.setOutputData(1,this._data)},n.prototype.onGetOutputs=function(){return[["error",o.EVENT]]},o.registerNodeType("network/httprequest",n)})(this);