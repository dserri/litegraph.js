!function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,LiteGraph.debug&&console.log("Node registered: "+t);var n,i=e.name,o=t.lastIndexOf("/");for(n in e.category=t.substring(0,o),e.title||(e.title=i),LGraphNode.prototype)e.prototype[n]||(e.prototype[n]=LGraphNode.prototype[n]);o=this.registered_node_types[t];if(o&&console.log("replacing node type: "+t),!Object.prototype.hasOwnProperty.call(e.prototype,"shape")&&(Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=t}},get:function(){return this._shape},enumerable:!0,configurable:!0}),e.supported_extensions))for(var s in e.supported_extensions){s=e.supported_extensions[s];s&&s.constructor===String&&(this.node_types_by_file_extension[s.toLowerCase()]=e)}(this.registered_node_types[t]=e).constructor.name&&(this.Nodes[i]=e),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(t,e),o&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(t,e,o),e.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new e(e.title||"tmpnode")},unregisterNodeType:function(t){var e=t.constructor===String?this.registered_node_types[t]:t;if(!e)throw"node type not found: "+t;delete this.registered_node_types[e.type],e.constructor.name&&delete this.Nodes[e.constructor.name]},registerNodeAndSlotType:function(t,e,n){n=n||!1;var i=(t.constructor===String&&"anonymous"!==this.registered_node_types[t]?this.registered_node_types[t]:t).constructor.type;let o=[];o="string"==typeof e?e.split(","):e==this.EVENT||e==this.ACTION?["_event_"]:["*"];for(let e=0;e<o.length;++e){let t=o[e];""===t&&(t="*");var s=n?"registered_slot_out_types":"registered_slot_in_types";void 0===this[s][t]&&(this[s][t]={nodes:[]}),this[s][t].nodes.includes(i)||this[s][t].nodes.push(i),n?this.slot_types_out.includes(t.toLowerCase())||(this.slot_types_out.push(t.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(t.toLowerCase())||(this.slot_types_in.push(t.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(t,e){var n,i="";if(e.inputs)for(var o=0;o<e.inputs.length;++o)i+="this.addInput('"+e.inputs[o][0]+"',"+(n=(n=e.inputs[o][1])&&n.constructor===String?'"'+n+'"':n)+");\n";if(e.outputs)for(o=0;o<e.outputs.length;++o)i+="this.addOutput('"+e.outputs[o][0]+"',"+(n=(n=e.outputs[o][1])&&n.constructor===String?'"'+n+'"':n)+");\n";if(e.properties)for(var o in e.properties){var s=e.properties[o];i+="this.addProperty('"+o+"',"+(s=s&&s.constructor===String?'"'+s+'"':s)+");\n"}i+="if(this.onCreate)this.onCreate()";var a=Function(i);for(o in e)"inputs"!=o&&"outputs"!=o&&"properties"!=o&&(a.prototype[o]=e[o]);return a.title=e.title||t.split("/").pop(),a.desc=e.desc||"Generated from object",this.registerNodeType(t,a),a},wrapFunctionAsNode:function(t,n,e,i,o){var s=Array(n.length),a="";if(null!==e)for(var r=LiteGraph.getParameterNames(n),h=0;h<r.length;++h){var l=0;e&&(null!=e[h]&&e[h].constructor===String?l="'"+e[h]+"'":null!=e[h]&&(l=e[h])),a+="this.addInput('"+r[h]+"',"+l+");\n"}null!==i&&(a+="this.addOutput('out',"+(null!=i?i.constructor===String?"'"+i+"'":i:0)+");\n"),o&&(a+="this.properties = "+JSON.stringify(o)+";\n");i=Function(a);return i.title=t.split("/").pop(),i.desc="Generated from "+n.name,i.prototype.onExecute=function(){for(var t=0;t<s.length;++t)s[t]=this.getInputData(t);var e=n.apply(this,s);this.setOutputData(0,e)},this.registerNodeType(t,i),i},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(t,e){for(var n in LGraphNode.prototype[t]=e,this.registered_node_types){n=this.registered_node_types[n];n.prototype[t]&&(n.prototype["_"+t]=n.prototype[t]),n.prototype[t]=e}},createNode:function(t,e,n){var i=this.registered_node_types[t];if(!i)return LiteGraph.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;i.prototype;e=e||i.title||t;var o=null;if(LiteGraph.catch_exceptions)try{o=new i(e)}catch(t){return console.error(t),null}else o=new i(e);if(o.type=t,!o.title&&e&&(o.title=e),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=LiteGraph.DEFAULT_POSITION.concat()),o.mode||(o.mode=LiteGraph.ALWAYS),n)for(var s in n)o[s]=n[s];return o.onNodeCreated&&o.onNodeCreated(),o},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var n,i=[];for(n in this.registered_node_types){var o=this.registered_node_types[n];o.filter==e&&(""==t?null==o.category&&i.push(o):o.category==t&&i.push(o))}return this.auto_sort_node_types&&i.sort(function(t,e){return t.title.localeCompare(e.title)}),i},getNodeTypesCategories:function(t){var e={"":1};for(i in this.registered_node_types){var n=this.registered_node_types[i];n.category&&!n.skip_list&&n.filter==t&&(e[n.category]=1)}var i,o=[];for(i in e)o.push(i);return this.auto_sort_node_types?o.sort():o},reloadNodes:function(t){for(var e=document.getElementsByTagName("script"),n=[],i=0;i<e.length;i++)n.push(e[i]);var o=document.getElementsByTagName("head")[0];t=document.location.href+t;for(i=0;i<n.length;i++){var s=n[i].src;if(s&&s.substr(0,t.length)==t)try{LiteGraph.debug&&console.log("Reloading: "+s);var a=document.createElement("script");a.type="text/javascript",a.src=s,o.appendChild(a),o.removeChild(n[i])}catch(t){if(LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error while reloading "+s)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var n,i=JSON.parse(JSON.stringify(t));if(!e)return i;for(n in i)e[n]=i[n];return e},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^16*Math.random()>>t/4).toString(16))},isValidConnection:function(t,e){if(""!=e&&"*"!==e||(e=0),!(t=""!=t&&"*"!==t?t:0)||!e||t==e||t==LiteGraph.EVENT&&e==LiteGraph.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var n=t.split(","),i=e.split(","),o=0;o<n.length;++o)for(var s=0;s<i.length;++s)if(this.isValidConnection(n[o],i[s]))return!0;return!1},registerSearchboxExtra:function(t,e,n){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:n}},fetchFile:function(e,n,i,o){if(e){if(n=n||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(t){if(t.ok)return"arraybuffer"==n?t.arrayBuffer():"text"==n||"string"==n?t.text():"json"==n?t.json():"blob"==n?t.blob():void 0;throw new Error("File not found")}).then(function(t){i&&i(t)}).catch(function(t){console.error("error fetching file:",e),o&&o(t)});if(e.constructor===File||e.constructor===Blob){var t=new FileReader;if(t.onload=function(t){t=t.target.result;"json"==n&&(t=JSON.parse(t)),i&&i(t)},"arraybuffer"==n)return t.readAsArrayBuffer(e);if("text"==n||"json"==n)return t.readAsText(e);if("blob"==n)return t.readAsBinaryString(e)}}return null}};function LGraph(t){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function LLink(t,e,n,i,o,s){this.id=t,this.type=e,this.origin_id=n,this.origin_slot=i,this.target_id=o,this.target_slot=s,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(t){this._ctor(t)}function LGraphGroup(t){this._ctor(t)}function DragAndScale(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function LGraphCanvas(t,e,n){this.options=n=n||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=n.viewport||null,e&&e.attachCanvas(this),this.setCanvas(t,n.skip_events),this.clear(),n.skip_render||this.startRendering(),this.autoresize=n.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(t){if(t.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),(t.graph=this).list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},LGraph.prototype.detachCanvas=function(t){var e;this.list_of_graphcanvas&&-1!=(e=this.list_of_graphcanvas.indexOf(t))&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))},LGraph.prototype.start=function(t){var e;this.status!=LGraph.STATUS_RUNNING&&(this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=this,0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,function t(){-1==e.execution_timer_id&&(window.requestAnimationFrame(t),e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep)&&e.onAfterStep()}()):this.execution_timer_id=setInterval(function(){e.onBeforeStep&&e.onBeforeStep(),e.runStep(1,!e.catch_errors),e.onAfterStep&&e.onAfterStep()},t))},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(t,e,n){t=t||1;var i=LiteGraph.getTime(),o=(this.globaltime=.001*(i-this.starttime),this._nodes_executable||this._nodes);if(o){if(n=n||o.length,e){for(var s=0;s<t;s++){for(var a=0;a<n;++a){var r=o[a];LiteGraph.use_deferred_actions&&r._waiting_actions&&r._waiting_actions.length&&r.executePendingActions(),r.mode==LiteGraph.ALWAYS&&r.onExecute&&r.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(s=0;s<t;s++){for(a=0;a<n;++a){r=o[a];LiteGraph.use_deferred_actions&&r._waiting_actions&&r._waiting_actions.length&&r.executePendingActions(),r.mode==LiteGraph.ALWAYS&&r.onExecute&&r.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw t;LiteGraph.debug&&console.log("Error during execution: "+t),this.stop()}e=LiteGraph.getTime(),i=e-i;this.execution_time=.001*(i=0==i?1:i),this.globaltime+=.001*i,this.iteration+=1,this.elapsed_time=.001*(e-this.last_update_time),this.last_update_time=e,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},LGraph.prototype.computeExecutionOrder=function(t,e){for(var n=[],i=[],o={},s={},a={},r=0,h=this._nodes.length;r<h;++r){var l=this._nodes[r];if(!t||l.onExecute){var p=0;if((o[l.id]=l).inputs)for(var u=0,c=l.inputs.length;u<c;u++)l.inputs[u]&&null!=l.inputs[u].link&&(p+=1);0==p?(i.push(l),e&&(l._level=1)):(e&&(l._level=0),a[l.id]=p)}}for(;;){if(0==i.length)break;l=i.shift();if(n.push(l),delete o[l.id],l.outputs)for(var r=0;r<l.outputs.length;r++){var d=l.outputs[r];if(null!=d&&null!=d.links&&0!=d.links.length)for(u=0;u<d.links.length;u++){var _,g=d.links[u],g=this.links[g];!g||s[g.id]||(null==(_=this.getNodeById(g.target_id))?s[g.id]=!0:(e&&(!_._level||_._level<=l._level)&&(_._level=l._level+1),s[g.id]=!0,--a[_.id],0==a[_.id]&&i.push(_)))}}}for(r in o)n.push(o[r]);n.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(h=n.length,r=0;r<h;++r)n[r].order=r;for(n=n.sort(function(t,e){var n=t.constructor.priority||t.priority||0,i=e.constructor.priority||e.priority||0;return n==i?t.order-e.order:n-i}),r=0;r<h;++r)n[r].order=r;return n},LGraph.prototype.getAncestors=function(t){for(var e=[],n=[t],i={};n.length;){var o=n.shift();if(o.inputs){i[o.id]||o==t||(i[o.id]=!0,e.push(o));for(var s=0;s<o.inputs.length;++s){var a=o.getInputNode(s);a&&-1==e.indexOf(a)&&n.push(a)}}}return e.sort(function(t,e){return t.order-e.order}),e},LGraph.prototype.arrange=function(i,o){i=i||100;var e=this.computeExecutionOrder(!1,!0),n=[];for(let t=0;t<e.length;++t){var s=e[t],a=s._level||1;n[a]||(n[a]=[]),n[a].push(s)}let r=i;for(let t=0;t<n.length;++t){var h=n[t];if(h){let e=100,n=i+LiteGraph.NODE_TITLE_HEIGHT;for(let t=0;t<h.length;++t){var l=h[t],p=(l.pos[0]=o==LiteGraph.VERTICAL_LAYOUT?n:r,l.pos[1]=o==LiteGraph.VERTICAL_LAYOUT?r:n,o==LiteGraph.VERTICAL_LAYOUT?1:0),p=(l.size[p]>e&&(e=l.size[p]),o==LiteGraph.VERTICAL_LAYOUT?0:1);n+=l.size[p]+i+LiteGraph.NODE_TITLE_HEIGHT}r+=e+i}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(t,e,n){n=n||LiteGraph.ALWAYS;var i=this._nodes_in_order||this._nodes;if(i)for(var o=0,s=i.length;o<s;++o){var a=i[o];a.constructor===LiteGraph.Subgraph&&"onExecute"!=t?a.mode==n&&a.sendEventToAllNodes(t,e,n):a[t]&&a.mode==n&&(void 0===e?a[t]():e&&e.constructor===Array?a[t].apply(a,e):a[t](e))}},LGraph.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var i=this.list_of_graphcanvas[n];i[t]&&i[t].apply(i,e)}},LGraph.prototype.add=function(t,e){if(t){if(t.constructor!==LGraphGroup){if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?t.id=LiteGraph.uuidv4():t.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?null!=t.id&&-1!=t.id||(t.id=LiteGraph.uuidv4()):null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),(t.graph=this)._version++,this._nodes.push(t),(this._nodes_by_id[t.id]=t).onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}this._groups.push(t),this.setDirtyCanvas(!0),this.change(),(t.graph=this)._version++}},LGraph.prototype.remove=function(t){if(t.constructor===LiteGraph.LGraphGroup)-1!=(o=this._groups.indexOf(t))&&this._groups.splice(o,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(this.beforeChange(),t.inputs)for(var e=0;e<t.inputs.length;e++)null!=(n=t.inputs[e]).link&&t.disconnectInput(e);if(t.outputs)for(var n,e=0;e<t.outputs.length;e++)null!=(n=t.outputs[e]).links&&n.links.length&&t.disconnectOutput(e);if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(e=0;e<this.list_of_graphcanvas.length;++e){var i=this.list_of_graphcanvas[e];i.selected_nodes[t.id]&&delete i.selected_nodes[t.id],i.node_dragged==t&&(i.node_dragged=null)}var o=this._nodes.indexOf(t);-1!=o&&this._nodes.splice(o,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},LGraph.prototype.findNodesByClass=function(t,e){for(var n=(e=e||[]).length=0,i=this._nodes.length;n<i;++n)this._nodes[n].constructor===t&&e.push(this._nodes[n]);return e},LGraph.prototype.findNodesByType=function(t,e){for(var t=t.toLowerCase(),n=(e=e||[]).length=0,i=this._nodes.length;n<i;++n)this._nodes[n].type.toLowerCase()==t&&e.push(this._nodes[n]);return e},LGraph.prototype.findNodeByTitle=function(t){for(var e=0,n=this._nodes.length;e<n;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},LGraph.prototype.findNodesByTitle=function(t){for(var e=[],n=0,i=this._nodes.length;n<i;++n)this._nodes[n].title==t&&e.push(this._nodes[n]);return e},LGraph.prototype.getNodeOnPos=function(t,e,n,i){for(var o=(n=n||this._nodes).length-1;0<=o;o--){var s=n[o];if(s.isPointInside(t,e,i))return s}return null},LGraph.prototype.getGroupOnPos=function(t,e){for(var n=this._groups.length-1;0<=n;n--){var i=this._groups[n];if(i.isPointInside(t,e,2,!0))return i}return null},LGraph.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var e=this._nodes[t],n=LiteGraph.registered_node_types[e.type];e.constructor!=n&&(console.log("node being replaced by newer version: "+e.type),n=LiteGraph.createNode(e.type),(this._nodes[t]=n).configure(e.serialize()),(n.graph=this)._nodes_by_id[n.id]=n,e.inputs&&(n.inputs=e.inputs.concat()),e.outputs)&&(n.outputs=e.outputs.concat())}this.updateExecutionOrder()},LGraph.prototype.onAction=function(t,e,n){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var i=0;i<this._input_nodes.length;++i){var o=this._input_nodes[i];if(o.properties.name==t){o.actionDo(t,e,n);break}}},LGraph.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},LGraph.prototype.addInput=function(t,e,n){this.inputs[t]||(this.beforeChange(),this.inputs[t]={name:t,type:e,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(t,e){t=this.inputs[t];t&&(t.value=e)},LGraph.prototype.getInputData=function(t){t=this.inputs[t];return t?t.value:null},LGraph.prototype.renameInput=function(t,e){if(e!=t)return!!this.inputs[t]&&(this.inputs[e]?(console.error("there is already one input with that name"),!1):(this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},LGraph.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(t,e,n){this.outputs[t]={name:t,type:e,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(t,e){t=this.outputs[t];t&&(t.value=e)},LGraph.prototype.getOutputData=function(t){t=this.outputs[t];return t?t.value:null},LGraph.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},LGraph.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].onTrigger(e)},LGraph.prototype.setCallback=function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].setTrigger(e)},LGraph.prototype.beforeChange=function(t){this.onBeforeChange&&this.onBeforeChange(this,t),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(t){this.onAfterChange&&this.onAfterChange(this,t),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(this.list_of_graphcanvas)for(var t=0;t<this.list_of_graphcanvas.length;++t)if(this.list_of_graphcanvas[t].live_mode)return!0;return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var t in this.links){t=this.links[t];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},LGraph.prototype.removeLink=function(t){var e,t=this.links[t];t&&(e=this.getNodeById(t.target_id))&&e.disconnectInput(t.target_slot)},LGraph.prototype.serialize=function(){for(var t=[],e=0,n=this._nodes.length;e<n;++e)t.push(this._nodes[e].serialize());var i=[];for(e in this.links){var o=this.links[e];if(!o.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var s,a=new LLink;for(s in o)a[s]=o[s];o=this.links[e]=a}i.push(o.serialize())}for(var r=[],e=0;e<this._groups.length;++e)r.push(this._groups[e].serialize());var h={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:i,groups:r,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(h),h},LGraph.prototype.configure=function(t,e){if(t){e||this.clear();var n=t.nodes;if(t.links&&t.links.constructor===Array){for(var i=[],o=0;o<t.links.length;++o){var s,a=t.links[o];a?((s=new LLink).configure(a),i[s.id]=s):console.warn("serialized graph link data contains errors, skipping.")}t.links=i}for(o in t)"nodes"!=o&&"groups"!=o&&(this[o]=t[o]);var r=!1;if(this._nodes=[],n){for(var o=0,h=n.length;o<h;++o){var l=n[o];(p=LiteGraph.createNode(l.type,l.title))||(LiteGraph.debug&&console.log("Node not found or has errors: "+l.type),(p=new LGraphNode).last_serialization=l,r=p.has_errors=!0),p.id=l.id,this.add(p,!0)}for(o=0,h=n.length;o<h;++o){var p,l=n[o];(p=this.getNodeById(l.id))&&p.configure(l)}}if(this._groups.length=0,t.groups)for(o=0;o<t.groups.length;++o){var u=new LiteGraph.LGraphGroup;u.configure(t.groups[o]),this.add(u)}return this.updateExecutionOrder(),this.extra=t.extra||{},this.onConfigure&&this.onConfigure(t),this._version++,this.setDirtyCanvas(!0,!0),r}},LGraph.prototype.load=function(t,n){var e,i,o=this;t.constructor===File||t.constructor===Blob?((e=new FileReader).addEventListener("load",function(t){t=JSON.parse(t.target.result);o.configure(t),n&&n()}),e.readAsText(t)):((i=new XMLHttpRequest).open("GET",t,!0),i.send(null),i.onload=function(t){var e;200!==i.status?console.error("Error loading graph:",i.status,i.response):(e=JSON.parse(i.response),o.configure(e),n&&n())},i.onerror=function(t){console.error("Error loading graph:",t)})},LGraph.prototype.onNodeTrace=function(t,e,n){},LLink.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink,global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(t){for(var e in this.graph&&this.graph._version++,t)if("properties"==e)for(var n in t.properties)this.properties[n]=t.properties[n],this.onPropertyChanged&&this.onPropertyChanged(n,t.properties[n]);else null!=t[e]&&("object"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=LiteGraph.cloneObject(t[e],this[e]):this[e]=t[e]);if(t.title||(this.title=this.constructor.title),this.inputs)for(var i=0;i<this.inputs.length;++i){var o=this.inputs[i],s=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,i,!0,s,o),this.onInputAdded&&this.onInputAdded(o)}if(this.outputs)for(i=0;i<this.outputs.length;++i){var a=this.outputs[i];if(a.links){for(e=0;e<a.links.length;++e){s=this.graph?this.graph.links[a.links[e]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,i,!0,s,a)}this.onOutputAdded&&this.onOutputAdded(a)}}if(this.widgets){for(i=0;i<this.widgets.length;++i){var r=this.widgets[i];r&&r.options&&r.options.property&&null!=this.properties[r.options.property]&&(r.value=JSON.parse(JSON.stringify(this.properties[r.options.property])))}if(t.widgets_values)for(i=0;i<t.widgets_values.length;++i)this.widgets[i]&&(this.widgets[i].value=t.widgets_values[i])}this.onConfigure&&this.onConfigure(t)},LGraphNode.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(e=0;e<this.widgets.length;++e)this.widgets[e]?t.widgets_values[e]=this.widgets[e].value:t.widgets_values[e]=null}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},LGraphNode.prototype.clone=function(){var t=LiteGraph.createNode(this.type);if(!t)return null;var e=LiteGraph.cloneObject(this.serialize());if(e.inputs)for(var n=0;n<e.inputs.length;++n)e.inputs[n].link=null;if(e.outputs)for(n=0;n<e.outputs.length;++n)e.outputs[n].links&&(e.outputs[n].links.length=0);return delete e.id,LiteGraph.use_uuids&&(e.id=LiteGraph.uuidv4()),t.configure(e),t},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var n=this.properties[t];if(this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,n)&&(this.properties[t]=n),this.widgets)for(var i=0;i<this.widgets.length;++i){var o=this.widgets[i];if(o&&o.options.property==t){o.value=e;break}}}},LGraphNode.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n._data=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var o=this.outputs[t].links[i],o=this.graph.links[o];o&&(o.data=e)}}},LGraphNode.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n.type=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var o=this.outputs[t].links[i];this.graph.links[o].type=e}}},LGraphNode.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link))return t=this.inputs[t].link,(t=this.graph.links[t])?(e&&(e=this.graph.getNodeById(t.origin_id))&&(e.updateOutputData?e.updateOutputData(t.origin_slot):e.onExecute&&e.onExecute()),t.data):null},LGraphNode.prototype.getInputDataType=function(t){var e;return this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)&&(t=this.inputs[t].link,t=this.graph.links[t])?(e=this.graph.getNodeById(t.origin_id))?(e=e.outputs[t.origin_slot])?e.type:null:t.type:null},LGraphNode.prototype.getInputDataByName=function(t,e){t=this.findInputSlot(t);return-1==t?null:this.getInputData(t,e)},LGraphNode.prototype.isInputConnected=function(t){return!!this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link},LGraphNode.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},LGraphNode.prototype.getInputLink=function(t){return this.inputs&&t<this.inputs.length?(t=this.inputs[t],this.graph.links[t.link]):null},LGraphNode.prototype.getInputNode=function(t){return this.inputs&&!(t>=this.inputs.length)&&(t=this.inputs[t])&&null!==t.link&&(t=this.graph.links[t.link])?this.graph.getNodeById(t.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,n=this.inputs.length;e<n;++e){var i=this.inputs[e];if(t==i.name&&null!=i.link){i=this.graph.links[i.link];if(i)return i.data}}return this.properties[t]},LGraphNode.prototype.getOutputData=function(t){return!this.outputs||t>=this.outputs.length?null:this.outputs[t]._data},LGraphNode.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},LGraphNode.prototype.isOutputConnected=function(t){return!!this.outputs&&t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length},LGraphNode.prototype.isAnyOutputConnected=function(){if(this.outputs)for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var n=[],i=0;i<e.links.length;i++){var o=e.links[i],o=this.graph.links[o];o&&(o=this.graph.getNodeById(o.target_id))&&n.push(o)}return n},LGraphNode.prototype.addOnTriggerInput=function(){var t=this.findInputSlot("onTrigger");return-1==t?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):t},LGraphNode.prototype.addOnExecutedOutput=function(){var t=this.findOutputSlot("onExecuted");return-1==t?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):t},LGraphNode.prototype.onAfterExecuteNode=function(t,e){var n=this.findOutputSlot("onExecuted");-1!=n&&this.triggerSlot(n,t,null,e)},LGraphNode.prototype.changeMode=function(t){switch(t){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=t,!0},LGraphNode.prototype.executePendingActions=function(){if(this._waiting_actions&&this._waiting_actions.length){for(var t=0;t<this._waiting_actions.length;++t){var e=this._waiting_actions[t];this.onAction(e[0],e[1],e[2],e[3],e[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(t,e){e=e||{},this.onExecute&&(e.action_call||(e.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(t,e),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,e)&&e.action_call&&(this.action_call=e.action_call,this.graph.nodes_executedAction[this.id]=e.action_call),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,e)},LGraphNode.prototype.actionDo=function(t,e,n,i){n=n||{},this.onAction&&(n.action_call||(n.action_call=this.id+"_"+(t||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=t||"actioning",this.onAction(t,e,n,i),this.graph.nodes_actioning[this.id]=!1,n)&&n.action_call&&(this.action_call=n.action_call,this.graph.nodes_executedAction[this.id]=n.action_call),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,n)},LGraphNode.prototype.trigger=function(t,e,n){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var i=0;i<this.outputs.length;++i){var o=this.outputs[i];!o||o.type!==LiteGraph.EVENT||t&&o.name!=t||this.triggerSlot(i,e,null,n)}}},LGraphNode.prototype.triggerSlot=function(t,e,n,i){if(i=i||{},this.outputs)if(null==t)console.error("slot must be a number");else{t.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");t=this.outputs[t];if(t){var o=t.links;if(o&&o.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var s=0;s<o.length;++s){var a,r,h=o[s];null!=n&&n!=h||(h=this.graph.links[o[s]])&&(h._last_time=LiteGraph.getTime(),a=this.graph.getNodeById(h.target_id))&&(r=a.inputs[h.target_slot],a.mode===LiteGraph.ON_TRIGGER?(i.action_call||(i.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),a.onExecute&&a.doExecute(e,i)):a.onAction&&(i.action_call||(i.action_call=this.id+"_act_"+Math.floor(9999*Math.random())),r=a.inputs[h.target_slot],LiteGraph.use_deferred_actions&&a.onExecute?(a._waiting_actions||(a._waiting_actions=[]),a._waiting_actions.push([r.name,e,i,h.target_slot])):a.actionDo(r.name,e,i,h.target_slot)))}}}}},LGraphNode.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){t=this.outputs[t];if(t){var n=t.links;if(n&&n.length)for(var i=0;i<n.length;++i){var o=n[i];null!=e&&e!=o||(o=this.graph.links[n[i]])&&(o._last_time=0)}}}},LGraphNode.prototype.setSize=function(t){this.size=t,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(t,e,n,i){var o={name:t,type:n,default_value:e};if(i)for(var s in i)o[s]=i[s];return this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[t]=e,o},LGraphNode.prototype.addOutput=function(t,e,n){var i={name:t,type:e,links:null};if(n)for(var o in n)i[o]=n[o];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,e,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i},LGraphNode.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var o in n[2])i[o]=n[2][o];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,n[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var n=this.outputs[e].links,i=0;i<n.length;++i){var o=this.graph.links[n[i]];o&&--o.origin_slot}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(t,e,n){var i={name:t,type:e=e||0,link:null};if(n)for(var o in n)i[o]=n[o];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),LiteGraph.registerNodeAndSlotType(this,e),this.setDirtyCanvas(!0,!0),i},LGraphNode.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var o in n[2])i[o]=n[2][o];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i),LiteGraph.registerNodeAndSlotType(this,n[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(t){this.disconnectInput(t);for(var e,n=this.inputs.splice(t,1),i=t;i<this.inputs.length;++i)this.inputs[i]&&(e=this.graph.links[this.inputs[i].link])&&--e.target_slot;this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(t,n[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(t,e,n,i){t={name:t,type:e,pos:n,direction:i,links:null};return this.connections.push(t),t},LGraphNode.prototype.computeSize=function(t){if(this.constructor.size)return this.constructor.size.concat();var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=t||new Float32Array([0,0]),e=Math.max(e,1),i=LiteGraph.NODE_TEXT_SIZE,t=c(this.title),o=0,s=0;if(this.inputs)for(var a=0,r=this.inputs.length;a<r;++a){var h=this.inputs[a];o<(l=c(h.label||h.name||""))&&(o=l)}if(this.outputs)for(a=0,r=this.outputs.length;a<r;++a){var l,p=this.outputs[a];s<(l=c(p.label||p.name||""))&&(s=l)}n[0]=Math.max(o+s+10,t),n[0]=Math.max(n[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*LiteGraph.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+e*LiteGraph.NODE_SLOT_HEIGHT;var u=0;if(this.widgets&&this.widgets.length){for(a=0,r=this.widgets.length;a<r;++a)this.widgets[a].computeSize?u+=this.widgets[a].computeSize(n[0])[1]+4:u+=LiteGraph.NODE_WIDGET_HEIGHT+4;u+=8}function c(t){return t?i*t.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],u):null!=this.widgets_start_y?n[1]=Math.max(n[1],u+this.widgets_start_y):n[1]+=u,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n},LGraphNode.prototype.getPropertyInfo=function(t){var e=null;if(this.properties_info)for(var n=0;n<this.properties_info.length;++n)if(this.properties_info[n].name==t){e=this.properties_info[n];break}return this.constructor["@"+t]&&(e=this.constructor["@"+t]),(e=(e=!(e=this.constructor.widgets_info&&this.constructor.widgets_info[t]?this.constructor.widgets_info[t]:e)&&this.onGetPropertyInfo?this.onGetPropertyInfo(t):e)||{}).type||(e.type=typeof this.properties[t]),"combo"==e.widget&&(e.type="enum"),e},LGraphNode.prototype.addWidget=function(t,e,n,i,o){this.widgets||(this.widgets=[]),!o&&i&&i.constructor===Object&&(o=i,i=null),o&&o.constructor===String&&(o={property:o}),i&&i.constructor===String&&((o=o||{}).property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);e={type:t.toLowerCase(),name:e,value:n,callback:i,options:o||{}};if(void 0!==e.options.y&&(e.y=e.options.y),i||e.options.callback||e.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"!=t||e.options.values)return this.widgets.push(e),this.setSize(this.computeSize()),e;throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }"},LGraphNode.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},LGraphNode.prototype.getBounding=function(t,e){t=t||new Float32Array(4);var n=this.pos,i=this.flags.collapsed,o=this.size;let s=0,a=1,r=0,h=0;return e&&(s=4,a=6+s,r=4,h=5+r),t[0]=n[0]-s,t[1]=n[1]-LiteGraph.NODE_TITLE_HEIGHT-r,t[2]=i?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+a:o[0]+a,t[3]=i?LiteGraph.NODE_TITLE_HEIGHT+h:o[1]+LiteGraph.NODE_TITLE_HEIGHT+h,this.onBounding&&this.onBounding(t),t},LGraphNode.prototype.isPointInside=function(t,e,n,i){n=n||0;var o=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(i&&(o=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(t,e,this.pos[0]-n,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-n,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*n,LiteGraph.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<t&&this.pos[0]+this.size[0]+4+n>t&&this.pos[1]-o-n<e&&this.pos[1]+this.size[1]+n>e)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(t,e){var n=new Float32Array(2);if(this.inputs)for(var i=0,o=this.inputs.length;i<o;++i){var s=this.inputs[i];if(this.getConnectionPos(!0,i,n),isInsideRectangle(t,e,n[0]-10,n[1]-5,20,10))return{input:s,slot:i,link_pos:n}}if(this.outputs)for(i=0,o=this.outputs.length;i<o;++i){var a=this.outputs[i];if(this.getConnectionPos(!1,i,n),isInsideRectangle(t,e,n[0]-10,n[1]-5,20,10))return{output:a,slot:i,link_pos:n}}return null},LGraphNode.prototype.findInputSlot=function(t,e){if(this.inputs)for(var n=0,i=this.inputs.length;n<i;++n)if(t==this.inputs[n].name)return e?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlot=function(t,e){if(e=e||!1,this.outputs)for(var n=0,i=this.outputs.length;n<i;++n)if(t==this.outputs[n].name)return e?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.inputs)for(var n=0,i=this.inputs.length;n<i;++n)if(!(this.inputs[n].link&&null!=this.inputs[n].link||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.inputs[n].type)))return e.returnObj?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},e=Object.assign({returnObj:!1,typesNotAccepted:[]},t);if(this.outputs)for(var n=0,i=this.outputs.length;n<i;++n)if(!(this.outputs[n].links&&null!=this.outputs[n].links||e.typesNotAccepted&&e.typesNotAccepted.includes&&e.typesNotAccepted.includes(this.outputs[n].type)))return e.returnObj?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotByType=function(t,e,n,i){return this.findSlotByType(!0,t,e,n,i)},LGraphNode.prototype.findOutputSlotByType=function(t,e,n,i){return this.findSlotByType(!1,t,e,n,i)},LGraphNode.prototype.findSlotByType=function(t,e,n,i,o){n=n||!1,i=i||!1,o=o||!1;var s=(t=t||!1)?this.inputs:this.outputs;if(s){""!=e&&"*"!=e||(e=0);for(var a=0,r=s.length;a<r;++a){var h=(e+"").toLowerCase().split(",");u=((u="0"==s[a].type||"*"==s[a].type?"0":s[a].type)+"").toLowerCase().split(",");for(var l=0;l<h.length;l++)for(var p=0;p<u.length;p++)if("_event_"==h[l]&&(h[l]=LiteGraph.EVENT),"_event_"==u[l]&&(u[l]=LiteGraph.EVENT),"*"==h[l]&&(h[l]=0),"*"==u[l]&&(u[l]=0),!(h[l]!=u[p]||i&&s[a].links&&null!==s[a].links))return n?s[a]:a}if(i&&!o)for(a=0,r=s.length;a<r;++a){var u,h=(e+"").toLowerCase().split(",");u=((u="0"==s[a].type||"*"==s[a].type?"0":s[a].type)+"").toLowerCase().split(",");for(l=0;l<h.length;l++)for(p=0;p<u.length;p++)if("*"==h[l]&&(h[l]=0),"*"==u[l]&&(u[l]=0),h[l]==u[p])return n?s[a]:a}}return-1},LGraphNode.prototype.connectByType=function(t,e,n,i){var i=i||{},i=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},i),o=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findInputSlotByType(n,!1,!0);return 0<=o&&null!==o?this.connect(t,e,o):i.createEventInCase&&n==LiteGraph.EVENT?this.connect(t,e,-1):i.generalTypeInCase&&0<=(o=e.findInputSlotByType(0,!1,!0,!0))||i.firstFreeIfOutputGeneralInCase&&(0==n||"*"==n||""==n)&&0<=(o=e.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?this.connect(t,e,o):(console.debug("no way to connect type: ",n," to targetNODE ",e),null)},LGraphNode.prototype.connectByTypeOutput=function(t,e,n,i){var i=i||{},i=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},i),o=(e=e&&e.constructor===Number?this.graph.getNodeById(e):e).findOutputSlotByType(n,!1,!0);return 0<=o&&null!==o||i.generalTypeInCase&&0<=(o=e.findOutputSlotByType(0,!1,!0,!0))?e.connect(o,this,t):i.createEventInCase&&n==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(o=e.addOnExecutedOutput(),e.connect(o,this,t)):i.firstFreeIfInputGeneralInCase&&(0==n||"*"==n||""==n)&&0<=(o=e.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))?e.connect(o,this,t):(console.debug("no way to connect byOUT type: ",n," to sourceNODE ",e),null)},LGraphNode.prototype.connect=function(t,e,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(!(e=e&&e.constructor===Number?this.graph.getNodeById(e):e))throw"target node is null";if(e==this)return null;if(n.constructor===String){if(-1==(n=e.findInputSlot(n)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+n),null}else if(n===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;e.changeMode(LiteGraph.ON_TRIGGER),n=e.findInputSlot("onTrigger")}else if(!e.inputs||n>=e.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var i,o=!1,s=e.inputs[n],a=this.outputs[t];return this.outputs[t]?!1!==(n=e.onBeforeConnectInput?e.onBeforeConnectInput(n):n)&&null!==n&&LiteGraph.isValidConnection(a.type,s.type)?e.onConnectInput&&!1===e.onConnectInput(n,a.type,a,this,t)||this.onConnectOutput&&!1===this.onConnectOutput(t,s.type,s,e,n)?null:(e.inputs[n]&&null!=e.inputs[n].link&&(this.graph.beforeChange(),e.disconnectInput(n,{doProcessChange:!1}),o=!0),null!==a.links&&a.links.length&&a.type===LiteGraph.EVENT&&!LiteGraph.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(t,!1,{doProcessChange:!1}),o=!0),i=new LLink(LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,s.type||a.type,this.id,t,e.id,n),this.graph.links[i.id]=i,null==a.links&&(a.links=[]),a.links.push(i.id),e.inputs[n].link=i.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!0,i,a),e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,n,!0,i,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,n,this,t),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t,e,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,i),i):(this.setDirtyCanvas(!1,!0),o&&this.graph.connectionChange(this,null),null):null},LGraphNode.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[t];if(!n||!n.links||0==n.links.length)return!1;if(e){if(!(e=e.constructor===Number?this.graph.getNodeById(e):e))throw"Target Node not found";for(var i=0,o=n.links.length;i<o;i++){var s=n.links[i];if((a=this.graph.links[s]).target_id==e.id){n.links.splice(i,1),(r=e.inputs[a.target_slot]).link=null,delete this.graph.links[s],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,a.target_slot,!1,a,r),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,a,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot));break}}}else{for(i=0,o=n.links.length;i<o;i++){var a,r,s=n.links[i];(a=this.graph.links[s])&&(e=this.graph.getNodeById(a.target_id),r=null,this.graph&&this.graph._version++,e&&((r=e.inputs[a.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(LiteGraph.INPUT,a.target_slot,!1,a,r),this.graph)&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot),delete this.graph.links[s],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,t,!1,a,n),this.graph)&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,t),this.graph.onNodeConnectionChange(LiteGraph.INPUT,e,a.target_slot))}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var n=this.inputs[t].link;if(null!=n){this.inputs[t].link=null;var i=this.graph.links[n];if(i){var o=this.graph.getNodeById(i.origin_id);if(!o)return!1;var s=o.outputs[i.origin_slot];if(!s||!s.links||0==s.links.length)return!1;for(var a=0,r=s.links.length;a<r;a++)if(s.links[a]==n){s.links.splice(a,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,t,!1,i,e),o.onConnectionsChange&&o.onConnectionsChange(LiteGraph.OUTPUT,a,!1,i,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,o,a),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,t))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(t,e,n){n=n||new Float32Array(2);var i,o=0,s=(t&&this.inputs&&(o=this.inputs.length),!t&&this.outputs&&(o=this.outputs.length),.5*LiteGraph.NODE_SLOT_HEIGHT),a=!1,a=t?void 0!==this.inputs_horizontal?this.inputs_horizontal:this.horizontal:void 0!==this.outputs_horizontal?this.outputs_horizontal:this.horizontal;return this.flags.collapsed?(i=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH,a?(n[0]=this.pos[0]+.5*i,n[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=t?this.pos[0]:this.pos[0]+i,n[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT)):t&&-1==e?(n[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT):t&&e<o&&this.inputs[e].pos?(n[0]=this.pos[0]+this.inputs[e].pos[0],n[1]=this.pos[1]+this.inputs[e].pos[1]):!t&&e<o&&this.outputs[e].pos?(n[0]=this.pos[0]+this.outputs[e].pos[0],n[1]=this.pos[1]+this.outputs[e].pos[1]):a?(n[0]=this.pos[0]+(e+.5)*(this.size[0]/o),n[1]=t?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(n[0]=t?this.pos[0]+s:this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(e+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),n},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,t)},LGraphNode.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},LGraphNode.prototype.loadImage=function(t){var e=new Image,n=(e.src=LiteGraph.node_images_path+t,e.ready=!1,this);return e.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},e},LGraphNode.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,n=0;n<e.length;++n){var i=e[n];!t&&i.node_capturing_input!=this||(i.node_capturing_input=t?this:null)}},LGraphNode.prototype.collapse=function(t){this.graph._version++,!1===this.constructor.collapsable&&!t||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},LGraphNode.prototype.localToScreen=function(t,e,n){return[(t+this.pos[0])*n.scale+n.offset[0],(e+this.pos[1])*n.scale+n.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font_size=t.font_size},LGraphGroup.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(t,e,n){if(this._pos[0]+=t,this._pos[1]+=e,!n)for(var i=0;i<this._nodes.length;++i){var o=this._nodes[i];o.pos[0]+=t,o.pos[1]+=e}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),n=0;n<t.length;++n){var i=t[n];i.getBounding(e),overlapBounding(this._bounding,e)&&this._nodes.push(i)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"up",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(t){var e,n,i,o;this.element?(o=this.element.width,e=this.element.height,n=-this.offset[0],i=-this.offset[1],t&&(n+=t[0]/this.scale,i+=t[1]/this.scale,o=t[2],e=t[3]),t=n+o/this.scale,o=i+e/this.scale,this.visible_area[0]=n,this.visible_area[1]=i,this.visible_area[2]=t-n,this.visible_area[3]=o-i):this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},DragAndScale.prototype.onMouse=function(t){var e,n,i,o,s,a;if(this.enabled)return i=(e=this.element).getBoundingClientRect(),n=t.clientX-i.left,i=t.clientY-i.top,t.canvasx=n,t.canvasy=i,t.dragging=this.dragging,o=!this.viewport||(this.viewport,n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3]),s=!1,this.onmouse&&(s=this.onmouse(t)),t.type==LiteGraph.pointerevents_method+"down"&&o?(this.dragging=!0,LiteGraph.pointerListenerRemove(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback)):t.type==LiteGraph.pointerevents_method+"move"?s||(s=n-this.last_mouse[0],a=i-this.last_mouse[1],this.dragging&&this.mouseDrag(s,a)):t.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback)):!o||"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel",t.wheel="wheel"==t.type?-t.deltaY:null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta)),this.last_mouse[0]=n,this.last_mouse[1]=i,o?(t.preventDefault(),t.stopPropagation(),!1):void 0},DragAndScale.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},DragAndScale.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(t,e){var n;t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element&&(n=this.element.getBoundingClientRect())&&(e=e||[.5*n.width,.5*n.height],n=this.convertCanvasToOffset(e),this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1),e=[(t=this.convertCanvasToOffset(e))[0]-n[0],t[1]-n[1]],this.offset[0]+=e[0],this.offset[1]+=e[1],this.onredraw)&&this.onredraw(this)},DragAndScale.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),!t&&this.graph?this.graph.detachCanvas(this):(t.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)))},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){var t,e;this._graph_stack&&0!=this._graph_stack.length&&(t=this.graph._subgraph_node,e=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t])),this.ds.offset=[0,0],this.ds.scale=1)},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(t||!this.canvas||e||this.unbindEvents(),this.canvas=t,this.ds.element=t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),e||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){var t,e;this._events_binded?console.warn("LGraphCanvas: events already binded"):(t=this.canvas,e=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(t,"down",this._mousedown_callback,!0),t.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(t,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(t,"move",this._mousemove_callback),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),t.setAttribute("tabindex",1),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0)},LGraphCanvas.prototype.unbindEvents=function(){var t;this._events_binded?(t=this.getCanvasWindow().document,LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1):console.warn("LGraphCanvas: no events binded")},LGraphCanvas.getFileExtension=function(t){var e=t.indexOf("?"),e=(t=-1!=e?t.substr(0,e):t).lastIndexOf(".");return-1==e?"":t.substr(e+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){var t;return this.canvas?(t=this.canvas.ownerDocument).defaultView||t.parentWindow:window},LGraphCanvas.prototype.startRendering=function(){function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}this.is_rendering||(this.is_rendering=!0,e.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(t){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow(),n=(e.document,LGraphCanvas.active_canvas=this),i=t.clientX,o=t.clientY,i=(this.ds.viewport=this.viewport,!this.viewport||(this.viewport,i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&o>=this.viewport[1]&&o<this.viewport[1]+this.viewport[3]));if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(e.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(e.document,"up",this._mouseup_callback,!0)),i){var s=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),a=!1,o=LiteGraph.getTime(),i=void 0===t.isPrimary||!t.isPrimary,r=o-this.last_mouseclick<300&&i;if(this.mouse[0]=t.clientX,this.mouse[1]=t.clientY,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&i?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(e),!this.onMouse||1!=this.onMouse(t)){if(1!=t.which||this.pointer_is_double)if(2==t.which)if(LiteGraph.middle_click_slot_add_default_node){if(s&&this.allow_interaction&&!a&&!this.read_only&&!this.connecting_node&&!s.flags.collapsed&&!this.live_mode){var h=!1,l=!1,p=!1;if(s.outputs)for(d=0,v=s.outputs.length;d<v;++d){f=s.outputs[d],y=s.getConnectionPos(!1,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){h=f,l=d,p=!0;break}}if(s.inputs)for(d=0,v=s.inputs.length;d<v;++d){m=s.inputs[d],y=s.getConnectionPos(!0,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){h=m,l=d,p=!1;break}}h&&!1!==l&&(o=.5-(l+1)/(p?s.outputs:s.inputs).length,i=s.getBounding(),i=[p?i[0]+i[2]:i[0],t.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:p?s:null,slotFrom:p?l:null,nodeTo:p?null:s,slotTo:p?null:l,position:i,nodeType:"AUTO",posAdd:[p?30:-30,130*-o],posSizeFix:[p?0:-1,0]}))}}else!a&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else 3!=t.which&&!this.pointer_is_double||!this.allow_interaction||a||this.read_only||(s&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[s.id]||t.shiftKey||t.ctrlKey||t.metaKey)?this.selected_nodes[s.id]||this.selectNodes([s],!0):this.selectNodes([s])),this.processContextMenu(s,t));else{t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,a=!0),LiteGraph.alt_drag_do_clone_nodes&&t.altKey&&s&&this.allow_interaction&&!a&&!this.read_only&&(cloned=s.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),s=cloned,a=!0,u||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=s),this.selected_nodes[s.id])||this.processNodeSelected(s,t));var u,c,i=!1;if(!s||!this.allow_interaction&&!s.flags.allow_interaction||a||this.read_only){if(!a){if(!this.read_only)for(var d=0;d<this.visible_links.length;++d){var _=this.visible_links[d],g=_._pos;if(!(!g||t.canvasX<g[0]-4||t.canvasX>g[0]+4||t.canvasY<g[1]-4||t.canvasY>g[1]+4)){this.showLinkMenu(_,t),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(t.ctrlKey&&(this.dragging_rectangle=null),distance([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),r&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(t),t.preventDefault(),t.stopPropagation()),i=!0}}else{if(this.live_mode||s.flags.pinned||this.bringToFront(s),this.allow_interaction&&!this.connecting_node&&!s.flags.collapsed&&!this.live_mode)if(!a&&!1!==s.resizable&&isInsideRectangle(t.canvasX,t.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=s,this.canvas.style.cursor="se-resize",a=!0;else{if(s.outputs)for(var d=0,v=s.outputs.length;d<v;++d){var f=s.outputs[d],y=s.getConnectionPos(!1,d);if(isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)){this.connecting_node=s,this.connecting_output=f,this.connecting_output.slot_index=d,this.connecting_pos=s.getConnectionPos(!1,d),this.connecting_slot=d,LiteGraph.shift_click_do_break_link_from&&t.shiftKey&&s.disconnectOutput(d),r?s.onOutputDblClick&&s.onOutputDblClick(d,t):s.onOutputClick&&s.onOutputClick(d,t),a=!0;break}}if(s.inputs)for(var d=0,v=s.inputs.length;d<v;++d){var L,m=s.inputs[d],y=s.getConnectionPos(!0,d);isInsideRectangle(t.canvasX,t.canvasY,y[0]-15,y[1]-10,30,20)&&(r?s.onInputDblClick&&s.onInputDblClick(d,t):s.onInputClick&&s.onInputClick(d,t),null!==m.link&&(L=this.graph.links[m.link],LiteGraph.click_do_break_link_to&&(s.disconnectInput(d),a=this.dirty_bgcanvas=!0),this.allow_reconnect_links||t.shiftKey)&&(LiteGraph.click_do_break_link_to||s.disconnectInput(d),this.connecting_node=this.graph._nodes_by_id[L.origin_id],this.connecting_slot=L.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),a=this.dirty_bgcanvas=!0),a||(this.connecting_node=s,this.connecting_input=m,this.connecting_input.slot_index=d,this.connecting_pos=s.getConnectionPos(!0,d),this.connecting_slot=d,a=this.dirty_bgcanvas=!0))}}a||(u=!1,o=[t.canvasX-s.pos[0],t.canvasY-s.pos[1]],(c=this.processNodeWidgets(s,this.graph_mouse,t))&&(u=!0,this.node_widget=[s,c]),this.allow_interaction&&r&&this.selected_nodes[s.id]&&(s.onDblClick&&s.onDblClick(t,o,this),this.processNodeDblClicked(s),u=!0),s.onMouseDown&&s.onMouseDown(t,o,this)?u=!0:(s.subgraph&&!s.skip_subgraph_button&&!s.flags.collapsed&&o[0]>s.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&o[1]<0&&(n=this,setTimeout(function(){n.openSubgraph(s.subgraph)},10)),this.live_mode&&(u=i=!0)),u?s.is_selected||this.processNodeSelected(s,t):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=s),this.processNodeSelected(s,t)),this.dirty_canvas=!0)}!a&&i&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=t.clientX,this.last_mouse[1]=t.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),e.document.activeElement&&("input"==e.document.activeElement.nodeName.toLowerCase()||"textarea"==e.document.activeElement.nodeName.toLowerCase())||t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}}},LGraphCanvas.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(LGraphCanvas.active_canvas=this).adjustMouseEvent(t);var e=[t.clientX,t.clientY],n=(this.mouse[0]=e[0],this.mouse[1]=e[1],[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]]);if(this.last_mouse=e,this.graph_mouse[0]=t.canvasX,this.graph_mouse[1]=t.canvasY,!this.block_click){t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t,this.node_widget[1]),this.dirty_canvas=!0);var i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]]:(e=n[0]/this.ds.scale,r=n[1]/this.ds.scale,this.selected_group.move(e,r,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||i&&i.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o,s,a,r,h=0,l=this.graph._nodes.length;h<l;++h)this.graph._nodes[h].mouseOver&&i!=this.graph._nodes[h]&&(this.graph._nodes[h].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(i)i.redraw_on_mouse&&(this.dirty_canvas=!0),i.mouseOver||(i.mouseOver=!0,this.node_over=i,this.dirty_canvas=!0,i.onMouseEnter&&i.onMouseEnter(t)),i.onMouseMove&&i.onMouseMove(t,[t.canvasX-i.pos[0],t.canvasY-i.pos[1]],this),this.connecting_node&&(this.connecting_output?(o=this._highlight_input||[0,0],this.isOverNodeBox(i,t.canvasX,t.canvasY)||(-1!=(s=this.isOverNodeInput(i,t.canvasX,t.canvasY,o))&&i.inputs[s]?(a=i.inputs[s].type,LiteGraph.isValidConnection(this.connecting_output.type,a)&&(this._highlight_input=o,this._highlight_input_slot=i.inputs[s])):(this._highlight_input=null,this._highlight_input_slot=null))):this.connecting_input&&(o=this._highlight_output||[0,0],this.isOverNodeBox(i,t.canvasX,t.canvasY)||(-1!=(s=this.isOverNodeOutput(i,t.canvasX,t.canvasY,o))&&i.outputs[s]?(a=i.outputs[s].type,LiteGraph.isValidConnection(this.connecting_input.type,a)&&(this._highlight_output=o)):this._highlight_output=null))),this.canvas&&(isInsideRectangle(t.canvasX,t.canvasY,i.pos[0]+i.size[0]-5,i.pos[1]+i.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair");else{for(var p=null,h=0;h<this.visible_links.length;++h){var u=this.visible_links[h],c=u._pos;if(!(!c||t.canvasX<c[0]-4||t.canvasX>c[0]+4||t.canvasY<c[1]-4||t.canvasY>c[1]+4)){p=u;break}}p!=this.over_link_center&&(this.over_link_center=p,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=i&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var h in this.selected_nodes){var d=this.selected_nodes[h];d.pos[0]+=n[0]/this.ds.scale,d.pos[1]+=n[1]/this.ds.scale,d.is_selected||this.processNodeSelected(d,t)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(e=[t.canvasX-this.resizing_node.pos[0],t.canvasY-this.resizing_node.pos[1]],r=this.resizing_node.computeSize(),e[0]=Math.max(r[0],e[0]),e[1]=Math.max(r[1],e[1]),this.resizing_node.setSize(e),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}}return t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(t){var e=void 0===t.isPrimary||t.isPrimary;if(!e)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var n=this.getCanvasWindow().document,n=((LGraphCanvas.active_canvas=this).options.skip_events||(LiteGraph.pointerListenerRemove(n,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(n,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(t),LiteGraph.getTime());if(t.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==t.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,t),this.node_widget=null,this.selected_group&&(n=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),a=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(n,a,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null),this.selected_group_resizing=!1;var i,n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var o=this.graph._nodes,s=new Float32Array(4),a=Math.abs(this.dragging_rectangle[2]),r=Math.abs(this.dragging_rectangle[3]),h=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-a:this.dragging_rectangle[0],l=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-r:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=h,this.dragging_rectangle[1]=l,this.dragging_rectangle[2]=a,this.dragging_rectangle[3]=r,!n||10<a&&10<r){for(var p=[],u=0;u<o.length;++u){var c=o[u];c.getBounding(s),overlapBounding(this.dragging_rectangle,s)&&p.push(c)}p.length&&this.selectNodes(p,t.shiftKey)}else this.selectNodes([n],t.shiftKey||t.ctrlKey)}this.dragging_rectangle=null}else this.connecting_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,h=(this.connecting_output||this.connecting_input).type,n?this.connecting_output?-1!=(i=this.isOverNodeInput(n,t.canvasX,t.canvasY))?this.connecting_node.connect(this.connecting_slot,n,i):this.connecting_node.connectByType(this.connecting_slot,n,h):this.connecting_input&&(-1!=(i=this.isOverNodeOutput(n,t.canvasX,t.canvasY))?n.connect(i,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,n,h)):LiteGraph.release_link_on_empty_shows_menu&&(t.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(t,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(t,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:t}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:t})),this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1):this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?((n=this.node_dragged)&&t.click_time<300&&isInsideRectangle(t.canvasX,t.canvasY,n.pos[0],n.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&n.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(!(n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]]))}else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return e&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,n=(this.adjustMouseEvent(t),t.clientX),i=t.clientY;if(!this.viewport||(this.viewport,n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3]))return n=this.ds.scale,0<e?n*=1.1:e<0&&(n*=1/1.1),this.ds.changeScale(n,[t.clientX,t.clientY]),this.graph.change(),t.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeBox=function(t,e,n){var i=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(e,n,t.pos[0]+2,t.pos[1]+2-i,i-4,i-4)},LGraphCanvas.prototype.isOverNodeInput=function(t,e,n,i){if(t.inputs)for(var o=0,s=t.inputs.length;o<s;++o){t.inputs[o];var a=t.getConnectionPos(!0,o);if((void 0!==t.inputs_horizontal?t.inputs_horizontal:t.horizontal)?isInsideRectangle(e,n,a[0]-5,a[1]-10,10,20):isInsideRectangle(e,n,a[0]-10,a[1]-5,40,10))return i&&(i[0]=a[0],i[1]=a[1]),o}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(t,e,n,i){if(t.outputs)for(var o=0,s=t.outputs.length;o<s;++o){t.outputs[o];var a=t.getConnectionPos(!1,o);if((void 0!==t.outputs_horizontal?t.outputs_horizontal:t.horizontal)?isInsideRectangle(e,n,a[0]-5,a[1]-10,10,20):isInsideRectangle(e,n,a[0]-10,a[1]-5,40,10))return i&&(i[0]=a[0],i[1]=a[1]),o}return-1},LGraphCanvas.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(e=this.dragging_canvas=!0),27==t.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),67!==t.keyCode||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),86===t.keyCode&&(t.metaKey||t.ctrlKey)&&this.pasteFromClipboard(t.shiftKey),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,n=[];for(i in this.selected_nodes)!1!==(o=this.selected_nodes[i]).clonable&&(o._relative_id=e,n.push(o),e+=1);for(var i=0;i<n.length;++i){var o=n[i];if(!1!==o.clonable){var s=o.clone();if(s){if(t.nodes.push(s.serialize()),o.inputs&&o.inputs.length)for(var a=0;a<o.inputs.length;++a){var r,h=o.inputs[a];h&&null!=h.link&&(h=this.graph.links[h.link])&&(r=this.graph.getNodeById(h.origin_id))&&t.links.push([r._relative_id,h.origin_slot,o._relative_id,h.target_slot,r.id])}}else console.warn("node type not found: "+o.type)}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},LGraphCanvas.prototype.pasteFromClipboard=function(t=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!t){var e=localStorage.getItem("litegrapheditor_clipboard");if(e){this.graph.beforeChange();for(var n=JSON.parse(e),i=!1,o=!1,s=0;s<n.nodes.length;++s)i?(i[0]>n.nodes[s].pos[0]&&(i[0]=n.nodes[s].pos[0],o[0]=s),i[1]>n.nodes[s].pos[1]&&(i[1]=n.nodes[s].pos[1],o[1]=s)):(i=[n.nodes[s].pos[0],n.nodes[s].pos[1]],o=[s,s]);for(var a=[],s=0;s<n.nodes.length;++s){var r=n.nodes[s],h=LiteGraph.createNode(r.type);h&&(h.configure(r),h.pos[0]+=this.graph_mouse[0]-i[0],h.pos[1]+=this.graph_mouse[1]-i[1],this.graph.add(h,{doProcessChange:!1}),a.push(h))}for(s=0;s<n.links.length;++s){var l,p=n.links[s],u=p[0],u=(null!=u?l=a[u]:LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&t&&(u=p[4])&&(l=this.graph.getNodeById(u)),a[p[2]]);l&&u?l.connect(p[1],u,p[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(a),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=t.clientX,n=t.clientY;if(!this.viewport||(this.viewport,e>=this.viewport[0]&&e<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3])){var e=[t.canvasX,t.canvasY],i=this.graph?this.graph.getNodeOnPos(e[0],e[1]):null;if(i){if(i.onDropFile||i.onDropData){var o=t.dataTransfer.files;if(o&&o.length)for(var s=0;s<o.length;s++){var a,r,h=t.dataTransfer.files[0],l=h.name;LGraphCanvas.getFileExtension(l);i.onDropFile&&i.onDropFile(h),i.onDropData&&((a=new FileReader).onload=function(t){t=t.target.result;i.onDropData(t,l,h)},"text"==(r=h.type.split("/")[0])||""==r?a.readAsText(h):"image"==r?a.readAsDataURL(h):a.readAsArrayBuffer(h))}}return!(!i.onDropItem||!i.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}n=null,(n=this.onDropItem?this.onDropItem(event):n)||this.checkDropItem(t)}},LGraphCanvas.prototype.checkDropItem=function(t){var e,n;t.dataTransfer.files.length&&(e=t.dataTransfer.files[0],n=LGraphCanvas.getFileExtension(e.name).toLowerCase(),n=LiteGraph.node_types_by_file_extension[n])&&(this.graph.beforeChange(),(n=LiteGraph.createNode(n.type)).pos=[t.canvasX,t.canvasY],this.graph.add(n),n.onDropFile&&n.onDropFile(e),this.graph.afterChange())},LGraphCanvas.prototype.processNodeDblClicked=function(t){this.onShowNodePanel?this.onShowNodePanel(t):this.showShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(t)},LGraphCanvas.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},LGraphCanvas.prototype.selectNodes=function(t,e){for(var n in e||this.deselectAllNodes(),t="string"==typeof(t=t||this.graph._nodes)?[t]:t){var i=t[n];if(i.is_selected)this.deselectNode(i);else{if(!i.is_selected&&i.onSelected&&i.onSelected(),i.is_selected=!0,(this.selected_nodes[i.id]=i).inputs)for(var o=0;o<i.inputs.length;++o)this.highlighted_links[i.inputs[o].link]=!0;if(i.outputs)for(o=0;o<i.outputs.length;++o){var s=i.outputs[o];if(s.links)for(var a=0;a<s.links.length;++a)this.highlighted_links[s.links[a]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var n=t.outputs[e];if(n.links)for(var i=0;i<n.links.length;++i)delete this.highlighted_links[n.links[i]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,n=t.length;e<n;++e){var i=t[e];i.is_selected&&(i.onDeselected&&i.onDeselected(),i.is_selected=!1,this.onNodeDeselected)&&this.onNodeDeselected(i)}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var t in this.graph.beforeChange(),this.selected_nodes){var e,n,i,o,t=this.selected_nodes[t];t.block_delete||(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length&&(e=t.graph.links[t.inputs[0].link],n=t.graph.links[t.outputs[0].links[0]],i=t.getInputNode(0),o=t.getOutputNodes(0)[0],i)&&o&&i.connect(e.origin_slot,o,n.target_slot),this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(t){var e,n=0,i=0;i=this.canvas?(e=this.canvas.getBoundingClientRect(),n=t.clientX-e.left,t.clientY-e.top):(n=t.clientX,t.clientY),this.last_mouse_position[0]=n,this.last_mouse_position[1]=i,t.canvasX=n/this.ds.scale-this.ds.offset[0],t.canvasY=i/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},LGraphCanvas.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},LGraphCanvas.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},LGraphCanvas.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var temp=new Float32Array(4),temp_vec2=(LGraphCanvas.prototype.computeVisibleNodes=function(t,e){for(var n=e||[],i=n.length=0,o=(t=t||this.graph._nodes).length;i<o;++i){var s=t[i];(!this.live_mode||s.onDrawBackground||s.onDrawForeground)&&overlapBounding(this.visible_area,s.getBounding(temp,!0))&&n.push(s)}return n},LGraphCanvas.prototype.draw=function(t,e){var n;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(n=LiteGraph.getTime(),this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1)},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var e=this.canvas,n=(t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(n&&(t.save(),t.beginPath(),t.rect(n[0],n[1],n[2],n[3]),t.clip()),this.clear_background&&(n?t.clearRect(n[0],n[1],n[2],n[3]):t.clearRect(0,0,e.width,e.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t,n?n[0]:0,n?n[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var i,o,s,a,r=this.computeVisibleNodes(null,this.visible_nodes),h=0;h<r.length;++h){var l=r[h];t.save(),t.translate(l.pos[0],l.pos[1]),this.drawNode(l,t),t.restore()}this.render_execution_order&&this.drawExecutionOrder(t),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(t),null!=this.connecting_pos&&(t.lineWidth=this.connections_width,i=(e=this.connecting_output||this.connecting_input).type,(a=null)==(o=e.dir)&&(o=this.connecting_output?(void 0!==this.connecting_node.outputs_horizontal?this.connecting_node.outputs_horizontal:this.connecting_node.horizontal)?LiteGraph.DOWN:LiteGraph.RIGHT:(void 0!==this.connecting_node.inputs_horizontal?this.connecting_node.inputs_horizontal:this.connecting_node.horizontal)?LiteGraph.UP:LiteGraph.LEFT),e=e.shape,a=i===LiteGraph.EVENT?LiteGraph.EVENT_LINK_COLOR:LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,a,o,LiteGraph.CENTER),t.beginPath(),i===LiteGraph.EVENT||e===LiteGraph.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):e===LiteGraph.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),(s=this._highlight_input_slot.shape)===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()),this._highlight_output)&&(t.beginPath(),s===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),t.fill()),this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.onDrawOverlay&&this.onDrawOverlay(t),n&&t.restore(),t.finish2D&&t.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(t){var e=this.graph,n=e._subgraph_node;n?(this.drawSubgraphPanelLeft(e,n,t),this.drawSubgraphPanelRight(e,n,t)):console.warn("subgraph without subnode")},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(t,e,n){var i=e.inputs?e.inputs.length:0,o=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(10,10,200,(i+1)*o+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left",n.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var s=50;if(n.font="14px Arial",e.inputs)for(var a=0;a<e.inputs.length;++a){var r,h,l=e.inputs[a];l.not_subgraph_input||(this.drawButton(20,s+2,180,o-2)&&(r=e.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(h=LiteGraph.createNode(r))?(t.add(h),this.block_click=!1,this.last_click_position=null,this.selectNodes([h]),this.node_dragged=h,this.dragging_canvas=!1,h.setProperty("name",l.name),h.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",r)),n.fillStyle="#9C9",n.beginPath(),n.arc(184,s+.5*o,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(l.name,30,s+.75*o),n.fillStyle="#777",n.fillText(l.type,130,s+.75*o),s+=o)}this.drawButton(20,s+2,180,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(e)}},LGraphCanvas.prototype.drawSubgraphPanelRight=function(t,e,n){var i=e.outputs?e.outputs.length:0,o=this.bgcanvas.width,s=200,a=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT),i=(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(o-s-10,10,s,(i+1)*a+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left","Graph Outputs"),r=n.measureText(i).width;if(n.fillText(i,o-r-20,34),this.drawButton(o-s,20,20,20,"X","#151515"))this.closeSubgraph();else{var h=50;if(n.font="14px Arial",e.outputs)for(var l=0;l<e.outputs.length;++l){var p,u,c=e.outputs[l];c.not_subgraph_input||(this.drawButton(o-s,h+2,180,a-2)&&(p=e.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(u=LiteGraph.createNode(p))?(t.add(u),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",c.name),u.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",p)),n.fillStyle="#9C9",n.beginPath(),n.arc(o-s+16,h+.5*a,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(c.name,o-s+30,h+.75*a),n.fillStyle="#777",n.fillText(c.type,o-s+130,h+.75*a),h+=a)}this.drawButton(o-s,h+2,180,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(e)}},LGraphCanvas.prototype.drawButton=function(t,e,n,i,o,s,a,r){var h=this.ctx,l=(s=s||LiteGraph.NODE_DEFAULT_COLOR,a=a||"#555",r=r||LiteGraph.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),p=LiteGraph.isInsideRectangle(l[0],l[1],t,e,n,i),u=((l=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(u=this.canvas.getBoundingClientRect(),l[0]-=u.left,l[1]-=u.top),l&&LiteGraph.isInsideRectangle(l[0],l[1],t,e,n,i)),l=(h.fillStyle=p?a:s,u&&(h.fillStyle="#AAA"),h.beginPath(),h.roundRect(t,e,n,i,[4]),h.fill(),null!=o&&o.constructor==String&&(h.fillStyle=r,h.textAlign="center",h.font=(.65*i|0)+"px Arial",h.fillText(o,t+.5*n,e+.75*i),h.textAlign="left"),u&&!this.block_click);return u&&this.blockClick(),l},LGraphCanvas.prototype.isAreaClicked=function(t,e,n,i,o){var s=this.mouse,s=(LiteGraph.isInsideRectangle(s[0],s[1],t,e,n,i),(s=this.last_click_position)&&LiteGraph.isInsideRectangle(s[0],s[1],t,e,n,i)),t=s&&!this.block_click;return s&&o&&this.blockClick(),t},LGraphCanvas.prototype.renderInfo=function(t,e,n){e=e||10,n=n||this.canvas.height-80,t.save(),t.translate(e,n),t.font="10px Arial",t.fillStyle="#888",t.textAlign="left",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var t=this.bgcanvas,e=(t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),n=(e.start&&e.start(),this.viewport||[0,0,e.canvas.width,e.canvas.height]);if(this.clear_background&&e.clearRect(n[0],n[1],n[2],n[3]),this._graph_stack&&this._graph_stack.length){e.save();this._graph_stack[this._graph_stack.length-1];for(var n=this.graph._subgraph_node,i=(e.strokeStyle=n.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=n.bgcolor||"#AAA",""),o=1;o<this._graph_stack.length;++o)i+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";e.fillText(i+n.getTitle(),.5*t.width,40),e.restore()}var s,n=!1;this.onRenderBackground&&(n=this.onRenderBackground(t,e)),this.viewport||(e.restore(),e.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(e.save(),this.ds.toCanvasContext(e),this.ds.scale<1.5&&!n&&this.clear_background_color&&(e.fillStyle=this.clear_background_color,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!n&&(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(s=this)._bg_img.onload=function(){s.draw(!0,!0)}),(n=null)==this._pattern&&0<this._bg_img.width?(n=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=n):n=this._pattern,n&&(e.fillStyle=n,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1,e.imageSmoothingEnabled=e.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()),e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},new Float32Array(2)),tmp_area=(LGraphCanvas.prototype.drawNode=function(t,e){var n=(this.current_node=t).color||t.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,i=t.bgcolor||t.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,o=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else{var s=this.editor_alpha;if(e.globalAlpha=s,this.render_shadows&&!o?(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var a,r=t._shape||LiteGraph.BOX_SHAPE,h=temp_vec2,l=(temp_vec2.set(t.size),t.horizontal),p=void 0!==t.inputs_horizontal?t.inputs_horizontal:l,u=void 0!==t.outputs_horizontal?t.outputs_horizontal:l,c=(t.flags.collapsed&&(e.font=this.inner_text_font,null!=(a=t.getTitle?t.getTitle():t.title))&&(t._collapsed_width=Math.min(t.size[0],e.measureText(a).width+2*LiteGraph.NODE_TITLE_HEIGHT),h[0]=t._collapsed_width,h[1]=0),t.clip_area&&(e.save(),e.beginPath(),r==LiteGraph.BOX_SHAPE?e.rect(0,0,h[0],h[1]):r==LiteGraph.ROUND_SHAPE?e.roundRect(0,0,h[0],h[1],[10]):r==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*h[0],.5*h[1],.5*h[0],0,2*Math.PI),e.clip()),this.drawNodeShape(t,e,h,n,i=t.has_errors?"red":i,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=p?"center":"left",e.font=this.inner_text_font,!o),d=this.connecting_output,_=this.connecting_input,g=(e.lineWidth=1,0),v=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var f,y,L=null,m=null;if(t.inputs)for(b=0;b<t.inputs.length;b++){T=t.inputs[b];if(null!=T.link){L=T;break}}if(t.outputs)for(b=0;b<t.outputs.length;b++)(T=t.outputs[b]).links&&T.links.length&&(m=T);L&&(y=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void(f=0)!==t.inputs_horizontal?t.inputs_horizontal:l)&&(f=.5*t._collapsed_width,y=-LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),T.type===LiteGraph.EVENT||T.shape===LiteGraph.BOX_SHAPE?e.rect(f-7+.5,y-4,14,8):T.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(f+8,y),e.lineTo(f+-4,y-4),e.lineTo(f+-4,y+4),e.closePath()):e.arc(f,y,4,0,2*Math.PI),e.fill()),m&&(f=t._collapsed_width,y=-.5*LiteGraph.NODE_TITLE_HEIGHT,(void 0!==t.outputs_horizontal?t.outputs_horizontal:l)&&(f=.5*t._collapsed_width,y=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),T.type===LiteGraph.EVENT||T.shape===LiteGraph.BOX_SHAPE?e.rect(f-7+.5,y-4,14,8):T.shape===LiteGraph.ARROW_SHAPE?(e.moveTo(f+6,y),e.lineTo(f-6,y-4),e.lineTo(f-6,y+4),e.closePath()):e.arc(f,y,4,0,2*Math.PI),e.fill())}}else{if(t.inputs)for(var b=0;b<t.inputs.length;b++){var G=(T=t.inputs[b]).type,C=T.shape;e.globalAlpha=s,this.connecting_output&&!LiteGraph.isValidConnection(T.type,d.type)&&(e.globalAlpha=.4*s),e.fillStyle=null!=T.link?T.color_on||this.default_connection_color_byType[G]||this.default_connection_color.input_on:T.color_off||this.default_connection_color_byTypeOff[G]||this.default_connection_color_byType[G]||this.default_connection_color.input_off;(N=t.getConnectionPos(!0,b,v))[0]-=t.pos[0],N[1]-=t.pos[1],g<N[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=N[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.beginPath(),"array"==G&&(C=LiteGraph.GRID_SHAPE);var w=!0;T.type===LiteGraph.EVENT||T.shape===LiteGraph.BOX_SHAPE?p?e.rect(N[0]-5+.5,N[1]-8+.5,10,14):e.rect(N[0]-6+.5,N[1]-5+.5,14,10):C===LiteGraph.ARROW_SHAPE?(e.moveTo(N[0]+8,N[1]+.5),e.lineTo(N[0]-4,N[1]+6+.5),e.lineTo(N[0]-4,N[1]-6+.5),e.closePath()):C===LiteGraph.GRID_SHAPE?(e.rect(N[0]-4,N[1]-4,2,2),e.rect(N[0]-1,N[1]-4,2,2),e.rect(N[0]+2,N[1]-4,2,2),e.rect(N[0]-4,N[1]-1,2,2),e.rect(N[0]-1,N[1]-1,2,2),e.rect(N[0]+2,N[1]-1,2,2),e.rect(N[0]-4,N[1]+2,2,2),e.rect(N[0]-1,N[1]+2,2,2),e.rect(N[0]+2,N[1]+2,2,2),w=!1):o?e.rect(N[0]-4,N[1]-4,8,8):e.arc(N[0],N[1],4,0,2*Math.PI),e.fill(),c&&(E=null!=T.label?T.label:T.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,p||T.dir==LiteGraph.UP?e.fillText(E,N[0],N[1]-10):e.fillText(E,N[0]+10,N[1]+5))}if(e.textAlign=u?"center":"right",e.strokeStyle="black",t.outputs)for(var b=0;b<t.outputs.length;b++){var T,G=(T=t.outputs[b]).type,C=T.shape;this.connecting_input&&!LiteGraph.isValidConnection(G,_.type)&&(e.globalAlpha=.4*s);(N=t.getConnectionPos(!1,b,v))[0]-=t.pos[0],N[1]-=t.pos[1],g<N[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=N[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),e.fillStyle=T.links&&T.links.length?T.color_on||this.default_connection_color_byType[G]||this.default_connection_color.output_on:T.color_off||this.default_connection_color_byTypeOff[G]||this.default_connection_color_byType[G]||this.default_connection_color.output_off,e.beginPath(),"array"==G&&(C=LiteGraph.GRID_SHAPE);var N,E,w=!0;G===LiteGraph.EVENT||C===LiteGraph.BOX_SHAPE?u?e.rect(N[0]-5+.5,N[1]-8+.5,10,14):e.rect(N[0]-6+.5,N[1]-5+.5,14,10):C===LiteGraph.ARROW_SHAPE?(e.moveTo(N[0]+8,N[1]+.5),e.lineTo(N[0]-4,N[1]+6+.5),e.lineTo(N[0]-4,N[1]-6+.5),e.closePath()):C===LiteGraph.GRID_SHAPE?(e.rect(N[0]-4,N[1]-4,2,2),e.rect(N[0]-1,N[1]-4,2,2),e.rect(N[0]+2,N[1]-4,2,2),e.rect(N[0]-4,N[1]-1,2,2),e.rect(N[0]-1,N[1]-1,2,2),e.rect(N[0]+2,N[1]-1,2,2),e.rect(N[0]-4,N[1]+2,2,2),e.rect(N[0]-1,N[1]+2,2,2),e.rect(N[0]+2,N[1]+2,2,2),w=!1):o?e.rect(N[0]-4,N[1]-4,8,8):e.arc(N[0],N[1],4,0,2*Math.PI),e.fill(),!o&&w&&e.stroke(),c&&(E=null!=T.label?T.label:T.name)&&(e.fillStyle=LiteGraph.NODE_TEXT_COLOR,u||T.dir==LiteGraph.DOWN?e.fillText(E,N[0],N[1]-8):e.fillText(E,N[0]-10,N[1]+5))}e.textAlign="left",e.globalAlpha=1,t.widgets&&(a=g,(p||u||t.widgets_up)&&(a=2),null!=t.widgets_start_y&&(a=t.widgets_start_y),this.drawNodeWidgets(t,a,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null))}t.clip_area&&e.restore(),e.globalAlpha=1}}},LGraphCanvas.prototype.drawLinkTooltip=function(t,e){var n,i=e._pos;t.fillStyle="black",t.beginPath(),t.arc(i[0],i[1],3,0,2*Math.PI),t.fill(),null==e.data||this.onDrawLinkTooltip&&1==this.onDrawLinkTooltip(t,e,this)||(n=null)!=(n=(e=e.data).constructor===Number?e.toFixed(2):e.constructor===String?'"'+e+'"':e.constructor===Boolean?String(e):e.toToolTip?e.toToolTip():"["+e.constructor.name+"]")&&(n=n.substr(0,30),t.font="14px Courier New",e=t.measureText(n).width+20,t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(i[0]-.5*e,i[1]-15-24,e,24,[3]),t.moveTo(i[0]-10,i[1]-15),t.lineTo(i[0]+10,i[1]-15),t.lineTo(i[0],i[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(n,i[0],i[1]-15-24*.3))},new Float32Array(4)),margin_area=(LGraphCanvas.prototype.drawNodeShape=function(t,e,n,i,o,s,a){e.strokeStyle=i,e.fillStyle=o;var r,o=LiteGraph.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,l=t._shape||t.constructor.shape||LiteGraph.ROUND_SHAPE,p=t.constructor.title_mode,u=!0,a=(p==LiteGraph.TRANSPARENT_TITLE||p==LiteGraph.NO_TITLE?u=!1:p==LiteGraph.AUTOHIDE_TITLE&&a&&(u=!0),tmp_area),c=(a[0]=0,a[1]=u?-o:0,a[2]=n[0]+1,a[3]=u?n[1]+o:n[1],e.globalAlpha);e.beginPath(),l==LiteGraph.BOX_SHAPE||h?e.fillRect(a[0],a[1],a[2],a[3]):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CARD_SHAPE?e.roundRect(a[0],a[1],a[2],a[3],l==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):l==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),e.fill(),!t.flags.collapsed&&u&&(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,a[2],2)),e.shadowColor="transparent",t.onDrawBackground&&t.onDrawBackground(e,this,this.canvas,this.graph_mouse),(u||p==LiteGraph.TRANSPARENT_TITLE)&&(t.onDrawTitleBar?t.onDrawTitleBar(e,o,n,this.ds.scale,i):p!=LiteGraph.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)&&(u=t.constructor.title_color||i,t.flags.collapsed&&(e.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients?((r=LGraphCanvas.gradients[u])||((r=LGraphCanvas.gradients[u]=e.createLinearGradient(0,0,400,0)).addColorStop(0,u),r.addColorStop(1,"#000")),e.fillStyle=r):e.fillStyle=u,e.beginPath(),l==LiteGraph.BOX_SHAPE||h?e.rect(0,-o,n[0]+1,o):l!=LiteGraph.ROUND_SHAPE&&l!=LiteGraph.CARD_SHAPE||e.roundRect(0,-o,n[0]+1,o,t.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),e.fill(),e.shadowColor="transparent"),r=!1,LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[t.mode]&&(r=LiteGraph.NODE_MODES_COLORS[t.mode]),LiteGraph.node_box_coloured_when_on&&(r=t.action_triggered?"#FFF":t.execute_triggered?"#AAA":r),t.onDrawTitleBox?t.onDrawTitleBox(e,o,n,this.ds.scale):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CIRCLE_SHAPE||l==LiteGraph.CARD_SHAPE?(h&&(e.fillStyle="black",e.beginPath(),e.arc(.5*o,-.5*o,6,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||r||LiteGraph.NODE_DEFAULT_BOXCOLOR,h?e.fillRect(.5*o-5,-.5*o-5,10,10):(e.beginPath(),e.arc(.5*o,-.5*o,5,0,2*Math.PI),e.fill())):(h&&(e.fillStyle="black",e.fillRect(.5*(o-10)-1,-.5*(o+10)-1,12,12)),e.fillStyle=t.boxcolor||r||LiteGraph.NODE_DEFAULT_BOXCOLOR,e.fillRect(.5*(o-10),-.5*(o+10),10,10)),e.globalAlpha=c,t.onDrawTitleText&&t.onDrawTitleText(e,o,n,this.ds.scale,this.title_text_font,s),!h&&(e.font=this.title_text_font,u=String(t.getTitle()))&&(e.fillStyle=s?LiteGraph.NODE_SELECTED_TITLE_COLOR:t.constructor.title_text_color||this.node_title_color,t.flags.collapsed?(e.textAlign="left",e.measureText(u),e.fillText(u.substr(0,20),o,LiteGraph.NODE_TITLE_TEXT_Y-o),e.textAlign="left"):(e.textAlign="left",e.fillText(u,o,LiteGraph.NODE_TITLE_TEXT_Y-o))),t.flags.collapsed||!t.subgraph||t.skip_subgraph_button||(r=LiteGraph.NODE_TITLE_HEIGHT,c=t.size[0]-r,u=LiteGraph.isInsideRectangle(this.graph_mouse[0]-t.pos[0],this.graph_mouse[1]-t.pos[1],2+c,2-r,r-4,r-4),e.fillStyle=u?"#888":"#555",l==LiteGraph.BOX_SHAPE||h?e.fillRect(2+c,2-r,r-4,r-4):(e.beginPath(),e.roundRect(2+c,2-r,r-4,r-4,[4]),e.fill()),e.fillStyle="#333",e.beginPath(),e.moveTo(c+.2*r,.6*-r),e.lineTo(c+.8*r,.6*-r),e.lineTo(c+.5*r,.3*-r),e.fill()),t.onDrawTitle)&&t.onDrawTitle(e),s&&(t.onBounding&&t.onBounding(a),p==LiteGraph.TRANSPARENT_TITLE&&(a[1]-=o,a[3]+=o),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),l==LiteGraph.BOX_SHAPE?e.rect(-6+a[0],-6+a[1],12+a[2],12+a[3]):l==LiteGraph.ROUND_SHAPE||l==LiteGraph.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+a[0],-6+a[1],12+a[2],12+a[3],[2*this.round_radius]):l==LiteGraph.CARD_SHAPE?e.roundRect(-6+a[0],-6+a[1],12+a[2],12+a[3],[2*this.round_radius,2,2*this.round_radius,2]):l==LiteGraph.CIRCLE_SHAPE&&e.arc(.5*n[0],.5*n[1],.5*n[0]+6,0,2*Math.PI),e.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,e.stroke(),e.strokeStyle=i,e.globalAlpha=1),0<t.execute_triggered&&t.execute_triggered--,0<t.action_triggered&&t.action_triggered--},new Float32Array(4)),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(t,e){for(var n in t)if(t[n]!=e[n])return!1;return!0}function distance(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function colorToString(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"}function isInsideRectangle(t,e,n,i,o,s){return n<t&&t<n+o&&i<e&&e<i+s}function growBounding(t,e,n){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),n<t[1]?t[1]=n:n>t[3]&&(t[3]=n)}function isInsideBounding(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])}function overlapBounding(t,e){var n=t[0]+t[2];return!(e[0]+e[2]<t[0]||t[1]>e[1]+e[3]||n<e[0]||t[1]+t[3]<e[1])}function hex2num(t){t=(t="#"==t.charAt(0)?t.slice(1):t).toUpperCase();for(var e,n,i="0123456789ABCDEF",o=new Array(3),s=0,a=0;a<6;a+=2)e=i.indexOf(t.charAt(a)),n=i.indexOf(t.charAt(a+1)),o[s]=16*e+n,s++;return o}function num2hex(t){for(var e,n,i="0123456789ABCDEF",o="#",s=0;s<3;s++)e=t[s]/16,n=t[s]%16,o+=i.charAt(e)+i.charAt(n);return o}function ContextMenu(t,n){n=n||{},this.options=n;var e=this,i=(n.parentMenu&&(n.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),n.parentMenu=null):(this.parentMenu=n.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),null),o=("MouseEvent"!==(i=n.event?n.event.constructor.name:i)&&"CustomEvent"!==i&&"PointerEvent"!==i&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+i+")"),n.event=null),document.createElement("div"));function s(t){var e=parseInt(o.style.top);return o.style.top=(e+t.deltaY*n.scroll_speed).toFixed()+"px",t.preventDefault(),!0}o.className="litegraph litecontextmenu litemenubar-panel",n.className&&(o.className+=" "+n.className),o.style.minWidth=100,o.style.minHeight=100,o.style.pointerEvents="none",setTimeout(function(){o.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(o,"up",function(t){return t.preventDefault(),!0},!0),o.addEventListener("contextmenu",function(t){return 2==t.button&&t.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(o,"down",function(t){if(2==t.button)return e.close(),t.preventDefault(),!0},!0),n.scroll_speed||(n.scroll_speed=.1),o.addEventListener("wheel",s,!0),o.addEventListener("mousewheel",s,!0),this.root=o,n.title&&((i=document.createElement("div")).className="litemenu-title",i.innerHTML=n.title,o.appendChild(i));for(var a=0;a<t.length;a++){var r=t.constructor==Array?t[a]:a,h=(null!=r&&r.constructor!==String&&(r=void 0===r.content?String(r):r.content),t[a]);this.addItem(r,h,n),0}LiteGraph.pointerListenerAdd(o,"enter",function(t){o.closing_timer&&clearTimeout(o.closing_timer)});var l,p,i=document,i=(((i=(i=n.event?n.event.target.ownerDocument:i)||document).fullscreenElement||i.body).appendChild(o),n.left||0),u=n.top||0;n.event&&(i=n.event.clientX-10,u=n.event.clientY-10,n.title&&(u-=20),n.parentMenu&&(i=(l=n.parentMenu.root.getBoundingClientRect()).left+l.width),l=document.body.getBoundingClientRect(),p=o.getBoundingClientRect(),0==l.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),l.width&&i>l.width-p.width-10&&(i=l.width-p.width-10),l.height)&&u>l.height-p.height-10&&(u=l.height-p.height-10),o.style.left=i+"px",o.style.top=u+"px",n.scale&&(o.style.transform="scale("+n.scale+")")}function CurveEditor(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}function clamp(t,e,n){return t<e?e:n<t?n:t}LGraphCanvas.prototype.drawConnections=function(t){for(var e=LiteGraph.getTime(),n=this.visible_area,i=(margin_area[0]=n[0]-20,margin_area[1]=n[1]-20,margin_area[2]=n[2]+40,margin_area[3]=n[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha,this.graph._nodes),o=0,s=i.length;o<s;++o){var a=i[o];if(a.inputs&&a.inputs.length)for(var r=0;r<a.inputs.length;++r){var h,l,p,u,c,d,_=a.inputs[r];_&&null!=_.link&&(_=_.link,_=this.graph.links[_])&&null!=(u=this.graph.getNodeById(_.origin_id))&&(h=null,h=-1==(p=_.origin_slot)?[u.pos[0]+10,u.pos[1]+10]:u.getConnectionPos(!1,p,tempA),l=a.getConnectionPos(!0,r,tempB),link_bounding[0]=h[0],link_bounding[1]=h[1],link_bounding[2]=l[0]-h[0],link_bounding[3]=l[1]-h[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area))&&(p=u.outputs[p],c=a.inputs[r],p)&&c&&(p=p.dir||(void 0!==u.outputs_horizontal?u.outputs_horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:u.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),u=c.dir||(void 0!==a.inputs_horizontal?a.inputs_horizontal?LiteGraph.UP:LiteGraph.LEFT:a.horizontal?LiteGraph.UP:LiteGraph.LEFT),this.renderLink(t,h,l,_,!1,0,null,p,u),_)&&_._last_time&&e-_._last_time<1e3&&(c=2-.002*(e-_._last_time),d=t.globalAlpha,t.globalAlpha=d*c,this.renderLink(t,h,l,_,!0,c,"white",p,u),t.globalAlpha=d)}}t.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(t,e,n,i,o,s,a,r,h,l){i&&this.visible_links.push(i),a=(a=!a&&i?i.color||LGraphCanvas.link_type_colors[i.type]:a)||this.default_link_color,null!=i&&this.highlighted_links[i.id]&&(a="#FFF"),r=r||LiteGraph.RIGHT,h=h||LiteGraph.LEFT;var p=distance(e,n),u=!1,c=Math.abs(e[0]-n[0]),d=Math.abs(e[1]-n[1]);this.links_render_mode==LiteGraph.SPLINE_LINK&&(r==LiteGraph.RIGHT&&h==LiteGraph.LEFT||r==LiteGraph.LEFT&&h==LiteGraph.RIGHT?c<50&&20<d&&(u=!0):(r==LiteGraph.DOWN&&h==LiteGraph.UP||r==LiteGraph.UP&&h==LiteGraph.DOWN)&&d<50&&20<c&&(u=!0)),this.render_connections_border&&.6<this.ds.scale&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",1<(l=l||1)&&(t.lineWidth=.5),t.beginPath();for(var _=0;_<l;_+=1){var g=5*(_-.5*(l-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK)if(t.moveTo(e[0],e[1]+g),u){var v=e[0],f=e[1]+g,y=n[0],L=n[1]+g;r==LiteGraph.RIGHT?v+=10:r==LiteGraph.LEFT?v-=10:r==LiteGraph.DOWN?f+=10:r==LiteGraph.UP&&(f-=10),h==LiteGraph.LEFT?y-=10:h==LiteGraph.RIGHT?y+=10:h==LiteGraph.UP?L-=10:h==LiteGraph.DOWN&&(L+=10),t.lineTo(v,f),t.lineTo(.5*(v+y),f),t.lineTo(.5*(v+y),L),t.lineTo(y,L),t.lineTo(n[0],n[1]+g)}else{var m=0,b=0,G=0,C=0;switch(r){case LiteGraph.LEFT:m=-.25*p;break;case LiteGraph.RIGHT:m=.25*p;break;case LiteGraph.UP:b=-.25*p;break;case LiteGraph.DOWN:b=.25*p}switch(h){case LiteGraph.LEFT:G=-.25*p;break;case LiteGraph.RIGHT:G=.25*p;break;case LiteGraph.UP:C=-.25*p;break;case LiteGraph.DOWN:C=.25*p}t.bezierCurveTo(e[0]+m,e[1]+b+g,n[0]+G,n[1]+C+g,n[0],n[1]+g)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){t.moveTo(e[0],e[1]+g);m=0,b=0,G=0,C=0;switch(r){case LiteGraph.LEFT:m=-1;break;case LiteGraph.RIGHT:m=1;break;case LiteGraph.UP:b=-1;break;case LiteGraph.DOWN:b=1}switch(h){case LiteGraph.LEFT:G=-1;break;case LiteGraph.RIGHT:G=1;break;case LiteGraph.UP:C=-1;break;case LiteGraph.DOWN:C=1}t.lineTo(e[0]+15*m,e[1]+15*b+g),t.lineTo(n[0]+15*G,n[1]+15*C+g),t.lineTo(n[0],n[1]+g)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);v=e[0],f=e[1],y=n[0],L=n[1];r==LiteGraph.RIGHT?v+=10:f+=10,h==LiteGraph.LEFT?y-=10:L-=10,t.lineTo(v,f),t.lineTo(.5*(v+y),f),t.lineTo(.5*(v+y),L),t.lineTo(y,L),t.lineTo(n[0],n[1])}}this.render_connections_border&&.6<this.ds.scale&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var w,T,N=this.computeConnectionPoint(e,n,.5,r,h);if(i&&i._pos&&(i._pos[0]=N[0],i._pos[1]=N[1]),.6<=this.ds.scale&&this.highquality_render&&h!=LiteGraph.CENTER&&(this.render_connection_arrows&&(d=this.computeConnectionPoint(e,n,.25,r,h),c=this.computeConnectionPoint(e,n,.26,r,h),o=this.computeConnectionPoint(e,n,.75,r,h),i=this.computeConnectionPoint(e,n,.76,r,h),T=w=0,T=this.render_curved_connections?(w=-Math.atan2(c[0]-d[0],c[1]-d[1]),-Math.atan2(i[0]-o[0],i[1]-o[1])):w=n[1]>e[1]?0:Math.PI,t.save(),t.translate(d[0],d[1]),t.rotate(w),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(o[0],o[1]),t.rotate(T),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()),t.beginPath(),t.arc(N[0],N[1],5,0,2*Math.PI),t.fill()),s){t.fillStyle=a;for(_=0;_<5;++_){var E=(.001*LiteGraph.getTime()+.2*_)%1,N=this.computeConnectionPoint(e,n,E,r,h);t.beginPath(),t.arc(N[0],N[1],5,0,2*Math.PI),t.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(t,e,n,i,o){i=i||LiteGraph.RIGHT,o=o||LiteGraph.LEFT;var s=distance(t,e),a=t,r=[t[0],t[1]],h=[e[0],e[1]],t=e;switch(i){case LiteGraph.LEFT:r[0]+=-.25*s;break;case LiteGraph.RIGHT:r[0]+=.25*s;break;case LiteGraph.UP:r[1]+=-.25*s;break;case LiteGraph.DOWN:r[1]+=.25*s}switch(o){case LiteGraph.LEFT:h[0]+=-.25*s;break;case LiteGraph.RIGHT:h[0]+=.25*s;break;case LiteGraph.UP:h[1]+=-.25*s;break;case LiteGraph.DOWN:h[1]+=.25*s}e=(1-n)*(1-n)*(1-n),i=(1-n)*(1-n)*3*n,o=3*(1-n)*(n*n),n*=n*n;return[e*a[0]+i*r[0]+o*h[0]+n*t[0],e*a[1]+i*r[1]+o*h[1]+n*t[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,n=0;n<e.length;++n){var i=e[n];t.fillStyle="black",t.fillRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==i.order&&t.strokeRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(i.order,i.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-6)}t.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(t,e,n,i){if(!t.widgets||!t.widgets.length)return 0;for(var o=t.size[0],s=t.widgets,a=(e+=2,LiteGraph.NODE_WIDGET_HEIGHT),r=.5<this.ds.scale,h=(n.save(),n.globalAlpha=this.editor_alpha,LiteGraph.WIDGET_OUTLINE_COLOR),l=LiteGraph.WIDGET_BGCOLOR,p=LiteGraph.WIDGET_TEXT_COLOR,u=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,c=0;c<s.length;++c){var d,_=s[c],g=e,v=(_.y&&(g=_.y),_.last_y=g,n.strokeStyle=h,n.fillStyle="#222",n.textAlign="left",_.disabled&&(n.globalAlpha*=.5),_.width||o);switch(_.type){case"button":_.clicked&&(n.fillStyle="#AAA",_.clicked=!1,this.dirty_canvas=!0),n.fillRect(15,g,v-30,a),r&&!_.disabled&&n.strokeRect(15,g,v-30,a),r&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.label||_.name,.5*v,g+.7*a));break;case"toggle":n.textAlign="left",n.strokeStyle=h,n.fillStyle=l,n.beginPath(),r?n.roundRect(15,g,v-30,a,[.5*a]):n.rect(15,g,v-30,a),n.fill(),r&&!_.disabled&&n.stroke(),n.fillStyle=_.value?"#89A":"#333",n.beginPath(),n.arc(v-30,g+.5*a,.36*a,0,2*Math.PI),n.fill(),r&&(n.fillStyle=u,null!=(f=_.label||_.name)&&n.fillText(f,30,g+.7*a),n.fillStyle=_.value?p:u,n.textAlign="right",n.fillText(_.value?_.options.on||"true":_.options.off||"false",v-40,g+.7*a));break;case"slider":n.fillStyle=l,n.fillRect(15,g,v-30,a);var f=_.options.max-_.options.min,y=(_.value-_.options.min)/f;1<(y=y<0?0:y)&&(y=1),n.fillStyle=_.options.hasOwnProperty("slider_color")?_.options.slider_color:i==_?"#89A":"#678",n.fillRect(15,g,y*(v-30),a),r&&!_.disabled&&n.strokeRect(15,g,v-30,a),_.marker&&(1<(y=(y=(_.marker-_.options.min)/f)<0?0:y)&&(y=1),n.fillStyle=_.options.hasOwnProperty("marker_color")?_.options.marker_color:"#AA9",n.fillRect(15+y*(v-30),g,2,a)),r&&(n.textAlign="center",n.fillStyle=p,n.fillText(_.label||_.name+"  "+Number(_.value).toFixed(null!=_.options.precision?_.options.precision:3),.5*v,g+.7*a));break;case"number":case"combo":n.textAlign="left",n.strokeStyle=h,n.fillStyle=l,n.beginPath(),r?n.roundRect(15,g,v-30,a,[.5*a]):n.rect(15,g,v-30,a),n.fill(),r&&(_.disabled||n.stroke(),n.fillStyle=p,_.disabled||(n.beginPath(),n.moveTo(31,g+5),n.lineTo(21,g+.5*a),n.lineTo(31,g+a-5),n.fill(),n.beginPath(),n.moveTo(v-15-16,g+5),n.lineTo(v-15-6,g+.5*a),n.lineTo(v-15-16,g+a-5),n.fill()),n.fillStyle=u,n.fillText(_.label||_.name,35,g+.7*a),n.fillStyle=p,n.textAlign="right","number"==_.type?n.fillText(Number(_.value).toFixed(void 0!==_.options.precision?_.options.precision:3),v-30-20,g+.7*a):(y=_.value,_.options.values&&(d=(d=_.options.values).constructor===Function?d():d)&&d.constructor!==Array&&(y=d[_.value]),n.fillText(y,v-30-20,g+.7*a)));break;case"string":case"text":n.textAlign="left",n.strokeStyle=h,n.fillStyle=l,n.beginPath(),r?n.roundRect(15,g,v-30,a,[.5*a]):n.rect(15,g,v-30,a),n.fill(),r&&(_.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(15,g,v-30,a),n.clip(),n.fillStyle=u,null!=(d=_.label||_.name)&&n.fillText(d,30,g+.7*a),n.fillStyle=p,n.textAlign="right",n.fillText(String(_.value).substr(0,30),v-30,g+.7*a),n.restore());break;default:_.draw&&_.draw(n,t,v,g,a)}e+=(_.computeSize?_.computeSize(v)[1]:a)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction))for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0);break;case"number":case"combo":var old_value=w.value,values,values_list,delta,index,text_values,menu,delta;function inner_clicked(t,e,n){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),!(that.dirty_canvas=!0)}event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type?(deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):event.type==LiteGraph.pointerevents_method+"down"?(values=w.options.values,values&&values.constructor===Function&&(values=w.options.values(w,node)),values_list=null,"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values)),delta=x<40?-1:widget_width-40<x?1:0,"number"==w.type?(w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):delta?(index=-1,this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index):(text_values=values!=values_list?Object.values(values):values,menu=new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window))):event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type&&(delta=x<40?-1:widget_width-40<x?1:0,event.click_time<200)&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}.bind(w),event),old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,function(t){inner_value_change(this,t)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}return null;function inner_value_change(t,e){"number"==t.type&&(e=Number(e)),t.value=e,t.options&&t.options.property&&void 0!==node.properties[t.options.property]&&node.setProperty(t.options.property,e),t.callback&&t.callback(t.value,that,node,pos,event)}},LGraphCanvas.prototype.drawGroups=function(t,e){if(this.graph){var n=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var i=0;i<n.length;++i){var o,s,a=n[i];overlapBounding(this.visible_area,a._bounding)&&(e.fillStyle=a.color||"#335",e.strokeStyle=a.color||"#335",o=a._pos,s=a._size,e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(o[0]+.5,o[1]+.5,s[0],s[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(o[0]+s[0],o[1]+s[1]),e.lineTo(o[0]+s[0]-10,o[1]+s[1]),e.lineTo(o[0]+s[0],o[1]+s[1]-10),e.fill(),s=a.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE,e.font=s+"px Arial",e.textAlign="left",e.fillText(a.title,o[0]+4,o[1]+s))}e.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(t,e){var n;t||e||(t=(n=this.canvas.parentNode).offsetWidth,e=n.offsetHeight),this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(t){var e,n,i;t?(n=(e=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),i=setInterval(function(){e.editor_alpha*=n,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,n<1&&e.editor_alpha<.01&&(clearInterval(i),n<1)&&(e.live_mode=!0),1<n&&.99<e.editor_alpha&&(clearInterval(i),e.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.onNodeSelectionChange=function(t){},LGraphCanvas.onGroupAdd=function(t,e,n){var i=LGraphCanvas.active_canvas,o=(i.getCanvasWindow(),new LiteGraph.LGraphGroup);o.pos=i.convertEventToCanvasOffset(n),i.graph.add(o)},LGraphCanvas.getBoundaryNodes=function(t){let e=null,n=null,i=null,o=null;for(var s in t){var s=t[s],[a,r]=s.pos,[h,l]=s.size;(null===e||r<e.pos[1])&&(e=s),(null===n||a+h>n.pos[0]+n.size[0])&&(n=s),(null===i||r+l>i.pos[1]+i.size[1])&&(i=s),(null===o||a<o.pos[0])&&(o=s)}return{top:e,right:n,bottom:i,left:o}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,n,i){if(e){var o,s,a=LGraphCanvas.active_canvas;let t=[];t=void 0===i?LGraphCanvas.getBoundaryNodes(e):{top:i,right:i,bottom:i,left:i};for([o,s]of Object.entries(a.selected_nodes))switch(n){case"right":s.pos[0]=t.right.pos[0]+t.right.size[0]-s.size[0];break;case"left":s.pos[0]=t.left.pos[0];break;case"top":s.pos[1]=t.top.pos[1];break;case"bottom":s.pos[1]=t.bottom.pos[1]+t.bottom.size[1]-s.size[1]}a.dirty_canvas=!0,a.dirty_bgcanvas=!0}},LGraphCanvas.onNodeAlign=function(t,e,n,i,o){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase(),o)},parentMenu:i})},LGraphCanvas.onGroupAlign=function(t,e,n,i){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(t){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,t.toLowerCase())},parentMenu:i})},LGraphCanvas.onMenuAdd=function(t,e,n,i,a){var r=LGraphCanvas.active_canvas,h=r.getCanvasWindow(),l=r.graph;if(l)return function o(i,t){var e=LiteGraph.getNodeTypesCategories(r.filter||l.filter).filter(function(t){return t.startsWith(i)}),s=[];e.map(function(t){var e,n;t&&(n=new RegExp("^("+i+")"),t=t.replace(n,"").split("/")[0],e=""===i?t+"/":i+t+"/",-1!=(n=t).indexOf("::")&&(n=n.split("::")[1]),-1===s.findIndex(function(t){return t.value===e}))&&s.push({value:e,content:n,has_submenu:!0,callback:function(t,e,n,i){o(t.value,i)}})}),LiteGraph.getNodeTypesInCategory(i.slice(0,-1),r.filter||l.filter).map(function(t){t.skip_list||s.push({value:t.type,content:t.title,has_submenu:!1,callback:function(t,e,n,i){i=i.getFirstEvent(),r.graph.beforeChange(),(t=LiteGraph.createNode(t.value))&&(t.pos=r.convertEventToCanvasOffset(i),r.graph.add(t)),a&&a(t),r.graph.afterChange()}})}),new LiteGraph.ContextMenu(s,{event:n,parentMenu:t},h)}("",i),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(t,e,n,i,o){if(o){var s,a=this,r=LGraphCanvas.active_canvas.getCanvasWindow(),e=o.optional_inputs,h=[];if(e=o.onGetInputs?o.onGetInputs():e)for(var l=0;l<e.length;l++){var p,u=e[l];u?(p=u[0],p=(u[2]||(u[2]={}),u[2].label&&(p=u[2].label),u[2].removable=!0,{content:p,value:u}),u[1]==LiteGraph.ACTION&&(p.className="event"),h.push(p)):h.push(null)}if((h=o.onMenuNodeInputs&&(s=o.onMenuNodeInputs(h))?s:h).length)return new LiteGraph.ContextMenu(h,{event:n,callback:function(t,e,n){o&&(t.callback&&t.callback.call(a,o,t,e,n),t.value)&&(o.graph.beforeChange(),o.addInput(t.value[0],t.value[1],t.value[2]),o.onNodeInputAdd&&o.onNodeInputAdd(t.value),o.setDirtyCanvas(!0,!0),o.graph.afterChange())},parentMenu:i,node:o},r),!1;console.log("no input entries")}},LGraphCanvas.showMenuNodeOptionalOutputs=function(t,e,n,r,h){if(h){var i,l=this,o=LGraphCanvas.active_canvas.getCanvasWindow(),e=h.optional_outputs,s=[];if(e=h.onGetOutputs?h.onGetOutputs():e)for(var a=0;a<e.length;a++){var p,u=e[a];u?h.flags&&h.flags.skip_repeated_outputs&&-1!=h.findOutputSlot(u[0])||(p=u[0],u[2]||(u[2]={}),u[2].label&&(p=u[2].label),u[2].removable=!0,p={content:p,value:u},u[1]==LiteGraph.EVENT&&(p.className="event"),s.push(p)):s.push(null)}if(this.onMenuNodeOutputs&&(s=this.onMenuNodeOutputs(s)),LiteGraph.do_add_triggers_slots&&-1==h.findOutputSlot("onExecuted")&&s.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),(s=h.onMenuNodeOutputs&&(i=h.onMenuNodeOutputs(s))?i:s).length)return new LiteGraph.ContextMenu(s,{event:n,callback:function t(e,n,i){if(!h)return;e.callback&&e.callback.call(l,h,e,n,i);if(!e.value)return;var o=e.value[1];{if(o&&(o.constructor===Object||o.constructor===Array)){var s,a=[];for(s in o)a.push({content:s,value:o[s]});return new LiteGraph.ContextMenu(a,{event:n,callback:t,parentMenu:r,node:h}),!1}h.graph.beforeChange(),h.addOutput(e.value[0],e.value[1],e.value[2]),h.onNodeOutputAdd&&h.onNodeOutputAdd(e.value),h.setDirtyCanvas(!0,!0),h.graph.afterChange()}},parentMenu:r,node:h},o),!1}},LGraphCanvas.onShowMenuNodeProperties=function(t,e,n,i,s){if(s&&s.properties){var o,a=LGraphCanvas.active_canvas,r=a.getCanvasWindow(),h=[];for(o in s.properties){"object"==typeof(t=void 0!==s.properties[o]?s.properties[o]:" ")&&(t=JSON.stringify(t));var l=s.getPropertyInfo(o);"enum"!=l.type&&"combo"!=l.type||(t=LGraphCanvas.getPropertyPrintableValue(t,l.values)),t=LGraphCanvas.decodeHTML(t),h.push({content:"<span class='property_name'>"+(l.label||o)+"</span><span class='property_value'>"+t+"</span>",value:o})}if(h.length)return new LiteGraph.ContextMenu(h,{event:n,callback:function(t,e,n,i){var o;s&&(o=this.getBoundingClientRect(),a.showEditPropertyValue(s,t.value,{position:[o.left,o.top]}))},parentMenu:i,allow_html:!0,node:s},r),!1}},LGraphCanvas.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},LGraphCanvas.onMenuResizeNode=function(t,e,n,i,o){if(o){var s=function(t){t.size=t.computeSize(),t.onResize&&t.onResize(t.size)},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)s(o);else for(var r in a.selected_nodes)s(a.selected_nodes[r]);o.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(i,t){var o=this,s=o.graph.getNodeById(i.origin_id),a=o.graph.getNodeById(i.target_id),r=!1,h=(s&&s.outputs&&s.outputs[i.origin_slot]&&(r=s.outputs[i.origin_slot].type),!1),l=(a&&a.outputs&&a.outputs[i.target_slot]&&(h=a.inputs[i.target_slot].type),new LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=i.data?i.data.constructor.name:null,callback:function(t,e,n){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,n,l,function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&s.connectByType(i.origin_slot,t,r)&&(t.connectByType(i.target_slot,a,h),t.pos[0]-=.5*t.size[0])});break;case"Delete":o.graph.removeLink(i.id)}}}));return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},e=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),n=e.nodeFrom&&null!==e.slotFrom,t=!n&&e.nodeTo&&null!==e.slotTo;if(n||t)if(e.nodeType){var i=n?e.nodeFrom:e.nodeTo,o=n?e.slotFrom:e.slotTo,s=!1;switch(typeof o){case"string":s=n?i.findOutputSlot(o,!1):i.findInputSlot(o,!1),o=(n?i.outputs:i.inputs)[o];break;case"object":s=n?i.findOutputSlot(o.name):i.findInputSlot(o.name);break;case"number":s=o,o=(n?i.outputs:i.inputs)[o];break;default:return console.warn("Cant get slot information "+o),!1}!1!==o&&!1!==s||console.warn("createDefaultNodeForSlot bad slotX "+o+" "+s);var a=o.type==LiteGraph.EVENT?"_event_":o.type,r=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(r&&r[a]){if(o.link,nodeNewType=!1,"object"==typeof r[a]||"array"==typeof r[a]){for(var h in r[a])if(e.nodeType==r[a][h]||"AUTO"==e.nodeType){nodeNewType=r[a][h];break}}else e.nodeType!=r[a]&&"AUTO"!=e.nodeType||(nodeNewType=r[a]);if(nodeNewType){var l=!1,p=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(l=nodeNewType).node),LiteGraph.createNode(nodeNewType));if(p){if(l){if(l.properties)for(var u in l.properties)p.addProperty(u,l.properties[u]);if(l.inputs)for(var u in p.inputs=[],l.inputs)p.addOutput(l.inputs[u][0],l.inputs[u][1]);if(l.outputs)for(var u in p.outputs=[],l.outputs)p.addOutput(l.outputs[u][0],l.outputs[u][1]);l.title&&(p.title=l.title),l.json&&p.configure(l.json)}return this.graph.add(p),p.pos=[e.position[0]+e.posAdd[0]+(e.posSizeFix[0]?e.posSizeFix[0]*p.size[0]:0),e.position[1]+e.posAdd[1]+(e.posSizeFix[1]?e.posSizeFix[1]*p.size[1]:0)],n?e.nodeFrom.connectByType(s,p,a):e.nodeTo.connectByTypeOutput(s,p,a),!0}console.log("failed creating "+nodeNewType)}}}else console.warn("No type to createDefaultNodeForSlot");else console.warn("No data passed to createDefaultNodeForSlot "+e.nodeFrom+" "+e.slotFrom+" "+e.nodeTo+" "+e.slotTo);return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},i=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),o=this,s=i.nodeFrom&&i.slotFrom,t=!s&&i.nodeTo&&i.slotTo;if(s||t){var e=s?i.nodeFrom:i.nodeTo,a=s?i.slotFrom:i.slotTo,r=!1;switch(typeof a){case"string":r=s?e.findOutputSlot(a,!1):e.findInputSlot(a,!1),a=(s?e.outputs:e.inputs)[a];break;case"object":r=s?e.findOutputSlot(a.name):e.findInputSlot(a.name);break;case"number":r=a,a=(s?e.outputs:e.inputs)[a];break;default:return console.warn("Cant get slot information "+a),!1}var n=["Add Node",null],h=(o.allow_searchbox&&(n.push("Search"),n.push(null)),a.type==LiteGraph.EVENT?"_event_":a.type),l=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(l&&l[h])if("object"==typeof l[h]||"array"==typeof l[h])for(var p in l[h])n.push(l[h][p]);else n.push(l[h]);var u=new LiteGraph.ContextMenu(n,{event:i.e,title:(a&&""!=a.name?a.name+(h?" | ":""):"")+(a&&h?h:""),callback:function(t,e,n){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,n,u,function(t){s?i.nodeFrom.connectByType(r,t,h):i.nodeTo.connectByTypeOutput(r,t,h)});break;case"Search":s?o.showSearchBox(n,{node_from:i.nodeFrom,slot_from:a,type_filter_in:h}):o.showSearchBox(n,{node_to:i.nodeTo,slot_from:a,type_filter_out:h});break;default:o.createDefaultNodeForSlot(Object.assign(i,{position:[i.e.canvasX,i.e.canvasY],nodeType:t}))}}})}else console.warn("No data passed to showConnectionMenu");return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,n,i,o){var s=e.property||"title",a=o[s],r=document.createElement("div");r.is_modified=!1,r.className="graphdialog",r.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",r.close=function(){r.parentNode&&r.parentNode.removeChild(r)};r.querySelector(".name").innerText=s;var h=r.querySelector(".value");h&&(h.value=a,h.addEventListener("blur",function(t){this.focus()}),h.addEventListener("keydown",function(t){if(r.is_modified=!0,27==t.keyCode)r.close();else if(13==t.keyCode)d();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}));var a=LGraphCanvas.active_canvas.canvas,l=a.getBoundingClientRect(),p=-20,u=-20;l&&(p-=l.left,u-=l.top),event?(r.style.left=event.clientX+p+"px",r.style.top=event.clientY+u+"px"):(r.style.left=.5*a.width+p+"px",r.style.top=.5*a.height+u+"px");r.querySelector("button").addEventListener("click",d),a.parentNode.appendChild(r),h&&h.focus();var c=null;function d(){var t;h&&(t=h.value,"Number"==e.type?t=Number(t):"Boolean"==e.type&&(t=Boolean(t)),o[s]=t,r.parentNode&&r.parentNode.removeChild(r),o.setDirtyCanvas(!0,!0))}r.addEventListener("mouseleave",function(t){LiteGraph.dialog_close_on_mouse_leave&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(t){LiteGraph.dialog_close_on_mouse_leave&&c&&clearTimeout(c)})},LGraphCanvas.prototype.prompt=function(t,e,n,i,o){var s=this,a=(t=t||"",document.createElement("div"));a.is_modified=!1,a.className="graphdialog rounded",a.innerHTML=o?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",a.close=function(){s.prompt_box=null,a.parentNode&&a.parentNode.removeChild(a)};var o=LGraphCanvas.active_canvas.canvas,r=(o.parentNode.appendChild(a),1<this.ds.scale&&(a.style.transform="scale("+this.ds.scale+")"),null),h=!1,l=(LiteGraph.pointerListenerAdd(a,"leave",function(t){h||LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(r=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(a,"enter",function(t){LiteGraph.dialog_close_on_mouse_leave&&r&&clearTimeout(r)}),a.querySelectorAll("select")),l=(l&&l.forEach(function(t){t.addEventListener("click",function(t){h++}),t.addEventListener("blur",function(t){h=0}),t.addEventListener("change",function(t){h=-1})}),s.prompt_box&&s.prompt_box.close(),(s.prompt_box=a).querySelector(".name").innerText=t,a.querySelector(".value")),p=(l.value=e,l);p.addEventListener("keydown",function(t){if(a.is_modified=!0,27!=t.keyCode){if(13!=t.keyCode||"textarea"==t.target.localName)return;n&&n(this.value)}a.close(),t.preventDefault(),t.stopPropagation()});a.querySelector("button").addEventListener("click",function(t){n&&n(p.value),s.setDirty(!0),a.close()});t=o.getBoundingClientRect(),e=-20,l=-20;return t&&(e-=t.left,l-=t.top),i?(a.style.left=i.clientX+e+"px",a.style.top=i.clientY+l+"px"):(a.style.left=.5*o.width+e+"px",a.style.top=.5*o.height+l+"px"),setTimeout(function(){p.focus()},10),a},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(s,c){var t,e,n,i,o={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open},d=(c=Object.assign(o,c||{}),this),_=LGraphCanvas.active_canvas,a=_.canvas,r=a.ownerDocument||document,h=document.createElement("div"),g=(h.className="litegraph litesearchbox graphdialog rounded",h.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",c.do_type_filter&&(h.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",h.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),h.innerHTML+="<div class='helper'></div>",r.fullscreenElement?r.fullscreenElement.appendChild(h):(r.body.appendChild(h),r.body.style.overflow="hidden"),c.do_type_filter&&(t=h.querySelector(".slot_in_type_filter"),e=h.querySelector(".slot_out_type_filter")),h.close=function(){d.search_box=null,this.blur(),a.focus(),r.body.style.overflow="",setTimeout(function(){d.canvas.focus()},20),h.parentNode&&h.parentNode.removeChild(h)},1<this.ds.scale&&(h.style.transform="scale("+this.ds.scale+")"),c.hide_on_mouse_leave&&(n=!1,i=null,LiteGraph.pointerListenerAdd(h,"enter",function(t){i&&(clearTimeout(i),i=null)}),LiteGraph.pointerListenerAdd(h,"leave",function(t){n||(i=setTimeout(function(){h.close()},500))}),c.do_type_filter)&&(t.addEventListener("click",function(t){n++}),t.addEventListener("blur",function(t){n=0}),t.addEventListener("change",function(t){n=-1}),e.addEventListener("click",function(t){n++}),e.addEventListener("blur",function(t){n=0}),e.addEventListener("change",function(t){n=-1})),d.search_box&&d.search_box.close(),(d.search_box=h).querySelector(".helper")),v=null,f=null,l=null,y=h.querySelector("input");if(y&&(y.addEventListener("blur",function(t){d.search_box&&this.focus()}),y.addEventListener("keydown",function(t){if(38==t.keyCode)w(!1);else if(40==t.keyCode)w(!0);else if(27==t.keyCode)h.close();else{if(13!=t.keyCode)return f&&clearInterval(f),void(f=setTimeout(T,250));T(),l?C(l.innerHTML):v?C(v):h.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0})),c.do_type_filter){if(t){var p=(L=LiteGraph.slot_types_in).length;c.type_filter_in!=LiteGraph.EVENT&&c.type_filter_in!=LiteGraph.ACTION||(c.type_filter_in="_event_");for(var u=0;u<p;u++)(m=document.createElement("option")).value=L[u],m.innerHTML=L[u],t.appendChild(m),!1!==c.type_filter_in&&(c.type_filter_in+"").toLowerCase()==(L[u]+"").toLowerCase()&&(m.selected=!0);t.addEventListener("change",function(){T()})}if(e){var L,p=(L=LiteGraph.slot_types_out).length;c.type_filter_out!=LiteGraph.EVENT&&c.type_filter_out!=LiteGraph.ACTION||(c.type_filter_out="_event_");for(var m,u=0;u<p;u++)(m=document.createElement("option")).value=L[u],m.innerHTML=L[u],e.appendChild(m),!1!==c.type_filter_out&&(c.type_filter_out+"").toLowerCase()==(L[u]+"").toLowerCase()&&(m.selected=!0);e.addEventListener("change",function(){T()})}}var o=a.getBoundingClientRect(),b=(s?s.clientX:o.left+.5*o.width)-80,G=(s?s.clientY:o.top+.5*o.height)-20;function C(t){if(t)if(d.onSearchBoxSelection)d.onSearchBoxSelection(t,s,_);else{var e=LiteGraph.searchbox_extras[t.toLowerCase()],n=(e&&(t=e.type),_.graph.beforeChange(),LiteGraph.createNode(t));if(n&&(n.pos=_.convertEventToCanvasOffset(s),_.graph.add(n,!1)),e&&e.data){if(e.data.properties)for(var i in e.data.properties)n.addProperty(i,e.data.properties[i]);if(e.data.inputs)for(var i in n.inputs=[],e.data.inputs)n.addOutput(e.data.inputs[i][0],e.data.inputs[i][1]);if(e.data.outputs)for(var i in n.outputs=[],e.data.outputs)n.addOutput(e.data.outputs[i][0],e.data.outputs[i][1]);e.data.title&&(n.title=e.data.title),e.data.json&&n.configure(e.data.json)}if(c.node_from){var o=!1;switch(typeof c.slot_from){case"string":o=c.node_from.findOutputSlot(c.slot_from);break;case"object":-1==(o=c.slot_from.name?c.node_from.findOutputSlot(c.slot_from.name):-1)&&void 0!==c.slot_from.slot_index&&(o=c.slot_from.slot_index);break;case"number":o=c.slot_from;break;default:o=0}void 0!==c.node_from.outputs[o]&&!1!==o&&-1<o&&c.node_from.connectByType(o,n,c.node_from.outputs[o].type)}if(c.node_to){o=!1;switch(typeof c.slot_from){case"string":o=c.node_to.findInputSlot(c.slot_from);break;case"object":-1==(o=c.slot_from.name?c.node_to.findInputSlot(c.slot_from.name):-1)&&void 0!==c.slot_from.slot_index&&(o=c.slot_from.slot_index);break;case"number":o=c.slot_from;break;default:o=0}void 0!==c.node_to.inputs[o]&&!1!==o&&-1<o&&c.node_to.connectByTypeOutput(o,n,c.node_to.inputs[o].type)}_.graph.afterChange()}h.close()}function w(t){var e=l;l&&l.classList.remove("selected"),(l=l?(l=t?l.nextSibling:l.previousSibling)||e:t?g.childNodes[0]:g.childNodes[g.childNodes.length])&&(l.classList.add("selected"),l.scrollIntoView({block:"end",behavior:"smooth"}))}function T(){f=null;var o=y.value;if(v=null,g.innerHTML="",o||c.show_all_if_empty)if(d.onSearchBox){var t=d.onSearchBox(g,o,_);if(t)for(var e=0;e<t.length;++e)u(t[e])}else{var s,a,n=0,o=o.toLowerCase(),r=_.filter||_.graph.filter;for(e in a=c.do_type_filter&&d.search_box?(s=d.search_box.querySelector(".slot_in_type_filter"),d.search_box.querySelector(".slot_out_type_filter")):s=!1,LiteGraph.searchbox_extras){var i=LiteGraph.searchbox_extras[e];if(c.show_all_if_empty&&!o||-1!==i.desc.toLowerCase().indexOf(o)){var h=LiteGraph.registered_node_types[i.type];if((!h||h.filter==r)&&p(i.type)&&(u(i.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit)&&n++>LGraphCanvas.search_limit)break}}var l=null;if(Array.prototype.filter)l=Object.keys(LiteGraph.registered_node_types).filter(p);else for(var e in l=[],LiteGraph.registered_node_types)p(e)&&l.push(e);for(e=0;e<l.length&&(u(l[e]),!(-1!==LGraphCanvas.search_limit&&n++>LGraphCanvas.search_limit));e++);if(c.show_general_after_typefiltered&&(s.value||a.value)){for(var e in filtered_extra=[],LiteGraph.registered_node_types)p(e,{inTypeOverride:!(!s||!s.value)&&"*",outTypeOverride:!(!a||!a.value)&&"*"})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(u(filtered_extra[e],"generic_type"),!(-1!==LGraphCanvas.search_limit&&n++>LGraphCanvas.search_limit));e++);}if((s.value||a.value)&&0==g.childNodes.length&&c.show_general_if_none_on_typefilter){for(var e in filtered_extra=[],LiteGraph.registered_node_types)p(e,{skipFilter:!0})&&filtered_extra.push(e);for(e=0;e<filtered_extra.length&&(u(filtered_extra[e],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&n++>LGraphCanvas.search_limit));e++);}function p(t,e){var e=e||{},e=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},e),n=LiteGraph.registered_node_types[t];if(r&&n.filter!=r)return!1;if((!c.show_all_if_empty||o)&&-1===t.toLowerCase().indexOf(o))return!1;if(c.do_type_filter&&!e.skipFilter){n=t,t=s.value;if(!1!==e.inTypeOverride&&(t=e.inTypeOverride),s&&t&&LiteGraph.registered_slot_in_types[t]&&LiteGraph.registered_slot_in_types[t].nodes){var i=LiteGraph.registered_slot_in_types[t].nodes.includes(n);if(!1===i)return!1}t=a.value;if(!1!==e.outTypeOverride&&(t=e.outTypeOverride),a&&t&&LiteGraph.registered_slot_out_types[t]&&LiteGraph.registered_slot_out_types[t].nodes){i=LiteGraph.registered_slot_out_types[t].nodes.includes(n);if(!1===i)return!1}}return!0}}function u(t,e){var n=document.createElement("div");v=v||t,n.innerText=t,n.dataset.type=escape(t),n.className="litegraph lite-search-item",e&&(n.className+=" "+e),n.addEventListener("click",function(t){C(unescape(this.dataset.type))}),g.appendChild(n)}}return h.style.left=b+"px",h.style.top=G+"px",s.layerY>o.height-200&&(g.style.maxHeight=o.height-s.layerY-20+"px"),y.focus(),c.show_all_on_open&&T(),h},LGraphCanvas.prototype.showEditPropertyValue=function(e,n,i){if(e&&void 0!==e.properties[n]){i=i||{};var o=e.getPropertyInfo(n),s=o.type,t="";if("string"==s||"number"==s||"array"==s||"object"==s)t="<input autofocus type='text' class='value'/>";else if("enum"!=s&&"combo"!=s||!o.values){if("boolean"!=s&&"toggle"!=s)return void console.warn("unknown type: "+s);t="<input autofocus type='checkbox' class='value' "+(e.properties[n]?"checked":"")+"/>"}else{for(var a in t="<select autofocus type='text' class='value'>",o.values){var r=a;t+="<option value='"+(r=o.values.constructor===Array?o.values[a]:r)+"' "+(r==e.properties[n]?"selected":"")+">"+o.values[a]+"</option>"}t+="</select>"}var h=this.createDialog("<span class='name'>"+(o.label||n)+"</span>"+t+"<button>OK</button>",i),l=!1;return"enum"!=s&&"combo"!=s||!o.values?"boolean"==s||"toggle"==s?(l=h.querySelector("input"))&&l.addEventListener("click",function(t){h.modified(),u(!!l.checked)}):(l=h.querySelector("input"))&&(l.addEventListener("blur",function(t){this.focus()}),r=void 0!==e.properties[n]?e.properties[n]:"","string"!==s&&(r=JSON.stringify(r)),l.value=r,l.addEventListener("keydown",function(t){if(27==t.keyCode)h.close();else if(13==t.keyCode)p();else if(13!=t.keyCode)return void h.modified();t.preventDefault(),t.stopPropagation()})):(l=h.querySelector("select")).addEventListener("change",function(t){h.modified(),u(t.target.value)}),l&&l.focus(),h.querySelector("button").addEventListener("click",p),h}function p(){u(l.value)}function u(t){o&&o.values&&o.values.constructor===Object&&null!=o.values[t]&&(t=o.values[t]),"number"==typeof e.properties[n]&&(t=Number(t)),"array"!=s&&"object"!=s||(t=JSON.parse(t)),e.properties[n]=t,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(n,t),i.onclose&&i.onclose(),h.close(),e.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(t,e){e=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},e||{});var n=document.createElement("div"),t=(n.className="graphdialog",n.innerHTML=t,n.is_modified=!1,this.canvas.getBoundingClientRect()),i=-20,o=-20,s=(t&&(i-=t.left,o-=t.top),e.position?(i+=e.position[0],o+=e.position[1]):e.event?(i+=e.event.clientX,o+=e.event.clientY):(i+=.5*this.canvas.width,o+=.5*this.canvas.height),n.style.left=i+"px",n.style.top=o+"px",this.canvas.parentNode.appendChild(n),e.checkForInput&&(t=[],t=n.querySelectorAll("input"))&&t.forEach(function(t){t.addEventListener("keydown",function(t){if(n.modified(),27==t.keyCode)n.close();else if(13!=t.keyCode)return;t.preventDefault(),t.stopPropagation()}),t.focus()}),n.modified=function(){n.is_modified=!0},n.close=function(){n.parentNode&&n.parentNode.removeChild(n)},null),a=!1,i=(n.addEventListener("mouseleave",function(t){a||(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!n.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(s=setTimeout(n.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),n.addEventListener("mouseenter",function(t){(e.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&s&&clearTimeout(s)}),n.querySelectorAll("select"));return i&&i.forEach(function(t){t.addEventListener("click",function(t){a++}),t.addEventListener("blur",function(t){a=0}),t.addEventListener("change",function(t){a=-1})}),n},LGraphCanvas.prototype.createPanel=function(t,e){var l=(e=e||{}).window||window,p=document.createElement("div");return p.className="litegraph dialog",p.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",p.header=p.querySelector(".dialog-header"),e.width&&(p.style.width=e.width+(e.width.constructor===Number?"px":"")),e.height&&(p.style.height=e.height+(e.height.constructor===Number?"px":"")),e.closable&&((e=document.createElement("span")).innerHTML="&#10005;",e.classList.add("close"),e.addEventListener("click",function(){p.close()}),p.header.appendChild(e)),p.title_element=p.querySelector(".dialog-title"),p.title_element.innerText=t,p.content=p.querySelector(".dialog-content"),p.alt_content=p.querySelector(".dialog-alt-content"),p.footer=p.querySelector(".dialog-footer"),p.close=function(){p.onClose&&"function"==typeof p.onClose&&p.onClose(),p.parentNode&&p.parentNode.removeChild(p),this.parentNode&&this.parentNode.removeChild(this)},p.toggleAltContent=function(t){var e;t=void 0!==t?(e=t?"block":"none",t?"none":"block"):(e="block"!=p.alt_content.style.display?"block":"none","block"!=p.alt_content.style.display?"none":"block"),p.alt_content.style.display=e,p.content.style.display=t},p.toggleFooterVisibility=function(t){t=void 0!==t?t?"block":"none":"block"!=p.footer.style.display?"block":"none",p.footer.style.display=t},p.clear=function(){this.content.innerHTML=""},p.addHTML=function(t,e,n){var i=document.createElement("div");return e&&(i.className=e),i.innerHTML=t,(n?p.footer:p.content).appendChild(i),i},p.addButton=function(t,e,n){var i=document.createElement("button");return i.innerText=t,i.options=n,i.classList.add("btn"),i.addEventListener("click",e),p.footer.appendChild(i),i},p.addSeparator=function(){var t=document.createElement("div");t.className="separator",p.content.appendChild(t)},p.addWidget=function(e,t,n,s,i){s=s||{};var o=String(n),a=("number"==(e=e.toLowerCase())&&(o=n.toFixed(3)),document.createElement("div")),r=(a.className="property",a.innerHTML="<span class='property_name'></span><span class='property_value'></span>",a.querySelector(".property_name").innerText=s.label||t,a.querySelector(".property_value"));function h(t,e){s.callback&&s.callback(t,e,s),i&&i(t,e,s)}return r.innerText=o,a.dataset.property=t,a.dataset.type=s.type||e,a.options=s,a.value=n,"code"==e?a.addEventListener("click",function(t){p.inner_showCodePad(this.dataset.property)}):"boolean"==e?(a.classList.add("boolean"),n&&a.classList.add("bool-on"),a.addEventListener("click",function(){var t=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",h(t,this.value)})):"string"==e||"number"==e?(r.setAttribute("contenteditable",!0),r.addEventListener("keydown",function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())}),r.addEventListener("blur",function(){var t=this.innerText;h(this.parentNode.dataset.property,t="number"==this.parentNode.dataset.type?Number(t):t)})):"enum"!=e&&"combo"!=e||(o=LGraphCanvas.getPropertyPrintableValue(n,s.values),r.innerText=o,r.addEventListener("click",function(t){var e=s.values||[],i=this.parentNode.dataset.property,o=this;new LiteGraph.ContextMenu(e,{event:t,className:"dark",callback:function(t,e,n){return o.innerText=t,h(i,t),!1}},l)})),p.content.appendChild(a),a},p.onOpen&&"function"==typeof p.onOpen&&p.onOpen(),p},LGraphCanvas.getPropertyPrintableValue=function(t,e){if(!e)return String(t);if(e.constructor===Array)return String(t);if(e.constructor===Object){var n,i="";for(n in e)if(e[n]==t){i=n;break}return String(t)+" ("+i+")"}},LGraphCanvas.prototype.closePanels=function(){var t=document.querySelector("#node-panel");t&&t.close(),(t=document.querySelector("#option-panel"))&&t.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(t,e,n,i){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!(e&&e.event&&e.event.target&&e.event.target.lgraphcanvas))return void console.warn("Canvas not found");var o=e.event.target.lgraphcanvas}else o=this;o.closePanels();e=o.getCanvasWindow();function s(t,e,n){n&&n.key&&(t=n.key),n.values&&(e=Object.values(n.values).indexOf(e)),o[t]=e}panel=o.createPanel("Options",{closable:!0,window:e,onOpen:function(){o.OPTIONPANEL_IS_OPEN=!0},onClose:function(){o.OPTIONPANEL_IS_OPEN=!1,o.options_panel=null}}),(o.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var a,r=LiteGraph.availableCanvasOptions;for(a in r.sort(),r){var h=r[a];panel.addWidget("boolean",h,o[h],{key:h,on:"True",off:"False"},s)}o.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[o.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},s),panel.addSeparator(),panel.footer.innerHTML="",o.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(s){this.SELECTED_NODE=s,this.closePanels();var t=this.getCanvasWindow(),a=this,r=this.createPanel(s.title||"",{closable:!0,window:t,onOpen:function(){a.NODEPANEL_IS_OPEN=!0},onClose:function(){a.NODEPANEL_IS_OPEN=!1,a.node_panel=null}});function o(){r.content.innerHTML="",r.addHTML("<span class='node_type'>"+s.type+"</span><span class='node_desc'>"+(s.constructor.desc||"")+"</span><span class='separator'></span>"),r.addHTML("<h3>Properties</h3>");function t(t,e){switch(a.graph.beforeChange(s),t){case"Title":s.title=e;break;case"Mode":var n=Object.values(LiteGraph.NODE_MODES).indexOf(e);0<=n&&LiteGraph.NODE_MODES[n]?s.changeMode(n):console.warn("unexpected mode: "+e);break;case"Color":LGraphCanvas.node_colors[e]?(s.color=LGraphCanvas.node_colors[e].color,s.bgcolor=LGraphCanvas.node_colors[e].bgcolor):console.warn("unexpected color: "+e);break;default:s.setProperty(t,e)}a.graph.afterChange(),a.dirty_canvas=!0}r.addWidget("string","Title",s.title,{},t),r.addWidget("combo","Mode",LiteGraph.NODE_MODES[s.mode],{values:LiteGraph.NODE_MODES},t);var e,n="";for(e in void 0!==s.color&&(n=Object.keys(LGraphCanvas.node_colors).filter(function(t){return LGraphCanvas.node_colors[t].color==s.color})),r.addWidget("combo","Color",n,{values:Object.keys(LGraphCanvas.node_colors)},t),s.properties){var i=s.properties[e],o=s.getPropertyInfo(e);o.type;s.onAddPropertyToPanel&&s.onAddPropertyToPanel(e,r)||r.addWidget(o.widget||o.type,e,i,o,t)}r.addSeparator(),s.onShowCustomPanelInfo&&s.onShowCustomPanelInfo(r),r.footer.innerHTML="",r.addButton("Delete",function(){s.block_delete||(s.graph.remove(s),r.close())}).classList.add("delete")}(a.node_panel=r).id="node-panel",r.node=s,r.classList.add("settings"),r.inner_showCodePad=function(e){r.classList.remove("settings"),r.classList.add("centered"),r.alt_content.innerHTML="<textarea class='code'></textarea>";function n(){r.toggleAltContent(!1),r.toggleFooterVisibility(!0),i.parentNode.removeChild(i),r.classList.add("settings"),r.classList.remove("centered"),o()}var i=r.alt_content.querySelector("textarea"),t=(i.value=s.properties[e],i.addEventListener("keydown",function(t){"Enter"==t.code&&t.ctrlKey&&(s.setProperty(e,i.value),n())}),r.toggleAltContent(!0),r.toggleFooterVisibility(!1),i.style.height="calc(100% - 40px)",r.addButton("Assign",function(){s.setProperty(e,i.value),n()})),t=(r.alt_content.appendChild(t),r.addButton("Close",n));t.style.float="right",r.alt_content.appendChild(t)},o(),this.canvas.parentNode.appendChild(r)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(o){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),i=(t&&t.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function s(){if(i.clear(),o.inputs)for(var t=0;t<o.inputs.length;++t){var e,n=o.inputs[t];n.not_subgraph_input||((e=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=n.name,e.dataset.slot=t,e.querySelector(".name").innerText=n.name,e.querySelector(".type").innerText=n.type,e.querySelector("button").addEventListener("click",function(t){o.removeInput(Number(this.parentNode.dataset.slot)),s()}))}}i.node=o,i.classList.add("subgraph_dialog");return i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(t){var e=this.parentNode,n=e.querySelector(".name").value,i=e.querySelector(".type").value;n&&-1==o.findInputSlot(n)&&(o.addInput(n,i),e.querySelector(".name").value="",e.querySelector(".type").value="",s())}),s(),this.canvas.parentNode.appendChild(i),i},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(i){var t=this.canvas.parentNode.querySelector(".subgraph_dialog"),o=(t&&t.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function s(){if(o.clear(),i.outputs)for(var t=0;t<i.outputs.length;++t){var e,n=i.outputs[t];n.not_subgraph_output||((e=o.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=n.name,e.dataset.slot=t,e.querySelector(".name").innerText=n.name,e.querySelector(".type").innerText=n.type,e.querySelector("button").addEventListener("click",function(t){i.removeOutput(Number(this.parentNode.dataset.slot)),s()}))}}o.node=i,o.classList.add("subgraph_dialog");t=o.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function e(){var t=this.parentNode,e=t.querySelector(".name").value,n=t.querySelector(".type").value;e&&-1==i.findOutputSlot(e)&&(i.addOutput(e,n),t.querySelector(".name").value="",t.querySelector(".type").value="",s())}return t.querySelector(".name").addEventListener("keydown",function(t){13==t.keyCode&&e.apply(this)}),t.querySelector("button").addEventListener("click",function(t){e.apply(this)}),s(),this.canvas.parentNode.appendChild(o),o},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var t=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),e=0;e<t.length;++e){var n=t[e];!n.node||n.node.graph&&n.graph==this.graph||n.close()}},LGraphCanvas.onMenuNodeCollapse=function(t,e,n,i,o){o.graph.beforeChange();function s(t){t.collapse()}var a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)s(o);else for(var r in a.selected_nodes)s(a.selected_nodes[r]);o.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(t,e,n,i,o){o.pin()},LGraphCanvas.onMenuNodeMode=function(t,e,n,i,s){return new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:function(e){if(s){var n=Object.values(LiteGraph.NODE_MODES).indexOf(e),t=function(t){0<=n&&LiteGraph.NODE_MODES[n]?t.changeMode(n):(console.warn("unexpected mode: "+e),t.changeMode(LiteGraph.ALWAYS))},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)t(s);else for(var o in i.selected_nodes)t(i.selected_nodes[o])}},parentMenu:i,node:s}),!1},LGraphCanvas.onMenuNodeColors=function(t,e,n,i,s){if(!s)throw"no node for color";var o,a=[];for(o in a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var r=LGraphCanvas.node_colors[o],t={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+r.color+"; background-color:"+r.bgcolor+"'>"+o+"</span>"};a.push(t)}return new LiteGraph.ContextMenu(a,{event:n,callback:function(t){if(s){var e=t.value?LGraphCanvas.node_colors[t.value]:null,n=function(t){e?t.constructor===LiteGraph.LGraphGroup?t.color=e.groupcolor:(t.color=e.color,t.bgcolor=e.bgcolor):(delete t.color,delete t.bgcolor)},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)n(s);else for(var o in i.selected_nodes)n(i.selected_nodes[o]);s.setDirtyCanvas(!0,!0)}},parentMenu:i,node:s}),!1},LGraphCanvas.onMenuNodeShapes=function(t,e,n,i,o){if(o)return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:function(e){if(o){o.graph.beforeChange();var t=function(t){t.shape=e},n=LGraphCanvas.active_canvas;if(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)t(o);else for(var i in n.selected_nodes)t(n.selected_nodes[i]);o.graph.afterChange(),o.setDirtyCanvas(!0)}},parentMenu:i,node:o}),!1;throw"no node passed"},LGraphCanvas.onMenuNodeRemove=function(t,e,n,i,o){if(!o)throw"no node passed";function s(t){!1!==t.removable&&a.remove(t)}var a=o.graph,r=(a.beforeChange(),LGraphCanvas.active_canvas);if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)s(o);else for(var h in r.selected_nodes)s(r.selected_nodes[h]);a.afterChange(),o.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(t,e,n,i,o){var s,a,r=o.graph,h=LGraphCanvas.active_canvas;h&&((s=Object.values(h.selected_nodes||{})).length||(s=[o]),(a=LiteGraph.createNode("graph/subgraph")).pos=o.pos.concat(),r.add(a),a.buildFromNodes(s),h.deselectAllNodes(),o.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(t,e,n,i,o){o.graph.beforeChange();function s(t){var e;!1!==t.clonable&&(e=t.clone())&&(e.pos=[t.pos[0]+5,t.pos[1]+5],t.graph.add(e),a[e.id]=e)}var a={},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)s(o);else for(var h in r.selected_nodes)s(r.selected_nodes[h]);Object.keys(a).length&&r.selectNodes(a),o.graph.afterChange(),o.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var t,e=null;return this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],1<Object.keys(this.selected_nodes).length&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),e=this.getExtraMenuOptions&&(t=this.getExtraMenuOptions(this,e))?e.concat(t):e},LGraphCanvas.prototype.getNodeMenuOptions=function(t){var e,n=null;return t.getMenuOptions?n=t.getMenuOptions(this):(!(n=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}])!==t.resizable&&n.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),n.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),t.onGetInputs&&(e=t.onGetInputs())&&e.length&&(n[0].disabled=!1),t.onGetOutputs&&(e=t.onGetOutputs())&&e.length&&(n[1].disabled=!1),t.getExtraMenuOptions&&(e=t.getExtraMenuOptions(this,n))&&(e.push(null),n=e.concat(n)),!1!==t.clonable&&n.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&n.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),n.push(null,{content:"Remove",disabled:!(!1!==t.removable&&!t.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(n,t),n},LGraphCanvas.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(h,t){var e,l=this,n=LGraphCanvas.active_canvas.getCanvasWindow(),i=null,o={event:t,callback:function(t,e,n){var i,o,s,a,r;t&&("Remove Slot"==t.content?(i=t.slot,h.graph.beforeChange(),i.input?h.removeInput(i.slot):i.output&&h.removeOutput(i.slot),h.graph.afterChange()):"Disconnect Links"==t.content?(i=t.slot,h.graph.beforeChange(),i.output?h.disconnectOutput(i.slot):i.input&&h.disconnectInput(i.slot),h.graph.afterChange()):"Rename Slot"==t.content&&(o=(i=t.slot).input?h.getInputInfo(i.slot):h.getOutputInfo(i.slot),s=l.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",e),(a=s.querySelector("input"))&&o&&(a.value=o.label||""),r=function(){h.graph.beforeChange(),a.value&&(o&&(o.label=a.value),l.setDirty(!0)),s.close(),h.graph.afterChange()},s.querySelector("button").addEventListener("click",r),a.addEventListener("keydown",function(t){if(s.is_modified=!0,27==t.keyCode)s.close();else if(13==t.keyCode)r();else if(13!=t.keyCode&&"textarea"!=t.target.localName)return;t.preventDefault(),t.stopPropagation()}),a.focus()))},extra:h},s=(h&&(o.title=h.type),null);h&&(s=h.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=h),s?(i=[],h.getSlotMenuOptions?i=h.getSlotMenuOptions(s):(s&&s.output&&s.output.links&&s.output.links.length&&i.push({content:"Disconnect Links",slot:s}),(e=s.input||s.output).removable&&i.push(e.locked?"Cannot remove":{content:"Remove Slot",slot:s}),e.nameLocked||i.push({content:"Rename Slot",slot:s})),o.title=(s.input||s.output).type||"*",s.input&&s.input.type==LiteGraph.ACTION&&(o.title="Action"),s.output&&s.output.type==LiteGraph.EVENT&&(o.title="Event")):h?i=this.getNodeMenuOptions(h):(i=this.getCanvasMenuOptions(),(e=this.graph.getGroupOnPos(t.canvasX,t.canvasY))&&i.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:e,options:this.getGroupMenuOptions(e)}})),i&&new LiteGraph.ContextMenu(i,o,n)},LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(t,e,i){var o=this,n=(i=i||{},document.createElement("div")),s=!(n.className="litemenu-entry submenu");function a(t){var e=this.value,n=!0;if((o.current_submenu&&o.current_submenu.close(t),i.callback&&!0===i.callback.call(this,e,i,t,o,i.node)&&(n=!1),e)&&(e.callback&&!i.ignore_item_callbacks&&!0!==e.disabled&&!0===e.callback.call(this,e,i,t,o,i.extra)&&(n=!1),e.submenu)){if(!e.submenu.options)throw"ContextMenu submenu needs options";new o.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:o,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:i.autoopen});n=!1}n&&!o.lock&&o.close()}return null===e?n.classList.add("separator"):(n.innerHTML=e&&e.title?e.title:t,(n.value=e)&&(e.disabled&&(s=!0,n.classList.add("disabled")),e.submenu||e.has_submenu)&&n.classList.add("has_submenu"),"function"==typeof e?(n.dataset.value=t,n.onclick_callback=e):n.dataset.value=e,e.className&&(n.className+=" "+e.className)),this.root.appendChild(n),s||n.addEventListener("click",a),!s&&i.autoopen&&LiteGraph.pointerListenerAdd(n,"enter",function(t){var e=this.value;e&&e.has_submenu&&a.call(this,t)}),n},ContextMenu.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!ContextMenu.isCursorOverElement(t,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(t,e,n,i){var o=document.createEvent("CustomEvent");return o.initCustomEvent(e,!0,!0,n),o.srcElement=i,t.dispatchEvent?t.dispatchEvent(o):t.__events&&t.__events.dispatchEvent(o),o},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(t,e){var n=t.clientX,t=t.clientY,e=e.getBoundingClientRect();return!!e&&t>e.top&&t<e.top+e.height&&n>e.left&&n<e.left+e.width},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var n=[],i=0;i<e.length;i++)n.push(e[i]);for(i=0;i<n.length;i++)n[i].close?n[i].close():n[i].parentNode&&n[i].parentNode.removeChild(n[i])}},LiteGraph.extendClass=function(t,e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);if(e.prototype)for(var n in e.prototype)!e.prototype.hasOwnProperty(n)||t.prototype.hasOwnProperty(n)||(e.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,e.prototype.__lookupGetter__(n)):t.prototype[n]=e.prototype[n],e.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,e.prototype.__lookupSetter__(n)))},CurveEditor.sampleCurve=function(t,e){if(e){for(var n=0;n<e.length-1;++n){var i,o=e[n],s=e[n+1];if(!(s[0]<t))return i=s[0]-o[0],Math.abs(i)<1e-5?o[1]:(i=(t-o[0])/i,o[1]*(1-i)+s[1]*i)}return 0}},CurveEditor.prototype.draw=function(t,e,n,i,o,s){var a=this.points;if(a){var r=(this.size=e)[0]-2*this.margin,h=e[1]-2*this.margin;o=o||"#666",t.save(),t.translate(this.margin,this.margin),i&&(t.fillStyle="#111",t.fillRect(0,0,r,h),t.fillStyle="#222",t.fillRect(.5*r,0,1,h),t.strokeStyle="#333",t.strokeRect(0,0,r,h)),t.strokeStyle=o,s&&(t.globalAlpha=.5),t.beginPath();for(var l=0;l<a.length;++l){var p=a[l];t.lineTo(p[0]*r,(1-p[1])*h)}if(t.stroke(),t.globalAlpha=1,!s)for(l=0;l<a.length;++l){p=a[l];t.fillStyle=this.selected==l?"#FFF":this.nearest==l?"#DDD":"#AAA",t.beginPath(),t.arc(p[0]*r,(1-p[1])*h,2,0,2*Math.PI),t.fill()}t.restore()}},CurveEditor.prototype.onMouseDown=function(t,e){var n,i,o,s=this.points;if(s&&!(t[1]<0))return n=this.size[0]-2*this.margin,i=this.size[1]-2*this.margin,o=t[0]-this.margin,t=t[1]-this.margin,e=30/e.ds.scale,this.selected=this.getCloserPoint([o,t],e),-1==this.selected&&(s.push(e=[o/n,1-t/i]),s.sort(function(t,e){return t[0]-e[0]}),this.selected=s.indexOf(e),this.must_update=!0),-1!=this.selected||void 0},CurveEditor.prototype.onMouseMove=function(t,e){var n,i,o,s,a=this.points;!a||(n=this.selected)<0||(i=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),s=[t[0]-this.margin,t[1]-this.margin],e=30/e.ds.scale,this._nearest=this.getCloserPoint(s,e),(s=a[n])&&(!(e=0==n||n==a.length-1)&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10)?(a.splice(n,1),this.selected=-1):(s[0]=e?0==n?0:1:clamp(i,0,1),s[1]=1-clamp(o,0,1),a.sort(function(t,e){return t[0]-e[0]}),this.selected=a.indexOf(s),this.must_update=!0)))},CurveEditor.prototype.onMouseUp=function(t,e){return!(this.selected=-1)},CurveEditor.prototype.getCloserPoint=function(t,e){var n=this.points;if(!n)return-1;e=e||30;for(var i=this.size[0]-2*this.margin,o=this.size[1]-2*this.margin,s=n.length,a=[0,0],r=1e6,h=-1,l=0;l<s;++l){var p=n[l],p=(a[0]=p[0]*i,a[1]=(1-p[1])*o,a[0]<t[0]&&0,vec2.distance(t,a));r<p||e<p||(h=l,r=p)}return h},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(t,e,n,i=!1){if(t&&t.addEventListener&&e&&"function"==typeof n){var o=LiteGraph.pointerevents_method,s=e;if("pointer"==o&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+s+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),s){case"down":o="touch",s="start";break;case"move":o="touch";break;case"up":o="touch",s="end";break;case"cancel":o="touch";break;case"enter":console.log("debug: Should I send a move event?");break;default:console.warn("PointerEvent not available in this browser ? The event "+s+" would not be called")}switch(s){case"down":case"up":case"move":case"over":case"out":case"enter":t.addEventListener(o+s,n,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=o)return t.addEventListener(o+s,n,i);default:return t.addEventListener(s,n,i)}}},LiteGraph.pointerListenerRemove=function(t,e,n,i=!1){if(t&&t.removeEventListener&&e&&"function"==typeof n)switch(e){case"down":case"up":case"move":case"over":case"out":case"enter":"pointer"!=LiteGraph.pointerevents_method&&"mouse"!=LiteGraph.pointerevents_method||t.removeEventListener(LiteGraph.pointerevents_method+e,n,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return t.removeEventListener(LiteGraph.pointerevents_method+e,n,i);default:return t.removeEventListener(e,n,i)}},global.clamp=clamp,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),"undefined"!=typeof exports&&(exports.LiteGraph=this.LiteGraph,exports.LGraph=this.LGraph,exports.LLink=this.LLink,exports.LGraphNode=this.LGraphNode,exports.LGraphGroup=this.LGraphGroup,exports.DragAndScale=this.DragAndScale,exports.LGraphCanvas=this.LGraphCanvas,exports.ContextMenu=this.ContextMenu);